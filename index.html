<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Waste Services - Construction Broker Demo</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
    /* Custom CSS Variables for theming */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
    }

    /* Apply primary color to common elements */
    .bg-blue-600 {
        background-color: var(--primary-color) !important;
    }

    .text-blue-600 {
        color: var(--primary-color) !important;
    }

    .border-blue-500 {
        border-color: var(--primary-color) !important;
    }

    .bg-blue-500 {
        background-color: var(--primary-color) !important;
    }

    .text-blue-500 {
        color: var(--primary-color) !important;
    }

    .hover\:bg-blue-700:hover {
        background-color: var(--primary-hover) !important;
    }
</style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        
        // Lucide React Icons as components
        const LucideIcon = ({ icon, size = 24, className = "" }) => {
            const icons = {
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
                X: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                Search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>,
                User: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
                Users: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
                Phone: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>,
                Mail: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-10 5L2 7"></path></svg>,
                Truck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 17h4V5H2v12h3"></path><circle cx="7.5" cy="17.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle><path d="M14 12h5l3 3v4h-8v-7z"></path></svg>,
                BarChart3: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
                Grid: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
                Settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6m4.22-10.22l4.24 4.24M6.34 6.34l4.24 4.24m10.61 4.88l-4.24 4.24M6.34 17.66l4.24-4.24M1 12h6m6 0h6"></path></svg>,
                Activity: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
                DollarSign: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
                Recycle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5"></path><path d="m11 19-2 2m2-2 2 2"></path><path d="M18.5 8H20a2 2 0 0 1 0 4h-2.5l4 4"></path><path d="m2 18 4-4"></path><path d="M12 8V5c0-1.1.9-2 2-2h3"></path><path d="m16 2 4 4-4 4"></path></svg>,
                Loader: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>,
                LogOut: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
                Trash2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
                Mountain: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m8 3 4 8 5-5 5 15H2L8 3z"></path></svg>,
                Star: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
                Layout: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>,
                Palette: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>,
                Calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
                Copy: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
                Edit3: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>,
                Filter: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
                ChevronDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>,
                ChevronUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
                ChevronUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
                Menu: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,  
                Repeat: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>,
                Maximize2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
                Package: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
                FileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            };
            
            return icons[icon] || null;
        };
// Searchable Dropdown Component
const SearchableDropdown = ({ 
  options = [], 
  value, 
  onChange, 
  placeholder = "Select...", 
  displayField = "name",
  valueField = "name",
  className = ""
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredProducts, setFilteredProducts] = useState(options);

  useEffect(() => {
    // Sort options alphabetically and filter by search term
    const sorted = [...options].sort((a, b) => {
      const aName = a[displayField] || '';
      const bName = b[displayField] || '';
      return aName.localeCompare(bName);
    });
    
    const filtered = sorted.filter(option => {
      const optionText = option[displayField] || '';
      return optionText.toLowerCase().includes(searchTerm.toLowerCase());
    });
    
   setFilteredProducts(filtered);
  }, [options, searchTerm, displayField]);

  const handleSelect = (option) => {
    onChange(option[valueField]);
    setIsOpen(false);
    setSearchTerm('');
  };

  const selectedOption = options.find(opt => opt[valueField] === value);

  return (
    <div className="relative">
      <div
        className={`w-full px-3 py-2 border border-gray-300 rounded-lg cursor-pointer bg-white ${className}`}
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center justify-between">
          <span className={value ? 'text-gray-900' : 'text-gray-500'}>
            {selectedOption ? selectedOption[displayField] : placeholder}
          </span>
          <ChevronDown size={16} className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </div>
      
      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
          <div className="p-2 border-b">
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Type to search..."
              className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              autoFocus
            />
          </div>
          <div className="max-h-48 overflow-y-auto">
       {filteredProducts.length === 0 ? (
  <div className="px-3 py-2 text-gray-500 text-sm">No options found</div>
) : (
  filteredProducts.map((option, index) => (
    <div
      key={option.id || index}
      className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
      onClick={() => handleSelect(option)}
    >
      {option[displayField]}
    </div>
  ))
)}
          </div>
        </div>
      )}
    </div>
  );
};

// Sage Product Selector Component
const SageProductSelector = ({ jobType, selectedProduct, onSelect, products }) => {
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  // Smart filtering based on job type and waste type
const getFilteredProducts = () => {
  if (products.length === 0) {
  return [];
}

  let filtered = products;

  // Filter by search term only
  if (searchTerm) {
   filtered = filtered.filter(p => {
  const searchLower = searchTerm.toLowerCase();
  const nameLower = (p.name || '').toLowerCase();
  const descLower = (p.description || '').toLowerCase();
  const codeLower = (p.item_code || '').toLowerCase();
  
  return nameLower.includes(searchLower) ||
         descLower.includes(searchLower) ||
         codeLower.includes(searchLower) ||
         nameLower.replace(/\s+/g, '').includes(searchLower) ||
         searchLower.split(' ').every(word => nameLower.includes(word));
});
  }

  // Sort alphabetically by name
  return filtered.sort((a, b) => a.name.localeCompare(b.name));
};
  const filteredProducts = getFilteredProducts();
  const selectedProductDetails = products.find(p => p.sage_id === selectedProduct);

  if (products.length === 0) {
    return (
      <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
        Loading Sage products...
      </div>
    );
  }

  if (products.length === 0) {
    return (
      <div className="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50 text-red-600">
        No Sage products found. Please sync products in Admin Panel first.
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {/* Search input */}
      <div className="relative">
        <Search size={16} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
        <input
          type="text"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          placeholder="Search Sage products/services..."
          className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm"
        />
      </div>

      {/* Selected product display */}
      {selectedProductDetails && (
        <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium text-blue-900">{selectedProductDetails.name}</div>
              <div className="text-sm text-blue-700">Code: {selectedProductDetails.item_code}</div>
            </div>
            <button
              onClick={() => onSelect('', '')}
              className="text-blue-600 hover:text-blue-800"
            >
              <X size={16} />
            </button>
          </div>
        </div>
      )}

      {/* Product list */}
      <div className="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
        {filteredProducts.length === 0 ? (
          <div className="p-3 text-gray-500 text-sm">No products match your search</div>
        ) : (
          filteredProducts.map((product, index) => {
            const isRecommended = index < 3 && !searchTerm;
            return (
              <div
                key={product.id}
                className={`p-3 border-b border-gray-200 last:border-b-0 cursor-pointer hover:bg-gray-50 ${
                  isRecommended ? 'bg-green-50' : ''
                }`}
                onClick={() => onSelect(product)}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium text-gray-900">
                      {product.name}
                      {isRecommended && (
                        <span className="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                          Recommended
                        </span>
                      )}
                    </div>
                    <div className="text-sm text-gray-600">
                      Code: {product.item_code} | Type: {product.type}
                    </div>
                    {product.description && (
                      <div className="text-xs text-gray-500 mt-1">{product.description}</div>
                    )}
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>

      <div className="text-xs text-gray-500">
        {products.length} products available from Sage
      </div>
    </div>
  );
};
        // Create icon components
        const Plus = (props) => <LucideIcon icon="Plus" {...props} />;
        const X = (props) => <LucideIcon icon="X" {...props} />;
        const Search = (props) => <LucideIcon icon="Search" {...props} />;
        const User = (props) => <LucideIcon icon="User" {...props} />;
        const Users = (props) => <LucideIcon icon="Users" {...props} />;
        const Phone = (props) => <LucideIcon icon="Phone" {...props} />;
        const Mail = (props) => <LucideIcon icon="Mail" {...props} />;
        const Truck = (props) => <LucideIcon icon="Truck" {...props} />;
        const BarChart3 = (props) => <LucideIcon icon="BarChart3" {...props} />;
        const Grid = (props) => <LucideIcon icon="Grid" {...props} />;
        const Settings = (props) => <LucideIcon icon="Settings" {...props} />;
        const Activity = (props) => <LucideIcon icon="Activity" {...props} />;
        const DollarSign = (props) => <LucideIcon icon="DollarSign" {...props} />;
        const TrendingUp = (props) => <LucideIcon icon="TrendingUp" {...props} />;
        const Recycle = (props) => <LucideIcon icon="Recycle" {...props} />;
        const Loader = (props) => <LucideIcon icon="Loader" {...props} />;
        const LogOut = (props) => <LucideIcon icon="LogOut" {...props} />;
        const Trash2 = (props) => <LucideIcon icon="Trash2" {...props} />;
        const Mountain = (props) => <LucideIcon icon="Mountain" {...props} />;
        const Star = (props) => <LucideIcon icon="Star" {...props} />;
        const Layout = (props) => <LucideIcon icon="Layout" {...props} />;
        const Palette = (props) => <LucideIcon icon="Palette" {...props} />;
        const Calendar = (props) => <LucideIcon icon="Calendar" {...props} />;
        const Copy = (props) => <LucideIcon icon="Copy" {...props} />;
        const Edit3 = (props) => <LucideIcon icon="Edit3" {...props} />;
        const Filter = (props) => <LucideIcon icon="Filter" {...props} />;
        const ChevronDown = (props) => <LucideIcon icon="ChevronDown" {...props} />;
        const ChevronUp = (props) => <LucideIcon icon="ChevronUp" {...props} />;
        const Menu = (props) => <LucideIcon icon="Menu" {...props} />;
        const Repeat = (props) => <LucideIcon icon="Repeat" {...props} />;
        const Package = (props) => <LucideIcon icon="Package" {...props} />;
        const Maximize2 = (props) => <LucideIcon icon="Maximize2" {...props} />;
        const FileText = (props) => <LucideIcon icon="FileText" {...props} />;

        // Demo Data
        const demoUsers = [
          { id: '1', email: 'admin@totalwaste.co.uk', password: 'demo123', firstName: 'System', lastName: 'Administrator', role: 'ADMIN' },
          { id: '2', email: 'manager@totalwaste.co.uk', password: 'demo123', firstName: 'Sarah', lastName: 'Johnson', role: 'MANAGER' },
          { id: '3', email: 'broker@totalwaste.co.uk', password: 'demo123', firstName: 'Tom', lastName: 'Richards', role: 'BROKER' }
        ];

        const initialJobs = [
          {
            id: 'TWS-2024-001', jobNumber: 'TWS-2024-001', jobDate: '2024-12-15',
            customerName: 'Greenfield Construction Ltd', customerPO: 'GF-PO-2024-1234',
            supplierName: 'Metropolitan Waste Solutions', supplierRef: 'MW-24-5678',
            jobType: 'Skip Hire', skipSize: '8 yard', wasteType: 'Mixed Construction Waste',
            quantity: 1, unit: 'skip', weight: '3.5', customerUnitPrice: 185.00, customerFinalPrice: 185.00,
            supplierUnitPrice: 142.00, supplierFinalPrice: 142.00, vatRate: 20,
            grossProfit: 43.00, profitMargin: 23.2, status: 'CONFIRMED', priority: 'Medium',
            jobValue: 185.00, siteAddress: '89 Construction Drive, London', sitePostcode: 'E14 9KL',
            siteContact: 'John Smith', sitePhone: '+44 7700 900123', deliveryInstructions: 'Place skip in designated area near site entrance',
            wasteTransferNote: 'WTN-2024-001234', invoiceNumber: 'INV-2024-0156', invoiceStatus: 'Invoiced', paymentStatus: 'Not Paid',
            isCompleted: false, isCancelled: false, parentJobId: null, linkedJobs: []
          },
          {
            id: 'TWS-2024-002', jobNumber: 'TWS-2024-002', jobDate: '2024-12-16',
            customerName: 'BuildMaster Holdings Ltd', customerPO: 'BM-PO-2024-5678',
            supplierName: 'Northern Aggregates Ltd', supplierRef: 'NA-24-9012',
            haulierName: 'Fast Haulage Ltd',
            jobType: 'Aggregates', aggregateType: 'Type 1 Sub Base', quantity: 25, unit: 'tonnes',
            customerUnitPrice: 32.50, customerFinalPrice: 812.50, supplierUnitPrice: 26.80,
            supplierFinalPrice: 670.00, vatRate: 20, grossProfit: 142.50,
            profitMargin: 17.5, status: 'IN_PROGRESS', priority: 'High', jobValue: 812.50,
            siteAddress: '456 Development Square, Manchester', sitePostcode: 'M1 2AB',
            siteContact: 'Emma Thompson', sitePhone: '+44 7700 900456',
            deliveryInstructions: 'Call site manager 30 mins before arrival',
            timeSlot: 'AM (8:00-12:00)',
            invoiceNumber: '', invoiceStatus: 'Not Invoiced', paymentStatus: 'Not Paid',
            isCompleted: false, isCancelled: false, parentJobId: null, linkedJobs: []
          },
          {
            id: 'TWS-2024-003', jobNumber: 'TWS-2024-003', jobDate: '2024-12-12',
            customerName: 'City Retail Chain', customerPO: 'CRC-PO-2024-9012',
            supplierName: 'Quick Waste Ltd', supplierRef: 'QW-24-3456',
            jobType: 'Waste Collection', wasteType: 'Commercial Waste', quantity: 5, unit: 'collections',
            customerUnitPrice: 85.00, customerFinalPrice: 425.00, supplierUnitPrice: 65.00,
            supplierFinalPrice: 325.00, vatRate: 20, grossProfit: 100.00,
            profitMargin: 23.5, status: 'CONFIRMED', priority: 'High', jobValue: 425.00,
            siteAddress: '789 High Street, Birmingham', sitePostcode: 'B1 1AA',
            siteContact: 'Mark Wilson', sitePhone: '+44 7700 900789',
            deliveryInstructions: 'Weekly collection every Monday morning',
            invoiceNumber: 'INV-2024-0155', invoiceStatus: 'Invoiced', paymentStatus: 'Part Paid',
            isCompleted: false, isCancelled: false, parentJobId: null, linkedJobs: []
          }
        ];

        const initialCustomers = [
          {
            id: 'CUST-001', companyName: 'Greenfield Construction Ltd', tradingName: 'Greenfield', 
            companyNumber: '12345678', vatNumber: 'GB123456789', primaryContact: 'John Smith',
            contactPosition: 'Site Manager', phone: '+44 20 7946 0958', mobile: '+44 7700 900123',
            email: 'john.smith@greenfield-construction.co.uk', accountsEmail: 'accounts@greenfield-construction.co.uk',
            creditRating: 'A', businessType: 'Main Contractor', paymentTerms: 30, creditLimit: 75000,
            accountStatus: 'Active', siteAddress: '45 Construction Way, London', sitePostcode: 'E1 6AN',
            billingAddress: 'Same as site', billingPostcode: 'E1 6AN', healthSafetyCompliant: true,
            chasAccredited: true, insuranceExpiry: '2025-12-31', preferredContactMethod: 'Email'
          },
          {
            id: 'CUST-002', companyName: 'BuildMaster Holdings Ltd', tradingName: 'BuildMaster',
            companyNumber: '87654321', vatNumber: 'GB987654321', primaryContact: 'Emma Thompson',
            contactPosition: 'Procurement Manager', phone: '+44 161 234 5678', mobile: '+44 7700 900456',
            email: 'emma.thompson@buildmaster.co.uk', accountsEmail: 'finance@buildmaster.co.uk',
            creditRating: 'A+', businessType: 'Property Developer', paymentTerms: 14, creditLimit: 50000,
            accountStatus: 'Active', siteAddress: '123 Development Square, Manchester', sitePostcode: 'M1 2AB',
            billingAddress: 'BuildMaster House, 456 Business Park', billingPostcode: 'M2 3CD',
            healthSafetyCompliant: true, chasAccredited: true, insuranceExpiry: '2025-10-15',
            preferredContactMethod: 'Phone'
          },
          {
            id: 'CUST-003', companyName: 'City Retail Chain', tradingName: 'City Retail',
            companyNumber: '11223344', vatNumber: 'GB112233445', primaryContact: 'Mark Wilson',
            contactPosition: 'Facilities Manager', phone: '+44 207 555 0199', mobile: '+44 7700 900789',
            email: 'mark.wilson@cityretail.co.uk', accountsEmail: 'ap@cityretail.co.uk',
            creditRating: 'B+', businessType: 'Retail', paymentTerms: 30, creditLimit: 25000,
            accountStatus: 'Active', siteAddress: '789 High Street, Birmingham', sitePostcode: 'B1 1AA',
            billingAddress: 'City Retail HQ, 321 Corporate Drive', billingPostcode: 'B2 2BB',
            healthSafetyCompliant: true, chasAccredited: false, insuranceExpiry: '2025-09-30',
            preferredContactMethod: 'Email'
          }
        ];

        const initialSuppliers = [
          {
            id: 'SUPP-001', companyName: 'Metropolitan Waste Solutions', tradingName: 'Metro Waste',
            companyNumber: '99887766', vatNumber: 'GB998877665', primaryContact: 'Dave Wilson',
            contactPosition: 'Operations Director', phone: '+44 20 8555 0123', mobile: '+44 7700 900321',
            email: 'dave.wilson@metro-waste.co.uk', accountsEmail: 'billing@metro-waste.co.uk',
            supplierRating: 'A', preferredSupplier: true, primaryServices: ['Skip Hire', 'Waste Collection', 'Recycling'],
            wasteCarrierLicense: 'CBDU123456', wasteCarrierExpiry: '2026-03-31', 
            environmentalPermits: 'EPR/AB1234CD/V001', publicLiabilityInsurance: 'PLI-2024-MW-001',
            insuranceExpiry: '2025-08-31', insuranceAmount: '10000000', serviceAreas: ['London', 'South East'],
            fleetSize: '21-50', skipSizes: ['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', '12 yard', '12 yard enclosed'],
            certifications: ['ISO 14001', 'FORS Silver', 'CHAS'], accountStatus: 'Active',
            performanceScore: 95, bankName: 'HSBC', paymentTerms: 30
          },
          {
            id: 'SUPP-002', companyName: 'Northern Aggregates Ltd', tradingName: 'Northern Agg',
            companyNumber: '55443322', vatNumber: 'GB554433221', primaryContact: 'Michael Davies',
            contactPosition: 'Sales Manager', phone: '+44 161 555 0187', mobile: '+44 7700 900654',
            email: 'michael.davies@northern-agg.co.uk', accountsEmail: 'accounts@northern-agg.co.uk',
            supplierRating: 'B+', preferredSupplier: false, primaryServices: ['Aggregates Supply'],
            wasteCarrierLicense: 'CBDU654321', wasteCarrierExpiry: '2025-12-31',
            publicLiabilityInsurance: 'PLI-2024-NA-001', insuranceExpiry: '2025-07-31',
            insuranceAmount: '5000000', serviceAreas: ['North West', 'Midlands'],
            fleetSize: '11-20', aggregateTypes: ['Type 1 Sub Base', 'Type 2 Sub Base', 'Ballast', 'Sharp Sand'],
            certifications: ['ISO 9001', 'FORS Bronze'], accountStatus: 'Active',
            performanceScore: 88, bankName: 'Barclays', paymentTerms: 45
          },
          {
            id: 'SUPP-003', companyName: 'Quick Waste Ltd', tradingName: 'Quick Waste',
            companyNumber: '77665544', vatNumber: 'GB776655443', primaryContact: 'Sarah Brown',
            contactPosition: 'Account Manager', phone: '+44 207 555 0188', mobile: '+44 7700 900987',
            email: 'sarah.brown@quickwaste.co.uk', accountsEmail: 'finance@quickwaste.co.uk',
            supplierRating: 'A-', preferredSupplier: true, primaryServices: ['Waste Collection', 'Recycling', 'Skip Hire'],
            wasteCarrierLicense: 'CBDU789012', wasteCarrierExpiry: '2026-06-30',
            environmentalPermits: 'EPR/CD5678EF/V002', publicLiabilityInsurance: 'PLI-2024-QW-001',
            insuranceExpiry: '2025-09-30', insuranceAmount: '10000000', serviceAreas: ['London', 'South East', 'South West'],
            fleetSize: '50+', skipSizes: ['6 yard', '8 yard', '10 yard', '12 yard', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'],
            certifications: ['ISO 14001', 'ISO 45001', 'FORS Gold', 'CHAS', 'SafeContractor'],
            accountStatus: 'Active', performanceScore: 92, bankName: 'Lloyds', paymentTerms: 30
          },
          {
            id: 'SUPP-004', companyName: 'Fast Haulage Ltd', tradingName: 'Fast Haulage',
            companyNumber: '88776655', vatNumber: 'GB887766554', primaryContact: 'Tom Richards',
            contactPosition: 'Transport Manager', phone: '+44 161 555 0199', mobile: '+44 7700 900111',
            email: 'tom.richards@fasthaulage.co.uk', accountsEmail: 'accounts@fasthaulage.co.uk',
            supplierRating: 'A', preferredSupplier: true, primaryServices: ['Haulage', 'Transport'],
            wasteCarrierLicense: 'CBDU888999', wasteCarrierExpiry: '2026-01-31',
            publicLiabilityInsurance: 'PLI-2024-FH-001', insuranceExpiry: '2025-11-30',
            insuranceAmount: '5000000', serviceAreas: ['North West', 'Midlands', 'North East'],
            fleetSize: '21-50', certifications: ['ISO 9001', 'FORS Silver'], 
            accountStatus: 'Active', performanceScore: 90, bankName: 'NatWest', paymentTerms: 30
          }
        ];

        // Global state for waste types and aggregate types
        const defaultWasteTypes = {
          'Skip Hire': ['Mixed Construction Waste', 'Inert/Soil', 'Wood', 'Metal', 'Plasterboard', 'Green Waste', 'Mixed Heavy', 'Light Mixed'],
          'Aggregates': ['Type 1 Sub Base', 'Type 2 Sub Base', 'Ballast', 'Sharp Sand', 'Building Sand', 'Topsoil', 'Shingle'],
          'Waste Collection': ['General Waste', 'Dry Mixed Recycling', 'Cardboard', 'Wood', 'Metal', 'WEEE', 'Hazardous'],
          'Roll-on Roll-off': ['Mixed Construction Waste', 'Inert/Soil', 'Wood', 'Metal', 'Mixed Heavy'],
          'Grab Hire': ['Mixed Construction Waste', 'Inert/Soil', 'Hardcore', 'Green Waste'],
          'Muck Away': ['Clean Soil', 'Mixed Soil', 'Clay', 'Contaminated Soil']
        };

        // Authentication Context
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
          const [user, setUser] = useState(null);
          const [isLoading, setIsLoading] = useState(false);

          const login = async (email, password) => {
  setIsLoading(true);
  try {
    const { data, error } = await window.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .eq('password', password)
      .single();
    
    if (error || !data) {
      throw new Error('Invalid credentials');
    }
    
    // Split the name into first and last for compatibility
    const nameParts = data.name.split(' ');
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';
    
    setUser({
      id: data.id,
      email: data.email,
      firstName: firstName,
      lastName: lastName,
      role: data.role
    });
    return true;
  } catch (err) {
    throw new Error('Invalid credentials');
  }
};

          const logout = () => {
            setUser(null);
          };

          const hasPermission = (permission) => {
            if (!user) return false;
            const permissions = {
              ADMIN: ['jobs:create', 'jobs:read', 'jobs:update', 'jobs:delete', 'customers:create', 'customers:read', 'customers:update', 'customers:delete', 'suppliers:create', 'suppliers:read', 'suppliers:update', 'suppliers:delete', 'admin:access', 'quotes:create', 'quotes:read', 'quotes:update', 'quotes:delete'],
              MANAGER: ['jobs:create', 'jobs:read', 'jobs:update', 'jobs:delete', 'customers:create', 'customers:read', 'customers:update', 'customers:delete', 'suppliers:create', 'suppliers:read', 'suppliers:update', 'suppliers:delete', 'quotes:create', 'quotes:read', 'quotes:update'],
              BROKER: ['jobs:create', 'jobs:read', 'jobs:update', 'customers:read', 'suppliers:read', 'quotes:create', 'quotes:read']
            };
            return permissions[user.role]?.includes(permission) || false;
          };

          return (
            <AuthContext.Provider value={{ user, login, logout, isLoading, hasPermission }}>
              {children}
            </AuthContext.Provider>
          );
        };

        const useAuth = () => {
          const context = useContext(AuthContext);
          if (!context) throw new Error('useAuth must be used within AuthProvider');
          return context;
        };

        // Global state context for waste types management
        const WasteTypesContext = createContext();

        const WasteTypesProvider = ({ children }) => {
          const [wasteTypes, setWasteTypes] = useState(defaultWasteTypes);

          const updateWasteTypes = (jobType, types) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: types
            }));
          };

          const addWasteType = (jobType, newType) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: [...(prev[jobType] || []), newType]
            }));
          };

          const deleteWasteType = (jobType, typeToDelete) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: prev[jobType].filter(type => type !== typeToDelete)
            }));
          };

          return (
            <WasteTypesContext.Provider value={{ wasteTypes, updateWasteTypes, addWasteType, deleteWasteType }}>
              {children}
            </WasteTypesContext.Provider>
          );
        };

        const useWasteTypes = () => {
          const context = useContext(WasteTypesContext);
          if (!context) throw new Error('useWasteTypes must be used within WasteTypesProvider');
          return context;
        };

        // Login Component
        const LoginScreen = () => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');
          const { login, isLoading } = useAuth();

          const handleLogin = async () => {
            try {
              setError('');
              await login(email, password);
            } catch (err) {
              setError(err.message);
            }
          };

          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
              <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 mx-auto mb-4">
  {localStorage.getItem('companyLogo') ? (
    <img 
      src={localStorage.getItem('companyLogo')} 
      alt="Company Logo" 
      className="w-full h-full object-contain"
    />
  ) : (
    <div className="w-full h-full bg-blue-600 rounded-lg flex items-center justify-center">
      <Recycle className="w-8 h-8 text-white" />
    </div>
  )}
</div>
                  <h1 className="text-2xl font-bold text-gray-900">
  {localStorage.getItem('companyName') || 'Total Waste Services'}
</h1>
                  <p className="text-gray-600">System Login</p>
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                    {error}
                  </div>
                )}

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder=""
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder=""
                    />
                  </div>

                  <button
                    onClick={handleLogin}
                    disabled={isLoading}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center"
                  >
                    {isLoading ? <Loader className="animate-spin mr-2" size={20} /> : null}
                    Sign In
                  </button>
                </div>

                
              </div>
            </div>
          );
        };

        // Job Form Component
        const JobForm = ({ job, onClose, onSave, customers, suppliers, sageProducts }) => {
          const { wasteTypes } = useWasteTypes();
          const [formData, setFormData] = useState(job || {
            customerName: '',
            customerPO: '',
            supplierName: '',
            supplierRef: '',
            haulierName: '',
            jobType: 'Skip Hire',
            wasteType: '',
            skipSize: '',
            aggregateType: '',
            quantity: 1,
            unit: 'skip',
            weight: '',
            customerUnitPrice: 0,
            customerFinalPrice: 0,
            supplierUnitPrice: 0,
            supplierFinalPrice: 0,
            vatRate: 20,
            jobDate: new Date().toISOString().split('T')[0],
            timeSlot: '',
            collectionDate: '',
            status: 'CONFIRMED',
            priority: 'Medium',
            siteAddress: '',
            sitePostcode: '',
            siteContact: '',
            sitePhone: '',
            deliveryInstructions: '',
            accessRestrictions: '',
            wasteTransferNote: '',
            hazardousWaste: false,
            consignmentNote: '',
            invoiceNumber: '',
            invoiceStatus: 'Not Invoiced',
            paymentStatus: 'Not Paid',
            notes: '',
            isCompleted: false,
            isCancelled: false,
            sageProductId: '',
            sageProductName: ''
          });

          const [activeTab, setActiveTab] = useState('details');

          // Auto-set unit to tonnes for Aggregates
          useEffect(() => {
            if (formData.jobType === 'Aggregates' && formData.unit !== 'tonnes') {
              setFormData({...formData, unit: 'tonnes'});
            }
          }, [formData.jobType]);

          const calculatePrices = () => {
            const customerTotal = formData.customerUnitPrice * formData.quantity;
            const supplierTotal = formData.supplierUnitPrice * formData.quantity;
            setFormData({
              ...formData,
              customerFinalPrice: customerTotal,
              supplierFinalPrice: supplierTotal
            });
          };

          useEffect(() => {
            calculatePrices();
          }, [formData.customerUnitPrice, formData.supplierUnitPrice, formData.quantity]);

          const generateJobNumber = () => {
            const year = new Date().getFullYear();
            const lastJobNumber = parseInt(localStorage.getItem('lastJobNumber') || '0');
            const newJobNumber = lastJobNumber + 1;
            localStorage.setItem('lastJobNumber', newJobNumber.toString());
            return `TWS-${year}-${String(newJobNumber).padStart(4, '0')}`;
          };

          const handleSubmit = () => {
            // Check if this is a skip/RoRo with quantity > 1
            if ((formData.jobType === 'Skip Hire' || formData.jobType === 'Roll-on Roll-off') && formData.quantity > 1) {
            const jobs = [];
            const firstJobNumber = generateJobNumber();
            for (let i = 0; i < formData.quantity; i++) {
                const jobId = i === 0 ? firstJobNumber : `${firstJobNumber}-${i+1}`;
                const newJob = {
                  ...formData,
                  id: jobId,
                  jobNumber: jobId,
                  quantity: 1,
                  customerFinalPrice: formData.customerUnitPrice,
                  supplierFinalPrice: formData.supplierUnitPrice,
                  grossProfit: formData.customerUnitPrice - formData.supplierUnitPrice,
                  profitMargin: formData.customerUnitPrice > 0 ? 
                    ((formData.customerUnitPrice - formData.supplierUnitPrice) / formData.customerUnitPrice) * 100 : 0,
                  jobValue: formData.customerUnitPrice,
                  parentJobId: i === 0 ? null : jobs[0].id,
                  linkedJobs: []
                };
                jobs.push(newJob);
              }
              // Link jobs together
              jobs[0].linkedJobs = jobs.slice(1).map(j => j.id);
              jobs.forEach(job => onSave(job));
            } else {
              const newJobNumber = job?.id || generateJobNumber();
              const newJob = {
                ...formData,               
                id: newJobNumber,
                jobNumber: job?.jobNumber || newJobNumber,
                grossProfit: formData.customerFinalPrice - formData.supplierFinalPrice,
                profitMargin: formData.customerFinalPrice > 0 ? 
                  ((formData.customerFinalPrice - formData.supplierFinalPrice) / formData.customerFinalPrice) * 100 : 0,
                jobValue: formData.customerFinalPrice,
                parentJobId: null,
                linkedJobs: []
              };
              onSave(newJob);
            }
          };

          const skipSizes = ['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', 
                             '12 yard', '12 yard enclosed', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'];
          const roroSizes = ['20 yard', '40 yard'];
          const timeSlots = ['AM (8:00-12:00)', 'PM (12:00-17:00)'];

          // Filter suppliers who provide haulage services
          const hauliers = suppliers.filter(s => 
            s.primaryServices?.includes('Haulage') || 
            s.primaryServices?.includes('Transport')
          );

          return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{job ? 'Edit Job' : 'Add New Job'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('details')}
                    className={`px-6 py-3 font-medium ${activeTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Job Details
                  </button>
                  <button
                    onClick={() => setActiveTab('site')}
                    className={`px-6 py-3 font-medium ${activeTab === 'site' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Site Information
                  </button>
                  <button
                    onClick={() => setActiveTab('financial')}
                    className={`px-6 py-3 font-medium ${activeTab === 'financial' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Pricing & Status
                  </button>
                </div>

                <div className="p-6">
                  {/* Job Details Tab */}
                  {activeTab === 'details' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
  <SearchableDropdown
    options={customers.map(c => ({
      ...c,
      name: c.companyName || c.name
    }))}
    value={formData.customerName}
    onChange={(value) => setFormData({...formData, customerName: value})}
    placeholder={`Select Customer (${customers.length} available)`}
    displayField="name"
    valueField="name"
  />
</div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Customer PO Number</label>
                          <input
                            type="text"
                            value={formData.customerPO}
                            onChange={(e) => setFormData({...formData, customerPO: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Customer purchase order"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Supplier *</label>
  <SearchableDropdown
    options={suppliers.map(s => ({
      ...s,
      name: s.name || s.companyName
    }))}
    value={formData.supplierName}
    onChange={(value) => setFormData({...formData, supplierName: value})}
    placeholder={`Select Supplier (${suppliers.length} available)`}
    displayField="name"
    valueField="name"
  />
</div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Reference</label>
                          <input
                            type="text"
                            value={formData.supplierRef}
                            onChange={(e) => setFormData({...formData, supplierRef: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Supplier job reference"
                          />
                        </div>
                      </div>

                      {formData.jobType === 'Aggregates' && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Haulier</label>
                            <select
                              value={formData.haulierName}
                              onChange={(e) => setFormData({...formData, haulierName: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            >
                              <option value="">Select Haulier</option>
                              {hauliers.map(haulier => (
                                <option key={haulier.id} value={haulier.companyName}>{haulier.companyName}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                      )}

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Job Type *</label>
                          <select
                            value={formData.jobType}
                            onChange={(e) => setFormData({...formData, jobType: e.target.value, wasteType: '', skipSize: '', aggregateType: ''})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Skip Hire">Skip Hire</option>
                            <option value="Aggregates">Aggregates</option>
                            <option value="Waste Collection">Waste Collection</option>
                            <option value="Grab Hire">Grab Hire</option>
                            <option value="Muck Away">Muck Away</option>
                            <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                          <select
                            value={formData.priority}
                            onChange={(e) => setFormData({...formData, priority: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                          </select>
                        </div>
                      </div>

                    {formData.jobType === 'Skip Hire' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Skip Hire"
        selectedProduct={formData.sageProductName}
        onSelect={(product) => setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id})}
        products={sageProducts}
      />
    </div>
  </div>
)}
{formData.jobType === 'Roll-on Roll-off' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Roll-on Roll-off"
        selectedProduct={formData.sageProductName}
        onSelect={(product) => setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id})}
        products={sageProducts}
      />
    </div>
  </div>
)}

                  {formData.jobType === 'Aggregates' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Aggregates"
        selectedProduct={formData.sageProductName}
        onSelect={(product) => setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id})}
        products={sageProducts}
      />
    </div>
  </div>
)}

                     {(formData.jobType === 'Grab Hire' || formData.jobType === 'Muck Away' || formData.jobType === 'Waste Collection') && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType={formData.jobType}
        selectedProduct={formData.sageProductName}
        onSelect={(product) => setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id})}
        products={sageProducts}
      />
    </div>
  </div>
)}
                      
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Quantity * 
                            {(formData.jobType === 'Skip Hire' || formData.jobType === 'Roll-on Roll-off') && 
                             <span className="text-xs text-gray-500 ml-1">(creates multiple jobs if &gt; 1)</span>
                            }
                          </label>
                          <input
                            type="number"
                            value={formData.quantity}
                            onChange={(e) => setFormData({...formData, quantity: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                          <select
                            value={formData.unit}
                            onChange={(e) => setFormData({...formData, unit: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            disabled={formData.jobType === 'Aggregates'}
                          >
                            <option value="skip">Skip</option>
                            <option value="tonnes">Tonnes</option>
                            <option value="loads">Loads</option>
                            <option value="collections">Collections</option>
                            <option value="days">Days</option>
                          </select>
                        </div>
                        {formData.jobType !== 'Aggregates' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Weight (tonnes)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={formData.weight}
                              onChange={(e) => setFormData({...formData, weight: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="If known"
                            />
                          </div>
                        )}
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Date *</label>
                          <input
                            type="date"
                            value={formData.jobDate}
                            onChange={(e) => setFormData({...formData, jobDate: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                        {formData.jobType === 'Aggregates' ? (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Time Slot</label>
                            <select
                              value={formData.timeSlot}
                              onChange={(e) => setFormData({...formData, timeSlot: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            >
                              <option value="">Select time slot</option>
                              {timeSlots.map(slot => (
                                <option key={slot} value={slot}>{slot}</option>
                              ))}
                            </select>
                          </div>
                        ) : (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Collection Date</label>
                            <input
                              type="date"
                              value={formData.collectionDate}
                              onChange={(e) => setFormData({...formData, collectionDate: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        )}
                      </div>

                      <div>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.hazardousWaste}
                            onChange={(e) => setFormData({...formData, hazardousWaste: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Contains Hazardous Waste</span>
                        </label>
                      </div>

                      {formData.hazardousWaste && (
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Consignment Note Number</label>
                          <input
                            type="text"
                            value={formData.consignmentNote}
                            onChange={(e) => setFormData({...formData, consignmentNote: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Hazardous waste consignment note"
                          />
                        </div>
                      )}
                    </div>
                  )}

                  {/* Site Information Tab */}
                  {activeTab === 'site' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Site Address *</label>
                        <input
                          type="text"
                          value={formData.siteAddress}
                          onChange={(e) => setFormData({...formData, siteAddress: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                          placeholder="Delivery/collection address"
                        />
                        <input
                          type="text"
                          value={formData.sitePostcode}
                          onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Postcode"
                        />
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Name</label>
                          <input
                            type="text"
                            value={formData.siteContact}
                            onChange={(e) => setFormData({...formData, siteContact: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="On-site contact person"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Phone</label>
                          <input
                            type="tel"
                            value={formData.sitePhone}
                            onChange={(e) => setFormData({...formData, sitePhone: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Mobile number"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Instructions</label>
                        <textarea
                          value={formData.deliveryInstructions}
                          onChange={(e) => setFormData({...formData, deliveryInstructions: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Specific placement instructions, site entry procedure, etc."
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Access Restrictions</label>
                        <textarea
                          value={formData.accessRestrictions}
                          onChange={(e) => setFormData({...formData, accessRestrictions: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={2}
                          placeholder="Height/width restrictions, weight limits, time restrictions, etc."
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea
                          value={formData.notes}
                          onChange={(e) => setFormData({...formData, notes: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Any other relevant information..."
                        />
                      </div>
                    </div>
                  )}

                  {/* Financial & Status Tab */}
                  {activeTab === 'financial' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Customer Unit Price (£) *</label>
                          <input
                            type="number"
                            step="0.01"
                            value={formData.customerUnitPrice}
                            onChange={(e) => setFormData({...formData, customerUnitPrice: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Unit Cost (£) *</label>
                          <input
                            type="number"
                            step="0.01"
                            value={formData.supplierUnitPrice}
                            onChange={(e) => setFormData({...formData, supplierUnitPrice: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Rate (%)</label>
                          <select
                            value={formData.vatRate}
                            onChange={(e) => setFormData({...formData, vatRate: parseFloat(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>0% (Zero Rated)</option>
                            <option value={5}>5% (Reduced)</option>
                            <option value={20}>20% (Standard)</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                          <input
                            type="text"
                            value={formData.invoiceNumber}
                            onChange={(e) => setFormData({...formData, invoiceNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="INV-001234"
                          />
                        </div>
                        {/* Sage Product/Service Selection */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Status</label>
                          <select
                            value={formData.invoiceStatus}
                            onChange={(e) => setFormData({...formData, invoiceStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Not Invoiced">Not Invoiced</option>
                            <option value="Invoiced">Invoiced</option>
                            <option value="Part Invoiced">Part Invoiced</option>
                          </select>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                          <select
                            value={formData.paymentStatus}
                            onChange={(e) => setFormData({...formData, paymentStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Not Paid">Not Paid</option>
                            <option value="Part Paid">Part Paid</option>
                            <option value="Paid">Paid</option>
                            <option value="Overdue">Overdue</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Job Status</label>
                          <select
                            value={formData.status}
                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="IN_PROGRESS">In Progress</option>
                          </select>
                        </div>
                      </div>

                      <div className="flex items-center space-x-6">
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.isCompleted}
                            onChange={(e) => setFormData({...formData, isCompleted: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Job Completed</span>
                        </label>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.isCancelled}
                            onChange={(e) => setFormData({...formData, isCancelled: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Job Cancelled</span>
                        </label>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Waste Transfer Note</label>
                        <input
                          type="text"
                          value={formData.wasteTransferNote}
                          onChange={(e) => setFormData({...formData, wasteTransferNote: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="WTN reference number"
                        />
                      </div>

                      {formData.customerUnitPrice > 0 && formData.supplierUnitPrice > 0 && (
                        <div className="bg-green-50 p-4 rounded-lg">
                          <h4 className="font-medium text-green-900 mb-3">Profit Calculation</h4>
                          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                            <div>
                              <span className="text-green-700">Customer Total:</span>
                              <p className="font-semibold">£{formData.customerFinalPrice.toFixed(2)}</p>
                              <p className="text-xs text-gray-600">+ VAT: £{(formData.customerFinalPrice * formData.vatRate / 100).toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-green-700">Supplier Cost:</span>
                              <p className="font-semibold">£{formData.supplierFinalPrice.toFixed(2)}</p>
                              <p className="text-xs text-gray-600">+ VAT: £{(formData.supplierFinalPrice * formData.vatRate / 100).toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-green-700">Gross Profit:</span>
                              <p className="font-semibold text-green-600">
                                £{(formData.customerFinalPrice - formData.supplierFinalPrice).toFixed(2)}
                              </p>
                            </div>
                            <div>
                              <span className="text-green-700">Margin:</span>
                              <p className="font-semibold text-green-600">
                                {formData.customerFinalPrice > 0 ? 
                                  (((formData.customerFinalPrice - formData.supplierFinalPrice) / formData.customerFinalPrice) * 100).toFixed(1) : 0}%
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {job ? 'Update Job' : 'Create Job'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Job Card Component
        const JobCard = ({ job, onClick }) => {
          const jobIcons = {
            'Skip Hire': { icon: 'Trash2', color: 'text-blue-600', bg: 'bg-blue-100' },
            'Aggregates': { icon: 'Mountain', color: 'text-orange-600', bg: 'bg-orange-100' },
            'Waste Collection': { icon: 'Recycle', color: 'text-green-600', bg: 'bg-green-100' },
            'Grab Hire': { icon: 'Truck', color: 'text-purple-600', bg: 'bg-purple-100' },
            'Muck Away': { icon: 'Truck', color: 'text-red-600', bg: 'bg-red-100' },
            'Roll-on Roll-off': { icon: 'Truck', color: 'text-indigo-600', bg: 'bg-indigo-100' }
          };

          const statusConfig = {
            'QUOTED': { color: 'bg-yellow-100 text-yellow-800', progress: 25 },
            'CONFIRMED': { color: 'bg-green-100 text-green-800', progress: 50 },
            'IN_PROGRESS': { color: 'bg-blue-100 text-blue-800', progress: 75 },
            'COLLECTED': { color: 'bg-purple-100 text-purple-800', progress: 100 }
          };

          if (job.isCompleted) {
            statusConfig['COMPLETED'] = { color: 'bg-emerald-100 text-emerald-800', progress: 100 };
          }
          if (job.isCancelled) {
            statusConfig['CANCELLED'] = { color: 'bg-red-100 text-red-800', progress: 0 };
          }

          const jobIcon = jobIcons[job.jobType] || jobIcons['Skip Hire'];
          const status = job.status === 'COLLECTED' ? statusConfig['COLLECTED'] :
                         job.isCompleted ? statusConfig['COMPLETED'] : 
                         job.isCancelled ? statusConfig['CANCELLED'] : 
                         statusConfig[job.status] || statusConfig['QUOTED'];
          const IconComponent = jobIcon.icon === 'Trash2' ? Trash2 : jobIcon.icon === 'Mountain' ? Mountain : 
                               jobIcon.icon === 'Recycle' ? Recycle : Truck;

          const isFinished = job.isCompleted || job.status === 'COLLECTED';

          return (
            <div 
              className={`bg-white rounded-lg border border-gray-200 p-4 cursor-pointer hover:shadow-lg transition-all ${
                isFinished ? 'opacity-75' : ''
              }`}
              onClick={onClick}
            >
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center space-x-2">
                  <div className={`p-2 rounded-lg ${jobIcon.bg}`}>
                    <IconComponent size={16} className={jobIcon.color} />
                  </div>
                  <div>
                    <span className={`text-sm font-semibold ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                      {job.jobNumber}
                    </span>
                    <p className="text-xs text-gray-600">{job.jobType}</p>
                  </div>
                </div>
                <span className={`px-2 py-1 rounded-full text-xs font-medium ${status.color}`}>
                  {job.status === 'COLLECTED' ? 'COLLECTED' : 
                   job.isCompleted ? 'COMPLETED' : 
                   job.isCancelled ? 'CANCELLED' : 
                   job.status.replace('_', ' ')}
                </span>
              </div>

              <div className="mb-3">
                <div className="w-full bg-gray-200 rounded-full h-1.5">
                  <div 
                    className="h-1.5 rounded-full bg-blue-500 transition-all" 
                    style={{ width: `${status.progress}%` }}
                  />
                </div>
              </div>

              <div className="space-y-2 mb-3">
                <div className="flex items-center text-sm">
                  <User size={12} className="mr-2 text-blue-500" />
                  <span className={`text-gray-700 truncate ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                    {job.customerName}
                  </span>
                </div>
                <div className="flex items-center text-sm">
                  <Truck size={12} className="mr-2 text-green-500" />
                  <span className={`text-gray-700 truncate ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                    {job.supplierName}
                  </span>
                </div>
              </div>

              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-600">{new Date(job.jobDate).toLocaleDateString()}</span>
                <span className="font-medium text-green-600">£{job.grossProfit?.toFixed(0)}</span>
              </div>
              
              {job.parentJobId && (
                <div className="mt-2 text-xs text-gray-500">
                  Exchange from: {job.parentJobId}
                </div>
              )}
              
              {job.invoiceNumber && (
                <div className="mt-2 text-xs text-gray-500">
                  Invoice: {job.invoiceNumber}
                </div>
              )}
            </div>
          );
        };

        // Dashboard Component
        const Dashboard = ({ jobs, customers }) => {
          const totalRevenue = jobs.reduce((sum, job) => sum + (job.jobValue || 0), 0);
          const totalProfit = jobs.reduce((sum, job) => sum + (job.grossProfit || 0), 0);
          const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
          const activeJobs = jobs.filter(j => ['CONFIRMED', 'IN_PROGRESS'].includes(j.status)).length;

          const metrics = [
            { label: 'Active Jobs', value: activeJobs, icon: 'Activity', color: 'bg-blue-500' },
            { label: 'Monthly Revenue', value: `£${(totalRevenue/1000).toFixed(0)}k`, icon: 'DollarSign', color: 'bg-green-500' },
            { label: 'Profit Margin', value: `${avgMargin.toFixed(1)}%`, icon: 'TrendingUp', color: 'bg-purple-500' },
            { label: 'Customers', value: customers.length, icon: 'Users', color: 'bg-orange-500' }
          ];

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Dashboard</h2>
                <p className="text-gray-600">Overview of your waste management operations</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                {metrics.map((metric, index) => {
                  const Icon = metric.icon === 'Activity' ? Activity : 
                               metric.icon === 'DollarSign' ? DollarSign :
                               metric.icon === 'TrendingUp' ? TrendingUp : Users;
                  return (
                    <div className="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600">{metric.label}</p>
                          <p className="text-2xl font-bold text-gray-900">{metric.value}</p>
                        </div>
                        <div className={`p-3 rounded-lg ${metric.color}`}>
                          <Icon size={24} className="text-white" />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-lg border border-gray-200">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-lg font-semibold">Recent Jobs</h3>
                  </div>
                  <div className="p-6">
                    <div className="space-y-4">
                      {jobs.slice(0, 5).map(job => (
                        <div key={job.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium">{job.jobNumber}</p>
                            <p className="text-sm text-gray-600">{job.customerName}</p>
                          </div>
                          <div className="text-right">
                            <p className="font-medium text-green-600">£{job.grossProfit?.toFixed(0)}</p>
                            <p className="text-xs text-gray-500">{job.status}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg border border-gray-200">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-lg font-semibold">Top Customers</h3>
                  </div>
                  <div className="p-6">
                    <div className="space-y-4">
                      {customers.slice(0, 5).map(customer => (
                        <div key={customer.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium">{customer.companyName}</p>
                            <p className="text-sm text-gray-600">{customer.primaryContact}</p>
                          </div>
                          <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                            customer.creditRating === 'A+' ? 'bg-green-100 text-green-700' :
                            customer.creditRating === 'A' ? 'bg-blue-100 text-blue-700' :
                            'bg-yellow-100 text-yellow-700'
                          }`}>
                            {customer.creditRating}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // Jobs Management Component
          const JobsView = ({ jobs, onAddJob, onUpdateJob, onDeleteJob, onDuplicateJob, onEditJob, customers, suppliers, user }) => {
          const { hasPermission } = useAuth();
          const [selectedJob, setSelectedJob] = useState(null);
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [currentMonth, setCurrentMonth] = useState(new Date());
          const [searchQuery, setSearchQuery] = useState('');
          const [filters, setFilters] = useState({
            jobType: '',
            status: '',
            priority: ''
          });
          const [creatingInvoice, setCreatingInvoice] = useState(false);
          const [invoiceJobId, setInvoiceJobId] = useState(null);

  const handleCreateInvoice = async (job) => {
  setCreatingInvoice(true);
  setInvoiceJobId(job.id);
  
  try {
    // Check if we're in demo mode (no real Sage connection)
    const isDemoMode = !window.SageAPI || !localStorage.getItem('sage_connected');
    
    if (isDemoMode) {
      // Demo mode - just create a fake invoice number
      const invoiceNumber = `INV-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;
      
      // Update local state only (in production, this would update Supabase)
      onUpdateJob({
        ...job,
        invoiceNumber: invoiceNumber
      });
      
      alert(`Demo Mode: Invoice ${invoiceNumber} created successfully!`);
    } else {
      // Production mode - use real Sage API
      const { data: customer } = await window.supabase
        .from('customers')
        .select('*')
        .eq('companyName', job.customerName)
        .single();
      
      if (!customer?.sageId) {
        throw new Error('Customer not synced with Sage. Please sync customer first.');
      }
      
      const invoiceData = {
        contact_id: customer.sageId,
        date: new Date().toISOString().split('T')[0],
        due_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
        reference: job.jobNumber,
        notes: `Job: ${job.jobNumber}\nType: ${job.jobType}\nSite: ${job.siteAddress}`,
        line_items: [{
          description: `${job.jobType} - ${job.wasteType || job.aggregateType || ''}`,
          quantity: job.quantity,
          unit_price: job.customerUnitPrice,
          tax_rate_id: '1',
          ledger_account_id: '1'
        }]
      };
      
      const invoice = await window.SageAPI.createDraftInvoice(invoiceData);
      
      await window.supabase
        .from('jobs')
        .update({ 
          sageInvoiceId: invoice.id,
          invoiceNumber: invoice.invoice_number || invoice.id
        })
        .eq('id', job.id);
      
      onUpdateJob({
        ...job,
        sageInvoiceId: invoice.id,
        invoiceNumber: invoice.invoice_number || invoice.id
      });
      
      alert('Invoice created successfully in Sage!');
    }
  } catch (error) {
    console.error('Error creating invoice:', error);
    alert('Failed to create invoice: ' + error.message);
  } finally {
    setCreatingInvoice(false);
    setInvoiceJobId(null);
  }
};

          const jobColors = {
            'Skip Hire': '#3B82F6',
            'Aggregates': '#F97316',
            'Waste Collection': '#10B981',
            'Grab Hire': '#8B5CF6',
            'Muck Away': '#EF4444',
            'Roll-on Roll-off': '#6366F1'
          };

          // Sort jobs by date descending (newest first)
            const sortedJobs = [...jobs].sort((a, b) => {
             const aNum = parseInt(a.jobNumber.split('-').pop());
             const bNum = parseInt(b.jobNumber.split('-').pop());
             return bNum - aNum;
            });

          const filteredJobs = sortedJobs.filter(job => {
            if (searchQuery && 
                !job.jobNumber.toLowerCase().includes(searchQuery.toLowerCase()) &&
                !job.customerName.toLowerCase().includes(searchQuery.toLowerCase()) &&
                !job.supplierName.toLowerCase().includes(searchQuery.toLowerCase())) {
              return false;
            }
            if (filters.jobType && job.jobType !== filters.jobType) return false;
            if (filters.status) {
              if (filters.status === 'COMPLETED' && !job.isCompleted) return false;
              if (filters.status === 'CANCELLED' && !job.isCancelled) return false;
              if (filters.status === 'COLLECTED' && job.status !== 'COLLECTED') return false;
              if (filters.status !== 'COMPLETED' && filters.status !== 'CANCELLED' && filters.status !== 'COLLECTED' && 
                  (job.status !== filters.status || job.isCompleted || job.isCancelled)) return false;
            }
            if (filters.priority && job.priority !== filters.priority) return false;
            return true;
          });

          const handleJobClick = (job) => {
            setSelectedJob(job);
          };

          const handleEditJob = (job) => {
            onEditJob(job);
            setSelectedJob(null);
          };

          const handleDuplicateJob = (job) => {
            const duplicatedJob = { ...job, id: null, jobNumber: null };
            delete duplicatedJob.id;
            delete duplicatedJob.jobNumber;
            onDuplicateJob(duplicatedJob);
            setSelectedJob(null);
          };

          const handleDeleteJob = (job) => {
            if (confirm(`Are you sure you want to delete job ${job.jobNumber}?`)) {
              onDeleteJob(job.id);
              setSelectedJob(null);
            }
          };


          const handleExchange = (job) => {
            // Create new exchange job - duplicate all details
            const exchangeJob = {
              ...job,
              id: null,
              jobNumber: null,
              parentJobId: job.id,
              isCompleted: false,
              isCancelled: false,
              status: 'CONFIRMED',
              notes: `Exchange for job ${job.jobNumber}. ${job.notes || ''}`.trim(),
              jobDate: new Date().toISOString().split('T')[0], // Set to today
              linkedJobs: []
            };
            
            // Remove the old id and jobNumber completely
            delete exchangeJob.id;
            delete exchangeJob.jobNumber;
            
            // Mark original job as collected
            onUpdateJob({ ...job, status: 'COLLECTED', isCompleted: true });
            
            // Add the exchange job
            onAddJob(exchangeJob);
            setSelectedJob(null);
          };

          const handleCollection = (job) => {
            onUpdateJob({ ...job, status: 'COLLECTED', isCompleted: true });
            setSelectedJob(null);
          };

          // Calendar View Component
          const CalendarView = () => {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = [];

            // Get all days in the month
            for (let d = 1; d <= lastDay.getDate(); d++) {
              days.push(new Date(year, month, d));
            }

            // Group jobs by date
            const jobsByDate = {};
            filteredJobs.forEach(job => {
              const jobDate = new Date(job.jobDate);
              const dateKey = `${jobDate.getFullYear()}-${jobDate.getMonth()}-${jobDate.getDate()}`;
              if (!jobsByDate[dateKey]) jobsByDate[dateKey] = [];
              jobsByDate[dateKey].push(job);
            });

            const navigateMonth = (direction) => {
              const newMonth = new Date(currentMonth);
              newMonth.setMonth(newMonth.getMonth() + direction);
              setCurrentMonth(newMonth);
            };

            return (
              <div className="bg-white rounded-lg border border-gray-200 p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-lg font-semibold">Calendar View</h3>
                  <div className="flex items-center space-x-4">
                    <button
                      onClick={() => navigateMonth(-1)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronDown size={20} className="rotate-90" />
                    </button>
                    <span className="font-medium">
                      {currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}
                    </span>
                    <button
                      onClick={() => navigateMonth(1)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronDown size={20} className="-rotate-90" />
                    </button>
                  </div>
                </div>
                <div className="grid grid-cols-7 gap-2">
                  {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                    <div key={day} className="text-center font-medium text-gray-600 p-2">
                      {day}
                    </div>
                  ))}
                  {Array(firstDay.getDay()).fill(null).map((_, index) => (
                    <div key={`empty-${index}`} className="p-2"></div>
                  ))}
                  {days.map(day => {
                    const dateKey = `${day.getFullYear()}-${day.getMonth()}-${day.getDate()}`;
                    const dayJobs = jobsByDate[dateKey] || [];
                    const isToday = new Date().toDateString() === day.toDateString();
                    
                    return (
                      <div 
                        key={dateKey} 
                        className={`border border-gray-200 rounded-lg p-2 min-h-[100px] ${
                          isToday ? 'bg-blue-50 border-blue-300' : ''
                        }`}
                      >
                        <div className={`font-medium mb-1 ${isToday ? 'text-blue-700' : 'text-gray-700'}`}>
                          {day.getDate()}
                        </div>
                        <div className="space-y-1">
                          {dayJobs.slice(0, 3).map(job => {
                            const isFinished = job.isCompleted || job.status === 'COLLECTED';
                            return (
                              <div
                                key={job.id}
                                className={`text-xs p-1 rounded cursor-pointer truncate hover:opacity-80 ${
                                  isFinished ? 'opacity-60' : ''
                                }`}
                                style={{ 
                                  backgroundColor: jobColors[job.jobType] + '20', 
                                  color: jobColors[job.jobType],
                                  borderLeft: `3px solid ${jobColors[job.jobType]}`,
                                  textDecoration: isFinished ? 'line-through' : 'none',
                                  textDecorationColor: isFinished ? '#ef4444' : 'transparent'
                                }}
                                onClick={() => handleJobClick(job)}
                                title={`${job.jobNumber} - ${job.customerName}${isFinished ? ' (Completed)' : ''}`}
                              >
                                {job.jobNumber}
                              </div>
                            );
                          })}
                          {dayJobs.length > 3 && (
                            <div className="text-xs text-gray-500 text-center">
                              +{dayJobs.length - 3} more
                            </div>
                          )}
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-4 flex flex-wrap gap-4">
                  <div className="text-sm text-gray-600">Job Types:</div>
                  {Object.entries(jobColors).map(([type, color]) => (
                    <div key={type} className="flex items-center space-x-2 text-sm">
                      <div 
                        className="w-4 h-4 rounded" 
                        style={{ backgroundColor: color }}
                      />
                      <span>{type}</span>
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Job Management</h2>
                  <p className="text-gray-600">{filteredJobs.length} jobs found</p>
                </div>
                <button 
  onClick={onAddJob}
  className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
>
  <Plus size={16} className="mr-1 sm:mr-2" />
  <span className="hidden sm:inline">Add Job</span>
  <span className="sm:hidden">Add</span>
</button>
              </div>

              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
  <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3">
      <Filter size={16} className="text-gray-600 hidden sm:block" />
      <input
        type="text"
        placeholder="Search jobs..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      />
      <select
        value={filters.jobType}
        onChange={(e) => setFilters({...filters, jobType: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Job Types</option>
        <option value="Skip Hire">Skip Hire</option>
        <option value="Aggregates">Aggregates</option>
        <option value="Waste Collection">Waste Collection</option>
        <option value="Grab Hire">Grab Hire</option>
        <option value="Muck Away">Muck Away</option>
        <option value="Roll-on Roll-off">Roll-on Roll-off</option>
      </select>
      <select
        value={filters.status}
        onChange={(e) => setFilters({...filters, status: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Statuses</option>
        <option value="CONFIRMED">Confirmed</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COLLECTED">Collected</option>
        <option value="COMPLETED">Completed</option>
        <option value="CANCELLED">Cancelled</option>
      </select>
      <select
        value={filters.priority}
        onChange={(e) => setFilters({...filters, priority: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Priorities</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>
      </select>
      <button
        onClick={() => {
          setSearchQuery('');
          setFilters({ jobType: '', status: '', priority: '' });
        }}
        className="w-full sm:w-auto px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
      >
        Clear
      </button>
    </div>
    
    <div className="flex items-center justify-end gap-2">
      <button
        onClick={() => setViewMode('grid')}
        className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Grid size={16} />
      </button>
      <button
        onClick={() => setViewMode('list')}
        className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Layout size={16} />
      </button>
      <button
        onClick={() => setViewMode('calendar')}
        className={`p-2 rounded ${viewMode === 'calendar' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Calendar size={16} />
      </button>
    </div>
  </div>
</div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'calendar' ? (
                    <CalendarView />
                  ) : viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                      {filteredJobs.map(job => (
                        <JobCard
                          key={job.id}
                          job={job}
                          onClick={() => handleJobClick(job)}
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Number</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {filteredJobs.map(job => {
                            const statusConfig = {
                              'QUOTED': 'bg-yellow-100 text-yellow-800',
                              'CONFIRMED': 'bg-green-100 text-green-800',
                              'IN_PROGRESS': 'bg-blue-100 text-blue-800',
                              'COLLECTED': 'bg-purple-100 text-purple-800'
                            };
                            
                            const status = job.status === 'COLLECTED' ? 'bg-purple-100 text-purple-800' :
                                         job.isCompleted ? 'bg-emerald-100 text-emerald-800' : 
                                         job.isCancelled ? 'bg-red-100 text-red-800' : 
                                         statusConfig[job.status];
                            
                            const isFinished = job.isCompleted || job.status === 'COLLECTED';
                            
                            return (
                              <tr 
                                key={job.id} 
                                className={`hover:bg-gray-50 cursor-pointer ${isFinished ? 'opacity-75' : ''}`}
                                onClick={() => handleJobClick(job)}
                              >
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div className="flex items-center">
                                    <div 
                                      className="w-2 h-8 rounded mr-3"
                                      style={{ backgroundColor: jobColors[job.jobType] }}
                                    />
                                    <div className={`text-sm font-medium text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                      {job.jobNumber}
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div>
                                    <div className={`text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                      {job.customerName}
                                    </div>
                                    <div className={`text-sm text-gray-500 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                      {job.supplierName}
                                    </div>
                                  </div>
                                </td>
                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                  {job.jobType}
                                </td>
                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                  {new Date(job.jobDate).toLocaleDateString('en-GB')}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${status}`}>
                                    {job.status === 'COLLECTED' ? 'Collected' :
                                     job.isCompleted ? 'Completed' : 
                                     job.isCancelled ? 'Cancelled' : 
                                     job.status.replace('_', ' ')}
                                  </span>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                  {job.invoiceNumber || '-'}
                                </td>
                                <td className={`px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                  £{job.jobValue?.toFixed(2)}
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
                                  <div>
                                    <div className={`text-sm font-medium text-green-600 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                                      £{job.grossProfit?.toFixed(2)}
                                    </div>
                                    <div className="text-xs text-gray-500">{job.profitMargin?.toFixed(1)}%</div>
                                  </div>
                                </td>
                                <td className="px-6 py-4 whitespace-nowrap">
  {(job.isCompleted || job.status === 'COLLECTED') && 
   !job.invoiceNumber && user?.role === 'ADMIN' && (
    <button
      onClick={(e) => {
        e.stopPropagation();
        handleCreateInvoice(job);
      }}
      disabled={creatingInvoice && invoiceJobId === job.id}
      className="text-green-600 hover:text-green-900 disabled:opacity-50"
      title="Create Invoice"
    >
      {creatingInvoice && invoiceJobId === job.id ? (
        <Loader size={16} className="animate-spin" />
      ) : (
        <FileText size={16} />
      )}
    </button>
  )}
</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  {filteredJobs.length === 0 && (
                    <div className="text-center py-8">
                      <Grid className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No jobs found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedJob && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedJob.jobNumber}</h2>
                        <p className="text-gray-600">{selectedJob.jobType}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => handleEditJob(selectedJob)}
                          className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                          title="Edit Job"
                        >
                          <Edit3 size={20} />
                        </button>
                        <button
                          onClick={() => handleDuplicateJob(selectedJob)}
                          className="p-2 text-green-600 hover:bg-green-100 rounded-lg"
                          title="Duplicate Job"
                        >
                          <Copy size={20} />
                        </button>
                        {(selectedJob.jobType === 'Skip Hire' || selectedJob.jobType === 'Roll-on Roll-off') && 
                         !selectedJob.isCompleted && selectedJob.status !== 'COLLECTED' && (
                          <>
                            <button
                              onClick={() => handleExchange(selectedJob)}
                              className="p-2 text-orange-600 hover:bg-orange-100 rounded-lg"
                              title="Exchange"
                            >
                              <Repeat size={20} />
                            </button>
                            <button
                              onClick={() => handleCollection(selectedJob)}
                              className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                              title="Collect"
                            >
                              <Package size={20} />
                            </button>
                          </>
                        )}
                        {/* Add Invoice Button - only for completed jobs without invoice */}
{(selectedJob.isCompleted || selectedJob.status === 'COLLECTED') && 
 !selectedJob.invoiceNumber && user?.role === 'ADMIN' && (
  <button
    onClick={() => handleCreateInvoice(selectedJob)}
    disabled={creatingInvoice && invoiceJobId === selectedJob.id}
    className="p-2 text-green-600 hover:bg-green-100 rounded-lg disabled:opacity-50"
    title="Create Invoice in Sage"
  >
    {creatingInvoice && invoiceJobId === selectedJob.id ? (
      <Loader size={20} className="animate-spin" />
    ) : (
      <FileText size={20} />
    )}
  </button>
)}
                        {hasPermission('jobs:delete') && (
                          <button
                            onClick={() => handleDeleteJob(selectedJob)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Job"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedJob(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                          <h3 className="font-semibold mb-4">Job Details</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Customer:</span>
                              <span className="font-medium">{selectedJob.customerName}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Supplier:</span>
                              <span className="font-medium">{selectedJob.supplierName}</span>
                            </div>
                            {selectedJob.haulierName && (
                              <div className="flex justify-between">
                                <span className="text-gray-600">Haulier:</span>
                                <span className="font-medium">{selectedJob.haulierName}</span>
                              </div>
                            )}
                            <div className="flex justify-between">
                              <span className="text-gray-600">Date:</span>
                              <span className="font-medium">{new Date(selectedJob.jobDate).toLocaleDateString()}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Quantity:</span>
                              <span className="font-medium">{selectedJob.quantity} {selectedJob.unit}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Priority:</span>
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                selectedJob.priority === 'High' || selectedJob.priority === 'Urgent' ? 'bg-red-100 text-red-700' :
                                selectedJob.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-green-100 text-green-700'
                              }`}>
                                {selectedJob.priority}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Status:</span>
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                selectedJob.status === 'COLLECTED' ? 'bg-purple-100 text-purple-700' :
                                selectedJob.isCompleted ? 'bg-emerald-100 text-emerald-700' :
                                selectedJob.isCancelled ? 'bg-red-100 text-red-700' :
                                'bg-blue-100 text-blue-700'
                              }`}>
                                {selectedJob.status === 'COLLECTED' ? 'Collected' :
                                 selectedJob.isCompleted ? 'Completed' : 
                                 selectedJob.isCancelled ? 'Cancelled' : 
                                 selectedJob.status}
                              </span>
                            </div>
                            {selectedJob.invoiceNumber && (
                              <div className="flex justify-between">
                                <span className="text-gray-600">Invoice:</span>
                                <span className="font-medium">{selectedJob.invoiceNumber}</span>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        <div>
                          <h3 className="font-semibold mb-4">Financial Summary</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Customer Price:</span>
                              <span className="font-medium text-blue-600">£{selectedJob.customerFinalPrice?.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Supplier Cost:</span>
                              <span className="font-medium text-red-600">£{selectedJob.supplierFinalPrice?.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Gross Profit:</span>
                              <span className="font-medium text-green-600">£{selectedJob.grossProfit?.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Margin:</span>
                              <span className="font-medium text-purple-600">{selectedJob.profitMargin?.toFixed(1)}%</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Total Value:</span>
                              <span className="font-medium text-blue-600">£{selectedJob.jobValue?.toFixed(2)}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      {selectedJob.siteAddress && (
                        <div className="mt-6">
                          <h3 className="font-semibold mb-2">Site Information</h3>
                          <p className="text-gray-700">{selectedJob.siteAddress}</p>
                          {selectedJob.sitePostcode && <p className="text-gray-600">{selectedJob.sitePostcode}</p>}
                          {selectedJob.siteContact && (
                            <p className="text-gray-600 mt-2">Contact: {selectedJob.siteContact} - {selectedJob.sitePhone}</p>
                          )}
                        </div>
                      )}

                      {selectedJob.parentJobId && (
                        <div className="mt-6 p-4 bg-orange-50 rounded-lg">
                          <h3 className="font-semibold mb-2 text-orange-900">Exchange Information</h3>
                          <p className="text-orange-700">This is an exchange job from: <span className="font-semibold">{selectedJob.parentJobId}</span></p>
                        </div>
                      )}

                      {selectedJob.linkedJobs && selectedJob.linkedJobs.length > 0 && (
                        <div className="mt-6">
                          <h3 className="font-semibold mb-2">Linked Jobs</h3>
                          <div className="flex flex-wrap gap-2">
                            {selectedJob.linkedJobs.map(jobId => (
                              <span key={jobId} className="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                {jobId}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Quotes View Component
        const QuotesView = ({ quotes, onAddQuote, onUpdateQuote, onEditQuote, onConvertToJob, customers, suppliers }) => {
          const [selectedQuote, setSelectedQuote] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [filters, setFilters] = useState({
            status: '',
            jobType: ''
          });

        // Sort quotes by quote number descending (newest first)        
        const sortedQuotes = [...quotes].sort((a, b) => {
            const aNum = parseInt(a.quoteNumber.split('-').pop());
            const bNum = parseInt(b.quoteNumber.split('-').pop());
            return bNum - aNum;
        });
          const filteredQuotes = sortedQuotes.filter(quote => {
            if (searchQuery && 
                !quote.quoteNumber.toLowerCase().includes(searchQuery.toLowerCase()) &&
                !quote.customerName.toLowerCase().includes(searchQuery.toLowerCase())) {
              return false;
            }
            if (filters.status && quote.status !== filters.status) return false;
            if (filters.jobType && quote.jobType !== filters.jobType) return false;
            return true;
          });

          const handleConvertToJob = (quote) => {
            // Convert quote to job
            const newJob = {
              customerName: quote.customerName,
              customerPO: '',
              supplierName: '',
              supplierRef: '',
              jobType: quote.jobType,
              wasteType: quote.wasteType,
              skipSize: quote.skipSize,
              aggregateType: quote.aggregateType,
              quantity: quote.quantity,
              unit: quote.unit,
              customerUnitPrice: quote.price,
              customerFinalPrice: quote.totalPrice,
              supplierUnitPrice: 0,
              supplierFinalPrice: 0,
              vatRate: 20,
              jobDate: quote.deliveryDate || new Date().toISOString().split('T')[0],
              status: 'CONFIRMED',
              priority: 'Medium',
              siteAddress: quote.siteAddress,
              sitePostcode: quote.sitePostcode,
              siteContact: quote.customerContact,
              sitePhone: quote.customerPhone,
              notes: `Converted from quote ${quote.quoteNumber}`,
              invoiceNumber: '',
              invoiceStatus: 'Not Invoiced',
              paymentStatus: 'Not Paid',
              isCompleted: false,
              isCancelled: false
            };
            
            onConvertToJob(newJob);
            onUpdateQuote({ ...quote, status: 'ACCEPTED' });
            setSelectedQuote(null);
          };

          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Quotes</h2>
                  <p className="text-gray-600">{filteredQuotes.length} quotes found</p>
                </div>
                <button 
                  onClick={onAddQuote}
                  className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                >
                  <Plus size={16} className="mr-2" />
                  New Quote
                </button>
              </div>

              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
                <div className="flex items-center space-x-4">
                  <Filter size={16} className="text-gray-600" />
                  <input
                    type="text"
                    placeholder="Search quotes..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="px-3 py-2 border border-gray-300 rounded-lg"
                  />
                  <select
                    value={filters.status}
                    onChange={(e) => setFilters({...filters, status: e.target.value})}
                    className="px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="SENT">Sent</option>
                    <option value="ACCEPTED">Accepted</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="EXPIRED">Expired</option>
                  </select>
                  <select
                    value={filters.jobType}
                    onChange={(e) => setFilters({...filters, jobType: e.target.value})}
                    className="px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="">All Job Types</option>
                    <option value="Skip Hire">Skip Hire</option>
                    <option value="Aggregates">Aggregates</option>
                    <option value="Waste Collection">Waste Collection</option>
                    <option value="Grab Hire">Grab Hire</option>
                    <option value="Muck Away">Muck Away</option>
                    <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                  </select>
                  <button
                    onClick={() => {
                      setSearchQuery('');
                      setFilters({ status: '', jobType: '' });
                    }}
                    className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                  >
                    Clear
                  </button>
                </div>
              </div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quote Number</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Valid Until</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {filteredQuotes.map(quote => {
                          const statusColors = {
                            'PENDING': 'bg-yellow-100 text-yellow-800',
                            'SENT': 'bg-blue-100 text-blue-800',
                            'ACCEPTED': 'bg-green-100 text-green-800',
                            'REJECTED': 'bg-red-100 text-red-800',
                            'EXPIRED': 'bg-gray-100 text-gray-800'
                          };
                          
                          const isExpired = new Date(quote.validUntil) < new Date() && quote.status !== 'ACCEPTED';
                          
                          return (
                            <tr 
                              key={quote.id} 
                              className="hover:bg-gray-50 cursor-pointer"
                              onClick={() => setSelectedQuote(quote)}
                            >
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm font-medium text-gray-900">{quote.quoteNumber}</div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm text-gray-900">{quote.customerName}</div>
                                  <div className="text-sm text-gray-500">{quote.customerContact}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {quote.jobType}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {new Date(quote.createdDate).toLocaleDateString('en-GB')}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {new Date(quote.validUntil).toLocaleDateString('en-GB')}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                  isExpired && quote.status === 'PENDING' ? statusColors['EXPIRED'] : statusColors[quote.status]
                                }`}>
                                  {isExpired && quote.status === 'PENDING' ? 'EXPIRED' : quote.status}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                £{quote.totalPrice?.toFixed(2)}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm">
                                <div className="flex items-center space-x-2" onClick={(e) => e.stopPropagation()}>
                                  <button
                                    onClick={() => onEditQuote(quote)}
                                    className="text-blue-600 hover:text-blue-900"
                                  >
                                    <Edit3 size={16} />
                                  </button>
                                  {quote.status === 'PENDING' || quote.status === 'SENT' ? (
                                    <button
                                      onClick={() => handleConvertToJob(quote)}
                                      className="text-green-600 hover:text-green-900"
                                      title="Convert to Job"
                                    >
                                      <Package size={16} />
                                    </button>
                                  ) : null}
                                </div>
                              </td>
                            </tr>
                          );
                        })}
                      </tbody>
                    </table>
                  </div>
                  
                  {filteredQuotes.length === 0 && (
                    <div className="text-center py-8">
                      <FileText className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No quotes found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedQuote && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedQuote.quoteNumber}</h2>
                        <p className="text-gray-600">{selectedQuote.jobType}</p>
                      </div>
                      <button onClick={() => setSelectedQuote(null)}>
                        <X size={24} />
                      </button>
                    </div>
                    
                    <div className="p-6">
                      <div className="space-y-4">
                        <div>
                          <h3 className="font-semibold mb-4">Customer Information</h3>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                              <span className="text-sm text-gray-600">Customer:</span>
                              <p className="font-medium">{selectedQuote.customerName}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Contact:</span>
                              <p className="font-medium">{selectedQuote.customerContact}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Email:</span>
                              <p className="font-medium">{selectedQuote.customerEmail}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Phone:</span>
                              <p className="font-medium">{selectedQuote.customerPhone}</p>
                            </div>
                          </div>
                        </div>

                        <div>
                          <h3 className="font-semibold mb-4">Quote Details</h3>
                          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                              <span className="text-sm text-gray-600">Quantity:</span>
                              <p className="font-medium">{selectedQuote.quantity} {selectedQuote.unit}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Unit Price:</span>
                              <p className="font-medium">£{selectedQuote.price?.toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Total Value:</span>
                              <p className="font-medium text-blue-600">£{selectedQuote.totalPrice?.toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-sm text-gray-600">Valid Until:</span>
                              <p className="font-medium">{new Date(selectedQuote.validUntil).toLocaleDateString('en-GB')}</p>
                            </div>
                          </div>
                        </div>

                        {selectedQuote.siteAddress && (
                          <div>
                            <h3 className="font-semibold mb-4">Site Information</h3>
                            <p>{selectedQuote.siteAddress}</p>
                            {selectedQuote.sitePostcode && <p className="text-gray-600">{selectedQuote.sitePostcode}</p>}
                          </div>
                        )}

                        {selectedQuote.notes && (
                          <div>
                            <h3 className="font-semibold mb-4">Notes</h3>
                            <p className="text-gray-700">{selectedQuote.notes}</p>
                          </div>
                        )}

                        {(selectedQuote.status === 'PENDING' || selectedQuote.status === 'SENT') && (
                          <div className="pt-4 border-t">
                            <button
                              onClick={() => handleConvertToJob(selectedQuote)}
                              className="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center"
                            >
                              <Package size={20} className="mr-2" />
                              Convert to Job
                            </button>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Customers View Component
          const CustomersView = ({ customers, onAddCustomer, onUpdateCustomer, onDeleteCustomer, user }) => {
          const { hasPermission } = useAuth();
          const [selectedCustomer, setSelectedCustomer] = useState(null);
          const [editingCustomer, setEditingCustomer] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [filters, setFilters] = useState({
            businessType: '',
            creditRating: '',
            accountStatus: ''
          });

          const [showSyncDialog, setShowSyncDialog] = useState(false);
const [syncResults, setSyncResults] = useState(null);
const [syncing, setSyncing] = useState(false);

          const filteredCustomers = customers.filter(customer => {
  if (searchQuery && 
      !(customer.companyName || customer.name || '').toLowerCase().includes(searchQuery.toLowerCase()) &&
      !(customer.primaryContact || '').toLowerCase().includes(searchQuery.toLowerCase())) {
    return false;
  }
  // ... rest of the filter logic
            if (filters.businessType && customer.businessType !== filters.businessType) return false;
            if (filters.creditRating && customer.creditRating !== filters.creditRating) return false;
            if (filters.accountStatus && customer.accountStatus !== filters.accountStatus) return false;
            return true;
          });
const displayCustomers = filteredCustomers.map(customer => ({
  ...customer,
  companyName: customer.companyName || customer.name,
  primaryContact: customer.primaryContact || '',
  businessType: customer.businessType || 'Other',
  creditRating: customer.creditRating || 'B',
  creditLimit: customer.creditLimit || 0,
  accountStatus: customer.accountStatus || 'Active',
  vatNumber: customer.vatNumber || customer.vat_number,
  email: customer.email || '',
  phone: customer.phone || ''
}));

          const handleDeleteCustomer = (customer) => {
          if (confirm(`Are you sure you want to delete ${customer.companyName || customer.name}?`)) {
              onDeleteCustomer(customer.id);
              setSelectedCustomer(null);
            }
          };

          const handleSyncFromSage = async () => {
            // Map database customers to the format the UI expects
  setSyncing(true);
  try {
    const results = await window.SageAPI.syncCustomersFromSage();
    setSyncResults(results);
    setShowSyncDialog(true);
  } catch (error) {
    alert('Failed to sync from Sage: ' + error.message);
  } finally {
    setSyncing(false);
  }
};

const handleApplySync = async () => {
  if (!syncResults) return;
  
  try {
    let successCount = 0;
    let skipCount = 0;
    
    // Add new customers directly to database
    for (const sageCustomer of syncResults.new) {
      // First check if this sage_id already exists
      const { data: existing, error: checkError } = await window.supabase
        .from('customers')
        .select('sage_id')
        .eq('sage_id', sageCustomer.sage_id)
        .single();
      
      if (existing) {
        console.log(`Skipping duplicate customer: ${sageCustomer.name}`);
        skipCount++;
        continue;
      }
      
      // Save to Supabase with the correct field names
      const { error } = await window.supabase
        .from('customers')
        .insert({
          name: sageCustomer.name,
          sage_id: sageCustomer.sage_id,
          email: sageCustomer.email || '',
          phone: sageCustomer.phone || '',
          vat_number: sageCustomer.vat_number || '',
          address: sageCustomer.address
        });
      
      if (error) {
        console.error('Error inserting customer:', error);
        // Continue with next customer instead of failing completely
        continue;
      }
      
      successCount++;
    }
    
    setShowSyncDialog(false);
    setSyncResults(null);
    
    if (skipCount > 0) {
      alert(`Successfully synced ${successCount} new customers from Sage!\n${skipCount} customers were skipped (already exist).`);
    } else {
      alert(`Successfully synced ${successCount} new customers from Sage!`);
    }
    
    // Refresh the page to show new customers
    window.location.reload();
    
  } catch (error) {
    alert('Error applying sync: ' + error.message);
  }
};
          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Customer Management</h2>
                  <p className="text-gray-600">{displayCustomers.length} customers found</p>
                </div>
                <div className="flex items-center space-x-2">
                <button 
  onClick={onAddCustomer}
  className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
>
  <Plus size={16} className="mr-1 sm:mr-2" />
  <span className="hidden sm:inline">Add Customer</span>
  <span className="sm:hidden">Add</span>
</button>
{user.role === 'ADMIN' && (
  <button
    onClick={handleSyncFromSage}
    disabled={syncing}
    className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-2 disabled:opacity-50 text-sm sm:text-base"
  >
    {syncing ? (
      <>
        <Loader size={16} className="mr-1 sm:mr-2 animate-spin" />
        <span className="hidden sm:inline">Syncing...</span>
        <span className="sm:hidden">Sync</span>
      </>
    ) : (
      <>
        <Repeat size={16} className="mr-1 sm:mr-2" />
        <span className="hidden sm:inline">Sync from Sage</span>
        <span className="sm:hidden">Sync</span>
      </>
    )}
  </button>
)}
    </div>
  </div>
              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <Filter size={16} className="text-gray-600" />
                    <input
                      type="text"
                      placeholder="Search customers..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <select
                      value={filters.businessType}
                      onChange={(e) => setFilters({...filters, businessType: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Business Types</option>
                      <option value="Construction Company">Construction Company</option>
                      <option value="Main Contractor">Main Contractor</option>
                      <option value="Sub Contractor">Sub Contractor</option>
                      <option value="Property Developer">Property Developer</option>
                      <option value="Demolition Contractor">Demolition Contractor</option>
                      <option value="Retail">Retail</option>
                      <option value="Other">Other</option>
                    </select>
                    <select
                      value={filters.creditRating}
                      onChange={(e) => setFilters({...filters, creditRating: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Credit Ratings</option>
                      <option value="A+">A+ (Excellent)</option>
                      <option value="A">A (Very Good)</option>
                      <option value="B+">B+ (Good)</option>
                      <option value="B">B (Average)</option>
                      <option value="C">C (Below Average)</option>
                    </select>
                    <button
                      onClick={() => {
                        setSearchQuery('');
                        setFilters({ businessType: '', creditRating: '', accountStatus: '' });
                      }}
                      className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                      Clear
                    </button>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setViewMode('grid')}
                      className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Grid size={16} />
                    </button>
                    <button
                      onClick={() => setViewMode('list')}
                      className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Layout size={16} />
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                      {displayCustomers.map(customer => (
                        <div
                          key={customer.id}
                          className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => setSelectedCustomer(customer)}
                        >
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h4 className="font-semibold text-gray-900 truncate">{customer.companyName}</h4>
                              <p className="text-sm text-gray-600">{customer.businessType}</p>
                            </div>
                            <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                              customer.creditRating === 'A+' || customer.creditRating === 'A' ? 'bg-green-100 text-green-700' :
                              customer.creditRating === 'B+' || customer.creditRating === 'B' ? 'bg-yellow-100 text-yellow-700' :
                              'bg-red-100 text-red-700'
                            }`}>
                              {customer.creditRating}
                            </span>
                          </div>
                          
                          <div className="space-y-2 mb-4">
                            <div className="flex items-center text-sm text-gray-600">
                              <User size={14} className="mr-2 text-blue-500" />
                              <span className="truncate">{customer.primaryContact}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Phone size={14} className="mr-2 text-green-500" />
                              <span>{customer.phone}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Mail size={14} className="mr-2 text-purple-500" />
                              <span className="truncate">{customer.email}</span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div className="text-sm">
                              <span className="text-gray-600">Credit Limit:</span>
                              <span className="font-medium text-gray-900 ml-1">£{customer.creditLimit?.toLocaleString() || '0'}</span>
                            </div>
                            <div className="text-sm">
                              <span className="text-gray-600">Terms:</span>
                              <span className="font-medium text-gray-900 ml-1">{customer.paymentTerms || 30} days</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Business Type</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit Rating</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit Limit</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {displayCustomers.map(customer => (
                            <tr 
                              key={customer.id} 
                              className="hover:bg-gray-50 cursor-pointer"
                              onClick={() => setSelectedCustomer(customer)}
                            >
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm font-medium text-gray-900">{customer.companyName}</div>
                                  <div className="text-sm text-gray-500">{customer.vatNumber}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm text-gray-900">{customer.primaryContact}</div>
                                  <div className="text-sm text-gray-500">{customer.email}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {customer.businessType}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                  customer.creditRating === 'A+' || customer.creditRating === 'A' ? 'bg-green-100 text-green-700' :
                                  customer.creditRating === 'B+' || customer.creditRating === 'B' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-red-100 text-red-700'
                                }`}>
                                  {customer.creditRating}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                £{customer.creditLimit?.toLocaleString() || '0'}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                  customer.accountStatus === 'Active' ? 'bg-green-100 text-green-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {customer.accountStatus || 'Active'}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  {displayCustomers.length === 0 && (
                    <div className="text-center py-8">
                      <Users className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No customers found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedCustomer && !editingCustomer && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedCustomer.companyName}</h2>
                        <p className="text-gray-600">{selectedCustomer.businessType}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        {hasPermission('customers:update') && (
                          <button
                            onClick={() => setEditingCustomer(selectedCustomer)}
                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                            title="Edit Customer"
                          >
                            <Edit3 size={20} />
                          </button>
                        )}
                        {hasPermission('customers:delete') && (
                          <button
                            onClick={() => handleDeleteCustomer(selectedCustomer)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Customer"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedCustomer(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 lg:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                          <h3 className="font-semibold mb-4">Contact Information</h3>
                          <div className="space-y-3">
                            <div className="flex items-center">
                              <User size={16} className="mr-3 text-blue-600" />
                              <div>
                                <p className="font-medium">{selectedCustomer.primaryContact}</p>
                                <p className="text-sm text-gray-600">{selectedCustomer.contactPosition || 'Primary Contact'}</p>
                              </div>
                            </div>
                            <div className="flex items-center">
                              <Phone size={16} className="mr-3 text-green-600" />
                              <span>{selectedCustomer.phone}</span>
                            </div>
                            {selectedCustomer.mobile && (
                              <div className="flex items-center">
                                <Phone size={16} className="mr-3 text-green-600" />
                                <span>{selectedCustomer.mobile} (Mobile)</span>
                              </div>
                            )}
                            <div className="flex items-center">
                              <Mail size={16} className="mr-3 text-purple-600" />
                              <span>{selectedCustomer.email}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div>
                          <h3 className="font-semibold mb-4">Business Details</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">VAT Number:</span>
                              <span className="font-medium">{selectedCustomer.vatNumber || 'Not provided'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Company Number:</span>
                              <span className="font-medium">{selectedCustomer.companyNumber || 'Not provided'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Credit Rating:</span>
                              <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                selectedCustomer.creditRating === 'A+' || selectedCustomer.creditRating === 'A' ? 'bg-green-100 text-green-700' :
                                selectedCustomer.creditRating === 'B+' || selectedCustomer.creditRating === 'B' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {selectedCustomer.creditRating}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Credit Limit:</span>
                              <span className="font-medium">£{selectedCustomer.creditLimit?.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Payment Terms:</span>
                              <span className="font-medium">{selectedCustomer.paymentTerms} days</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Business Type:</span>
                              <span className="font-medium">{selectedCustomer.businessType}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {editingCustomer && (
                <CustomerForm
                  customer={editingCustomer}
                  onClose={() => setEditingCustomer(null)}
                  onSave={(updatedCustomer) => {
                    onUpdateCustomer(updatedCustomer);
                    setEditingCustomer(null);
                    setSelectedCustomer(null);
                  }}
                />
              )}

              {showSyncDialog && syncResults && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div className="p-6 border-b border-gray-200">
        <h2 className="text-xl font-bold">Sync Preview</h2>
        <p className="text-gray-600">Review changes before applying</p>
      </div>
      
      <div className="p-6">
        {/* New Customers */}
        {syncResults.new.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-green-700">
              New Customers to Import ({syncResults.new.length})
            </h3>
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {syncResults.new.map((customer, idx) => (
                <div key={idx} className="p-3 bg-green-50 rounded-lg">
                  <div className="font-medium">{customer.companyName}</div>
<div className="text-sm text-gray-600">
  {customer.email || 'No email'}
  {customer.billingAddress && customer.billingAddress.length > 0 && 
    ` | ${customer.billingAddress.filter(line => line).join(', ')}`
  }
</div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {/* Conflicts */}
        {syncResults.conflicts.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-yellow-700">
              Conflicts Found ({syncResults.conflicts.length})
            </h3>
            <div className="space-y-2">
              {syncResults.conflicts.map((conflict, idx) => (
                <div key={idx} className="p-3 bg-yellow-50 rounded-lg">
                  <div className="font-medium">VAT: {conflict.sage.tax_number}</div>
                  <div className="text-sm">
                    <span className="text-gray-600">Local:</span> {conflict.local.companyName}
                  </div>
                  <div className="text-sm">
                    <span className="text-gray-600">Sage:</span> {conflict.sage.name}
                  </div>
                </div>
              ))}
            </div>
            <p className="text-sm text-yellow-700 mt-2">
              Conflicts will be skipped. Update manually if needed.
            </p>
          </div>
        )}
        
        {syncResults.new.length === 0 && syncResults.conflicts.length === 0 && (
          <p className="text-gray-500">No new customers to sync.</p>
        )}
      </div>
      
      <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
        <button
          onClick={() => {
            setShowSyncDialog(false);
            setSyncResults(null);
          }}
          className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        {syncResults.new.length > 0 && (
          <button
            onClick={handleApplySync}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            Import {syncResults.new.length} Customers
          </button>
        )}
      </div>
    </div>
  </div>
)}

            </div>
          );
        };

        // Suppliers View Component
          const SuppliersView = ({ suppliers, onAddSupplier, onUpdateSupplier, onDeleteSupplier, user }) => {
          const { hasPermission } = useAuth();
          const [selectedSupplier, setSelectedSupplier] = useState(null);
          const [editingSupplier, setEditingSupplier] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [filters, setFilters] = useState({
            service: '',
            rating: '',
            preferred: ''
          });
const [showSyncDialog, setShowSyncDialog] = useState(false);
const [syncResults, setSyncResults] = useState(null);
const [syncing, setSyncing] = useState(false);
          const filteredSuppliers = suppliers.filter(supplier => {
            if (searchQuery && 
                !(supplier.name || supplier.companyName || '').toLowerCase().includes(searchQuery.toLowerCase()) &&
                !(supplier.primaryContact || '').toLowerCase().includes(searchQuery.toLowerCase())) {
              return false;
            }
            if (filters.service && !supplier.primaryServices?.includes(filters.service)) return false;
            if (filters.rating && supplier.supplierRating !== filters.rating) return false;
            if (filters.preferred === 'yes' && !supplier.preferredSupplier) return false;
            if (filters.preferred === 'no' && supplier.preferredSupplier) return false;
            return true;
          });
          const displaySuppliers = filteredSuppliers.map(supplier => ({
  ...supplier,
  companyName: supplier.name && supplier.name !== 'Unknown Supplier' 
    ? supplier.name 
    : supplier.companyName || supplier.name || 'Unknown Supplier',
  primaryContact: supplier.primaryContact || 'No contact',
  vatNumber: supplier.vat_number || supplier.vatNumber || '',
  email: supplier.email || '',
  phone: supplier.phone || ''
}));

          const handleDeleteSupplier = (supplier) => {
          if (confirm(`Are you sure you want to delete ${supplier.name || supplier.companyName}?`)) {
              onDeleteSupplier(supplier.id);
              setSelectedSupplier(null);
            }
          };
          const handleSyncFromSage = async () => {
  setSyncing(true);
  try {
    const results = await window.SageAPI.syncSuppliersFromSage();
    setSyncResults(results);
    setShowSyncDialog(true);
  } catch (error) {
    alert('Failed to sync from Sage: ' + error.message);
  } finally {
    setSyncing(false);
  }
};

const handleApplySync = async () => {
  if (!syncResults) return;
  
  try {
    let successCount = 0;
    let skipCount = 0;
    
    // Add new suppliers directly to database
    for (const sageSupplier of syncResults.new) {
      // Check if supplier already exists
      // Check if supplier already exists by sage_id OR name
const { data: existing } = await window.supabase
  .from('suppliers')
  .select('id, sage_id, name')
  .eq('name', sageSupplier.companyName || sageSupplier.name || sageSupplier.displayed_as)
  .maybeSingle();
      
      if (existing) {
        console.log(`Skipping duplicate supplier: ${sageSupplier.name || sageSupplier.companyName}`);
        skipCount++;
        continue;
      }
      
     // Map the Sage fields correctly to match your database schema
const supplierData = {
  name: sageSupplier.companyName || sageSupplier.name || sageSupplier.displayed_as || 'Unknown Supplier',
 sage_id: sageSupplier.companyName + '_' + Date.now(),
  email: sageSupplier.email || '',
  phone: sageSupplier.telephone || sageSupplier.phone || '',
  vat_number: sageSupplier.tax_number || '',
  address: sageSupplier.main_address || ''
};
      
      // Save directly to Supabase
      const { error } = await window.supabase
        .from('suppliers')
        .insert(supplierData);
      
      if (error) {
        console.error('Error inserting supplier:', error);
        console.error('Supplier data:', supplierData);
        continue;
      }
      
      successCount++;
    }
    
    setShowSyncDialog(false);
    setSyncResults(null);
    
    if (skipCount > 0) {
      alert(`Successfully synced ${successCount} new suppliers from Sage!\n${skipCount} suppliers were skipped (already exist).`);
    } else if (successCount > 0) {
      alert(`Successfully synced ${successCount} new suppliers from Sage!`);
    } else {
      alert('No new suppliers were imported. They may already exist in your database.');
    }
    
    // Refresh the page to show new suppliers
    if (successCount > 0) {
      window.location.reload();
    }
    
  } catch (error) {
    console.error('Full error:', error);
    alert('Error applying sync: ' + error.message);
  }
};
          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Supplier Management</h2>
                  <p className="text-gray-600">{filteredSuppliers.length} suppliers found</p>
                </div>
                <div className="flex items-center space-x-2">
  <button 
    onClick={onAddSupplier}
    className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
  >
    <Plus size={16} className="mr-1 sm:mr-2" />
    <span className="hidden sm:inline">Add Supplier</span>
    <span className="sm:hidden">Add</span>
  </button>
  {user?.role === 'ADMIN' && (
    <button
      onClick={handleSyncFromSage}
      disabled={syncing}
      className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-2 disabled:opacity-50 text-sm sm:text-base"
    >
      {syncing ? (
        <>
          <Loader size={16} className="mr-1 sm:mr-2 animate-spin" />
          <span className="hidden sm:inline">Syncing...</span>
          <span className="sm:hidden">Sync</span>
        </>
      ) : (
        <>
          <Repeat size={16} className="mr-1 sm:mr-2" />
          <span className="hidden sm:inline">Sync from Sage</span>
          <span className="sm:hidden">Sync</span>
        </>
      )}
    </button>
  )}
</div>
              </div>

              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-4">
                    <Filter size={16} className="text-gray-600" />
                    <input
                      type="text"
                      placeholder="Search suppliers..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <select
                      value={filters.service}
                      onChange={(e) => setFilters({...filters, service: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Services</option>
                      <option value="Skip Hire">Skip Hire</option>
                      <option value="Waste Collection">Waste Collection</option>
                      <option value="Aggregates Supply">Aggregates Supply</option>
                      <option value="Recycling">Recycling</option>
                      <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                      <option value="Haulage">Haulage</option>
                      <option value="Transport">Transport</option>
                    </select>
                    <select
                      value={filters.rating}
                      onChange={(e) => setFilters({...filters, rating: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Ratings</option>
                      <option value="A+">A+ (Excellent)</option>
                      <option value="A">A (Very Good)</option>
                      <option value="A-">A- (Good)</option>
                      <option value="B+">B+ (Above Average)</option>
                      <option value="B">B (Average)</option>
                    </select>
                    <select
                      value={filters.preferred}
                      onChange={(e) => setFilters({...filters, preferred: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Suppliers</option>
                      <option value="yes">Preferred Only</option>
                      <option value="no">Non-Preferred</option>
                    </select>
                    <button
                      onClick={() => {
                        setSearchQuery('');
                        setFilters({ service: '', rating: '', preferred: '' });
                      }}
                      className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                      Clear
                    </button>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setViewMode('grid')}
                      className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Grid size={16} />
                    </button>
                    <button
                      onClick={() => setViewMode('list')}
                      className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Layout size={16} />
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                    {displaySuppliers.map(supplier => (
                        <div
                          key={supplier.id}
                          className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => setSelectedSupplier(supplier)}
                        >
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h4 className="font-semibold text-gray-900 truncate">{supplier.name || supplier.companyName}</h4>
                              <p className="text-sm text-gray-600">{supplier.primaryServices?.join(', ') || 'Services not specified'}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                              {supplier.preferredSupplier && (
                                <Star className="w-4 h-4 text-yellow-500 fill-current" />
                              )}
                              <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                supplier.supplierRating === 'A+' || supplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                supplier.supplierRating === 'A-' || supplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {supplier.supplierRating}
                              </span>
                            </div>
                          </div>
                          
                          <div className="space-y-2 mb-4">
                            <div className="flex items-center text-sm text-gray-600">
                              <User size={14} className="mr-2 text-blue-500" />
                              <span className="truncate">{supplier.primaryContact}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Phone size={14} className="mr-2 text-green-500" />
                              <span>{supplier.phone}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Truck size={14} className="mr-2 text-purple-500" />
                              <span className="truncate">
                                {supplier.primaryServices?.slice(0, 2).join(', ') || 'Services not specified'}
                              </span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div className="text-sm">
                              <span className="text-gray-600">Rating:</span>
                              <span className="font-medium text-gray-900 ml-1">{supplier.supplierRating}</span>
                            </div>
                            <div className="text-sm">
                              {supplier.preferredSupplier ? (
                                <span className="text-yellow-600 font-medium">⭐ Preferred</span>
                              ) : (
                                <span className="text-gray-500">Standard</span>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Services</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preferred</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {displaySuppliers.map(supplier => (
                            <tr 
                              key={supplier.id} 
                              className="hover:bg-gray-50 cursor-pointer"
                              onClick={() => setSelectedSupplier(supplier)}
                            >
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm font-medium text-gray-900">{supplier.name || supplier.companyName}</div>
                                  <div className="text-sm text-gray-500">{supplier.vatNumber}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm text-gray-900">{supplier.primaryContact}</div>
                                  <div className="text-sm text-gray-500">{supplier.email}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900">
                                  {supplier.primaryServices?.slice(0, 2).join(', ') || 'Not specified'}
                                  {supplier.primaryServices?.length > 2 && <span className="text-gray-500"> +{supplier.primaryServices.length - 2}</span>}
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                  supplier.supplierRating === 'A+' || supplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                  supplier.supplierRating === 'A-' || supplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-red-100 text-red-700'
                                }`}>
                                  {supplier.supplierRating}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                {supplier.preferredSupplier && (
                                  <Star className="w-5 h-5 text-yellow-500 fill-current" />
                                )}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {supplier.performanceScore}%
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  {filteredSuppliers.length === 0 && (
                    <div className="text-center py-8">
                      <Truck className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No suppliers found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedSupplier && !editingSupplier && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedSupplier.companyName}</h2>
                        <p className="text-gray-600">{selectedSupplier.primaryServices?.join(', ')}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        {hasPermission('suppliers:update') && (
                          <button
                            onClick={() => setEditingSupplier(selectedSupplier)}
                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                            title="Edit Supplier"
                          >
                            <Edit3 size={20} />
                          </button>
                        )}
                        {hasPermission('suppliers:delete') && (
                          <button
                            onClick={() => handleDeleteSupplier(selectedSupplier)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Supplier"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedSupplier(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 lg:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                          <h3 className="font-semibold mb-4">Contact Information</h3>
                          <div className="space-y-3">
                            <div className="flex items-center">
                              <User size={16} className="mr-3 text-blue-600" />
                              <div>
                                <p className="font-medium">{selectedSupplier.primaryContact}</p>
                                <p className="text-sm text-gray-600">Primary Contact</p>
                              </div>
                            </div>
                            <div className="flex items-center">
                              <Phone size={16} className="mr-3 text-green-600" />
                              <span>{selectedSupplier.phone}</span>
                            </div>
                            <div className="flex items-center">
                              <Mail size={16} className="mr-3 text-purple-600" />
                              <span>{selectedSupplier.email}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div>
                          <h3 className="font-semibold mb-4">Business Details</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Supplier Rating:</span>
                              <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                selectedSupplier.supplierRating === 'A+' || selectedSupplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                selectedSupplier.supplierRating === 'A-' || selectedSupplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {selectedSupplier.supplierRating}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Preferred Supplier:</span>
                              <span className="font-medium">
                                {selectedSupplier.preferredSupplier ? (
                                  <span className="text-yellow-600">⭐ Yes</span>
                                ) : (
                                  <span className="text-gray-500">No</span>
                                )}
                              </span>
                            </div>
                            <div>
                              <span className="text-gray-600">Services:</span>
                              <div className="mt-2 flex flex-wrap gap-1">
                                {selectedSupplier.primaryServices?.map(service => (
                                  <span key={service} className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                                    {service}
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {editingSupplier && (
                <SupplierForm
                  supplier={editingSupplier}
                  onClose={() => setEditingSupplier(null)}
                  onSave={(updatedSupplier) => {
                    onUpdateSupplier(updatedSupplier);
                    setEditingSupplier(null);
                    setSelectedSupplier(null);
                  }}
                />
              )}
              {showSyncDialog && syncResults && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div className="p-6 border-b border-gray-200">
        <h2 className="text-xl font-bold">Supplier Sync Preview</h2>
        <p className="text-gray-600">Review changes before applying</p>
      </div>
      
      <div className="p-6">
        {syncResults.new.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-green-700">
              New Suppliers to Import ({syncResults.new.length})
            </h3>
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {syncResults.new.map((supplier, idx) => (
                <div key={idx} className="p-3 bg-green-50 rounded-lg">
                  <div className="font-medium">{supplier.name || supplier.companyName}</div>
<div className="text-sm text-gray-600">
  {supplier.email || 'No email'} | 
  {supplier.phone || 'No phone'}
  {supplier.billingAddress && supplier.billingAddress.length > 0 && 
    ` | ${supplier.billingAddress.filter(line => line).join(', ')}`
  }
</div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {syncResults.conflicts.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-yellow-700">
              Conflicts Found ({syncResults.conflicts.length})
            </h3>
            <div className="space-y-2">
              {syncResults.conflicts.map((conflict, idx) => (
                <div key={idx} className="p-3 bg-yellow-50 rounded-lg">
                  <div className="font-medium">VAT: {conflict.sage.tax_number}</div>
                  <div className="text-sm">
                    <span className="text-gray-600">Local:</span> {conflict.local.companyName}
                  </div>
                  <div className="text-sm">
                    <span className="text-gray-600">Sage:</span> {conflict.sage.name}
                  </div>
                </div>
              ))}
            </div>
            <p className="text-sm text-yellow-700 mt-2">
              Conflicts will be skipped. Update manually if needed.
            </p>
          </div>
        )}
        
        {syncResults.new.length === 0 && syncResults.conflicts.length === 0 && (
          <p className="text-gray-500">No new suppliers to sync.</p>
        )}
      </div>
      
      <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
        <button
          onClick={() => {
            setShowSyncDialog(false);
            setSyncResults(null);
          }}
          className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        {syncResults.new.length > 0 && (
          <button
            onClick={handleApplySync}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            Import {syncResults.new.length} Suppliers
          </button>
        )}
      </div>
    </div>
  </div>
)}
            </div>
          );
        };

// Simple Admin Panel
        const AdminPanel = ({ user }) => {
          const { wasteTypes, updateWasteTypes, addWasteType, deleteWasteType } = useWasteTypes();
          const [configSection, setConfigSection] = useState('general');
          const [companyName, setCompanyName] = useState('Total Waste Services');
          const [primaryColor, setPrimaryColor] = useState('#2563eb');
          const [editingJobType, setEditingJobType] = useState('');
          const [newType, setNewType] = useState('');
          const [logo, setLogo] = useState(localStorage.getItem('companyLogo') || '');
          // Sage Integration states
const [sageSettings, setSageSettings] = useState({
  clientId: '',
  clientSecret: '',
  accessToken: '',
  refreshToken: '',
  companyId: '',
  apiRegion: 'UK',
  connectionStatus: 'disconnected',
  lastSync: ''
});
const [testingConnection, setTestingConnection] = useState(false);
const [syncingProducts, setSyncingProducts] = useState(false);
const [products, setProducts] = useState([]);
const [showProductsSyncDialog, setShowProductsSyncDialog] = useState(false);
const [productsSyncResults, setProductsSyncResults] = useState(null);
          
          // Load saved settings when component loads
useEffect(() => {
  const loadSettings = async () => {
    try {
      const { data, error } = await window.supabase
        .from('company_settings')
        .select('*');
      
      if (data) {
        data.forEach(setting => {
          if (setting.setting_name === 'company_name') {
            setCompanyName(setting.setting_value);
          } else if (setting.setting_name === 'primary_color') {
            setPrimaryColor(setting.setting_value);
            document.documentElement.style.setProperty('--primary-color', setting.setting_value);
          } else if (setting.setting_name === 'logo_url' && setting.setting_value) {
            setLogo(setting.setting_value);
          }
             
});
      }
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  };
  
  loadSettings();
  
}, []);

// Load products when component mounts
useEffect(() => {
  if (user?.role === 'ADMIN') {
    loadProducts();
  }
}, []);

// Function to handle color changes (existing line 3430)
// Function to handle color changes
const handleColorChange = (color) => {
  setPrimaryColor(color);
  document.documentElement.style.setProperty('--primary-color', color);
};

// Handle logo upload
const handleLogoUpload = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const handleThemeToggle = (theme) => {
  const isDark = theme === 'Dark Mode';
  setDarkMode(isDark);
  if (isDark) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  localStorage.setItem('darkMode', isDark.toString());
};
  
  try {
    // Delete old logo if exists
    const { data: existingFiles } = await window.supabase.storage
      .from('logo')
      .list();
    
    if (existingFiles && existingFiles.length > 0) {
      await window.supabase.storage
        .from('logo')
        .remove(existingFiles.map(f => f.name));
    }
    
    // Upload new logo
    const fileName = `company-logo.${file.name.split('.').pop()}`;
    const { data, error } = await window.supabase.storage
      .from('logo')
      .upload(fileName, file, { upsert: true });
    
    if (error) throw error;
    
    // Get public URL
    const { data: { publicUrl } } = window.supabase.storage
      .from('logo')
      .getPublicUrl(fileName);
    
    setLogo(publicUrl);
    localStorage.setItem('companyLogo', publicUrl); // Keep local cache
    alert('Logo uploaded successfully!');
  } catch (error) {
    console.error('Error:', error);
    alert('Error uploading logo');
  }
};

// Load Sage settings
useEffect(() => {
  const loadSageSettings = async () => {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret', 'sage_access_token', 
                             'sage_refresh_token', 'sage_company_id', 'sage_api_region', 
                             'sage_last_sync']);
      
      if (data) {
        const settings = {};
        data.forEach(item => {
          const key = item.setting_name.replace('sage_', '');
          if (key === 'client_id') settings.clientId = item.setting_value;
          else if (key === 'client_secret') settings.clientSecret = item.setting_value;
          else if (key === 'access_token') settings.accessToken = item.setting_value;
          else if (key === 'refresh_token') settings.refreshToken = item.setting_value;
          else if (key === 'company_id') settings.companyId = item.setting_value;
          else if (key === 'api_region') settings.apiRegion = item.setting_value;
          else if (key === 'last_sync') settings.lastSync = item.setting_value;
        });
        setSageSettings(prev => ({ ...prev, ...settings }));
      }
    } catch (error) {
      console.error('Error loading Sage settings:', error);
    }
  };
  loadSageSettings();
}, []);

// Save Sage settings
const handleSaveSageSettings = async () => {
  try {
    const updates = [
      { setting_name: 'sage_client_id', setting_value: sageSettings.clientId },
      { setting_name: 'sage_client_secret', setting_value: sageSettings.clientSecret },
      { setting_name: 'sage_access_token', setting_value: sageSettings.accessToken },
      { setting_name: 'sage_refresh_token', setting_value: sageSettings.refreshToken },
      { setting_name: 'sage_company_id', setting_value: sageSettings.companyId },
      { setting_name: 'sage_api_region', setting_value: sageSettings.apiRegion }
    ];
    
    for (const update of updates) {
      await window.supabase
        .from('company_settings')
        .upsert(update, { onConflict: 'setting_name' });
    }
    
    alert('Sage settings saved successfully!');
  } catch (error) {
    console.error('Error saving Sage settings:', error);
    alert('Error saving Sage settings');
  }
};

// Test Sage connection
const testSageConnection = async () => {
  setTestingConnection(true);
  try {
    // For now, just simulate a connection test
    // In production, this would call the Sage API
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Check if we have the minimum required credentials
    if (sageSettings.clientId && sageSettings.clientSecret) {
      setSageSettings(prev => ({ ...prev, connectionStatus: 'connected' }));
      alert('Successfully connected to Sage!');
    } else {
      throw new Error('Missing credentials');
    }
  } catch (error) {
    setSageSettings(prev => ({ ...prev, connectionStatus: 'error' }));
    alert('Failed to connect to Sage. Please check your credentials.');
  } finally {
    setTestingConnection(false);
  }
};
const syncProductsFromSage = async () => {
  setSyncingProducts(true);
  try {
    const results = await window.SageAPI.syncProductsFromSage();
    setProductsSyncResults(results);
    setShowProductsSyncDialog(true);
    await handleApplyProductsSync();
  } catch (error) {
    alert('Failed to sync products from Sage: ' + error.message);
  } finally {
    setSyncingProducts(false);
  }
};

const handleApplyProductsSync = async () => {
  if (!productsSyncResults) return;
  
  try {
    // Save products to Supabase
    for (const sageItem of productsSyncResults.new) {
      await window.supabase
        .from('sage_products')
       .insert({
  sage_id: sageItem.id,
  name: sageItem.displayed_as,
  description: sageItem.displayed_as,
  item_code: sageItem.id,
  sales_ledger_account: sageItem.sales_ledger_account_id,
  type: sageItem._isService ? 'service' : 'product', // We'll add this flag
  active: sageItem.active !== false
});
    }
    
    setShowProductsSyncDialog(false);
    setProductsSyncResults(null);
    alert(`Successfully synced ${productsSyncResults.new.length} products/services from Sage!`);
    
    // Reload products
    loadProducts();
  } catch (error) {
    alert('Error applying sync: ' + error.message);
  }
};

const loadProducts = async () => {
  try {
    const { data, error } = await window.supabase
      .from('sage_products')
      .select('*')
      .order('name');
    
    if (data) {
      setProducts(data);
    }
  } catch (error) {
    console.error('Error loading products:', error);
  }
};
          const [newUserData, setNewUserData] = useState({
            firstName: '',
            lastName: '',
            email: '',
            password: '',
            role: 'BROKER'
          });
          const [users, setUsers] = useState([]);

// Add this useEffect to load users
useEffect(() => {
  loadUsers();
}, []);

const loadUsers = async () => {
  try {
    const { data, error } = await window.supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (data) {
      setUsers(data.map(u => {
        const nameParts = u.name.split(' ');
        return {
          id: u.id,
          email: u.email,
          firstName: nameParts[0] || '',
          lastName: nameParts.slice(1).join(' ') || '',
          role: u.role
        };
      }));
    }
  } catch (error) {
    console.error('Error loading users:', error);
  }
};
          const [editingUser, setEditingUser] = useState(null);

          const sections = [
  { id: 'general', name: 'General Settings', icon: 'Settings' },
  { id: 'waste-types', name: 'Waste Types', icon: 'Trash2' },
  { id: 'forms', name: 'Form Configuration', icon: 'Layout' },
  { id: 'appearance', name: 'Appearance', icon: 'Palette' },
  { id: 'users', name: 'User Management', icon: 'Users' },
  { id: 'sage', name: 'Sage Integration', icon: 'Package' },
  { id: 'products', name: 'Products & Services', icon: 'Package' }
];

          const handleAddType = () => {
            if (newType && editingJobType) {
              addWasteType(editingJobType, newType);
              setNewType('');
            }
          };

          const handleDeleteType = (jobType, type) => {
            if (confirm(`Delete "${type}" from ${jobType}?`)) {
              deleteWasteType(jobType, type);
            }
          };

          const handleSaveSettings = async () => {
  try {
    // Save all settings to Supabase
    const updates = [
  { setting_name: 'company_name', setting_value: companyName },
  { setting_name: 'primary_color', setting_value: primaryColor },
  { setting_name: 'logo_url', setting_value: logo },
];
    
    for (const update of updates) {
      await window.supabase
        .from('company_settings')
        .upsert(update, { onConflict: 'setting_name' });
    }
    
    // Also update localStorage for immediate effect
    localStorage.setItem('companyName', companyName);
    localStorage.setItem('primaryColor', primaryColor);
    localStorage.setItem('companyLogo', logo);
    
    alert('Settings saved successfully for all users!');
  } catch (error) {
    console.error('Error saving settings:', error);
    alert('Error saving settings');
  }
};
          const handleAddUser = async () => {
  if (!newUserData.firstName || !newUserData.email || !newUserData.password) {
    alert('Please fill in all required fields');
    return;
  }
  
  try {
    const fullName = `${newUserData.firstName} ${newUserData.lastName || ''}`.trim();
    
    const { data, error } = await window.supabase
      .from('users')
      .insert([{
        email: newUserData.email,
        password: newUserData.password,
        name: fullName,
        role: newUserData.role
      }])
      .select();
    
    if (error) throw error;
    
    await loadUsers(); // Refresh the list
    setNewUserData({
      firstName: '',
      lastName: '',
      email: '',
      password: '',
      role: 'BROKER'
    });
    alert('User added successfully!');
  } catch (error) {
    console.error('Error adding user:', error);
    alert('Error adding user: ' + error.message);
  }
};

          const handleDeleteUser = async (userId) => {
  if (confirm('Are you sure you want to delete this user?')) {
    try {
      const { error } = await window.supabase
        .from('users')
        .delete()
        .eq('id', userId);
      
      if (error) throw error;
      await loadUsers(); // Refresh the list
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Error deleting user');
    }
  }
};

          const handleUpdateUser = async (updatedUser) => {
  try {
    const fullName = `${updatedUser.firstName} ${updatedUser.lastName || ''}`.trim();
    
    const { error } = await window.supabase
      .from('users')
      .update({
        email: updatedUser.email,
        name: fullName,
        role: updatedUser.role
      })
      .eq('id', updatedUser.id);
    
    if (error) throw error;
    await loadUsers(); // Refresh the list
    setEditingUser(null);
  } catch (error) {
    console.error('Error updating user:', error);
    alert('Error updating user');
  }
};

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">System Administration</h2>
                <p className="text-gray-600">Configure your waste management system</p>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div className="lg:col-span-1">
                  <div className="bg-white rounded-lg border border-gray-200 p-4">
                    <nav className="space-y-2">
                      {sections.map(section => {
                        const Icon = section.icon === 'Settings' ? Settings :
             section.icon === 'Layout' ? Layout :
             section.icon === 'Palette' ? Palette :
             section.icon === 'Trash2' ? Trash2 : 
             section.icon === 'Package' ? Package : Users;
                        return (
                          <button
                            key={section.id}
                            onClick={() => setConfigSection(section.id)}
                            className={`w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors ${
                              configSection === section.id ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'
                            }`}
                          >
                            <Icon size={18} />
                            <span>{section.name}</span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>
                </div>

                <div className="lg:col-span-3">
                  <div className="bg-white rounded-lg border border-gray-200 p-6">
                    {configSection === 'general' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">General Settings</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                            <input
                              type="text"
                              value={companyName}
                              onChange={(e) => setCompanyName(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                            <input
                              type="color"
                              value={primaryColor}
                              onChange={(e) => handleColorChange(e.target.value)}
                              className="w-full h-10 border border-gray-300 rounded-lg cursor-pointer"
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Default VAT Rate (%)</label>
                            <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
                              <option value="20">20% (Standard)</option>
                              <option value="5">5% (Reduced)</option>
                              <option value="0">0% (Zero)</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                            <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
                              <option value="GBP">GBP (£)</option>
                              <option value="EUR">EUR (€)</option>
                              <option value="USD">USD ($)</option>
                            </select>
                          </div>
                        </div>
                        <button 
                          onClick={handleSaveSettings}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          Save Settings
                        </button>
                      </div>
                    )}

                    {configSection === 'waste-types' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Waste & Aggregate Types Management</h3>
                        <div className="space-y-4">
                          {Object.entries(wasteTypes).map(([jobType, types]) => (
                            <div key={jobType} className="border border-gray-200 rounded-lg p-4">
                              <h4 className="font-medium text-gray-900 mb-3">{jobType}</h4>
                              <div className="space-y-2">
                                {types.map(type => (
                                  <div key={type} className="flex items-center justify-between py-2 px-3 bg-gray-50 rounded">
                                    <span className="text-sm">{type}</span>
                                    <button
                                      onClick={() => handleDeleteType(jobType, type)}
                                      className="text-red-600 hover:text-red-800"
                                    >
                                      <Trash2 size={16} />
                                    </button>
                                  </div>
                                ))}
                              </div>
                              {editingJobType === jobType ? (
                                <div className="mt-3 flex space-x-2">
                                  <input
                                    type="text"
                                    value={newType}
                                    onChange={(e) => setNewType(e.target.value)}
                                    placeholder="New type name"
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAddType()}
                                  />
                                  <button
                                    onClick={handleAddType}
                                    className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                  >
                                    Add
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingJobType('');
                                      setNewType('');
                                    }}
                                    className="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                  >
                                    Cancel
                                  </button>
                                </div>
                              ) : (
                                <button
                                  onClick={() => setEditingJobType(jobType)}
                                  className="mt-3 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200"
                                >
                                  <Plus size={16} className="inline mr-1" />
                                  Add New Type
                                </button>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {configSection === 'forms' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Form Configuration</h3>
                        <p className="text-gray-600">Configure form fields and validation rules</p>
                        <div className="space-y-4">
                          <div className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-medium mb-3">Job Form Fields</h4>
                            <div className="space-y-2">
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Customer PO Number (Optional)</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Waste Transfer Note</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Hazardous Waste Options</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" className="mr-2" />
                                <span className="text-sm">Photos Upload</span>
                              </label>
                            </div>
                          </div>
                          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Form Configuration
                          </button>
                        </div>
                      </div>
                    )}

                    {configSection === 'appearance' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Appearance Settings</h3>
                        <p className="text-gray-600">Customize the look and feel of your system</p>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Logo Upload</label>
                            <div className="flex items-center space-x-4">
                        <input 
                        type="file" 
                        accept="image/*" 
                        onChange={handleLogoUpload}
                         className="block" 
                          />
                        {logo && (
                        <img src={logo} alt="Company Logo" className="h-12 w-auto" />
                         )}
                          </div>
                          </div>
                          <div>
<label className="block text-sm font-medium text-gray-700 mb-2">Font Size</label>
  <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
  <option>Small</option>
  <option>Medium</option>
  <option>Large</option>
</select>
</div>
                          <button 
  onClick={() => handleSaveSettings()}
  style={{ backgroundColor: 'var(--primary-color)' }}
  className="px-4 py-2 text-white rounded-lg hover:opacity-90 mt-4"
  type="button"
>
  Save Appearance Settings
</button>
                        </div>
                      </div>
                    )}

                    {configSection === 'users' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">User Management</h3>
                        
                        {!editingUser && (
                          <>
                            <div className="bg-gray-50 p-4 rounded-lg">
                              <h4 className="font-medium mb-3">Add New User</h4>
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input
                                  type="text"
                                  placeholder="First Name"
                                  value={newUserData.firstName}
                                  onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="text"
                                  placeholder="Last Name"
                                  value={newUserData.lastName}
                                  onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="email"
                                  placeholder="Email"
                                  value={newUserData.email}
                                  onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="password"
                                  placeholder="Password"
                                  value={newUserData.password}
                                  onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <select
                                  value={newUserData.role}
                                  onChange={(e) => setNewUserData({...newUserData, role: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                >
                                  <option value="ADMIN">Admin</option>
                                  <option value="MANAGER">Manager</option>
                                  <option value="BROKER">Broker</option>
                                </select>
                                <button
                                  onClick={handleAddUser}
                                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                >
                                  Add User
                                </button>
                              </div>
                            </div>

                            <div className="space-y-4">
                              {users.map(user => (
                                <div key={user.id} className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                  <div>
                                    <p className="font-medium">{user.firstName} {user.lastName}</p>
                                    <p className="text-sm text-gray-600">{user.email}</p>
                                  </div>
                                  <div className="flex items-center space-x-3">
                                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                      user.role === 'ADMIN' ? 'bg-red-100 text-red-700' :
                                      user.role === 'MANAGER' ? 'bg-blue-100 text-blue-700' :
                                      'bg-green-100 text-green-700'
                                    }`}>
                                      {user.role}
                                    </span>
                                    <button
                                      onClick={() => setEditingUser(user)}
                                      className="text-blue-600 hover:text-blue-800"
                                    >
                                      <Edit3 size={16} />
                                    </button>
                                    {user.id !== '1' && (
                                      <button
                                        onClick={() => handleDeleteUser(user.id)}
                                        className="text-red-600 hover:text-red-800"
                                      >
                                        <Trash2 size={16} />
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </>
                        )}

                        {editingUser && (
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-medium mb-3">Edit User</h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                              <input
                                type="text"
                                value={editingUser.firstName}
                                onChange={(e) => setEditingUser({...editingUser, firstName: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <input
                                type="text"
                                value={editingUser.lastName}
                                onChange={(e) => setEditingUser({...editingUser, lastName: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <input
                                type="email"
                                value={editingUser.email}
                                onChange={(e) => setEditingUser({...editingUser, email: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <select
                                value={editingUser.role}
                                onChange={(e) => setEditingUser({...editingUser, role: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              >
                                <option value="ADMIN">Admin</option>
                                <option value="MANAGER">Manager</option>
                                <option value="BROKER">Broker</option>
                              </select>
                              <button
                                onClick={() => handleUpdateUser(editingUser)}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                              >
                                Save Changes
                              </button>
                              <button
                                onClick={() => setEditingUser(null)}
                                className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
    {configSection === 'sage' && (
  <div className="space-y-6">
    <h3 className="text-lg font-semibold">Sage 50 Cloud Integration</h3>
    
    {/* Connection Status */}
    <div className="bg-gray-50 p-4 rounded-lg">
      <div className="flex items-center justify-between">
        <div>
          <h4 className="font-medium">Connection Status</h4>
          <p className="text-sm text-gray-600">
            {localStorage.getItem('sage_connected') === 'true' ? 'Connected to Sage' : 'Not Connected'}
          </p>
          {sageSettings.lastSync && (
            <p className="text-xs text-gray-500 mt-1">
              Last sync: {new Date(sageSettings.lastSync).toLocaleString()}
            </p>
          )}
        </div>
        <div className={`w-3 h-3 rounded-full ${
          localStorage.getItem('sage_connected') === 'true' ? 'bg-green-500' : 'bg-gray-400'
        }`} />
      </div>
    </div>

    {/* API Credentials */}
    <div className="space-y-4">
      <h4 className="font-medium">API Credentials</h4>
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Client ID</label>
          <input
            type="text"
            value={sageSettings.clientId}
            onChange={(e) => setSageSettings({...sageSettings, clientId: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Your Sage Client ID"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Client Secret</label>
          <input
            type="password"
            value={sageSettings.clientSecret}
            onChange={(e) => setSageSettings({...sageSettings, clientSecret: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Your Sage Client Secret"
          />
        </div>
      </div>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Company ID (Optional)</label>
          <input
            type="text"
            value={sageSettings.companyId}
            onChange={(e) => setSageSettings({...sageSettings, companyId: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Sage Company ID"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">API Region</label>
          <select
            value={sageSettings.apiRegion}
            onChange={(e) => setSageSettings({...sageSettings, apiRegion: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
          >
            <option value="UK">UK & Ireland</option>
            <option value="US">United States</option>
            <option value="CA">Canada</option>
          </select>
        </div>
      </div>
    </div>

    {/* Action Buttons */}
    <div className="flex flex-wrap gap-3">
      <button
        onClick={handleSaveSageSettings}
        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
      >
        Save Settings
      </button>
      
      {localStorage.getItem('sage_connected') !== 'true' ? (
        <button
  onClick={() => {
    if (sageSettings.clientId && sageSettings.clientSecret) {
        connectToSagePopup();
    } else {
        alert('Please enter Client ID and Client Secret first');
    }
}}
          disabled={!sageSettings.clientId || !sageSettings.clientSecret}
          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Connect to Sage
        </button>
      ) : (
        <>
          <button
            onClick={async () => {
              if (confirm('Are you sure you want to disconnect from Sage?')) {
                // Clear tokens
                const updates = [
                  { setting_name: 'sage_access_token', setting_value: '' },
                  { setting_name: 'sage_refresh_token', setting_value: '' }
                ];
                
                for (const update of updates) {
                  await window.supabase
                    .from('company_settings')
                    .upsert(update, { onConflict: 'setting_name' });
                }
                
                localStorage.removeItem('sage_connected');
                setSageSettings(prev => ({ ...prev, accessToken: '', refreshToken: '' }));
                alert('Disconnected from Sage');
              }
            }}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Disconnect
          </button>
          
          <button
            onClick={syncProductsFromSage}
            disabled={syncingProducts}
            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
          >
            {syncingProducts ? (
              <>
                <Loader className="animate-spin mr-2 inline" size={16} />
                Syncing...
              </>
            ) : (
              'Sync Products'
            )}
          </button>
        </>
      )}
    </div>

    {/* Integration Features */}
    <div className="border-t pt-6">
      <h4 className="font-medium mb-4">Integration Features</h4>
      <div className="space-y-3">
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Sync customers from Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Sync suppliers from Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Create invoices in Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" />
          <span className="text-sm">Auto-sync on job completion</span>
        </label>
      </div>
    </div>

    {/* Help Section */}
    <div className="bg-blue-50 p-4 rounded-lg">
      <h4 className="font-medium text-blue-900 mb-2">Setup Instructions</h4>
      <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
        <li>Log in to your Sage Developer account</li>
        <li>Create a new application for API access</li>
        <li>Set redirect URI to: <code className="bg-blue-100 px-1">{window.location.origin}/sage-callback</code></li>
        <li>Copy your Client ID and Client Secret</li>
        <li>Enter the credentials above and save</li>
        <li>Click "Connect to Sage" to authorize access</li>
      </ol>
    </div>
  </div>
)}
{configSection === 'products' && (
  <div className="space-y-6">
    <h3 className="text-lg font-semibold">Products & Services Sync</h3>
    
    <div className="bg-gray-50 p-4 rounded-lg">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h4 className="font-medium">Sync from Sage</h4>
          <p className="text-sm text-gray-600">Import products and services from Sage</p>
        </div>
        <button
          onClick={syncProductsFromSage}
          disabled={syncingProducts}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center"
        >
          {syncingProducts ? (
            <>
              <Loader className="animate-spin mr-2" size={16} />
              Syncing...
            </>
          ) : (
            'Sync Products'
          )}
        </button>
      </div>
    </div>

    {products.length > 0 && (
      <div>
        <h4 className="font-medium mb-3">Synced Products ({products.length})</h4>
        <div className="bg-white border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {products.map((product) => (
                <tr key={product.id}>
                  <td className="px-4 py-2 text-sm">{product.item_code}</td>
                  <td className="px-4 py-2 text-sm">{product.name}</td>
                  <td className="px-4 py-2 text-sm">
                    <span className={`px-2 py-1 text-xs rounded-full ${
                      product.type === 'product' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'
                    }`}>
                      {product.type}
                    </span>
                  </td>
                  <td className="px-4 py-2 text-sm">
                    <span className={`px-2 py-1 text-xs rounded-full ${
                      product.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                    }`}>
                      {product.active ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    )}

    {showProductsSyncDialog && productsSyncResults && (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-xl font-bold">Products Sync Preview</h2>
            <p className="text-gray-600">Review products and services to import</p>
          </div>
          
          <div className="p-6">
            {productsSyncResults.new.length > 0 && (
              <div className="mb-6">
                <h3 className="font-semibold mb-3 text-green-700">
                  New Products/Services to Import ({productsSyncResults.new.length})
                </h3>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {productsSyncResults.new.map((item, idx) => (
                    <div key={idx} className="p-3 bg-green-50 rounded-lg">
                      <div className="font-medium">{item.displayed_as}</div>
                      <div className="text-sm text-gray-600">
                        Code: {item.item_code || 'N/A'} | 
                        Type: {item.type}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {productsSyncResults.new.length === 0 && (
              <p className="text-gray-500">No new products or services to sync.</p>
            )}
          </div>
          
          <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
            <button
              onClick={() => {
                setShowProductsSyncDialog(false);
                setProductsSyncResults(null);
              }}
              className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            {productsSyncResults.new.length > 0 && (
              <button
                onClick={handleApplyProductsSync}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                Import {productsSyncResults.new.length} Items
              </button>
            )}
          </div>
        </div>
      </div>
    )}
  </div>
)}
                  </div>
                </div>
              </div>
            </div>
          );
        };
        // Documents View Component
        const DocumentsView = ({ user }) => {
          const [documents, setDocuments] = useState([]);
          const [loading, setLoading] = useState(true);
          const [activeCategory, setActiveCategory] = useState('policies');

          useEffect(() => {
            loadDocuments();
          }, []);

          const loadDocuments = async () => {
            try {
              setLoading(true);
              const { data, error } = await window.supabase
                .from('documents')
                .select('*')
                .order('created_at', { ascending: false });
              
              if (error) {
                console.error('Error loading documents:', error);
                return;
              }
              
              setDocuments(data || []);
            } catch (error) {
              console.error('Error:', error);
            } finally {
              setLoading(false);
            }
          };

          const uploadDocument = async () => {
            const docType = document.getElementById('doc-category')?.value;
            const docTitle = document.getElementById('doc-title')?.value;
            const fileInput = document.getElementById('doc-file');
            const file = fileInput?.files[0];
            
            if (!docType || !docTitle || !file) {
              alert('Please fill all fields');
              return;
            }
            
            try {
              const fileName = `${Date.now()}_${file.name}`;
              const { data: fileData, error: fileError } = await window.supabase.storage
                .from('documents')
                .upload(fileName, file);
              
              if (fileError) throw fileError;
              
              const { data: { publicUrl } } = window.supabase.storage
                .from('documents')
                .getPublicUrl(fileName);
              
              const { data, error } = await window.supabase
                .from('documents')
                .insert([{
                  name: docTitle,
                  file_type: docType,
                  file_path: fileName,
                  file_url: publicUrl,
                  file_size: file.size
                }])
                .select();
              
              if (error) throw error;
              
              alert('Document uploaded successfully!');
              document.getElementById('doc-title').value = '';
              document.getElementById('doc-file').value = '';
              loadDocuments();
            } catch (error) {
              console.error('Error:', error);
              alert('Error: ' + error.message);
            }
          };

          const deleteDocument = async (docId) => {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            try {
              const { error } = await window.supabase
                .from('documents')
                .delete()
                .eq('id', docId);
              
              if (error) throw error;
              loadDocuments();
            } catch (error) {
              console.error('Error deleting document:', error);
              alert('Error deleting document');
            }
          };

               const filteredDocuments = documents.filter(doc => 
                 doc.file_type?.toLowerCase() === activeCategory
               );

          return (
            <div className="p-6">
              <h2 className="text-2xl font-bold mb-6">Company Documents</h2>
              
              {user?.role === 'ADMIN' && (
                <div className="bg-gray-100 p-4 rounded-lg mb-6">
                  <h3 className="text-lg font-semibold mb-4">Upload New Document</h3>
                  <div className="space-y-4">
                    <select id="doc-category" className="px-3 py-2 border rounded">
                      <option value="policies">Policies</option>
                      <option value="procedures">Procedures</option>
                    </select>
                    <input type="file" id="doc-file" className="block" accept=".pdf,.doc,.docx" />
                    <input type="text" id="doc-title" placeholder="Document Title" className="px-3 py-2 border rounded w-full max-w-xs" />
                    <button onClick={uploadDocument} className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                      Upload Document
                    </button>
                  </div>
                </div>
              )}
              
              <div className="flex gap-4 mb-6">
                <button 
                  onClick={() => setActiveCategory('policies')}
                  className={`px-4 py-2 rounded ${activeCategory === 'policies' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  Policies
                </button>
                <button 
                  onClick={() => setActiveCategory('procedures')}
                  className={`px-4 py-2 rounded ${activeCategory === 'procedures' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  Procedures
                </button>
              </div>
              
              {loading ? (
                <div className="text-center py-8">
                  <Loader className="mx-auto h-8 w-8 animate-spin text-blue-500" />
                  <p className="mt-2 text-gray-500">Loading documents...</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-4">
                  {filteredDocuments.length === 0 ? (
                    <div className="col-span-full text-center py-8 text-gray-500">
                      No {activeCategory} found
                    </div>
                  ) : (
                    filteredDocuments.map(doc => (
                      <div key={doc.id} className="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <h4 className="font-semibold">{doc.name || 'Untitled'}</h4>
                        <p className="text-sm text-gray-600">Uploaded: {new Date(doc.created_at).toLocaleDateString()}</p>
                        <div className="mt-2 flex gap-2">
                          <a 
                            href={doc.file_url} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-500 hover:text-blue-700"
                          >
                            View/Download
                          </a>
                          {user?.role === 'ADMIN' && (
                            <button 
                              onClick={() => deleteDocument(doc.id)}
                              className="text-red-500 hover:text-red-700"
                            >
                              Delete
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          );
        };
        // Main Application
        const App = () => {
          // Load company settings on app start
useEffect(() => {
  const loadGlobalSettings = async () => {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*');
      
      if (data) {
        data.forEach(setting => {
          if (setting.setting_name === 'primary_color') {
            document.documentElement.style.setProperty('--primary-color', setting.setting_value);
            localStorage.setItem('primaryColor', setting.setting_value);
          } else if (setting.setting_name === 'logo_url') {
            localStorage.setItem('companyLogo', setting.setting_value);
          }
        });
      }
    } catch (error) {
      console.error('Error loading global settings:', error);
    }
  };
  
  loadGlobalSettings();
}, []);
          const { user, logout } = useAuth();
          const [activeTab, setActiveTab] = useState('jobs');
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          
          // State for data management
          const [jobs, setJobs] = useState(initialJobs);
          const [customers, setCustomers] = useState(initialCustomers);
          const [suppliers, setSuppliers] = useState(initialSuppliers);
          // Load suppliers from Supabase when app starts
useEffect(() => {
  const loadSuppliersFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('suppliers')
        .select('*');
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setSuppliers(data);
        console.log('Loaded', data.length, 'suppliers from Supabase');
      }
    } catch (error) {
      console.error('Error loading suppliers:', error);
    }
  };
  
  loadSuppliersFromSupabase();
}, []);
          // Load customers from Supabase when app starts
useEffect(() => {
  const loadCustomersFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('customers')
        .select('*');
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setCustomers(data);
        console.log('Loaded', data.length, 'customers from Supabase');
      }
    } catch (error) {
      console.error('Error loading customers:', error);
    }
  };
  const loadSageProducts = async () => {
  try {
    const { data, error } = await window.supabase
      .from('sage_products')
      .select('*')
      .eq('active', true)
      .order('name');
    
    if (error) throw error;
    setSageProducts(data || []);
    console.log('Loaded', data.length, 'Sage products from Supabase');
  } catch (error) {
    console.error('Error loading Sage products:', error);
    setSageProducts([]);
  }
};
  loadCustomersFromSupabase();
  loadSageProducts();
}, []);
          const [quotes, setQuotes] = useState([]);
          
          // Form states
          const [showJobForm, setShowJobForm] = useState(false);
          const [showCustomerForm, setShowCustomerForm] = useState(false);
          const [showSupplierForm, setShowSupplierForm] = useState(false);
          const [showQuoteForm, setShowQuoteForm] = useState(false);
          const [editingJob, setEditingJob] = useState(null);
          const [editingQuote, setEditingQuote] = useState(null);
          const [sageProducts, setSageProducts] = useState([]);
          if (!user) {
            return <LoginScreen />;
          }

          const tabs = [
            { id: 'jobs', name: 'Jobs', icon: 'Grid' },
            { id: 'customers', name: 'Customers', icon: 'Users' },
            { id: 'suppliers', name: 'Suppliers', icon: 'Truck' },
            { id: 'quotes', name: 'Quotes', icon: 'FileText' },
            { id: 'dashboard', name: 'Dashboard', icon: 'BarChart3' },
            { id: 'documents', name: 'Documents', icon: 'FileText' },
            ...(user.role === 'ADMIN' ? [{ id: 'admin', name: 'Admin', icon: 'Settings' }] : [])
          ];

          const handleAddJob = (newJob) => {
            setJobs([...jobs, newJob]);
            setShowJobForm(false);
            setEditingJob(null);
          };

          const handleUpdateJob = (updatedJob) => {
            setJobs(jobs.map(job => job.id === updatedJob.id ? updatedJob : job));
            setEditingJob(null);
          };

          const handleDeleteJob = (jobId) => {
            setJobs(jobs.filter(job => job.id !== jobId));
          };

          const handleEditJob = (job) => {
            setEditingJob(job);
            setShowJobForm(true);
          };

          const handleDuplicateJob = (jobTemplate) => {
            const duplicatedJob = { ...jobTemplate, id: null, jobNumber: null };
            delete duplicatedJob.id;
            delete duplicatedJob.jobNumber;
            setEditingJob(duplicatedJob);
            setShowJobForm(true);
          };

          const handleAddCustomer = async (newCustomer) => {
  try {
    await saveCustomerToDatabase(newCustomer);
    setCustomers([...customers, newCustomer]);
    setShowCustomerForm(false);
  } catch (error) {
    alert('Error saving customer: ' + error.message);
  }
};
          const saveCustomerToDatabase = async (customer) => {
  const { error } = await window.supabase
    .from('customers')
    .insert([customer]);
  
  if (error) {
    console.error('Error saving customer:', error);
    throw error;
  }
};

          const handleUpdateCustomer = (updatedCustomer) => {
            setCustomers(customers.map(customer => customer.id === updatedCustomer.id ? updatedCustomer : customer));
          };

          const handleDeleteCustomer = (customerId) => {
            setCustomers(customers.filter(customer => customer.id !== customerId));
          };

          const handleAddSupplier = async (newSupplier) => {
  try {
    await saveSupplierToDatabase(newSupplier);
    setSuppliers([...suppliers, newSupplier]);
    setShowSupplierForm(false);
  } catch (error) {
    alert('Error saving supplier: ' + error.message);
  }
};

const saveSupplierToDatabase = async (supplier) => {
 // Map to correct database field names
const supplierData = {
  name: supplier.companyName || 'Unknown Supplier',
  sage_id: supplier.sage_id || supplier.id,
  email: supplier.email || '',
  phone: supplier.phone || '',
  vat_number: supplier.vatNumber || '',
  address: supplier.address || ''
};

const { error } = await window.supabase
  .from('suppliers')
  .insert([supplierData]);
  
  if (error) {
    console.error('Error saving supplier:', error);
    throw error;
  }
};

          const handleUpdateSupplier = (updatedSupplier) => {
            setSuppliers(suppliers.map(supplier => supplier.id === updatedSupplier.id ? updatedSupplier : supplier));
          };

          const handleDeleteSupplier = (supplierId) => {
            setSuppliers(suppliers.filter(supplier => supplier.id !== supplierId));
          };

          const handleAddQuote = (newQuote) => {
            setQuotes([...quotes, newQuote]);
            setShowQuoteForm(false);
            setEditingQuote(null);
          };

          const handleUpdateQuote = (updatedQuote) => {
            setQuotes(quotes.map(quote => quote.id === updatedQuote.id ? updatedQuote : quote));
            setEditingQuote(null);
          };

          const handleEditQuote = (quote) => {
            setEditingQuote(quote);
            setShowQuoteForm(true);
          };

          const handleConvertToJob = (newJob) => {
            setEditingJob(newJob);
            setShowJobForm(true);
            setActiveTab('jobs');
          };

          return (
            <div className="min-h-screen bg-gray-50">
              <div className="bg-white border-b border-gray-200">
  <div className="px-4 sm:px-6 py-4">
    <div className="flex items-center justify-between">
      <div className="flex items-center space-x-4">
        {/* Mobile menu button */}
        <button
          onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
          className="sm:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100"
        >
          <Menu size={24} />
        </button>
        
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10">
            {localStorage.getItem('companyLogo') ? (
              <img 
                src={localStorage.getItem('companyLogo')} 
                alt="Company Logo" 
                className="w-full h-full object-contain"
              />
            ) : (
              <div className="w-full h-full bg-blue-600 rounded-lg flex items-center justify-center">
                <Recycle className="w-6 h-6 text-white" />
              </div>
            )}
          </div>
          <div className="hidden sm:block">
            <h1 className="text-xl font-bold text-gray-900">Total Waste Services</h1>
          </div>
        </div>
      </div>
      
      <div className="flex items-center space-x-2 sm:space-x-4">
        <div className="hidden sm:flex items-center space-x-2">
          <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
          <span className="text-sm text-gray-600">Live</span>
        </div>
        
        <div className="flex items-center space-x-2">
          <div className="hidden sm:block w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
            <User size={16} />
          </div>
          <div className="text-sm">
            <div className="font-medium">{user.firstName}</div>
            <div className="text-gray-600 hidden sm:block">{user.role}</div>
          </div>
          <button
            onClick={logout}
            className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"
          >
            <LogOut size={16} />
          </button>
        </div>
      </div>
    </div>
  </div>

  {/* Desktop tabs */}
  <div className="hidden sm:block px-6">
    <div className="flex space-x-8">
      {tabs.map(tab => {
        const Icon = tab.icon === 'BarChart3' ? BarChart3 :
                     tab.icon === 'Grid' ? Grid :
                     tab.icon === 'Users' ? Users :
                     tab.icon === 'Truck' ? Truck :
                     tab.icon === 'FileText' ? FileText : Settings;
        return (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`flex items-center space-x-2 px-4 py-3 border-b-2 font-medium text-sm transition-all ${
              activeTab === tab.id
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <Icon size={16} />
            <span>{tab.name}</span>
          </button>
        );
      })}
    </div>
  </div>

  {/* Mobile menu */}
  {mobileMenuOpen && (
    <div className="sm:hidden px-4 py-2 space-y-1">
      {tabs.map(tab => {
        const Icon = tab.icon === 'BarChart3' ? BarChart3 :
                     tab.icon === 'Grid' ? Grid :
                     tab.icon === 'Users' ? Users :
                     tab.icon === 'Truck' ? Truck :
                     tab.icon === 'FileText' ? FileText : Settings;
        return (
          <button
            key={tab.id}
            onClick={() => {
              setActiveTab(tab.id);
              setMobileMenuOpen(false);
            }}
            className={`w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left ${
              activeTab === tab.id
                ? 'bg-blue-50 text-blue-600'
                : 'text-gray-700 hover:bg-gray-50'
            }`}
          >
            <Icon size={20} />
            <span>{tab.name}</span>
          </button>
        );
      })}
    </div>
  )}
</div>

              <div className="p-4 sm:p-6">
                {activeTab === 'dashboard' && <Dashboard jobs={jobs} customers={customers} />}
                {activeTab === 'documents' && (
                  <DocumentsView user={user} />
                )}
                {activeTab === 'jobs' && (
                  <JobsView 
                    jobs={jobs} 
                    onAddJob={() => setShowJobForm(true)}
                    onUpdateJob={handleUpdateJob}
                    onDeleteJob={handleDeleteJob}
                    onDuplicateJob={handleDuplicateJob}
                    onEditJob={handleEditJob}
                    customers={customers}
                    suppliers={suppliers}
                    user={user}
                  />
                )}
                {activeTab === 'customers' && (
                  <CustomersView 
                    customers={customers} 
                    onAddCustomer={() => setShowCustomerForm(true)}
                    onUpdateCustomer={handleUpdateCustomer}
                    onDeleteCustomer={handleDeleteCustomer}
                    user={user}  
                  />
                )}
                {activeTab === 'suppliers' && (
                  <SuppliersView 
                    suppliers={suppliers} 
                    onAddSupplier={() => setShowSupplierForm(true)}
                    onUpdateSupplier={handleUpdateSupplier}
                    onDeleteSupplier={handleDeleteSupplier}
                    user={user}
                  />
                )}
                {activeTab === 'quotes' && (
                  <QuotesView 
                    quotes={quotes}
                    onAddQuote={() => setShowQuoteForm(true)}
                    onUpdateQuote={handleUpdateQuote}
                    onEditQuote={handleEditQuote}
                    onConvertToJob={handleConvertToJob}
                    customers={customers}
                    suppliers={suppliers}
                  />
                )}
                {activeTab === 'admin' && <AdminPanel user={user} />}
              </div>

              {/* Forms */}
              {showJobForm && (
                <JobForm 
                  job={editingJob}
                  onClose={() => {
                    setShowJobForm(false);
                    setEditingJob(null);
                  }}
                  onSave={editingJob?.id ? handleUpdateJob : handleAddJob}
                  customers={customers}
                  suppliers={suppliers}
                  sageProducts={sageProducts}
                />
              )}

              {showCustomerForm && (
                <CustomerForm 
                  onClose={() => setShowCustomerForm(false)}
                  onSave={handleAddCustomer}
                />
              )}

              {showSupplierForm && (
                <SupplierForm 
                  onClose={() => setShowSupplierForm(false)}
                  onSave={handleAddSupplier}
                />
              )}

              {showQuoteForm && (
                <QuoteForm 
                  quote={editingQuote}
                  onClose={() => {
                    setShowQuoteForm(false);
                    setEditingQuote(null);
                  }}
                  onSave={editingQuote?.id ? handleUpdateQuote : handleAddQuote}
                  customers={customers}
                  suppliers={suppliers}
                />
              )}
            </div>
          );
        };
        // Sage API Service
const SageAPI = {
  baseURL: 'https://api.sage.com/v3.1',
  
  async getAccessToken() {
    // In production, this would handle OAuth2 flow
    const settings = await this.getSettings();
    return settings.accessToken;
  },
  
  async getSettings() {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_access_token', 'sage_refresh_token', 'sage_company_id', 'sage_api_region']);
      
      const settings = {};
      data?.forEach(item => {
        const key = item.setting_name.replace('sage_', '');
        settings[key] = item.setting_value;
      });
      return settings;
    } catch (error) {
      console.error('Error getting Sage settings:', error);
      return {};
    }
  },
  
  
 async makeRequest(endpoint, method = 'GET', body = null) {
    // Get settings including business ID
    const settings = await this.getSettings();
    
    // Fetch the business ID from settings
    const { data: businessData } = await window.supabase
        .from('company_settings')
        .select('setting_value')
        .eq('setting_name', 'sage_business_id')
        .single();
    
    const businessId = businessData?.setting_value;
    
    const response = await fetch('/api/sage-proxy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint,
            method,
            body,
            businessId // Include the business ID
        })
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || `HTTP error! status: ${response.status}`);
    }
    
    return response.json();
},
  
  async refreshToken() {
    try {
      const settings = await this.getSettings();
      if (!settings.refreshToken) return false;
      
      const { data: credentials } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret']);
      
      const clientId = credentials.find(s => s.setting_name === 'sage_client_id')?.setting_value;
      const clientSecret = credentials.find(s => s.setting_name === 'sage_client_secret')?.setting_value;
      
      const response = await fetch('https://oauth.accounting.sage.com/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: settings.refreshToken,
          client_id: clientId,
          client_secret: clientSecret
        })
      });
      
      if (!response.ok) return false;
      
      const tokens = await response.json();
      
      // Save new tokens
      await window.supabase
        .from('company_settings')
        .upsert([
          { setting_name: 'sage_access_token', setting_value: tokens.access_token },
          { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token }
        ], { onConflict: 'setting_name' });
      
      return true;
    } catch (error) {
      console.error('Token refresh failed:', error);
      return false;
    }
  },
  
  async testConnection() {
    try {
      // Test endpoint to verify connection
      await this.makeRequest('/user');
      return true;
    } catch (error) {
      console.error('Sage connection test failed:', error);
      return false;
    }
  },
  
async getCustomers() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`contacts?contact_type=customer&attributes=all&items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      // Check if there are more pages
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} customers from Sage`);
  return { $items: allItems };
},
 

async getSuppliers() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`contacts?contact_type=supplier&attributes=all&items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      // Check if there are more pages
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} suppliers from Sage`);
  return { $items: allItems };
},

  async getProducts() {
  return this.makeRequest('/products');
},

async getServices() {
  return this.makeRequest('/services');
},

async createDraftInvoice(invoiceData) {
  // Create invoice as draft status
  return this.makeRequest('/sales_invoices', 'POST', {
    ...invoiceData,
    status: 'draft'
  });
},
    async syncCustomersFromSage() {
  try {
    const sageCustomers = await this.getCustomers();
    const customerContacts = sageCustomers.$items.filter(function(contact) {
      return contact.contact_types && contact.contact_types.some(function(type) {
        return type.id === 'CUSTOMER';
      });
    });
    
    console.log(`Fetched ${customerContacts.length} customers from Sage`);
    
  //  existingCustomers = await window.supabase
    //  .from('customers')
      //.select('*');
    
    //syncResults = {
      //new: [],
      //updated: [],
      //conflicts: []
    //};
    
    // Continue with the rest of your existing code from line 5565 onwards...

    const existingCustomers = await window.supabase
      .from('customers')
      .select('*');
    
    const syncResults = {
      new: [],
      updated: [],
      conflicts: []
    };
    
 // Inside the for loop that processes sageCustomers
for (const sageCustomer of customerContacts) {
    const existing = existingCustomers.data?.find(
        c => c.vatNumber === sageCustomer.tax_number
    );

    if (!existing) {
        // Map Sage fields to your database fields
    const mappedCustomer = {
  name: sageCustomer.displayed_as || sageCustomer.name || sageCustomer.company_name || 'No Name',
  sage_id: sageCustomer.id,
  email: sageCustomer.email || '',
  phone: sageCustomer.main_contact_person?.phone || '',
  vat_number: sageCustomer.tax_number || '',
  address: sageCustomer.main_address ? {
    line1: sageCustomer.main_address.address_line_1 || '',
    line2: sageCustomer.main_address.address_line_2 || '',
    city: sageCustomer.main_address.city || '',
    postcode: sageCustomer.main_address.postal_code || '',
    country: sageCustomer.main_address.country || ''
  } : null
};
        syncResults.new.push(mappedCustomer);
    } else {
        // Check if data differs and add to conflicts if needed
        if (existing.companyName !== (sageCustomer.name || sageCustomer.displayed_as)) {
            syncResults.conflicts.push({
                sage: sageCustomer,
                local: existing
            });
        }
    }
}
    
    return syncResults;
  } catch (error) {
    console.error('Error syncing customers:', error);
    throw error;
  }
},
async syncSuppliersFromSage() {
  try {
    const sageSuppliers = await this.getSuppliers();
    const supplierContacts = sageSuppliers.$items.filter(function(contact) {
  return contact.contact_types && contact.contact_types.some(function(type) {
    return type.id === 'VENDOR';
  });
});
    const { data: existingSuppliers, error } = await window.supabase
      .from('suppliers')
      .select('*');
    
    if (error) throw error;
    
    const syncResults = {
      new: [],
      updated: [],
      conflicts: []
    };
    
    // Inside syncSuppliersFromSage - for the supplier processing loop
for (const sageSupplier of supplierContacts) {
    const existing = existingSuppliers.data?.find(
        s => s.vatNumber === sageSupplier.tax_number
    );

    if (!existing) {
        // Map Sage fields to your database fields
        const mappedSupplier = {
            companyName: sageSupplier.displayed_as || sageSupplier.name || sageSupplier.company_name || 'No Name',
            vatNumber: sageSupplier.tax_number || '',
          email: sageSupplier.email || '',
            phone: sageSupplier.main_contact_person?.phone || '',
            address: sageSupplier.main_address?.address_line_1 || '',
            city: sageSupplier.main_address?.city || '',
            postcode: sageSupplier.main_address?.postal_code || '',
            creditLimit: sageSupplier.credit_limit || 0,
            // Add any other fields you need
        };
        syncResults.new.push(mappedSupplier);
    } else {
        // Check if data differs and add to conflicts if needed
        if (existing.companyName !== (sageSupplier.name || sageSupplier.displayed_as)) {
            syncResults.conflicts.push({
                sage: sageSupplier,
                local: existing
            });
        }
    }
}
    
    return syncResults;
  } catch (error) {
    console.error('Error syncing suppliers:', error);
    throw error;
  }
},
async getProducts() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`products?items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} products from Sage`);
  return { $items: allItems };
},

async getServices() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`services?items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} services from Sage`);
  return { $items: allItems };
},

async syncProductsFromSage() {
  try {
    // Get both products and services
const sageProducts = await this.getProducts();
const sageServices = await this.getServices();

// Combine products and services
// Combine products and services with proper tagging
const allProducts = [
  ...(sageProducts.$items || []).map(item => ({ ...item, _isService: false })),
  ...(sageServices.$items || []).map(item => ({ ...item, _isService: true }))
];

console.log(`Fetched total of ${allProducts.length} products and services from Sage`);

    // Get existing items from Supabase
    const { data: existingItems, error } = await window.supabase
      .from('sage_products')
      .select('*');
    
    if (error) throw error;
    
    const syncResults = {
      new: [],
      updated: [],
      conflicts: []
    };
    
    for (const sageItem of allProducts) {
      const existing = existingItems?.find(
        item => item.sage_id === sageItem.id
      );
      
      if (!existing) {
        syncResults.new.push(sageItem);
      }
    }
    
    return syncResults;
  } catch (error) {
    console.error('Error syncing products:', error);
    throw error;
  }
},

async createDraftInvoice(invoiceData) {
  return this.makeRequest('/sales_invoices', 'POST', {
    ...invoiceData,
    status: 'draft'
  });
},
  async createInvoice(invoiceData) {
    return this.makeRequest('/sales_invoices', 'POST', invoiceData);
  }
};

// Make SageAPI available globally
window.SageAPI = SageAPI;
// Sage OAuth Handler
window.SageOAuthHandler = {
  authorizationUrl: 'https://www.sageone.com/oauth2/auth/central?filter=apiv3.1',
  tokenUrl: 'https://oauth.accounting.sage.com/token',
  redirect_uri: encodeURIComponent(window.location.origin + '/api/sage-callback'),
  
async connect() {
    try {
        const { data: settings } = await window.supabase
            .from('company_settings')
            .select('*')
            .in('setting_name', ['sage_client_id', 'sage_client_secret']);

        const clientId = settings.find(s => s.setting_name === 'sage_client_id')?.setting_value;
        console.log('Client ID:', clientId);

        if (!clientId) {
            alert('Please configure Sage Client ID in Admin settings first');
            return;
        }

        window.location.href = '/api/sage-auth';
        
    } catch (error) {
        console.error('Error starting OAuth flow:', error);
        alert('Failed to start Sage connection');
    }
},
      

  async handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');
    
    if (error) {
      console.error('OAuth error:', error);
      alert('Authorization failed: ' + error);
      window.location.href = '/';
      return;
    }
    
    if (!code) {
      console.error('No authorization code received');
      window.location.href = '/';
      return;
    }
    
    //const savedState = localStorage.getItem('sage_oauth_state');
    //if (state !== savedState) {
      //console.error('State mismatch');
      //window.location.href = '/';
      //return;
    //}
    
    try {
      document.getElementById('root').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-lg">Completing Sage connection...</p></div></div>';
      
      const { data: settings } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret']);
      
      const clientId = settings.find(s => s.setting_name === 'sage_client_id')?.setting_value;
      const clientSecret = settings.find(s => s.setting_name === 'sage_client_secret')?.setting_value;
      
      if (!clientId || !clientSecret) {
        throw new Error('Missing client credentials');
      }
      
      const tokenData = new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: window.location.origin + '/api/sage-callback',
        client_id: clientId,
        client_secret: clientSecret
      });
      
     const tokenResponse = await fetch('/api/sage-token-exchange', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        code: code,
        client_id: clientId,
        client_secret: clientSecret,
        redirect_uri: window.location.origin + '/api/sage-callback'
    })
});
      
      if (!tokenResponse.ok) {
        const errorData = await tokenResponse.text();
        console.error('Token response:', errorData);
        throw new Error('Token exchange failed');
      }
      
      const tokens = await tokenResponse.json();
      
      const updates = [
        { setting_name: 'sage_access_token', setting_value: tokens.access_token },
        { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token }
      ];
      
      for (const update of updates) {
        await window.supabase
          .from('company_settings')
          .upsert(update, { onConflict: 'setting_name' });
      }
      
      localStorage.removeItem('sage_oauth_state');
      localStorage.setItem('sage_connected', 'true');
      
     alert('Successfully connected to Sage!');
console.log('DEBUG: About to redirect to /#sage-integration');
console.trace('Stack trace');
debugger;
window.location.href = '/#sage-integration';  // Keep this line!
      
    } catch (error) {
      console.error('Error handling OAuth callback:', error);
      alert('Failed to complete Sage connection: ' + error.message);
      window.location.href = '/#sage-integration';
    }
  }
};
        // Customer Form Component
        const CustomerForm = ({ customer, onClose, onSave }) => {
          const [formData, setFormData] = useState(customer || {
            companyName: '',
            tradingName: '',
            companyNumber: '',
            vatNumber: '',
            primaryContact: '',
            contactPosition: '',
            phone: '',
            mobile: '',
            email: '',
            accountsEmail: '',
            businessType: 'Construction Company',
            siteAddress: '',
            sitePostcode: '',
            billingAddress: '',
            billingPostcode: '',
            creditRating: 'B',
            paymentTerms: 30,
            creditLimit: 10000,
            accountStatus: 'Active',
            wasteCarrierLicense: '',
            insuranceExpiry: '',
            healthSafetyCompliant: false,
            chasAccredited: false,
            preferredContactMethod: 'Email',
            specialRequirements: '',
            accountManager: '',
            dateRegistered: new Date().toISOString().split('T')[0]
          });

          const [activeTab, setActiveTab] = useState('company');

          const handleSubmit = () => {
            const newCustomer = {
              ...formData,
              id: customer?.id || `CUST-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`
            };
            onSave(newCustomer);
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{customer ? 'Edit Customer' : 'Add New Customer'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('company')}
                    className={`px-6 py-3 font-medium ${activeTab === 'company' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Company Details
                  </button>
                  <button
                    onClick={() => setActiveTab('contact')}
                    className={`px-6 py-3 font-medium ${activeTab === 'contact' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Contact Information
                  </button>
                  <button
                    onClick={() => setActiveTab('financial')}
                    className={`px-6 py-3 font-medium ${activeTab === 'financial' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Financial & Compliance
                  </button>
                  <button
                   onClick={() => {
                        setActiveTab('documents');

                     }}
                     className={`px-6 py-3 font-medium ${activeTab === 'documents' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                     Documents
        </button>
                </div>

                <div className="p-6">
                  {/* Company Details Tab */}
                  {activeTab === 'company' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                          <input
                            type="text"
                            value={formData.companyName}
                            onChange={(e) => setFormData({...formData, companyName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Legal company name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Trading Name</label>
                          <input
                            type="text"
                            value={formData.tradingName}
                            onChange={(e) => setFormData({...formData, tradingName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If different from company name"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Registration Number</label>
                          <input
                            type="text"
                            value={formData.companyNumber}
                            onChange={(e) => setFormData({...formData, companyNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="12345678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Number</label>
                          <input
                            type="text"
                            value={formData.vatNumber}
                            onChange={(e) => setFormData({...formData, vatNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="GB123456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Business Type</label>
                          <select
                            value={formData.businessType}
                            onChange={(e) => setFormData({...formData, businessType: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Construction Company">Construction Company</option>
                            <option value="Main Contractor">Main Contractor</option>
                            <option value="Sub Contractor">Sub Contractor</option>
                            <option value="Property Developer">Property Developer</option>
                            <option value="Demolition Contractor">Demolition Contractor</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="House Builder">House Builder</option>
                            <option value="Local Authority">Local Authority</option>
                            <option value="Facilities Management">Facilities Management</option>
                            <option value="Retail">Retail</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Status</label>
                          <select
                            value={formData.accountStatus}
                            onChange={(e) => setFormData({...formData, accountStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Closed">Closed</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Site Address</label>
                        <input
                          type="text"
                          value={formData.siteAddress}
                          onChange={(e) => setFormData({...formData, siteAddress: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                          placeholder="Primary site address"
                        />
                        <input
                          type="text"
                          value={formData.sitePostcode}
                          onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Postcode"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Billing Address</label>
                        <input
                          type="text"
                          value={formData.billingAddress}
                          onChange={(e) => setFormData({...formData, billingAddress: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                          placeholder="If different from site address"
                        />
                        <input
                          type="text"
                          value={formData.billingPostcode}
                          onChange={(e) => setFormData({...formData, billingPostcode: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Postcode"
                        />
                      </div>
                    </div>
                  )}

                  {/* Contact Information Tab */}
                  {activeTab === 'contact' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Contact Name *</label>
                          <input
                            type="text"
                            value={formData.primaryContact}
                            onChange={(e) => setFormData({...formData, primaryContact: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Full name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                          <input
                            type="text"
                            value={formData.contactPosition}
                            onChange={(e) => setFormData({...formData, contactPosition: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Job title"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Office Phone</label>
                          <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 20 1234 5678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                          <input
                            type="tel"
                            value={formData.mobile}
                            onChange={(e) => setFormData({...formData, mobile: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 7123 456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Email *</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="contact@company.com"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Accounts Email</label>
                          <input
                            type="email"
                            value={formData.accountsEmail}
                            onChange={(e) => setFormData({...formData, accountsEmail: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="accounts@company.com"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                          <select
                            value={formData.preferredContactMethod}
                            onChange={(e) => setFormData({...formData, preferredContactMethod: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Email">Email</option>
                            <option value="Phone">Phone</option>
                            <option value="Mobile">Mobile</option>
                            <option value="WhatsApp">WhatsApp</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Manager</label>
                          <input
                            type="text"
                            value={formData.accountManager}
                            onChange={(e) => setFormData({...formData, accountManager: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Internal account manager"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Special Requirements / Notes</label>
                        <textarea
                          value={formData.specialRequirements}
                          onChange={(e) => setFormData({...formData, specialRequirements: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Any special delivery instructions, site access requirements, etc."
                        />
                      </div>
                    </div>
                  )}

                  {/* Financial & Compliance Tab */}
                  {activeTab === 'financial' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Credit Rating</label>
                          <select
                            value={formData.creditRating}
                            onChange={(e) => setFormData({...formData, creditRating: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="A+">A+ (Excellent)</option>
                            <option value="A">A (Very Good)</option>
                            <option value="B+">B+ (Good)</option>
                            <option value="B">B (Average)</option>
                            <option value="C">C (Below Average)</option>
                            <option value="COD">Cash on Delivery Only</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Credit Limit (£)</label>
                          <input
                            type="number"
                            value={formData.creditLimit}
                            onChange={(e) => setFormData({...formData, creditLimit: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Terms (days)</label>
                          <select
                            value={formData.paymentTerms}
                            onChange={(e) => setFormData({...formData, paymentTerms: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>Payment in Advance</option>
                            <option value={7}>7 days</option>
                            <option value={14}>14 days</option>
                            <option value={30}>30 days</option>
                            <option value={45}>45 days</option>
                            <option value={60}>60 days</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Date Registered</label>
                          <input
                            type="date"
                            value={formData.dateRegistered}
                            onChange={(e) => setFormData({...formData, dateRegistered: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Waste Carrier License</label>
                          <input
                            type="text"
                            value={formData.wasteCarrierLicense}
                            onChange={(e) => setFormData({...formData, wasteCarrierLicense: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If applicable"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Expiry Date</label>
                          <input
                            type="date"
                            value={formData.insuranceExpiry}
                            onChange={(e) => setFormData({...formData, insuranceExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="space-y-3 pt-4 border-t">
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.healthSafetyCompliant}
                            onChange={(e) => setFormData({...formData, healthSafetyCompliant: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Health & Safety Compliant</span>
                        </label>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.chasAccredited}
                            onChange={(e) => setFormData({...formData, chasAccredited: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">CHAS Accredited</span>
                        </label>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {customer ? 'Update Customer' : 'Add Customer'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Supplier Form Component
        const SupplierForm = ({ supplier, onClose, onSave }) => {
          const [formData, setFormData] = useState(supplier || {
            companyName: '',
            tradingName: '',
            companyNumber: '',
            vatNumber: '',
            primaryContact: '',
            contactPosition: '',
            phone: '',
            mobile: '',
            email: '',
            accountsEmail: '',
            supplierRating: 'B',
            preferredSupplier: false,
            primaryServices: [],
            wasteCarrierLicense: '',
            wasteCarrierExpiry: '',
            environmentalPermits: '',
            publicLiabilityInsurance: '',
            insuranceExpiry: '',
            insuranceAmount: '',
            serviceAreas: [],
            fleetSize: '',
            skipSizes: [],
            aggregateTypes: [],
            certifications: [],
            bankName: '',
            bankAccountNumber: '',
            bankSortCode: '',
            paymentTerms: 30,
            minimumOrderValue: '',
            accountStatus: 'Active',
            performanceScore: 100,
            dateRegistered: new Date().toISOString().split('T')[0],
            notes: ''
          });

          const [activeTab, setActiveTab] = useState('company');

          const handleSubmit = () => {
            const newSupplier = {
              ...formData,
              id: supplier?.id || `SUPP-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`
            };
            onSave(newSupplier);
          };

          const handleServiceChange = (service, checked) => {
            if (checked) {
              setFormData({...formData, primaryServices: [...formData.primaryServices, service]});
            } else {
              setFormData({...formData, primaryServices: formData.primaryServices.filter(s => s !== service)});
            }
          };

          const handleAreaChange = (area, checked) => {
            if (checked) {
              setFormData({...formData, serviceAreas: [...formData.serviceAreas, area]});
            } else {
              setFormData({...formData, serviceAreas: formData.serviceAreas.filter(a => a !== area)});
            }
          };

          const handleCertChange = (cert, checked) => {
            if (checked) {
              setFormData({...formData, certifications: [...formData.certifications, cert]});
            } else {
              setFormData({...formData, certifications: formData.certifications.filter(c => c !== cert)});
            }
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{supplier ? 'Edit Supplier' : 'Add New Supplier'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('company')}
                    className={`px-6 py-3 font-medium ${activeTab === 'company' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Company Details
                  </button>
                  <button
                    onClick={() => setActiveTab('services')}
                    className={`px-6 py-3 font-medium ${activeTab === 'services' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Services & Equipment
                  </button>
                  <button
                    onClick={() => setActiveTab('compliance')}
                    className={`px-6 py-3 font-medium ${activeTab === 'compliance' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Compliance & Financial
                  </button>
                </div>

                <div className="p-6">
                  {/* Company Details Tab */}
                  {activeTab === 'company' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                          <input
                            type="text"
                            value={formData.companyName}
                            onChange={(e) => setFormData({...formData, companyName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Legal company name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Trading Name</label>
                          <input
                            type="text"
                            value={formData.tradingName}
                            onChange={(e) => setFormData({...formData, tradingName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If different from company name"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Registration Number</label>
                          <input
                            type="text"
                            value={formData.companyNumber}
                            onChange={(e) => setFormData({...formData, companyNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="12345678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Number *</label>
                          <input
                            type="text"
                            value={formData.vatNumber}
                            onChange={(e) => setFormData({...formData, vatNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="GB123456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Contact Name *</label>
                          <input
                            type="text"
                            value={formData.primaryContact}
                            onChange={(e) => setFormData({...formData, primaryContact: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Full name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                          <input
                            type="text"
                            value={formData.contactPosition}
                            onChange={(e) => setFormData({...formData, contactPosition: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Job title"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Office Phone</label>
                          <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 20 1234 5678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                          <input
                            type="tel"
                            value={formData.mobile}
                            onChange={(e) => setFormData({...formData, mobile: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 7123 456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Email *</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="contact@supplier.com"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Accounts Email</label>
                          <input
                            type="email"
                            value={formData.accountsEmail}
                            onChange={(e) => setFormData({...formData, accountsEmail: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="accounts@supplier.com"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Rating</label>
                          <select
                            value={formData.supplierRating}
                            onChange={(e) => setFormData({...formData, supplierRating: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="A+">A+ (Excellent)</option>
                            <option value="A">A (Very Good)</option>
                            <option value="A-">A- (Good)</option>
                            <option value="B+">B+ (Above Average)</option>
                            <option value="B">B (Average)</option>
                            <option value="C">C (Below Average)</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Status</label>
                          <select
                            value={formData.accountStatus}
                            onChange={(e) => setFormData({...formData, accountStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Closed">Closed</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Performance Score</label>
                          <input
                            type="number"
                            value={formData.performanceScore}
                            onChange={(e) => setFormData({...formData, performanceScore: parseInt(e.target.value) || 100})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            min="0"
                            max="100"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.preferredSupplier}
                            onChange={(e) => setFormData({...formData, preferredSupplier: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Preferred Supplier</span>
                        </label>
                      </div>
                    </div>
                  )}

                  {/* Services & Equipment Tab */}
                  {activeTab === 'services' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Primary Services</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {['Skip Hire', 'Waste Collection', 'Aggregates Supply', 'Recycling', 'Hazardous Waste', 
                            'Muck Away', 'Grab Hire', 'Roll-on Roll-off', 'Tipper Hire', 'Plant Hire', 'Haulage', 'Transport'].map(service => (
                            <label key={service} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.primaryServices.includes(service)}
                                onChange={(e) => handleServiceChange(service, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{service}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Service Areas</label>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                          {['London', 'South East', 'South West', 'Midlands', 'North West', 'North East', 
                            'Scotland', 'Wales', 'Northern Ireland', 'National Coverage'].map(area => (
                            <label key={area} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.serviceAreas?.includes(area) || false}
                                onChange={(e) => handleAreaChange(area, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{area}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Fleet Size</label>
                          <select
                            value={formData.fleetSize}
                            onChange={(e) => setFormData({...formData, fleetSize: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="">Select fleet size</option>
                            <option value="1-5">1-5 vehicles</option>
                            <option value="6-10">6-10 vehicles</option>
                            <option value="11-20">11-20 vehicles</option>
                            <option value="21-50">21-50 vehicles</option>
                            <option value="50+">50+ vehicles</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Minimum Order Value (£)</label>
                          <input
                            type="number"
                            value={formData.minimumOrderValue}
                            onChange={(e) => setFormData({...formData, minimumOrderValue: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="0.00"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Skip Sizes Available</label>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                          {['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', 
                            '12 yard', '12 yard enclosed', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'].map(size => (
                            <label key={size} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.skipSizes?.includes(size) || false}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setFormData({...formData, skipSizes: [...(formData.skipSizes || []), size]});
                                  } else {
                                    setFormData({...formData, skipSizes: (formData.skipSizes || []).filter(s => s !== size)});
                                  }
                                }}
                                className="mr-2"
                              />
                              <span className="text-sm">{size}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Aggregate Types</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {['Type 1 Sub Base', 'Type 2 Sub Base', 'Ballast', 'Sharp Sand', 'Building Sand', 
                            'Topsoil', 'Shingle', 'Crushed Concrete', 'Scalping', 'Gabion Stone'].map(type => (
                            <label key={type} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.aggregateTypes?.includes(type) || false}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setFormData({...formData, aggregateTypes: [...(formData.aggregateTypes || []), type]});
                                  } else {
                                    setFormData({...formData, aggregateTypes: (formData.aggregateTypes || []).filter(t => t !== type)});
                                  }
                                }}
                                className="mr-2"
                              />
                              <span className="text-sm">{type}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea
                          value={formData.notes}
                          onChange={(e) => setFormData({...formData, notes: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Special equipment, unique services, operational notes..."
                        />
                      </div>
                    </div>
                  )}

                  {/* Compliance & Financial Tab */}
                  {activeTab === 'compliance' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Waste Carrier License *</label>
                          <input
                            type="text"
                            value={formData.wasteCarrierLicense}
                            onChange={(e) => setFormData({...formData, wasteCarrierLicense: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="CBDU123456"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">License Expiry Date</label>
                          <input
                            type="date"
                            value={formData.wasteCarrierExpiry}
                            onChange={(e) => setFormData({...formData, wasteCarrierExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Environmental Permits</label>
                        <textarea
                          value={formData.environmentalPermits}
                          onChange={(e) => setFormData({...formData, environmentalPermits: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={2}
                          placeholder="List any environmental permits held..."
                        />
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Public Liability Insurance</label>
                          <input
                            type="text"
                            value={formData.publicLiabilityInsurance}
                            onChange={(e) => setFormData({...formData, publicLiabilityInsurance: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Policy number"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Expiry Date</label>
                          <input
                            type="date"
                            value={formData.insuranceExpiry}
                            onChange={(e) => setFormData({...formData, insuranceExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Cover Amount (£)</label>
                        <select
                          value={formData.insuranceAmount}
                          onChange={(e) => setFormData({...formData, insuranceAmount: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select amount</option>
                          <option value="1000000">£1,000,000</option>
                          <option value="2000000">£2,000,000</option>
                          <option value="5000000">£5,000,000</option>
                          <option value="10000000">£10,000,000</option>
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Certifications & Accreditations</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {['ISO 9001', 'ISO 14001', 'ISO 45001', 'FORS Bronze', 'FORS Silver', 'FORS Gold', 
                            'CHAS', 'SafeContractor', 'Constructionline', 'CLOCS'].map(cert => (
                            <label key={cert} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.certifications?.includes(cert) || false}
                                onChange={(e) => handleCertChange(cert, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{cert}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="pt-4 border-t">
                        <h4 className="font-medium text-gray-900 mb-3">Bank Details</h4>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                            <input
                              type="text"
                              value={formData.bankName}
                              onChange={(e) => setFormData({...formData, bankName: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                            <input
                              type="text"
                              value={formData.bankAccountNumber}
                              onChange={(e) => setFormData({...formData, bankAccountNumber: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="12345678"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Sort Code</label>
                            <input
                              type="text"
                              value={formData.bankSortCode}
                              onChange={(e) => setFormData({...formData, bankSortCode: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="12-34-56"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Terms (days)</label>
                          <select
                            value={formData.paymentTerms}
                            onChange={(e) => setFormData({...formData, paymentTerms: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>Payment on Delivery</option>
                            <option value={7}>7 days</option>
                            <option value={14}>14 days</option>
                            <option value={30}>30 days</option>
                            <option value={45}>45 days</option>
                            <option value={60}>60 days</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Date Registered</label>
                          <input
                            type="date"
                            value={formData.dateRegistered}
                            onChange={(e) => setFormData({...formData, dateRegistered: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {supplier ? 'Update Supplier' : 'Add Supplier'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Quote Form Component
        const QuoteForm = ({ quote, onClose, onSave, customers, suppliers }) => {
          const { wasteTypes } = useWasteTypes();
          const [formData, setFormData] = useState(quote || {
            customerName: '',
            customerContact: '',
            customerEmail: '',
            customerPhone: '',
            jobType: 'Skip Hire',
            wasteType: '',
            skipSize: '',
            aggregateType: '',
            quantity: 1,
            unit: 'skip',
            price: 0,
            validUntil: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0], // 30 days from now
            siteAddress: '',
            sitePostcode: '',
            deliveryDate: '',
            notes: '',
            status: 'PENDING'
          });

          const skipSizes = ['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', 
                             '12 yard', '12 yard enclosed', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'];
          const roroSizes = ['20 yard', '40 yard'];

          // Auto-set unit to tonnes for Aggregates
          useEffect(() => {
            if (formData.jobType === 'Aggregates' && formData.unit !== 'tonnes') {
              setFormData({...formData, unit: 'tonnes'});
            }
          }, [formData.jobType]);

          const generateQuoteNumber = () => {
            const year = new Date().getFullYear();
            const lastQuoteNumber = parseInt(localStorage.getItem('lastQuoteNumber') || '0');
            const newQuoteNumber = lastQuoteNumber + 1;
            localStorage.setItem('lastQuoteNumber', newQuoteNumber.toString());
            return `QT-${year}-${String(newQuoteNumber).padStart(4, '0')}`;
          };

          const handleSubmit = () => {
            const newQuoteNumber = quote?.id || generateQuoteNumber();
            const newQuote = {
              ...formData,
            id: newQuoteNumber,
            quoteNumber: quote?.quoteNumber || newQuoteNumber,
              createdDate: quote?.createdDate || new Date().toISOString().split('T')[0],
              totalPrice: formData.price * formData.quantity
            };
            onSave(newQuote);
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{quote ? 'Edit Quote' : 'Create New Quote'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>

                <div className="p-6 space-y-4">
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Customer Name *</label>
                      <select
                        value={formData.customerName}
                        onChange={(e) => {
                          const customer = customers.find(c => c.companyName === e.target.value);
                          setFormData({
                            ...formData, 
                            customerName: e.target.value,
                            customerContact: customer?.primaryContact || '',
                            customerEmail: customer?.email || '',
                            customerPhone: customer?.phone || ''
                          });
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      >
                        <option value="">Select Customer</option>
                        {customers.map(customer => (
                          <option key={customer.id} value={customer.companyName}>{customer.companyName}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                      <input
                        type="text"
                        value={formData.customerContact}
                        onChange={(e) => setFormData({...formData, customerContact: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                      <input
                        type="email"
                        value={formData.customerEmail}
                        onChange={(e) => setFormData({...formData, customerEmail: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                      <input
                        type="tel"
                        value={formData.customerPhone}
                        onChange={(e) => setFormData({...formData, customerPhone: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Job Type *</label>
                      <select
                        value={formData.jobType}
                        onChange={(e) => setFormData({...formData, jobType: e.target.value, wasteType: '', skipSize: '', aggregateType: ''})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      >
                        <option value="Skip Hire">Skip Hire</option>
                        <option value="Aggregates">Aggregates</option>
                        <option value="Waste Collection">Waste Collection</option>
                        <option value="Grab Hire">Grab Hire</option>
                        <option value="Muck Away">Muck Away</option>
                        <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Valid Until *</label>
                      <input
                        type="date"
                        value={formData.validUntil}
                        onChange={(e) => setFormData({...formData, validUntil: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>

                  {formData.jobType === 'Skip Hire' && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Skip Size</label>
                        <select
                          value={formData.skipSize}
                          onChange={(e) => setFormData({...formData, skipSize: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select size</option>
                          {skipSizes.map(size => (
                            <option key={size} value={size}>{size}</option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Waste Type</label>
                        <select
                          value={formData.wasteType}
                          onChange={(e) => setFormData({...formData, wasteType: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select type</option>
                          {wasteTypes['Skip Hire']?.map(type => (
                            <option key={type} value={type}>{type}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  )}

                  {formData.jobType === 'Roll-on Roll-off' && (
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">RoRo Size</label>
                        <select
                          value={formData.skipSize}
                          onChange={(e) => setFormData({...formData, skipSize: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select size</option>
                          {roroSizes.map(size => (
                            <option key={size} value={size}>{size}</option>
                          ))}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Waste Type</label>
                        <select
                          value={formData.wasteType}
                          onChange={(e) => setFormData({...formData, wasteType: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select type</option>
                          {wasteTypes['Roll-on Roll-off']?.map(type => (
                            <option key={type} value={type}>{type}</option>
                          ))}
                        </select>
                      </div>
                    </div>
                  )}

                  {formData.jobType === 'Aggregates' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Aggregate Type</label>
                      <select
                        value={formData.aggregateType}
                        onChange={(e) => setFormData({...formData, aggregateType: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      >
                        <option value="">Select type</option>
                        {wasteTypes['Aggregates']?.map(type => (
                          <option key={type} value={type}>{type}</option>
                        ))}
                      </select>
                    </div>
                  )}

                  {(formData.jobType === 'Grab Hire' || formData.jobType === 'Muck Away' || formData.jobType === 'Waste Collection') && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Waste Type</label>
                      <select
                        value={formData.wasteType}
                        onChange={(e) => setFormData({...formData, wasteType: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      >
                        <option value="">Select type</option>
                        {wasteTypes[formData.jobType]?.map(type => (
                          <option key={type} value={type}>{type}</option>
                        ))}
                      </select>
                    </div>
                  )}

                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                      <input
                        type="number"
                        value={formData.quantity}
                        onChange={(e) => setFormData({...formData, quantity: parseFloat(e.target.value) || 0})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                      <select
                        value={formData.unit}
                        onChange={(e) => setFormData({...formData, unit: e.target.value})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        disabled={formData.jobType === 'Aggregates'}
                      >
                        <option value="skip">Skip</option>
                        <option value="tonnes">Tonnes</option>
                        <option value="loads">Loads</option>
                        <option value="collections">Collections</option>
                        <option value="days">Days</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-1">Unit Price (£) *</label>
                      <input
                        type="number"
                        step="0.01"
                        value={formData.price}
                        onChange={(e) => setFormData({...formData, price: parseFloat(e.target.value) || 0})}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Site Address</label>
                    <input
                      type="text"
                      value={formData.siteAddress}
                      onChange={(e) => setFormData({...formData, siteAddress: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                      placeholder="Delivery/collection address"
                    />
                    <input
                      type="text"
                      value={formData.sitePostcode}
                      onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="Postcode"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Proposed Delivery Date</label>
                    <input
                      type="date"
                      value={formData.deliveryDate}
                      onChange={(e) => setFormData({...formData, deliveryDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea
                      value={formData.notes}
                      onChange={(e) => setFormData({...formData, notes: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      rows={3}
                      placeholder="Any additional information..."
                    />
                  </div>

                  {formData.price > 0 && formData.quantity > 0 && (
                    <div className="bg-blue-50 p-4 rounded-lg">
                      <div className="flex justify-between items-center">
                        <span className="font-medium text-blue-900">Total Quote Value:</span>
                        <span className="text-2xl font-bold text-blue-600">
                          £{(formData.price * formData.quantity).toFixed(2)}
                        </span>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {quote ? 'Update Quote' : 'Create Quote'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Root Component
        const WasteManagementDemo = () => {
          return (
            <WasteTypesProvider>
              <AuthProvider>
                <App />
              </AuthProvider>
            </WasteTypesProvider>
          );
        };

        // Render the app
        ReactDOM.render(<WasteManagementDemo />, document.getElementById('root'));
    </script>
<script>
</script>
<script>
// Check for Sage OAuth success FIRST - BEFORE ANYTHING ELSE
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('sage_success') === 'true') {
    const accessToken = urlParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token');
    
    if (accessToken && refreshToken) {
        // Save tokens to localStorage temporarily
        localStorage.setItem('sage_temp_access_token', accessToken);
        localStorage.setItem('sage_temp_refresh_token', refreshToken);
        localStorage.setItem('sage_oauth_complete', 'true');
        
        // Clean URL and redirect to login
        window.location.href = '/?sage_connection_pending=true';
    }
}

// Wait for Supabase to load
if (typeof window.supabase === 'undefined') {
    console.error('Supabase library not loaded!');
    alert('Supabase library not loaded!');
} else {
    // Initialize Supabase
    const SUPABASE_URL = 'https://ykpbnrjlqlhckmgcoulv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcGJucmpscWxoY2ttZ2NvdWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzE0OTAsImV4cCI6MjA2ODQwNzQ5MH0.YSt9xxYSskCp98iJDN0iQ5nNDRbI_EQWNnImcBxVBRU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase;
    // Handle OAuth callback if we're on the callback URL
if (window.location.pathname.includes('/api/sage-callback') ||
    (window.location.search.includes('code='))) {
  // We're on the OAuth callback
  document.getElementById('root').innerHTML = `
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4">Completing Sage connection...</p>
      </div>
    </div>
  `;
  
  // Wait for OAuth handler to be defined
  setTimeout(() => {
    if (window.SageOAuthHandler) {
      window.SageOAuthHandler.handleCallback();
    } else {
      console.error('OAuth handler not ready');
      window.location.href = '/';
    }
  }, 100);
}
    // Add this after line 4921 (window.supabase = supabase;)

// Function to load documents from Supabase
window.loadDocumentsFromSupabase = async function() {
    try {
        console.log('Loading documents from Supabase...');
        
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading documents:', error);
            return;
        }
        
        if (data && data.length > 0) {
            console.log(`Loaded ${data.length} documents`);
            
            // Find the documents list container
            const docsList = document.querySelector('#docs-list');
            if (docsList) {
                // Clear existing content except the sample
                docsList.innerHTML = '';
                
                // Add each document
                data.forEach(doc => {
                    const docDiv = document.createElement('div');
                    docDiv.className = 'bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow';
                    docDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2">${doc.name || 'Untitled'}</h3>
                        <p class="text-gray-600 text-sm mb-3">${doc.type || 'Document'}</p>
                        <div class="flex gap-2">
                            <a href="${doc.file_url}" target="_blank" 
                               class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                View
                            </a>
                            <button onclick="deleteDocument('${doc.id}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                Delete
                            </button>
                        </div>
                    `;
                    docDiv.setAttribute('data-type', doc.type?.toLowerCase() || '');
                    docsList.appendChild(docDiv);
                });
            }
        } else {
            console.log('No documents found');
        }
    } catch (error) {
        console.error('Error in loadDocumentsFromSupabase:', error);
    }
};
// Function to complete pending Sage connection
async function checkPendingSageConnection() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check if we have pending Sage connection
    if (urlParams.get('sage_connection_pending') === 'true' || localStorage.getItem('sage_oauth_complete') === 'true') {
        const accessToken = localStorage.getItem('sage_temp_access_token');
        const refreshToken = localStorage.getItem('sage_temp_refresh_token');
        
        if (accessToken && refreshToken) {
            try {
                // Save tokens to your database
                await window.supabase
                    .from('company_settings')
                    .upsert([
                        { setting_name: 'sage_access_token', setting_value: accessToken },
                        { setting_name: 'sage_refresh_token', setting_value: refreshToken },
                        { setting_name: 'sage_connected', setting_value: 'true' }
                    ]);
                
                // Clean up temporary storage
                localStorage.removeItem('sage_temp_access_token');
                localStorage.removeItem('sage_temp_refresh_token');
                localStorage.removeItem('sage_oauth_complete');
                
                // Set permanent connection flag
                localStorage.setItem('sage_connected', 'true');
                
                // Clean URL and show success
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('Successfully connected to Sage!');
                
                // Redirect to Sage integration page
                window.location.href = '/#sage-integration';
                
            } catch (error) {
                console.error('Error saving Sage tokens:', error);
                alert('Error completing Sage connection');
            }
        }
    }
}

// Load documents when user is authenticated
supabase.auth.getSession().then(({ data: { session } }) => {
  if (session) {
    console.log('User is authenticated, loading documents...');
    window.loadDocumentsFromSupabase();
    
    // Add delay and logging to ensure it runs
    setTimeout(() => {
        console.log('Checking for pending Sage connection...');
        checkPendingSageConnection();
    }, 1000);
}
});
// Also modify your upload function to refresh the list after upload
// Find your uploadDocument function and add this at the end of the success case:
// window.loadDocumentsFromSupabase();
    // Document upload function
    window.documentManager = {
   async uploadDocument() {
    const docType = document.getElementById('doc-category')?.value;
    const docTitle = document.getElementById('doc-title')?.value;
    const fileInput = document.getElementById('doc-file');
    const file = fileInput?.files[0];
    
    if (!docType || !docTitle || !file) {
        alert('Please fill all fields');
        return;
    }
    
    try {
        const fileName = `${Date.now()}_${file.name}`;
        const { data: fileData, error: fileError } = await supabase.storage
            .from('documents')
            .upload(fileName, file);
        
        if (fileError) throw fileError;
        
        const { data: { publicUrl } } = supabase.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        const { data, error } = await supabase
            .from('documents')
            .insert([{
                name: docTitle,
                file_path: fileName,
                file_url: publicUrl,
                file_type: docType,
                file_size: file.size,
                category: 'TEXT'
            }])
            .select();
        
        if (error) throw error;
        // Show success message
alert('Document uploaded successfully!');

// Update the display directly
const container = document.getElementById('docs-list');
if (container) {
  const docDiv = document.createElement('div');
  docDiv.className = 'border rounded-lg p-4';
  docDiv.innerHTML = 
    '<h4 class="font-semibold">' + docTitle + '</h4>' +
    '<p class="text-sm text-gray-600">Type: ' + docType + '</p>' +
    '<p class="text-sm text-gray-600">Uploaded: ' + new Date().toLocaleDateString() + '</p>' +
    '<a href="' + publicUrl + '" target="_blank" class="text-blue-500">View/Download</a>';
  container.appendChild(docDiv);
  
  // Hide the sample document
  const sample = document.querySelector('h4.font-semibold');
  if (sample && sample.textContent.includes('Sample Policy')) {
    sample.parentElement.style.display = 'none';
  }
}
        document.getElementById('doc-title').value = '';
        document.getElementById('doc-file').value = '';
        
       if (window.refreshDocuments) window.refreshDocuments();
        
        // Refresh the page to show the new document
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    }
}
    };
}
</script>
<!-- Your existing content -->

<script>
function connectToSagePopup() {
    const width = 600;
    const height = 700;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;
    
    const popup = window.open(
        '/api/sage-auth',
        'sage_oauth',
        `width=${width},height=${height},left=${left},top=${top}`
    );
    
    if (!popup) {
        alert('Please allow popups to connect to Sage');
        return;
    }
    
    const checkInterval = setInterval(() => {
        if (popup.closed) {
            clearInterval(checkInterval);
            checkPendingSageConnection();
        }
    }, 1000);
}

window.addEventListener('message', async (event) => {
    if (event.data.type === 'sage-oauth-complete') {
        console.log('Received OAuth tokens from popup');
        
        const { tokens } = event.data;
        const expiresAt = new Date(Date.now() + (tokens.expires_in * 1000)).toISOString();
        
        try {
            // Update each setting individually with proper upsert
            const settings = [
                { setting_name: 'sage_access_token', setting_value: tokens.access_token },
                { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token },
                { setting_name: 'sage_token_expires_at', setting_value: expiresAt },
                { setting_name: 'sage_connected', setting_value: 'true' }
            ];
            
            for (const setting of settings) {
                const { error } = await window.supabase
                    .from('company_settings')
                    .upsert(setting, { 
                        onConflict: 'setting_name'
                    });
                
                if (error) {
                    console.error('Error upserting:', setting.setting_name, error);
                }
            }
            
            localStorage.setItem('sage_connected', 'true');
            alert('Successfully connected to Sage!');
            // Don't reload to avoid logout
            // window.location.reload();
            
        } catch (error) {
            console.error('Error saving tokens:', error);
            alert('Error saving Sage connection. Please try again.');
        }
    } else if (event.data.type === 'sage-oauth-error') {
        console.error('OAuth error:', event.data.error);
        alert(`Failed to connect to Sage: ${event.data.error}`);
    }
});
</script>
</script>
</body>
</html>
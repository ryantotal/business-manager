<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Waste Services - Construction Broker Demo</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
    /* Custom CSS Variables for theming */
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
    }

    /* Apply primary color to common elements */
    .bg-blue-600 {
        background-color: var(--primary-color) !important;
    }

    .text-blue-600 {
        color: var(--primary-color) !important;
    }

    .border-blue-500 {
        border-color: var(--primary-color) !important;
    }

    .bg-blue-500 {
        background-color: var(--primary-color) !important;
    }

    .text-blue-500 {
        color: var(--primary-color) !important;
    }

    .hover\:bg-blue-700:hover {
        background-color: var(--primary-hover) !important;
    }
    /* Prevent horizontal scrolling/bouncing */
html, body {
  overflow-x: hidden;
  max-width: 100vw;
  overscroll-behavior-x: none;
}
</style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;
        
        // Lucide React Icons as components
        const LucideIcon = ({ icon, size = 24, className = "" }) => {
            const icons = {
                Plus: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
                X: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
                Search: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>,
                User: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
                Users: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
                Phone: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>,
                Mail: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="4" width="20" height="16" rx="2"></rect><path d="m22 7-10 5L2 7"></path></svg>,
                Truck: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M10 17h4V5H2v12h3"></path><circle cx="7.5" cy="17.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle><path d="M14 12h5l3 3v4h-8v-7z"></path></svg>,
                BarChart3: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>,
                Grid: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
                Settings: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6m4.22-10.22l4.24 4.24M6.34 6.34l4.24 4.24m10.61 4.88l-4.24 4.24M6.34 17.66l4.24-4.24M1 12h6m6 0h6"></path></svg>,
                Activity: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
                DollarSign: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
                TrendingUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
                Recycle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 19H4.815a1.83 1.83 0 0 1-1.57-.881 1.785 1.785 0 0 1-.004-1.784L7.196 9.5"></path><path d="m11 19-2 2m2-2 2 2"></path><path d="M18.5 8H20a2 2 0 0 1 0 4h-2.5l4 4"></path><path d="m2 18 4-4"></path><path d="M12 8V5c0-1.1.9-2 2-2h3"></path><path d="m16 2 4 4-4 4"></path></svg>,
                Loader: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`${className} animate-spin`}><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>,
                LogOut: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>,
                Trash2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
                Mountain: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m8 3 4 8 5-5 5 15H2L8 3z"></path></svg>,
                Star: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
                Layout: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>,
                Palette: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>,
                Calendar: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
                Copy: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>,
                CheckCircle: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg>,
                Edit3: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>,
                Filter: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
                ChevronDown: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"></polyline></svg>,
                ChevronUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
                ChevronUp: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="18 15 12 9 6 15"></polyline></svg>,
                Menu: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>,  
                Repeat: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>,
                Maximize2: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><line x1="21" y1="3" x2="14" y2="10"></line><line x1="3" y1="21" x2="10" y2="14"></line></svg>,
                Package: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
                FileText: <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            };
            
            return icons[icon] || null;
        };
// Searchable Dropdown Component
const SearchableDropdown = ({ 
  options = [], 
  value, 
  onChange, 
  placeholder = "Select...", 
  displayField = "name",
  valueField = "name",
  className = ""
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredProducts, setFilteredProducts] = useState(options);

  useEffect(() => {
    // Sort options alphabetically and filter by search term
    const sorted = [...options].sort((a, b) => {
      const aName = a[displayField] || '';
      const bName = b[displayField] || '';
      return aName.localeCompare(bName);
    });
    
    const filtered = sorted.filter(option => {
      const optionText = option[displayField] || '';
      return optionText.toLowerCase().includes(searchTerm.toLowerCase());
    });
    
   setFilteredProducts(filtered);
  }, [options, searchTerm, displayField]);

  const handleSelect = (option) => {
    onChange(option[valueField]);
    setIsOpen(false);
    setSearchTerm('');
  };

  const selectedOption = options.find(opt => opt[valueField] === value);

  return (
    <div className="relative">
      <div
        className={`w-full px-3 py-2 border border-gray-300 rounded-lg cursor-pointer bg-white ${className}`}
        onClick={() => setIsOpen(!isOpen)}
      >
        <div className="flex items-center justify-between">
          <span className={value ? 'text-gray-900' : 'text-gray-500'}>
            {selectedOption ? selectedOption[displayField] : placeholder}
          </span>
          <ChevronDown size={16} className={`transform transition-transform ${isOpen ? 'rotate-180' : ''}`} />
        </div>
      </div>
      
      {isOpen && (
        <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-hidden">
          <div className="p-2 border-b">
            <input
              type="text"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="Type to search..."
              className="w-full px-2 py-1 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              autoFocus
            />
          </div>
          <div className="max-h-48 overflow-y-auto">
       {filteredProducts.length === 0 ? (
  <div className="px-3 py-2 text-gray-500 text-sm">No options found</div>
) : (
  filteredProducts.map((option, index) => (
    <div
      key={option.id || index}
      className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b border-gray-100 last:border-b-0"
      onClick={() => handleSelect(option)}
    >
      {option[displayField]}
    </div>
  ))
)}
          </div>
        </div>
      )}
    </div>
  );
};

// Sage Product Selector Component
const SageProductSelector = ({ jobType, selectedProduct, onSelect, products }) => {
  const [loading, setLoading] = useState(true);
  const [searchTerm, setSearchTerm] = useState('');

  // Smart filtering based on job type and waste type
const getFilteredProducts = () => {
  if (products.length === 0) {
    return [];
  }

  let filtered = products;

  // Filter by search term only
  if (searchTerm) {
    filtered = filtered.filter(p => {
      const searchLower = searchTerm.toLowerCase();
      
      // Safe string conversion - handle null/undefined values
      const nameLower = (p.name || '').toString().toLowerCase();
      const descLower = (p.description || '').toString().toLowerCase();
      const codeLower = (p.item_code || '').toString().toLowerCase();
      
      return nameLower.includes(searchLower) || 
             descLower.includes(searchLower) || 
             codeLower.includes(searchLower) ||
             nameLower.replace(/\s+/g, '').includes(searchLower) ||
             searchLower.split(' ').every(word => nameLower.includes(word));
    });
  }

  // Sort alphabetically by name
  return filtered.sort((a, b) => {
    const aName = (a.name || '').toString();
    const bName = (b.name || '').toString();
    return aName.localeCompare(bName);
  });
};
  const filteredProducts = getFilteredProducts();
  const selectedProductDetails = products.find(p => p.sage_id === selectedProduct);

  if (products.length === 0) {
    return (
      <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-500">
        Loading Sage products...
      </div>
    );
  }

  if (products.length === 0) {
    return (
      <div className="w-full px-3 py-2 border border-red-300 rounded-lg bg-red-50 text-red-600">
        No Sage products found. Please sync products in Admin Panel first.
      </div>
    );
  }

  return (
    <div className="space-y-2">
      {/* Search input */}
      <div className="relative">
        <Search size={16} className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" />
        <input
          type="text"
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          placeholder="Search Sage products/services..."
          className="w-full pl-10 pr-3 py-2 border border-gray-300 rounded-lg text-sm"
        />
      </div>

      {/* Selected product display */}
      {selectedProductDetails && (
        <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div className="flex items-center justify-between">
            <div>
              <div className="font-medium text-blue-900">{selectedProductDetails.name}</div>
              <div className="text-sm text-blue-700">Code: {selectedProductDetails.item_code}</div>
            </div>
            <button
              onClick={() => onSelect('', '')}
              className="text-blue-600 hover:text-blue-800"
            >
              <X size={16} />
            </button>
          </div>
        </div>
      )}

      {/* Product list */}
      <div className="max-h-48 overflow-y-auto border border-gray-300 rounded-lg">
        {filteredProducts.length === 0 ? (
          <div className="p-3 text-gray-500 text-sm">No products match your search</div>
        ) : (
          filteredProducts.map((product, index) => {
            const isRecommended = index < 3 && !searchTerm;
            return (
              <div
                key={product.id}
                className={`p-3 border-b border-gray-200 last:border-b-0 cursor-pointer hover:bg-gray-50 ${
                  isRecommended ? 'bg-green-50' : ''
                }`}
                onClick={() => onSelect(product)}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium text-gray-900">
                      {product.name}
                      {isRecommended && (
                        <span className="ml-2 text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">
                          Recommended
                        </span>
                      )}
                    </div>
                    <div className="text-sm text-gray-600">
                      Code: {product.item_code} | Type: {product.type}
                    </div>
                    {product.description && (
                      <div className="text-xs text-gray-500 mt-1">{product.description}</div>
                    )}
                  </div>
                </div>
              </div>
            );
          })
        )}
      </div>

      <div className="text-xs text-gray-500">
        {products.length} products available from Sage
      </div>
    </div>
  );
};
        // Create icon components
        const Plus = (props) => <LucideIcon icon="Plus" {...props} />;
        const X = (props) => <LucideIcon icon="X" {...props} />;
        const Search = (props) => <LucideIcon icon="Search" {...props} />;
        const User = (props) => <LucideIcon icon="User" {...props} />;
        const Users = (props) => <LucideIcon icon="Users" {...props} />;
        const Phone = (props) => <LucideIcon icon="Phone" {...props} />;
        const Mail = (props) => <LucideIcon icon="Mail" {...props} />;
        const Truck = (props) => <LucideIcon icon="Truck" {...props} />;
        const BarChart3 = (props) => <LucideIcon icon="BarChart3" {...props} />;
        const Grid = (props) => <LucideIcon icon="Grid" {...props} />;
        const Settings = (props) => <LucideIcon icon="Settings" {...props} />;
        const Activity = (props) => <LucideIcon icon="Activity" {...props} />;
        const DollarSign = (props) => <LucideIcon icon="DollarSign" {...props} />;
        const TrendingUp = (props) => <LucideIcon icon="TrendingUp" {...props} />;
        const Recycle = (props) => <LucideIcon icon="Recycle" {...props} />;
        const Loader = (props) => <LucideIcon icon="Loader" {...props} />;
        const LogOut = (props) => <LucideIcon icon="LogOut" {...props} />;
        const Trash2 = (props) => <LucideIcon icon="Trash2" {...props} />;
        const Mountain = (props) => <LucideIcon icon="Mountain" {...props} />;
        const Star = (props) => <LucideIcon icon="Star" {...props} />;
        const Layout = (props) => <LucideIcon icon="Layout" {...props} />;
        const Palette = (props) => <LucideIcon icon="Palette" {...props} />;
        const Calendar = (props) => <LucideIcon icon="Calendar" {...props} />;
        const Copy = (props) => <LucideIcon icon="Copy" {...props} />;
        const Edit3 = (props) => <LucideIcon icon="Edit3" {...props} />;
        const Filter = (props) => <LucideIcon icon="Filter" {...props} />;
        const ChevronDown = (props) => <LucideIcon icon="ChevronDown" {...props} />;
        const ChevronUp = (props) => <LucideIcon icon="ChevronUp" {...props} />;
        const Menu = (props) => <LucideIcon icon="Menu" {...props} />;
        const Repeat = (props) => <LucideIcon icon="Repeat" {...props} />;
        const Package = (props) => <LucideIcon icon="Package" {...props} />;
        const Maximize2 = (props) => <LucideIcon icon="Maximize2" {...props} />;
        const FileText = (props) => <LucideIcon icon="FileText" {...props} />;

        // Demo Data
        const demoUsers = [
          { id: '1', email: 'admin@totalwaste.co.uk', password: 'demo123', firstName: 'System', lastName: 'Administrator', role: 'ADMIN' },
          { id: '2', email: 'manager@totalwaste.co.uk', password: 'demo123', firstName: 'Sarah', lastName: 'Johnson', role: 'MANAGER' },
          { id: '3', email: 'broker@totalwaste.co.uk', password: 'demo123', firstName: 'Tom', lastName: 'Richards', role: 'BROKER' }
        ];

        // Global state for waste types and aggregate types
        const defaultWasteTypes = {
          'Skip Hire': ['Mixed Construction Waste', 'Inert/Soil', 'Wood', 'Metal', 'Plasterboard', 'Green Waste', 'Mixed Heavy', 'Light Mixed'],
          'Aggregates': ['Type 1 Sub Base', 'Type 2 Sub Base', 'Ballast', 'Sharp Sand', 'Building Sand', 'Topsoil', 'Shingle'],
          'Waste Collection': ['General Waste', 'Dry Mixed Recycling', 'Cardboard', 'Wood', 'Metal', 'WEEE', 'Hazardous'],
          'Roll-on Roll-off': ['Mixed Construction Waste', 'Inert/Soil', 'Wood', 'Metal', 'Mixed Heavy'],
          'Grab Hire': ['Mixed Construction Waste', 'Inert/Soil', 'Hardcore', 'Green Waste'],
          'Muck Away': ['Clean Soil', 'Mixed Soil', 'Clay', 'Contaminated Soil']
        };

        // Authentication Context
        const AuthContext = createContext();

        const AuthProvider = ({ children }) => {
          const [user, setUser] = useState(null);
          const [isLoading, setIsLoading] = useState(false);

          const login = async (email, password) => {
  setIsLoading(true);
  try {
    const { data, error } = await window.supabase
      .from('users')
      .select('*')
      .eq('email', email)
      .eq('password', password)
      .single();
    
    if (error || !data) {
      throw new Error('Invalid credentials');
    }
    
    // Split the name into first and last for compatibility
    const nameParts = data.name.split(' ');
    const firstName = nameParts[0] || '';
    const lastName = nameParts.slice(1).join(' ') || '';
    
    setUser({
      id: data.id,
      email: data.email,
      firstName: firstName,
      lastName: lastName,
      role: data.role
    });
   
    return true;
  } catch (err) {
    throw new Error('Invalid credentials');
  }
};

          const logout = () => {
            setUser(null);
          };

          const hasPermission = (permission) => {
            if (!user) return false;
            const permissions = {
              ADMIN: ['jobs:create', 'jobs:read', 'jobs:update', 'jobs:delete', 'customers:create', 'customers:read', 'customers:update', 'customers:delete', 'suppliers:create', 'suppliers:read', 'suppliers:update', 'suppliers:delete', 'admin:access', 'quotes:create', 'quotes:read', 'quotes:update', 'quotes:delete'],
              MANAGER: ['jobs:create', 'jobs:read', 'jobs:update', 'jobs:delete', 'customers:create', 'customers:read', 'customers:update', 'customers:delete', 'suppliers:create', 'suppliers:read', 'suppliers:update', 'suppliers:delete', 'quotes:create', 'quotes:read', 'quotes:update'],
              BROKER: ['jobs:create', 'jobs:read', 'jobs:update', 'customers:read', 'suppliers:read', 'quotes:create', 'quotes:read']
            };
            return permissions[user.role]?.includes(permission) || false;
          };

          return (
            <AuthContext.Provider value={{ user, login, logout, isLoading, hasPermission }}>
              {children}
            </AuthContext.Provider>
          );
        };

        const useAuth = () => {
          const context = useContext(AuthContext);
          if (!context) throw new Error('useAuth must be used within AuthProvider');
          return context;
        };

        // Global state context for waste types management
        const WasteTypesContext = createContext();

        const WasteTypesProvider = ({ children }) => {
          const [wasteTypes, setWasteTypes] = useState(defaultWasteTypes);

          const updateWasteTypes = (jobType, types) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: types
            }));
          };

          const addWasteType = (jobType, newType) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: [...(prev[jobType] || []), newType]
            }));
          };

          const deleteWasteType = (jobType, typeToDelete) => {
            setWasteTypes(prev => ({
              ...prev,
              [jobType]: prev[jobType].filter(type => type !== typeToDelete)
            }));
          };

          return (
            <WasteTypesContext.Provider value={{ wasteTypes, updateWasteTypes, addWasteType, deleteWasteType }}>
              {children}
            </WasteTypesContext.Provider>
          );
        };

        const useWasteTypes = () => {
          const context = useContext(WasteTypesContext);
          if (!context) throw new Error('useWasteTypes must be used within WasteTypesProvider');
          return context;
        };

        // Login Component
        const LoginScreen = () => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');
          const { login, isLoading } = useAuth();

          const handleLogin = async () => {
            try {
              setError('');
              await login(email, password);
            } catch (err) {
              setError(err.message);
            }
          };

          return (
            <div className="min-h-screen bg-gray-50 flex items-center justify-center">
              <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8">
                <div className="text-center mb-8">
                  <div className="w-16 h-16 mx-auto mb-4">
  {localStorage.getItem('companyLogo') ? (
    <img 
      src={localStorage.getItem('companyLogo')} 
      alt="Company Logo" 
      className="w-full h-full object-contain"
    />
  ) : (
    <div className="w-full h-full bg-blue-600 rounded-lg flex items-center justify-center">
      <Recycle className="w-8 h-8 text-white" />
    </div>
  )}
</div>
                  <h1 className="text-2xl font-bold text-gray-900">
  {localStorage.getItem('companyName') || 'Total Waste Services'}
</h1>
                  <p className="text-gray-600">System Login</p>
                </div>

                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                    {error}
                  </div>
                )}

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder=""
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      placeholder=""
                    />
                  </div>

                  <button
                    onClick={handleLogin}
                    disabled={isLoading}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center justify-center"
                  >
                    {isLoading ? <Loader className="animate-spin mr-2" size={20} /> : null}
                    Sign In
                  </button>
                </div>

                
              </div>
            </div>
          );
        };

        // Job Form Component
const JobForm = ({ job, onClose, onSave, customers, suppliers, sageProducts, user, addressSuggestions, showAddressSuggestions, setShowAddressSuggestions, handleAddressSearch, contactSuggestions, showContactSuggestions, setShowContactSuggestions, handleContactSearch, phoneSuggestions, showPhoneSuggestions, setShowPhoneSuggestions, handlePhoneSearch }) => {    
 
          const [uploadFile, setUploadFile] = useState(null);
          const [jobAttachments, setJobAttachments] = useState([]);
          // Load attachments when job changes
useEffect(() => {
  if (job?.id) {
    loadJobAttachments(job.id);
  }
}, [job?.id]);
// Close address suggestions when clicking outside
useEffect(() => {
    const handleClickOutside = (event) => {
        if (!event.target.closest('.relative')) {
           setShowAddressSuggestions(false);
setShowContactSuggestions(false);
setShowPhoneSuggestions(false);
        }
    };
    
    if (showAddressSuggestions) {
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }
}, [showAddressSuggestions, setShowAddressSuggestions]);
const loadJobAttachments = async (jobId) => {
  try {
    const { data, error } = await window.supabase
      .from('job_attachments')
      .select('*')
      .eq('job_id', jobId)
      .order('uploaded_at', { ascending: false });
    
    if (error) throw error;
    setJobAttachments(data || []);
  } catch (error) {
    console.error('Error loading attachments:', error);
  }
};
const [attachmentType, setAttachmentType] = useState('Waste Transfer Note');
const handleDeleteAttachment = async (attachmentId) => {
  if (!window.confirm('Are you sure you want to delete this attachment?')) {
    return;
  }
  
  try {
    const { error } = await window.supabase
      .from('job_attachments')
      .delete()
      .eq('id', attachmentId);
    
    if (error) throw error;
    
    alert('Attachment deleted successfully!');
    // Refresh the attachments list
await loadJobAttachments(job.id);

// Also refresh the full page view if it's open
if (window.refreshFullPageAttachments) {
  window.refreshFullPageAttachments();
}
    // Refresh attachments or update state here
  } catch (error) {
    console.error('Error deleting attachment:', error);
    alert('Error deleting attachment: ' + error.message);
  }
};

const handleUploadInForm = async () => {
  const attachmentType = document.getElementById('attachment-type')?.value || 'Waste Transfer Note';
  const fileInput = document.getElementById('attachment-file');
  const file = fileInput?.files[0];

 if (!attachmentType || !file) {
  alert('Please select both an attachment type and a file');
  return;
}

if (!job || !job.id) {
  alert('Please save the job first before uploading attachments.\n\n1. Fill in the job details\n2. Click "Create Job" to save\n3. Then you can add documents to the saved job');
  return;
}

  try {
    const fileName = `job_${job.id}_${Date.now()}_${file.name}`;
    const { data: fileData, error: fileError } = await window.supabase.storage
      .from('documents')
      .upload(fileName, file);

    if (fileError) throw fileError;

    const { data: { publicUrl } } = window.supabase.storage
      .from('documents')
      .getPublicUrl(fileName);

    const { error } = await window.supabase
      .from('job_attachments')
      .insert([{
        job_id: job.id,
        file_name: file.name,
        file_url: publicUrl,
        file_type: attachmentType,
        file_size: file.size,
        uploaded_by: 'System Admin'
      }]);

    if (error) throw error;

    alert('Attachment uploaded successfully!');
    // Also refresh the full page view if it's open
if (window.refreshFullPageAttachments) {
  window.refreshFullPageAttachments();
}
    
    // Only addition - reload attachments
    await loadJobAttachments(job.id);
    
  } catch (error) {
    console.error('Error uploading attachment:', error);
    alert('Error uploading attachment: ' + error.message);
  }
};
          const [formData, setFormData] = useState(job || {
            customerName: '',
            id: job?.id,
            customerPO: '',
            supplierName: '',
            supplierRef: '',
            haulierName: '',
            jobType: 'Skip Hire',
            wasteType: '',
            skipSize: '',
            aggregateType: '',
            quantity: 1,
            unit: 'skip',
            weight: '',
            customerUnitPrice: 0,
            customerFinalPrice: 0,
            supplierUnitPrice: 0,
            supplierFinalPrice: 0,
            vatRate: 20,
            jobDate: job?.jobDate || new Date().toISOString().split('T')[0],
            timeSlot: '',
            collectionDate: '',
            status: 'CONFIRMED',
            priority: 'Medium',
            siteAddress1: '',
siteAddress2: '',
siteCity: '',
sitePostcode: '',
siteContact: '',
sitePhone: '',
siteNotes: '',
            deliveryInstructions: '',
            accessRestrictions: '',
            wasteTransferNote: '',
            hazardousWaste: false,
            consignmentNote: '',
            invoiceNumber: '',
            invoiceStatus: 'Not Invoiced',
            paymentStatus: 'Not Paid',
            notes: '',
            isCompleted: false,
            isCancelled: false,
            sageProductId: '',
            sageProductName: '',
            sage_si_number: ''
          });

          const [activeTab, setActiveTab] = useState('details');

          // Auto-set unit to tonnes for Aggregates
          useEffect(() => {
            if (formData.jobType === 'Aggregates' && formData.unit !== 'tonnes') {
              setFormData({...formData, unit: 'tonnes'});
            }
          }, [formData.jobType]);

          const calculatePrices = () => {
            const customerTotal = formData.customerUnitPrice * formData.quantity;
            const supplierTotal = formData.supplierUnitPrice * formData.quantity;
            setFormData({
              ...formData,
              customerFinalPrice: customerTotal,
              supplierFinalPrice: supplierTotal
            });
          };

          useEffect(() => {
            calculatePrices();
          }, [formData.customerUnitPrice, formData.supplierUnitPrice, formData.quantity]);

          const generateJobNumber = () => {
            const year = new Date().getFullYear();
            const lastJobNumber = parseInt(localStorage.getItem('lastJobNumber') || '0');
            const newJobNumber = lastJobNumber + 1;
            localStorage.setItem('lastJobNumber', newJobNumber.toString());
            return `TWS-${year}-${String(newJobNumber).padStart(4, '0')}`;
          };

    const handleSubmit = () => {
  // Capture complete Sage product details from lineItems
  const sageProductData = formData.lineItems?.map(item => ({
    sage_id: item.sage_id,
    product_name: item.product_name,
    description: item.description,
    item_code: item.item_code,
    type: item.type,
    quantity: item.quantity,
    unit_price: item.customer_price || 0,  // Use RRP from line item
    cost_price: item.supplier_price || 0,  // Use Cost from line item
    sales_ledger_account: item.sales_ledger_account || '4000',
    nominal_code: item.nominal_code || '4000', 
    tax_code: item.tax_code || 'T1',
    vat_rate: formData.vatRate
  })) || [];

  // Check if this is a skip/RoRo with quantity > 1
  if ((formData.jobType === 'Skip Hire' || formData.jobType === 'Roll-on Roll-off') && formData.quantity > 1) {
    const jobs = [];
    const firstJobNumber = generateJobNumber();
    for (let i = 0; i < formData.quantity; i++) {
      const jobId = i === 0 ? firstJobNumber : `${firstJobNumber}-${i+1}`;
      const newJob = {
        ...formData,
        id: jobId,
        jobNumber: jobId,
        quantity: 1,
        customerFinalPrice: formData.customerUnitPrice,
        supplierFinalPrice: formData.supplierUnitPrice,
        grossProfit: formData.customerUnitPrice - formData.supplierUnitPrice,
        profitMargin: formData.customerUnitPrice > 0 ?
          ((formData.customerUnitPrice - formData.supplierUnitPrice) / formData.customerUnitPrice) * 100 : 0,
        jobValue: formData.customerUnitPrice,
        parentJobId: i === 0 ? null : jobs[0].id,
        linkedJobs: [],
        sage_product_data: sageProductData,
        sage_line_items: formData.lineItems
      };
      jobs.push(newJob);
    }
    // Link jobs together
    jobs[0].linkedJobs = jobs.slice(1).map(j => j.id);
    jobs.forEach(job => onSave(job));
  } else {
    const newJobNumber = job?.jobNumber || generateJobNumber();
    const newJob = {
      ...formData,
      jobNumber: newJobNumber,
      grossProfit: formData.customerFinalPrice - formData.supplierFinalPrice,
      profitMargin: formData.customerFinalPrice > 0 ?
        ((formData.customerFinalPrice - formData.supplierFinalPrice) / formData.customerFinalPrice) * 100 : 0,
      jobValue: formData.customerFinalPrice,
      parentJobId: null,
      linkedJobs: [],
      sage_product_data: sageProductData,
      sage_line_items: formData.lineItems
    };
    // Clean up empty date fields to prevent database errors
    if (!newJob.collectionDate || newJob.collectionDate === '') {
      delete newJob.collectionDate;
    }
    if (!newJob.deliveryDate || newJob.deliveryDate === '') {
      delete newJob.deliveryDate;
    }
    if (!newJob.jobDate || newJob.jobDate === '') {
      newJob.jobDate = new Date().toISOString().split('T')[0];
    }
    // Only include ID if we're updating an existing job (not creating new/duplicate)
    // Check if formData has an id - if not, it's a new job
    if (job?.id && formData.id) {
      newJob.id = job.id;
    }
    onSave(newJob);
  }
};

          const skipSizes = ['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', 
                             '12 yard', '12 yard enclosed', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'];
          const roroSizes = ['20 yard', '40 yard'];
          const timeSlots = ['AM (8:00-12:00)', 'PM (12:00-17:00)'];

          // Filter suppliers who provide haulage services
          const hauliers = suppliers.filter(s => 
            s.primaryServices?.includes('Haulage') || 
            s.primaryServices?.includes('Transport')
          );

          return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{job ? 'Edit Job' : 'Add New Job'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('details')}
                    className="px-3 sm:px-6 py-3 text-sm sm:text-base font-medium ${activeTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}"
                  >
                    Job Details
                  </button>
                  <button
                    onClick={() => setActiveTab('site')}
                    className="px-3 sm:px-6 py-3 text-sm sm:text-base font-medium ${activeTab === 'site' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}"
                  >
                    Site Information
                  </button>
                  <button
                    onClick={() => setActiveTab('financial')}
                    className="px-3 sm:px-6 py-3 text-sm sm:text-base font-medium ${activeTab === 'financial' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}"
                  >
                    Pricing & Status
                  </button>
                  <button
                   onClick={() => setActiveTab('documents')}
                   className="px-3 sm:px-6 py-3 text-sm sm:text-base font-medium ${activeTab === 'documents' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}"
>
  Documents
</button>
                </div>

                <div className="p-6">
                  {/* Job Details Tab */}
                  {activeTab === 'details' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
  
  <SearchableDropdown
    options={customers.map(c => ({
      ...c,
      name: c.companyName || c.name
    }))}
    value={formData.customerName}
   onChange={(value) => {
  const customer = customers.find(c => (c.companyName || c.name) === value);
  setFormData({
    ...formData, 
    customerName: value,
    // Add these new fields
    customerReference: customer?.reference || '',
    customerMobile: customer?.mobile || '',
    customerMainContact: customer?.main_contact_name || '',
    customerCreditLimit: customer?.credit_limit || 0,
    customerCreditDays: customer?.credit_days || 30,
    customerDeliveryAddress: customer?.delivery_address || null,
    customerAccountStatus: customer?.account_status || 'Active'
  });
}}
    placeholder={`Select Customer (${customers.length} available)`}
    displayField="name"
    valueField="name"
  />
</div>
{/* Customer Extended Details - Auto-populated */}
{formData.customerName && (() => {
  const customer = customers.find(c => (c.companyName || c.name) === formData.customerName);
  return customer ? (
    <div className="col-span-2 bg-gray-50 rounded-lg p-4 mb-4">
      <h3 className="text-sm font-medium text-gray-700 mb-3">Customer Information</h3>
      <div className="grid grid-cols-2 gap-4 text-sm">
        <div>
          <span className="text-gray-600">Reference:</span>
          <span className="ml-2 font-medium">{customer.reference || '-'}</span>
        </div>
        <div>
          <span className="text-gray-600">Contact:</span>
          <span className="ml-2 font-medium">{customer.main_contact_name || '-'}</span>
        </div>
        <div>
          <span className="text-gray-600">Mobile:</span>
          <span className="ml-2 font-medium">{customer.mobile || '-'}</span>
        </div>
        <div>
          <span className="text-gray-600">Credit:</span>
          <span className="ml-2 font-medium">
            £{customer.credit_limit?.toLocaleString() || '0'} / {customer.credit_days || 30} days
          </span>
        </div>
        {customer.delivery_address && (
          <div className="col-span-2 pt-2 border-t">
            <span className="text-gray-600">Delivery Address:</span>
            <span className="ml-2 font-medium">
              {customer.delivery_address.address_line_1}
              {customer.delivery_address.address_line_2 && `, ${customer.delivery_address.address_line_2}`}
              {customer.delivery_address.city && `, ${customer.delivery_address.city}`}
              {customer.delivery_address.postal_code && ` ${customer.delivery_address.postal_code}`}
            </span>
          </div>
        )}
      </div>
    </div>
  ) : null;
})()}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Customer PO Number</label>
                          <input
                            type="text"
                            value={formData.customerPO}
                            onChange={(e) => setFormData({...formData, customerPO: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Customer purchase order"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Supplier *</label>
  <SearchableDropdown
    options={suppliers.map(s => ({
      ...s,
      name: s.name || s.companyName
    }))}
    value={formData.supplierName}
    onChange={(value) => setFormData({...formData, supplierName: value})}
    placeholder={`Select Supplier (${suppliers.length} available)`}
    displayField="name"
    valueField="name"
  />
</div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Reference</label>
                          <input
                            type="text"
                            value={formData.supplierRef}
                            onChange={(e) => setFormData({...formData, supplierRef: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Supplier job reference"
                          />
                        </div>
                      </div>

                      {formData.jobType === 'Aggregates' && (
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <div>
  <label className="block text-sm font-medium text-gray-700 mb-1">Haulier</label>
  <SearchableDropdown
    options={suppliers.map(s => ({
      ...s,
      name: s.name || s.companyName
    }))}
    value={formData.haulierName}
    onChange={(value) => setFormData({...formData, haulierName: value})}
    placeholder={`Select Haulier (${suppliers.length} available)`}
    displayField="name"
    valueField="name"
  />
</div>
                          </div>
                        </div>
                      )}

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Job Type *</label>
                          <select
                            value={formData.jobType}
                            onChange={(e) => setFormData({...formData, jobType: e.target.value, wasteType: '', skipSize: '', aggregateType: ''})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Skip Hire">Skip Hire</option>
                            <option value="Aggregates">Aggregates</option>
                            <option value="Waste Collection">Waste Collection</option>
                            <option value="Grab Hire">Grab Hire</option>
                            <option value="Muck Away">Muck Away</option>
                            <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                          <select
                            value={formData.priority}
                            onChange={(e) => setFormData({...formData, priority: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Low">Low</option>
                            <option value="Medium">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                          </select>
                        </div>
                      </div>

                    {formData.jobType === 'Skip Hire' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Skip Hire"
        selectedProduct={formData.sageProductName}
       onSelect={(product) => {
        console.log('Selected product full object:', product);
console.log('Product sage_id:', product.sage_id);
console.log('Product item_code:', product.item_code);
         alert('Adding product: ' + product.name); 
  setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
  const newLineItem = {
  id: Date.now(),
  sage_id: product.sage_id,
  product_name: product.name,
  description: product.description || product.name,
  item_code: product.item_code,
  type: product.type,
  quantity: 1,
  supplier_price: 0.00,  // Add this line
  customer_price: 0.00,  // Add this line
  unit_price: 0.00,
  discount: 0.00,
  vat_rate: 20,
  total: 0.00,
  sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
};
  const updatedLineItems = [...(formData.lineItems || []), newLineItem];
  setFormData({...formData, lineItems: updatedLineItems});
}}
        products={sageProducts}
      />
    </div>
  </div>
)}
{formData.jobType === 'Roll-on Roll-off' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Roll-on Roll-off"
        selectedProduct={formData.sageProductName}
        onSelect={(product) => {
          setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
          const newLineItem = {
            id: Date.now(),
            sage_id: product.sage_id,
            product_name: product.name,
            description: product.description || product.name,
            item_code: product.item_code,
            type: product.type,
            quantity: 1,
            supplier_price: 0.00,
            customer_price: 0.00,
            unit_price: 0.00,
            discount: 0.00,
            vat_rate: 20,
            total: 0.00,
            sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1' 
          };
          const updatedLineItems = [...(formData.lineItems || []), newLineItem];
          setFormData({...formData, lineItems: updatedLineItems});
        }}
        products={sageProducts}
      />
    </div>
  </div>
)}
{formData.lineItems && formData.lineItems.length > 0 && (
  <div className="mt-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
    <h3 className="text-xl font-semibold mb-6">Selected Products & Services</h3>
    <div className="overflow-x-auto">
      <table className="w-full border border-gray-300 rounded-lg bg-white">
        <thead className="bg-gray-100">
          <tr>
           <th className="px-4 py-3 text-left font-medium w-1/4">Product/Service</th>
<th className="px-4 py-3 text-left font-medium w-1/3">Description (Editable)</th>
<th className="px-2 py-3 text-left font-medium w-16">Qty</th>
<th className="px-2 py-3 text-left font-medium w-20">Cost £</th>
<th className="px-2 py-3 text-left font-medium w-20">RRP £</th>
<th className="px-2 py-3 text-left font-medium w-20">Profit</th>
<th className="px-4 py-3 text-left font-medium w-20">Actions</th>
          </tr>
        </thead>
        <tbody>
  {formData.lineItems.map((item, index) => {
    const lineProfit = ((item.customer_price || 0) - (item.supplier_price || 0)) * (item.quantity || 1);
    return (
      <tr key={item.id} className="border-t hover:bg-gray-50">
        <td className="px-4 py-3">
          <div>{item.product_name}</div>
          <div className="text-xs text-gray-500">{item.item_code}</div>
        </td>
        <td className="px-4 py-3">
          <input
            type="text"
            value={item.description}
            onChange={(e) => {
              const updatedItems = [...formData.lineItems];
              updatedItems[index].description = e.target.value;
              setFormData({...formData, lineItems: updatedItems});
            }}
            className="w-full px-2 py-1 border border-gray-300 rounded text-sm"
          />
        </td>
        <td className="px-2 py-3">
         <input
  type="text"
  className="w-16 px-2 py-1 border border-gray-300 rounded text-sm"
  value={item.quantity || ''}
  onChange={(e) => {
    const updatedItems = [...formData.lineItems];
    updatedItems[index] = {
      ...updatedItems[index],
      quantity: parseInt(e.target.value) || ''
    };
    setFormData({...formData, lineItems: updatedItems});
  }}
/>
        </td>
        <td className="px-2 py-3">
          <input
  type="text"
  className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
  value={item.supplier_price || ''}
  onChange={(e) => {
    const updatedItems = [...formData.lineItems];
    updatedItems[index] = {
      ...updatedItems[index],
      supplier_price: e.target.value
    };
    setFormData({...formData, lineItems: updatedItems});
  }}
/>
        </td>
        <td className="px-2 py-3">
          <input
  type="text"
  className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
  value={item.customer_price || ''}
  onChange={(e) => {
    const updatedItems = [...formData.lineItems];
    updatedItems[index] = {
      ...updatedItems[index],
      customer_price: e.target.value
    };
    setFormData({...formData, lineItems: updatedItems});
  }}
/>
        </td>
        <td className="px-2 py-3">
          <div className={`text-sm font-medium ${lineProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
            £{lineProfit.toFixed(2)}
          </div>
        </td>
        <td className="px-4 py-3">
          <button
            onClick={() => {
              const updatedItems = formData.lineItems.filter((_, i) => i !== index);
              setFormData({...formData, lineItems: updatedItems});
            }}
            className="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
          >
            Remove
          </button>
        </td>
      </tr>
    );
  })}
</tbody>
     </table>
</div>
<div className="mt-4 border-t pt-4">
  <div className="grid grid-cols-5 gap-4 text-sm">
    <div className="text-center">
      <div className="text-gray-600">Total Items</div>
      <div className="font-semibold">{formData.lineItems.length}</div>
    </div>
    <div className="text-center">
      <div className="text-gray-600">Total Quantity</div>
      <div className="font-semibold">
        {formData.lineItems.reduce((sum, item) => sum + (item.quantity || 1), 0)}
      </div>
    </div>
    <div className="text-center">
      <div className="text-gray-600">Total Cost</div>
      <div className="font-semibold text-red-600">
        £{formData.lineItems.reduce((sum, item) => 
          sum + ((item.supplier_price || 0) * (item.quantity || 1)), 0
        ).toFixed(2)}
      </div>
    </div>
    <div className="text-center">
      <div className="text-gray-600">Total RRP</div>
      <div className="font-semibold text-blue-600">
        £{formData.lineItems.reduce((sum, item) => 
          sum + ((item.customer_price || 0) * (item.quantity || 1)), 0
        ).toFixed(2)}
      </div>
    </div>
    <div className="text-center">
      <div className="text-gray-600">Total Profit</div>
      <div className="font-semibold text-green-600">
        £{(formData.lineItems.reduce((sum, item) => 
          sum + ((item.customer_price || 0) * (item.quantity || 1)), 0
        ) - formData.lineItems.reduce((sum, item) => 
          sum + ((item.supplier_price || 0) * (item.quantity || 1)), 0
        )).toFixed(2)}
      </div>
    </div>
  </div>
</div>
    </div>
)}

                  {formData.jobType === 'Aggregates' && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType="Aggregates"
        selectedProduct={formData.sageProductName}
        onSelect={(product) => {
  setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
  const newLineItem = {
    id: Date.now(),
    sage_id: product.sage_id,
    product_name: product.name,
    description: product.description || product.name,
    item_code: product.item_code,
    type: product.type,
    quantity: 1,
    supplier_price: 0.00,
    customer_price: 0.00,
    unit_price: 0.00,
    discount: 0.00,
    vat_rate: 20,
    total: 0.00,
    sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
  };
  const updatedLineItems = [...(formData.lineItems || []), newLineItem];
  setFormData({...formData, lineItems: updatedLineItems});
}}
        products={sageProducts}
      />
    </div>
  </div>
)}

                     {(formData.jobType === 'Grab Hire' || formData.jobType === 'Muck Away' || formData.jobType === 'Waste Collection') && (
  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div>
      <SageProductSelector 
        jobType={formData.jobType}
        selectedProduct={formData.sageProductName}
        onSelect={(product) => {
  setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
  const newLineItem = {
    id: Date.now(),
    sage_id: product.sage_id,
    product_name: product.name,
    description: product.description || product.name,
    item_code: product.item_code,
    type: product.type,
    quantity: 1,
    supplier_price: 0.00,
    customer_price: 0.00,
    unit_price: 0.00,
    discount: 0.00,
    vat_rate: 20,
    total: 0.00,
    sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
  };
  const updatedLineItems = [...(formData.lineItems || []), newLineItem];
  setFormData({...formData, lineItems: updatedLineItems});
}}
        products={sageProducts}
      />
    </div>
  </div>
)}
                      
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Quantity * 
                            {(formData.jobType === 'Skip Hire' || formData.jobType === 'Roll-on Roll-off') && 
                             <span className="text-xs text-gray-500 ml-1">(creates multiple jobs if &gt; 1)</span>
                            }
                          </label>
                          <input
                            type="number"
                            value={formData.quantity}
                            onChange={(e) => setFormData({...formData, quantity: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                          <select
                            value={formData.unit}
                            onChange={(e) => setFormData({...formData, unit: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            disabled={formData.jobType === 'Aggregates'}
                          >
                            <option value="skip">Skip</option>
                            <option value="tonnes">Tonnes</option>
                            <option value="loads">Loads</option>
                            <option value="collections">Collections</option>
                            <option value="days">Days</option>
                          </select>
                        </div>
                        {formData.jobType !== 'Aggregates' && (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Weight (tonnes)</label>
                            <input
                              type="number"
                              step="0.1"
                              value={formData.weight}
                              onChange={(e) => setFormData({...formData, weight: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="If known"
                            />
                          </div>
                        )}
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Date *</label>
                          <input
                            type="date"
                            value={formData.jobDate}
                            onChange={(e) => setFormData({...formData, jobDate: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                        {formData.jobType === 'Aggregates' ? (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Time Slot</label>
                            <select
                              value={formData.timeSlot}
                              onChange={(e) => setFormData({...formData, timeSlot: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            >
                              <option value="">Select time slot</option>
                              {timeSlots.map(slot => (
                                <option key={slot} value={slot}>{slot}</option>
                              ))}
                            </select>
                          </div>
                        ) : (
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Collection Date</label>
                            <input
                              type="date"
                              value={formData.collectionDate}
                              onChange={(e) => setFormData({...formData, collectionDate: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                        )}
                      </div>

                      <div>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.hazardousWaste}
                            onChange={(e) => setFormData({...formData, hazardousWaste: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Contains Hazardous Waste</span>
                        </label>
                      </div>

                      {formData.hazardousWaste && (
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Consignment Note Number</label>
                          <input
                            type="text"
                            value={formData.consignmentNote}
                            onChange={(e) => setFormData({...formData, consignmentNote: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Hazardous waste consignment note"
                          />
                        </div>
                      )}
                    </div>
                  )}

              
{/* Site Information Tab */}
{activeTab === 'site' && (
  <div className="space-y-4">
    <div className="relative">
      <label className="block text-sm font-medium text-gray-700 mb-1">Site Address *</label>
      <input
        type="text"
        value={formData.siteAddress1}
        onChange={(e) => {
            setFormData({...formData, siteAddress1: e.target.value});
            handleAddressSearch(e.target.value);
        }}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
        placeholder="Delivery/collection address"
      />
      
      {/* DROPDOWN GOES AFTER THE INPUT CLOSES */}
      {showAddressSuggestions && addressSuggestions && addressSuggestions.length > 0 ? (
        <div className="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
            {addressSuggestions.map((suggestion, index) => (
                <div
                    key={index}
                    className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
                    onClick={() => {
                        console.log('Clicked:', suggestion);
                        setFormData({
                            ...formData,
                            siteAddress1: suggestion.address,
                            sitePostcode: suggestion.postcode
                        });
                        setShowAddressSuggestions(false);
                    }}
                >
                    <div className="font-medium">{suggestion.address}</div>
                    {suggestion.postcode ? (
                        <div className="text-sm text-gray-600">{suggestion.postcode}</div>
                    ) : null}
                </div>
            ))}
        </div>
      ) : null}
    </div>
    
    <input
      type="text"
      value={formData.siteAddress2}
      onChange={(e) => setFormData({...formData, siteAddress2: e.target.value})}
      className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
      placeholder="Address line 2 (optional)"
    />
    <input
      type="text"
      value={formData.sitePostcode}
      onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
      placeholder="Postcode"
    />

    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
    <div className="relative">
        <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Name</label>
        <input
            type="text"
            value={formData.siteContact}
            onChange={(e) => {
                setFormData({...formData, siteContact: e.target.value});
                handleContactSearch(e.target.value);
            }}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="On-site contact person"
        />
        {showContactSuggestions && contactSuggestions.length > 0 && (
            <div className="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                {contactSuggestions.map((contact, index) => (
                    <div
                        key={index}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
                        onClick={() => {
                            setFormData({...formData, siteContact: contact});
                            setShowContactSuggestions(false);
                        }}
                    >
                        {contact}
                    </div>
                ))}
            </div>
        )}
    </div>
    <div className="relative">
        <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Phone</label>
        <input
            type="tel"
            value={formData.sitePhone}
            onChange={(e) => {
                setFormData({...formData, sitePhone: e.target.value});
                handlePhoneSearch(e.target.value);
            }}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Mobile number"
        />
        {showPhoneSuggestions && phoneSuggestions.length > 0 && (
            <div className="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto">
                {phoneSuggestions.map((phone, index) => (
                    <div
                        key={index}
                        className="px-4 py-2 hover:bg-gray-100 cursor-pointer"
                        onClick={() => {
                            setFormData({...formData, sitePhone: phone});
                            setShowPhoneSuggestions(false);
                        }}
                    >
                        {phone}
                    </div>
                ))}
            </div>
        )}
    </div>
</div>

    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Site Notes</label>
      <textarea
        value={formData.siteNotes}
        onChange={(e) => setFormData({...formData, siteNotes: e.target.value})}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
        rows={3}
        placeholder="Any additional site information, access instructions, etc."
      />
    </div>

    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Access Restrictions</label>
      <textarea
        value={formData.accessRestrictions}
        onChange={(e) => setFormData({...formData, accessRestrictions: e.target.value})}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
        rows={2}
        placeholder="Height/width restrictions, weight limits, time restrictions, etc."
      />
    </div>

    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
      <textarea
        value={formData.notes}
        onChange={(e) => setFormData({...formData, notes: e.target.value})}
        className="w-full px-3 py-2 border border-gray-300 rounded-lg"
        rows={3}
        placeholder="Any other relevant information..."
      />
    </div>
  </div>
)}

                  {/* Financial & Status Tab */}
                  {activeTab === 'financial' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Rate (%)</label>
                          <select
                            value={formData.vatRate}
                            onChange={(e) => setFormData({...formData, vatRate: parseFloat(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>0% (Zero Rated)</option>
                            <option value={5}>5% (Reduced)</option>
                            <option value={20}>20% (Standard)</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Number</label>
                          <input
                            type="text"
                            value={formData.invoiceNumber}
                            onChange={(e) => setFormData({...formData, invoiceNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="INV-001234"
                          />
                        </div>
                        {/* Sage Product/Service Selection */}
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Invoice Status</label>
                          <select
                            value={formData.invoiceStatus}
                            onChange={(e) => setFormData({...formData, invoiceStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Not Invoiced">Not Invoiced</option>
                            <option value="Invoiced">Invoiced</option>
                            <option value="Part Invoiced">Part Invoiced</option>
                          </select>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Job Status</label>
                          <select
                            value={formData.status}
                            onChange={(e) => setFormData({...formData, status: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="CONFIRMED">Confirmed</option>
                            <option value="IN_PROGRESS">In Progress</option>
                          </select>
                        </div>
                      </div>

                      <div className="flex items-center space-x-6">
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.isCompleted}
                            onChange={(e) => setFormData({...formData, isCompleted: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Job Completed</span>
                        </label>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.isCancelled}
                            onChange={(e) => setFormData({...formData, isCancelled: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Job Cancelled</span>
                        </label>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Waste Transfer Note</label>
                        <input
                          type="text"
                          value={formData.wasteTransferNote}
                          onChange={(e) => setFormData({...formData, wasteTransferNote: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="WTN reference number"
                        />
                      </div>

                      {formData.customerUnitPrice > 0 && formData.supplierUnitPrice > 0 && (
                        <div className="bg-green-50 p-4 rounded-lg">
                          <h4 className="font-medium text-green-900 mb-3">Profit Calculation</h4>
                          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                            <div>
                              <span className="text-green-700">Customer Total:</span>
                              <p className="font-semibold">£{formData.customerFinalPrice.toFixed(2)}</p>
                              <p className="text-xs text-gray-600">+ VAT: £{(formData.customerFinalPrice * formData.vatRate / 100).toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-green-700">Supplier Cost:</span>
                              <p className="font-semibold">£{formData.supplierFinalPrice.toFixed(2)}</p>
                              <p className="text-xs text-gray-600">+ VAT: £{(formData.supplierFinalPrice * formData.vatRate / 100).toFixed(2)}</p>
                            </div>
                            <div>
                              <span className="text-green-700">Gross Profit:</span>
                              <p className="font-semibold text-green-600">
                                £{(formData.customerFinalPrice - formData.supplierFinalPrice).toFixed(2)}
                              </p>
                            </div>
                            <div>
                              <span className="text-green-700">Margin:</span>
                              <p className="font-semibold text-green-600">
                                {formData.customerFinalPrice > 0 ? 
                                  (((formData.customerFinalPrice - formData.supplierFinalPrice) / formData.customerFinalPrice) * 100).toFixed(1) : 0}%
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
{/* Documents Tab */}
{activeTab === 'documents' && (
  <div className="space-y-4">
    <div className="bg-white rounded-lg border border-gray-200 p-6">
      <h3 className="text-lg font-semibold text-gray-800 mb-4">Upload Job Attachments</h3>
      
      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Attachment Type</label>
          <select id="attachment-type" className="w-full px-3 py-2 border border-gray-300 rounded-lg">
            <option value="Waste Transfer Note">Waste Transfer Note</option>
            <option value="Invoice">Invoice</option>
            <option value="Receipt">Receipt</option>
            <option value="Photo">Photo</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">Choose File</label>
          <input
            id="attachment-file"
            type="file"
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
          />
        </div>
        
        <button
          type="button"
          onClick={handleUploadInForm}
          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
        >
          Upload Attachment
        </button>
        {/* Display existing attachments */}
        {jobAttachments.length > 0 && (
          <div className="mt-6">
            <h4 className="font-medium text-gray-800 mb-3">Existing Attachments</h4>
            <div className="space-y-2">
              {jobAttachments.map(attachment => (
              <div key={attachment.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
  <span className="text-sm">{attachment.file_name} ({attachment.file_type})</span>
  <div className="flex gap-2">
    <a 
      href={attachment.file_url} 
      target="_blank" 
      rel="noopener noreferrer"
      className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
    >
      View
    </a>
    {user?.role === 'ADMIN' && (
    <button
      type="button"
      onClick={() => handleDeleteAttachment(attachment.id)}
      className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
    >
      Delete
    </button>
  )}
  </div>
</div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
)}
                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {job ? 'Update Job' : 'Create Job'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Job Card Component
        const JobCard = ({ job, onClick }) => {
          const jobIcons = {
            'Skip Hire': { icon: 'Trash2', color: 'text-blue-600', bg: 'bg-blue-100' },
            'Aggregates': { icon: 'Mountain', color: 'text-orange-600', bg: 'bg-orange-100' },
            'Waste Collection': { icon: 'Recycle', color: 'text-green-600', bg: 'bg-green-100' },
            'Grab Hire': { icon: 'Truck', color: 'text-purple-600', bg: 'bg-purple-100' },
            'Muck Away': { icon: 'Truck', color: 'text-red-600', bg: 'bg-red-100' },
            'Roll-on Roll-off': { icon: 'Truck', color: 'text-indigo-600', bg: 'bg-indigo-100' }
          };

          const statusConfig = {
            'QUOTED': { color: 'bg-yellow-100 text-yellow-800', progress: 25 },
            'CONFIRMED': { color: 'bg-green-100 text-green-800', progress: 50 },
            'IN_PROGRESS': { color: 'bg-blue-100 text-blue-800', progress: 75 },
            'COLLECTED': { color: 'bg-purple-100 text-purple-800', progress: 100 }
          };

          if (job.isCompleted) {
            statusConfig['COMPLETED'] = { color: 'bg-emerald-100 text-emerald-800', progress: 100 };
          }
          if (job.isCancelled) {
            statusConfig['CANCELLED'] = { color: 'bg-red-100 text-red-800', progress: 0 };
          }

          const jobIcon = jobIcons[job.jobType] || jobIcons['Skip Hire'];
          const status = job.status === 'COLLECTED' ? statusConfig['COLLECTED'] :
                         job.isCompleted ? statusConfig['COMPLETED'] : 
                         job.isCancelled ? statusConfig['CANCELLED'] : 
                         statusConfig[job.status] || statusConfig['QUOTED'];
          const IconComponent = jobIcon.icon === 'Trash2' ? Trash2 : jobIcon.icon === 'Mountain' ? Mountain : 
                               jobIcon.icon === 'Recycle' ? Recycle : Truck;

          const isFinished = job.isCompleted || job.status === 'COLLECTED';

          return (
            <div 
              className={`bg-white rounded-lg border border-gray-200 p-4 cursor-pointer hover:shadow-lg transition-all ${
                isFinished ? 'opacity-75' : ''
              }`}
              onClick={onClick}
            >
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center space-x-2">
                  <div className={`p-2 rounded-lg ${jobIcon.bg}`}>
                    <IconComponent size={16} className={jobIcon.color} />
                  </div>
                  <div>
                    <span className={`text-sm font-semibold ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                      {job.jobNumber}
                    </span>
                    <p className="text-xs text-gray-600">{job.jobType}</p>
                  </div>
                </div>
                <span className={`px-2 py-1 rounded-full text-xs font-medium ${status.color}`}>
                  {job.status === 'COLLECTED' ? 'COLLECTED' : 
                   job.isCompleted ? 'COMPLETED' : 
                   job.isCancelled ? 'CANCELLED' : 
                   job.status.replace('_', ' ')}
                </span>
              </div>

              <div className="mb-3">
                <div className="w-full bg-gray-200 rounded-full h-1.5">
                  <div 
                    className="h-1.5 rounded-full bg-blue-500 transition-all" 
                    style={{ width: `${status.progress}%` }}
                  />
                </div>
              </div>

              <div className="space-y-2 mb-3">
                <div className="flex items-center text-sm">
                  <User size={12} className="mr-2 text-blue-500" />
                  <span className={`text-gray-700 truncate ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                    {job.customerName}
                  </span>
                </div>
                <div className="flex items-center text-sm">
                  <Truck size={12} className="mr-2 text-green-500" />
                  <span className={`text-gray-700 truncate ${isFinished ? 'line-through decoration-red-500' : ''}`}>
                    {job.supplierName}
                  </span>
                </div>
              </div>

              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-600">{new Date(job.jobDate).toLocaleDateString()}</span>
                <span className="font-medium text-green-600">£{job.grossProfit?.toFixed(0)}</span>
              </div>
              
              {job.parentJobId && (
                <div className="mt-2 text-xs text-gray-500">
                  Exchange from: {job.parentJobId}
                </div>
              )}
              
              {currentjob.invoiceNumber && (
  <div className="mt-2 text-xs text-gray-500">
    Invoice: {currentjob.invoiceNumber}
    {currentjob.sage_si_number && (
      <span className="ml-2 text-blue-600 font-medium">
        | SI: {currentJob.sage_si_number}
      </span>
    )}
  </div>
)}
            </div>
          );
        };

        // Dashboard Component
        const Dashboard = ({ jobs, customers }) => {
          const totalRevenue = jobs.reduce((sum, job) => sum + (job.jobValue || 0), 0);
          const totalProfit = jobs.reduce((sum, job) => sum + (job.grossProfit || 0), 0);
          const avgMargin = totalRevenue > 0 ? (totalProfit / totalRevenue * 100) : 0;
          const activeJobs = jobs.filter(j => ['CONFIRMED', 'IN_PROGRESS'].includes(j.status)).length;

          const metrics = [
            { label: 'Active Jobs', value: activeJobs, icon: 'Activity', color: 'bg-blue-500' },
            { label: 'Monthly Revenue', value: `£${(totalRevenue/1000).toFixed(0)}k`, icon: 'DollarSign', color: 'bg-green-500' },
            { label: 'Profit Margin', value: `${avgMargin.toFixed(1)}%`, icon: 'TrendingUp', color: 'bg-purple-500' },
            { label: 'Customers', value: customers.length, icon: 'Users', color: 'bg-orange-500' }
          ];

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">Dashboard</h2>
                <p className="text-gray-600">Overview of your waste management operations</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                {metrics.map((metric, index) => {
                  const Icon = metric.icon === 'Activity' ? Activity : 
                               metric.icon === 'DollarSign' ? DollarSign :
                               metric.icon === 'TrendingUp' ? TrendingUp : Users;
                  return (
                    <div className="bg-white rounded-xl border border-gray-200 p-4 sm:p-6">
                      <div className="flex items-center justify-between">
                        <div>
                          <p className="text-sm text-gray-600">{metric.label}</p>
                          <p className="text-2xl font-bold text-gray-900">{metric.value}</p>
                        </div>
                        <div className={`p-3 rounded-lg ${metric.color}`}>
                          <Icon size={24} className="text-white" />
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="bg-white rounded-lg border border-gray-200">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-lg font-semibold">Recent Jobs</h3>
                  </div>
                  <div className="p-6">
                    <div className="space-y-4">
                      {jobs.slice(0, 5).map(job => (
                        <div key={job.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium">{job.jobNumber}</p>
                            <p className="text-sm text-gray-600">{job.customerName}</p>
                          </div>
                          <div className="text-right">
                            <p className="font-medium text-green-600">£{job.grossProfit?.toFixed(0)}</p>
                            <p className="text-xs text-gray-500">{job.status}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="bg-white rounded-lg border border-gray-200">
                  <div className="p-6 border-b border-gray-200">
                    <h3 className="text-lg font-semibold">Top Customers</h3>
                  </div>
                  <div className="p-6">
                    <div className="space-y-4">
                      {customers.slice(0, 5).map(customer => (
                        <div key={customer.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <div>
                            <p className="font-medium">{customer.companyName}</p>
                            <p className="text-sm text-gray-600">{customer.primaryContact}</p>
                          </div>
                          <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                            customer.creditRating === 'A+' ? 'bg-green-100 text-green-700' :
                            customer.creditRating === 'A' ? 'bg-blue-100 text-blue-700' :
                            'bg-yellow-100 text-yellow-700'
                          }`}>
                            {customer.creditRating}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        // Jobs Management Component
          const JobsView = ({ jobs, onAddJob, onUpdateJob, onDeleteJob, onDuplicateJob, onEditJob, customers, suppliers, user, setShowFullPageJob }) => {
          const { hasPermission } = useAuth();
          const [selectedJob, setSelectedJob] = useState(null);
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [currentMonth, setCurrentMonth] = useState(new Date());
          const [searchQuery, setSearchQuery] = useState('');
          const [filters, setFilters] = useState({
  status: '',
  jobType: '',
  priority: '',
  rejectionReason: ''
});
          const [creatingInvoice, setCreatingInvoice] = useState(false);
          const [invoiceJobId, setInvoiceJobId] = useState(null);

const handleCreateInvoice = async (job) => {
  setCreatingInvoice(true);
  setInvoiceJobId(job.id);
  
  try {
    // Check if we're in demo mode (no real Sage connection)
    const isDemoMode = !window.SageAPI || !localStorage.getItem('sage_connected');
    
    if (isDemoMode) {
      // Demo mode - just create a fake invoice number
      const invoiceNumber = `INV-${new Date().getFullYear()}-${String(Math.floor(Math.random() * 10000)).padStart(4, '0')}`;
      
      // Update local state only (in production, this would update Supabase)
      onUpdateJob({
        ...job,
        invoiceNumber: invoiceNumber,
        invoiceStatus: 'Invoiced'
      });
      
      alert(`Demo Mode: Invoice ${invoiceNumber} created successfully!`);
    } else {
      // Production mode - use real Sage API
      const { data: customer } = await window.supabase
        .from('customers')
        .select('*')
        .eq('companyName', job.customerName)
        .single();
      
      if (!customer?.sageId) {
        throw new Error('Customer not synced with Sage. Please sync customer first.');
      }
      
const lineItems = job.sage_line_items?.map(item => ({
  description: item.description || `${job.jobType} - ${item.product_name}`,
...(item.type?.toLowerCase() === 'service' ? {service_id: item.sage_id} : {product_id: item.sage_id}),
  quantity: item.quantity || job.quantity,
  unit_price: item.customer_price || item.unit_price || job.customerUnitPrice,
  ledger_account_id: item.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
  tax_rate_id: item.tax_code === 'T1' ? 'GB_STANDARD' : 'GB_ZERO',
tax_amount: item.tax_code === 'T1' 
  ? (item.customer_price || item.unit_price || job.customerUnitPrice) * (item.quantity || job.quantity) * 0.20
  : 0,  // Zero tax for GB_ZERO items
  ...(item.item_code ? {item_code: item.item_code} : {})
})) || [{
  // Fallback if no line items
  description: `${job.jobType} - ${job.sageProductName || ''}`,
...(item.type?.toLowerCase() === 'service' ? {service_id: item.sage_id} : {product_id: item.sage_id}),
  quantity: job.quantity,
  unit_price: job.customerUnitPrice,
  ledger_account_id: 'dc4b88bb472b11e9aac702d5719f235e',
  tax_rate_id: item.tax_code === 'T1' ? 'GB_STANDARD' : 'GB_ZERO',
tax_amount: item.tax_code === 'T1' 
  ? (item.customer_price || item.unit_price || job.customerUnitPrice) * (item.quantity || job.quantity) * 0.20
  : 0,  // Zero tax for GB_ZERO items
  }];

 const invoiceData = {
    sales_invoice: {
        contact_id: customer.sage_id,
        date: new Date().toISOString().split('T')[0],
        due_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
reference: job.customerPO || job.customer_po || '',
        // REMOVE LINE 3314 - no notes field at all
        // CHANGE: Add delivery_settings instead of main_address
        delivery_address: {
    address_line_1: jobToInvoice.siteAddress1 || '',  // Changed from site_address1
address_line_2: jobToInvoice.siteAddress2 || '',  // Changed from site_address2
city: jobToInvoice.siteCity || '',                // Changed from site_city
region: jobToInvoice.siteCounty || '',            // Changed from site_county
postal_code: jobToInvoice.sitePostcode || '',     // Changed from site_postcode
    country_code: 'GB'
},
        invoice_lines: lineItems
    }
};
      
      const invoice = await window.SageAPI.createDraftInvoice(invoiceData);
      
      // Sage returns the SI number in the response
      const siNumber = invoice.invoice_number || invoice.si_number || invoice.id;
      
      // Update the database with the SI number
      await window.supabase
        .from('jobs')
        .update({
          sage_invoice_id: invoice.id,
          invoice_number: invoice.invoice_number || invoice.id,
          sage_si_number: siNumber,
          invoice_status: 'Invoiced'
        })
        .eq('id', job.id);
      
      // ⚡ CRITICAL FIX: Fetch the updated job from database ⚡
      const { data: updatedJob, error } = await window.supabase
        .from('jobs')
        .select('*')
        .eq('id', job.id)
        .single();
      
      if (updatedJob && !error) {
  // Update the job object directly
  job.sage_si_number = updatedJob.sage_si_number;
  job.invoice_number = updatedJob.invoice_number;
  job.invoice_status = updatedJob.invoice_status;
  
  onUpdateJob(updatedJob);
  onUpdateDisplay(updatedJob);
  
  // Force a re-render
  setActiveTab(activeTab);
}
       else {
        // Fallback to manual update if fetch fails
        onUpdateJob({
          ...job,
          sage_invoice_id: invoice.id,
          invoice_number: invoice.invoice_number || invoice.id,
          sage_si_number: siNumber,
          invoice_status: 'Invoiced'
        });
      }
      
      alert(`Invoice created successfully in Sage! SI: ${siNumber}`);
    }
  } catch (error) {
    console.error('Error creating invoice:', error);
    alert('Failed to create invoice: ' + error.message);
  } finally {
    setCreatingInvoice(false);
    setInvoiceJobId(null);
  }
};
          const jobColors = {
            'Skip Hire': '#3B82F6',
            'Aggregates': '#F97316',
            'Waste Collection': '#10B981',
            'Grab Hire': '#8B5CF6',
            'Muck Away': '#EF4444',
            'Roll-on Roll-off': '#6366F1'
          };

          // Sort jobs by date descending (newest first)
            const sortedJobs = [...jobs].sort((a, b) => {
             const aNum = parseInt(a.jobNumber.split('-').pop());
             const bNum = parseInt(b.jobNumber.split('-').pop());
             return bNum - aNum;
            });

          const filteredJobs = sortedJobs.filter(job => {
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    const matchesJobNumber = (job.jobNumber || '').toLowerCase().includes(query);
   const matchesCustomer = (job.customerName || '').toLowerCase().includes(query);
    const matchesSupplier = (job.supplierName || '').toLowerCase().includes(query);
    const matchesPostcode = ((job.sitePostcode || '').toLowerCase().includes(query)) || 
                        ((job.postcode || '').toLowerCase().includes(query));
const matchesAddress = ((job.siteAddress1 || '').toLowerCase().includes(query)) || 
                       ((job.siteAddress || '').toLowerCase().includes(query));    
    if (!matchesJobNumber && !matchesCustomer && !matchesSupplier && !matchesPostcode && !matchesAddress) {
      return false;
    }
  }
            if (filters.jobType && job.jobType !== filters.jobType) return false;
            if (filters.status) {
              if (filters.status === 'COMPLETED' && !job.isCompleted) return false;
              if (filters.status === 'CANCELLED' && !job.isCancelled) return false;
              if (filters.status === 'COLLECTED' && job.status !== 'COLLECTED') return false;
              if (filters.status !== 'COMPLETED' && filters.status !== 'CANCELLED' && filters.status !== 'COLLECTED' && 
                  (job.status !== filters.status || job.isCompleted || job.isCancelled)) return false;
            }
            if (filters.priority && job.priority !== filters.priority) return false;
            return true;
          });

    const handleJobClick = (job) => {
  setShowFullPageJob(job); // ADD THIS LINE - opens full page view
};

// Add loadJobAttachments function
const loadJobAttachments = async (jobId) => {
  try {
    const { data, error } = await window.supabase
      .from('job_attachments')
      .select('*')
      .eq('job_id', jobId)
      .order('uploaded_at', { ascending: false });

    if (error) throw error;
    //setJobAttachments(data || []);
  } catch (error) {
    console.error('Error loading job attachments:', error);
    //setJobAttachments([]);
  }
};

// Add uploadJobAttachment function
const uploadJobAttachment = async () => {
  const attachmentType = document.getElementById('attachment-type')?.value;
  const fileInput = document.getElementById('attachment-file');
  const file = fileInput?.files[0];

  if (!attachmentType || !file || !selectedJob) {
    alert('Please select attachment type, file, and ensure a job is selected');
    return;
  }

  try {
    const fileName = `job_${selectedJob.id}_${Date.now()}_${file.name}`;
    const { data: fileData, error: fileError } = await window.supabase.storage
      .from('documents')
      .upload(fileName, file);

    if (fileError) throw fileError;

    const { data: { publicUrl } } = window.supabase.storage
      .from('documents')
      .getPublicUrl(fileName);

    // Save to job_attachments table
    const { data, error } = await window.supabase
      .from('job_attachments')
      .insert([{
        job_id: selectedJob.id,
        file_name: file.name,
        file_url: publicUrl,
        file_type: attachmentType,
        file_size: file.size,
        uploaded_by: user?.email
      }]);

    if (error) throw error;

    alert('Job attachment uploaded successfully!');
    loadJobAttachments(selectedJob.id);
    
    // Clear the form
    document.getElementById('attachment-file').value = '';
  } catch (error) {
    console.error('Error uploading job attachment:', error);
    alert('Error uploading job attachment');
  }
};


          const handleDuplicateJob = (job) => {
            const duplicatedJob = { ...job, id: null, jobNumber: null };
            delete duplicatedJob.id;
            delete duplicatedJob.jobNumber;
            onDuplicateJob(duplicatedJob);
            setSelectedJob(null);
          };

          const handleDeleteJob = async (job) => {
  if (confirm(`Are you sure you want to delete job ${job.jobNumber}?`)) {
    try {
      // Delete from Supabase database first
      const { error } = await window.supabase
        .from('jobs')
        .delete()
        .eq('id', job.id);
      
      if (error) throw error;
      
      // Call the parent delete function and close dialog
      onDeleteJob(job.id);
      setSelectedJob(null);
      
      console.log('Job deleted successfully:', job.jobNumber);
    } catch (error) {
      console.error('Error deleting job:', error);
      alert('Error deleting job: ' + error.message);
    }
  }
};

          // Calendar View Component
          const CalendarView = () => {
            const [expandedDays, setExpandedDays] = useState({});
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const days = [];

            // Get all days in the month
            for (let d = 1; d <= lastDay.getDate(); d++) {
              days.push(new Date(year, month, d));
            }

            // Group jobs by date
            const jobsByDate = {};
            filteredJobs.forEach(job => {
              const jobDate = new Date(job.jobDate);
              const dateKey = `${jobDate.getFullYear()}-${jobDate.getMonth()}-${jobDate.getDate()}`;
              if (!jobsByDate[dateKey]) jobsByDate[dateKey] = [];
              jobsByDate[dateKey].push(job);
            });

            const navigateMonth = (direction) => {
              const newMonth = new Date(currentMonth);
              newMonth.setMonth(newMonth.getMonth() + direction);
              setCurrentMonth(newMonth);
            };

            return (
              <div className="bg-white rounded-lg border border-gray-200 p-6">
                <div className="flex items-center justify-between mb-6">
                  <h3 className="text-lg font-semibold">Calendar View</h3>
                  <div className="flex items-center space-x-4">
                    <button
                      onClick={() => navigateMonth(-1)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronDown size={20} className="rotate-90" />
                    </button>
                    <span className="font-medium">
                      {currentMonth.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' })}
                    </span>
                    <button
                      onClick={() => navigateMonth(1)}
                      className="p-2 hover:bg-gray-100 rounded-lg"
                    >
                      <ChevronDown size={20} className="-rotate-90" />
                    </button>
                  </div>
                </div>
                <div className="grid grid-cols-7 gap-2">
                  {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                    <div key={day} className="text-center font-medium text-gray-600 p-2">
                      {day}
                    </div>
                  ))}
                  {Array(firstDay.getDay()).fill(null).map((_, index) => (
                    <div key={`empty-${index}`} className="p-2"></div>
                  ))}
                  {days.map(day => {
                    const dateKey = `${day.getFullYear()}-${day.getMonth()}-${day.getDate()}`;
                    const dayJobs = jobsByDate[dateKey] || [];
                    const isToday = new Date().toDateString() === day.toDateString();
                    
                    return (
                      <div 
                        key={dateKey} 
                        className={`border border-gray-200 rounded-lg p-2 min-h-[100px] ${
                          isToday ? 'bg-blue-50 border-blue-300' : ''
                        }`}
                      >
                        <div className={`font-medium mb-1 ${isToday ? 'text-blue-700' : 'text-gray-700'}`}>
                          {day.getDate()}
                        </div>
                        <div className="space-y-1">
                          {dayJobs.slice(0, expandedDays[day.toDateString()] ? dayJobs.length : 3).map(job => {
                            const isFinished = job.isCompleted || job.status === 'COLLECTED';
                            return (
                              <div
                                key={job.id}
                                className={`text-xs p-1 rounded cursor-pointer truncate hover:opacity-80 ${
                                  isFinished ? 'opacity-60' : ''
                                }`}
                                style={{ 
                                  backgroundColor: jobColors[job.jobType] + '20', 
                                  color: jobColors[job.jobType],
                                  borderLeft: `3px solid ${jobColors[job.jobType]}`,
                                  textDecoration: isFinished ? 'line-through' : 'none',
                                  textDecorationColor: isFinished ? '#ef4444' : 'transparent'
                                }}
                                onClick={() => handleJobClick(job)}
                                title={`${job.jobNumber} - ${job.customerName}${isFinished ? ' (Completed)' : ''}`}
                              >
                                <div className="truncate font-medium text-xs">
  {job.customerName || 'No Customer'}
</div>
<div className="truncate text-[10px] opacity-75">
  {job.sitePostcode || job.postcode || 'No Postcode'}
</div>
                              </div>
                            );
                          })}
                          {dayJobs.length > 3 && (
  <div 
    className="text-xs text-blue-600 text-center mt-1 py-1 bg-blue-50 rounded cursor-pointer hover:bg-blue-100 transition-colors"
    onClick={(e) => {
      e.stopPropagation();
      setExpandedDays(prev => ({
        ...prev,
        [day.toDateString()]: !prev[day.toDateString()]
      }));
    }}
  >
    {expandedDays[day.toDateString()] ? 'Show less' : `+${dayJobs.length - 3} more`}
  </div>
)}
                        </div>
                      </div>
                    );
                  })}
                </div>
                <div className="mt-4 flex flex-wrap gap-4">
                  <div className="text-sm text-gray-600">Job Types:</div>
                  {Object.entries(jobColors).map(([type, color]) => (
                    <div key={type} className="flex items-center space-x-2 text-sm">
                      <div 
                        className="w-4 h-4 rounded" 
                        style={{ backgroundColor: color }}
                      />
                      <span>{type}</span>
                    </div>
                  ))}
                </div>
              </div>
            );
          };

          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Job Management</h2>
                  <p className="text-gray-600">{filteredJobs.length} jobs found</p>
                </div>
                <button 
  onClick={onAddJob}
  className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
>
  <Plus size={16} className="mr-1 sm:mr-2" />
  <span className="hidden sm:inline">Add Job</span>
  <span className="sm:hidden">Add</span>
</button>
              </div>

              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
  <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3">
      <Filter size={16} className="text-gray-600 hidden sm:block" />
      <input
        type="text"
        placeholder="Search jobs, customers, postcodes..."
        value={searchQuery}
        onChange={(e) => setSearchQuery(e.target.value)}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      />
      <select
        value={filters.jobType}
        onChange={(e) => setFilters({...filters, jobType: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Job Types</option>
        <option value="Skip Hire">Skip Hire</option>
        <option value="Aggregates">Aggregates</option>
        <option value="Waste Collection">Waste Collection</option>
        <option value="Grab Hire">Grab Hire</option>
        <option value="Muck Away">Muck Away</option>
        <option value="Roll-on Roll-off">Roll-on Roll-off</option>
      </select>
      <select
        value={filters.status}
        onChange={(e) => setFilters({...filters, status: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Statuses</option>
        <option value="CONFIRMED">Confirmed</option>
        <option value="IN_PROGRESS">In Progress</option>
        <option value="COLLECTED">Collected</option>
        <option value="COMPLETED">Completed</option>
        <option value="CANCELLED">Cancelled</option>
      </select>
      <select
        value={filters.priority}
        onChange={(e) => setFilters({...filters, priority: e.target.value})}
        className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
      >
        <option value="">All Priorities</option>
        <option value="Low">Low</option>
        <option value="Medium">Medium</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>
      </select>
      <button
        onClick={() => {
          setSearchQuery('');
          setFilters({ jobType: '', status: '', priority: '' });
        }}
        className="w-full sm:w-auto px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
      >
        Clear
      </button>
    </div>
    
    <div className="flex items-center justify-end gap-2">
      <button
        onClick={() => setViewMode('grid')}
        className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Grid size={16} />
      </button>
      <button
        onClick={() => setViewMode('list')}
        className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Layout size={16} />
      </button>
      <button
        onClick={() => setViewMode('calendar')}
        className={`p-2 rounded ${viewMode === 'calendar' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
      >
        <Calendar size={16} />
      </button>
    </div>
  </div>
</div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'calendar' ? (
                    <CalendarView />
                  ) : viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                      {filteredJobs.map(job => (
                        <JobCard
                          key={job.id}
                          job={job}
                          onClick={() => handleJobClick(job)}
                        />
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
      <tr>
        <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job Number & Date</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product/Service</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Haulier</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postcode</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
<th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
          <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SI Number</th>
        </tr>
      </thead>
<tbody className="bg-white divide-y divide-gray-200">
  {filteredJobs.map(job => {
const statusConfig = {
 'QUOTED': 'bg-yellow-100 text-yellow-800',
'CONFIRMED': 'bg-green-100 text-green-800',
'IN_PROGRESS': 'bg-blue-100 text-blue-800',
'COLLECTED': 'bg-purple-100 text-purple-800'
 };
const status = job.status === 'COLLECTED' ? 'bg-purple-100 text-purple-800' :
job.isCompleted ? 'bg-emerald-100 text-emerald-800' :
job.isCancelled ? 'bg-red-100 text-red-800' :
statusConfig[job.status];
const isFinished = job.isCompleted || job.status === 'COLLECTED';
const firstProduct = job.lineItems && job.lineItems.length > 0 ? job.lineItems[0].product_name : job.jobType;
return (
<tr
key={job.id}
className={`hover:bg-gray-50 cursor-pointer ${isFinished ? 'opacity-75' : ''}`}
onClick={() => handleJobClick(job)}
>
<td className="px-3 py-3 whitespace-nowrap">
<div className="flex items-center">
<div
className="w-2 h-8 rounded mr-3"
style={{ backgroundColor: jobColors[job.jobType] }}
/>
<div>
<div className={`text-sm font-medium text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.jobNumber}
{job.quoteReference && (
  <div className="text-xs text-gray-500 mt-1">From Quote: {job.quoteReference}</div>
)}
</div>
<div className={`text-sm text-gray-500 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{new Date(job.jobDate).toLocaleDateString('en-GB')}
</div>
</div>
</div>
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.customerName}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.supplierName || '-'}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.lineItems && job.lineItems.length > 0 
  ? job.lineItems[0].product_name || job.lineItems[0].description || '-'
  : job.sageProductName || '-'
}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.haulierName || '-'}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.siteAddress1 || job.siteAddress || '-'}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.sitePostcode || '-'}
</td>
<td className={`px-3 py-3 whitespace-nowrap text-sm text-gray-900 ${isFinished ? 'line-through decoration-red-500' : ''}`}>
{job.jobType}
</td>
<td className="px-3 py-3 whitespace-nowrap">
<span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${status}`}>
{job.status === 'COLLECTED' ? 'Collected' :
job.isCompleted ? 'Completed' :
job.isCancelled ? 'Cancelled' :
job.status.replace('_', ' ')}
</span>
</td>
<td className="px-3 py-3 whitespace-nowrap text-sm text-gray-900">
  {job.invoiceNumber ? (
    <span className="font-medium text-blue-600">
      {job.invoiceNumber}
    </span>
  ) : (
    <span className="text-gray-400">-</span>
  )}
</td>
</tr>
 );
 })}
</tbody>                    
                      </table>
                    </div>
                  )}
                  
                  {filteredJobs.length === 0 && (
                    <div className="text-center py-8">
                      <Grid className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No jobs found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedJob && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
  <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedJob.jobNumber}</h2>
                        <p className="text-gray-600">{selectedJob.jobType}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        <button
                          onClick={() => handleEditJob(selectedJob)}
                          className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                          title="Edit Job"
                        >
                          <Edit3 size={20} />
                        </button>
                        <button
                          onClick={() => handleDuplicateJob(selectedJob)}
                          className="p-2 text-green-600 hover:bg-green-100 rounded-lg"
                          title="Duplicate Job"
                        >
                          <Copy size={20} />
                        </button>
                        {(selectedJob.jobType === 'Skip Hire' || selectedJob.jobType === 'Roll-on Roll-off') && 
                         !selectedJob.isCompleted && selectedJob.status !== 'COLLECTED' && (
                          <>
                            <button
                              onClick={() => handleExchange(selectedJob)}
                              className="p-2 text-orange-600 hover:bg-orange-100 rounded-lg"
                              title="Exchange"
                            >
                              <Repeat size={20} />
                            </button>
                            <button
                              onClick={() => handleCollection(selectedJob)}
                              className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                              title="Collect"
                            >
                              <Package size={20} />
                            </button>
                          </>
                        )}
                        {/* Add Invoice Button - only for completed jobs without invoice */}
{(selectedJob.isCompleted || selectedJob.status === 'COLLECTED') && 
 !selectedJob.invoiceNumber && user?.role === 'ADMIN' && (
  <button
    onClick={() => handleCreateInvoice(selectedJob)}
    disabled={creatingInvoice && invoiceJobId === selectedJob.id}
    className="p-2 text-green-600 hover:bg-green-100 rounded-lg disabled:opacity-50"
    title="Create Invoice in Sage"
  >
    {creatingInvoice && invoiceJobId === selectedJob.id ? (
      <Loader size={20} className="animate-spin" />
    ) : (
      <FileText size={20} />
    )}
  </button>
)}
                        {hasPermission('jobs:delete') && (
                          <button
                            onClick={() => handleDeleteJob(selectedJob)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Job"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedJob(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                         <h3 className="font-semibold mb-4">Customer & Job Information</h3>
                          <div className="space-y-3">
                           <div className="flex justify-between">
  <span className="text-gray-600">Customer:</span>
  <span className="font-medium">{selectedJob.customerName}</span>
</div>
<div className="flex justify-between">
  <span className="text-gray-600">Supplier:</span>
  <span className="font-medium">{selectedJob.supplierName}</span>
</div>
                            {selectedJob.haulierName && (
                              <div className="flex justify-between">
                                <span className="text-gray-600">Haulier:</span>
                                <span className="font-medium">{selectedJob.haulierName}</span>
                              </div>
                            )}
                            <div className="flex justify-between">
  <span className="text-gray-600">Products/Services:</span>
  <span className="font-medium">
    {selectedJob.products && selectedJob.products.length > 0 
      ? selectedJob.products.map(p => p.description || p.name).join(', ')
      : selectedJob.productName || selectedJob.description || 'No products specified'
    }
  </span>
</div>
{/* Site Information Section */}
<div className="bg-white border border-gray-200 rounded-lg mt-4">
  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3">
    <h3 className="font-semibold text-gray-800">Site Information</h3>
  </div>
  <div className="p-4 space-y-3">
    <div className="flex justify-between">
      <span className="text-gray-600">Site Address:</span>
      <span className="font-medium">{selectedJob.siteAddress1}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Site Postcode:</span>
      <span className="font-medium">{selectedJob.sitePostcode}</span>
    </div>
    {selectedJob.siteContact && (
      <div className="flex justify-between">
        <span className="text-gray-600">Site Contact:</span>
        <span className="font-medium">{selectedJob.siteContact}</span>
      </div>
    )}
    {selectedJob.sitePhone && (
      <div className="flex justify-between">
        <span className="text-gray-600">Contact Phone:</span>
        <span className="font-medium">{selectedJob.sitePhone}</span>
      </div>
    )}
  </div>
</div>
{/* Job Details Section */}
<div className="bg-white border border-gray-200 rounded-lg mt-4">
  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3">
    <h3 className="font-semibold text-gray-800">Job Details</h3>
  </div>
  <div className="p-4 space-y-3">
    <div className="flex justify-between">
      <span className="text-gray-600">Job Type:</span>
      <span className="font-medium">{selectedJob.jobType}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Date:</span>
      <span className="font-medium">{new Date(selectedJob.jobDate).toLocaleDateString()}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Quantity:</span>
      <span className="font-medium">{selectedJob.quantity} {selectedJob.unit}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Status:</span>
      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
        selectedJob.status === 'COLLECTED' ? 'bg-purple-100 text-purple-700' :
        selectedJob.isCompleted ? 'bg-emerald-100 text-emerald-700' :
        selectedJob.isCancelled ? 'bg-red-100 text-red-700' :
        'bg-blue-100 text-blue-700'
      }`}>
        {selectedJob.status === 'COLLECTED' ? 'Collected' :
         selectedJob.isCompleted ? 'Completed' : 
         selectedJob.isCancelled ? 'Cancelled' : 
         selectedJob.status}
      </span>
    </div>
  </div>
</div>
  </div>
</div>
                       </div>
                        </div>
                        <div>
                          </div>

{/* ADD PRODUCTS & SERVICES SECTION HERE */}
{selectedJob?.lineItems && selectedJob.lineItems.length > 0 && (
  <div className="mb-6">
    <h4 className="text-lg font-semibold mb-4 text-gray-800">Products & Services</h4>
    <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
      <table className="w-full">
        <thead className="bg-gray-50 border-b border-gray-200">
          <tr>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Product/Service</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Description</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Type</th>
            <th className="px-4 py-3 text-left text-sm font-medium text-gray-700">Quantity</th>
          </tr>
        </thead>
        <tbody className="divide-y divide-gray-200">
          {selectedJob.lineItems.map((item, index) => (
            <tr key={item.id || index} className="hover:bg-gray-50">
              <td className="px-4 py-3 text-sm font-medium text-gray-900">
                {item.product_name || item.name}
              </td>
              <td className="px-4 py-3 text-sm text-gray-700">
                {item.description || 'No description'}
              </td>
              <td className="px-4 py-3">
                <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                  item.type === 'service' 
                    ? 'bg-blue-100 text-blue-800' 
                    : 'bg-green-100 text-green-800'
                }`}>
                  {item.type || 'product'}
                </span>
              </td>
              <td className="px-4 py-3 text-sm text-gray-700">
                {item.quantity || 1}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      <div className="bg-gray-50 px-4 py-2 border-t border-gray-200">
        <p className="text-sm text-gray-600">
          Total items: {selectedJob.lineItems.length} | 
          Total quantity: {selectedJob.lineItems.reduce((sum, item) => sum + (item.quantity || 1), 0)}
        </p>
      </div>
    </div>
  </div>
)}

<div>
</div>
</div>
    
                      {selectedJob.parentJobId && (
                        <div className="mt-6 p-4 bg-orange-50 rounded-lg">
                          <h3 className="font-semibold mb-2 text-orange-900">Exchange Information</h3>
                          <p className="text-orange-700">This is an exchange job from: <span className="font-semibold">{selectedJob.parentJobId}</span></p>
                        </div>
                      )}

                      {selectedJob.linkedJobs && selectedJob.linkedJobs.length > 0 && (
                        <div className="mt-6">
                          <h3 className="font-semibold mb-2">Linked Jobs</h3>
                          <div className="flex flex-wrap gap-2">
                            {selectedJob.linkedJobs.map(jobId => (
                              <span key={jobId} className="px-3 py-1 bg-gray-100 rounded-full text-sm">
                                {jobId}
                              </span>
                            ))}
                          </div>
                        </div>
                      )}

                      {/* Financial Summary Section */}
<div className="bg-white border border-gray-200 rounded-lg mt-4">
  <div className="bg-gray-50 border-b border-gray-200 px-4 py-3">
    <h3 className="font-semibold text-gray-800">Financial Summary</h3>
  </div>
  <div className="p-4 space-y-3">
    <div className="flex justify-between">
      <span className="text-gray-600">Customer Price:</span>
      <span className="font-medium text-blue-600">£{selectedJob.customerFinalPrice?.toFixed(2)}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Supplier Cost:</span>
      <span className="font-medium text-red-600">£{selectedJob.supplierFinalPrice?.toFixed(2)}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Gross Profit:</span>
      <span className="font-medium text-green-600">£{selectedJob.grossProfit?.toFixed(2)}</span>
    </div>
    <div className="flex justify-between">
      <span className="text-gray-600">Profit Margin:</span>
      <span className="font-medium text-purple-600">{selectedJob.profitMargin?.toFixed(1)}%</span>
    </div>
  </div>
</div>
{/* Display existing attachments */}
    <div className="mt-4 space-y-2">
      {[].map(attachment => (
        <div key={attachment.id} className="flex items-center bg-white p-2 rounded border">
          <span className="text-sm">{attachment.file_name} ({attachment.file_type})</span>
          <button
            onClick={() => window.open(attachment.file_url)}
            className="text-blue-600 hover:text-blue-800 text-sm"
          >
            View
          </button>
        </div>
      ))}
    </div>
                      {/* Job Attachments Section */}
<div className="space-y-3 mt-6 pt-4 border-t border-gray-200">
  <h4 className="font-semibold text-gray-800">Job Attachments</h4>
  <div className="bg-gray-50 p-4 rounded-lg">
    <div className="space-y-4">
      <select id="attachment-type" className="px-3 py-2 border rounded">
        <option value="receipt">Receipt</option>
        <option value="wtn">Waste Transfer Note</option>
        <option value="invoice">Invoice</option>
        <option value="other">Other</option>
      </select>
      <input type="file" id="attachment-file" className="block" accept=".pdf,.doc,.docx,.jpg,.png" />
      <button
        onClick={handleUploadInForm}
        className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
      >
        Upload Attachment
      </button>
    </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // REPLACE the entire QuotesView component (around line 1700-1900) with this:
const QuotesView = ({ quotes, onAddQuote, onUpdateQuote, onEditQuote, onConvertToJob, onSendQuote, onAcceptQuote, onRejectQuote, onDeleteQuote, customers, suppliers, user, setShowFullPageQuote }) => {
  const [selectedQuote, setSelectedQuote] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [filters, setFilters] = useState({
  status: '',
  jobType: '',
  priority: ''
});

  // Sort quotes by quote number descending (newest first)        
  const sortedQuotes = [...quotes].sort((a, b) => {
    const aNum = parseInt(a.quoteNumber.split('-').pop());
    const bNum = parseInt(b.quoteNumber.split('-').pop());
    return bNum - aNum;
  });
  
  const filteredQuotes = sortedQuotes.filter(quote => {
  if (searchQuery) {
    const query = searchQuery.toLowerCase();
    const matchesQuoteNumber = quote.quoteNumber.toLowerCase().includes(query);
    const matchesCustomer = quote.customerName.toLowerCase().includes(query);
    const matchesSupplier = quote.supplierName && quote.supplierName.toLowerCase().includes(query);
    const matchesPostcode = (quote.sitePostcode && quote.sitePostcode.toLowerCase().includes(query)) ||
                           (quote.postcode && quote.postcode.toLowerCase().includes(query));
    const matchesAddress = (quote.siteAddress1 && quote.siteAddress1.toLowerCase().includes(query)) ||
                          (quote.siteAddress && quote.siteAddress.toLowerCase().includes(query));
    
    if (!matchesQuoteNumber && !matchesCustomer && !matchesSupplier && !matchesPostcode && !matchesAddress) {
      return false;
    }
  }
  
  if (filters.status && quote.status !== filters.status) return false;
  if (filters.jobType && quote.jobType !== filters.jobType) return false;
  if (filters.priority && quote.priority !== filters.priority) return false;
  if (filters.rejectionReason && quote.status === 'REJECTED' && 
      (!quote.rejected_reason || !quote.rejected_reason.toLowerCase().includes(filters.rejectionReason.toLowerCase()))) {
    return false;
  }
  
  return true;
});

  const handleQuoteClick = (quote) => {
    setShowFullPageQuote(quote);
  };

  const isExpired = (quote) => new Date(quote.validUntil) < new Date() && quote.status !== 'ACCEPTED';

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-2xl font-bold text-gray-900">Quotes</h2>
          <p className="text-gray-600">{filteredQuotes.length} quotes found</p>
        </div>
        <button 
          onClick={onAddQuote}
          className="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          <Plus size={16} className="mr-2" />
          New Quote
        </button>
      </div>

      {/* Filters */}
      {/* Filters */}
<div className="bg-white rounded-lg border border-gray-200 p-4">
  <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3">
    <Filter size={16} className="text-gray-600" />
    <input
      type="text"
      placeholder="Search quotes, customers, postcodes..."
      value={searchQuery}
      onChange={(e) => setSearchQuery(e.target.value)}
     className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
    />
    <select
      value={filters.status}
      onChange={(e) => setFilters({...filters, status: e.target.value})}
     className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Statuses</option>
      <option value="PENDING">Pending</option>
      <option value="SENT">Sent</option>
      <option value="ACCEPTED">Accepted</option>
      <option value="REJECTED">Rejected</option>
      <option value="CONVERTED">Converted</option>
      <option value="EXPIRED">Expired</option>
    </select>
    <select
      value={filters.jobType}
      onChange={(e) => setFilters({...filters, jobType: e.target.value})}
      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Job Types</option>
      <option value="Skip Hire">Skip Hire</option>
      <option value="Aggregates">Aggregates</option>
      <option value="Waste Collection">Waste Collection</option>
      <option value="Grab Hire">Grab Hire</option>
      <option value="Muck Away">Muck Away</option>
      <option value="Roll-on Roll-off">Roll-on Roll-off</option>
    </select>
    <select
      value={filters.priority}
      onChange={(e) => setFilters({...filters, priority: e.target.value})}
      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Priorities</option>
      <option value="Low">Low</option>
      <option value="Medium">Medium</option>
      <option value="High">High</option>
      <option value="Urgent">Urgent</option>
    </select>
    <select
      value={filters.rejectionReason}
      onChange={(e) => setFilters({...filters, rejectionReason: e.target.value})}
      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
    >
      <option value="">All Rejection Reasons</option>
      <option value="price">Price Too High</option>
      <option value="timeline">Timeline Issues</option>
      <option value="specification">Specification Mismatch</option>
      <option value="no_longer_required">No Longer Required</option>
      <option value="other">Other</option>
    </select>
    <button
      onClick={() => {
        setSearchQuery('');
        setFilters({ status: '', jobType: '', priority: '', rejectionReason: '' });
      }}
      className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
    >
      Clear
    </button>
  </div>
</div>

      <div className="bg-white rounded-lg border border-gray-200">
        <div className="p-6">
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
  <tr>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quote Number & Date</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product/Service</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postcode</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rejection Reason</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Value</th>
    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
  </tr>
</thead>
     <tbody className="bg-white divide-y divide-gray-200">
  {filteredQuotes.map(quote => {
    const statusColors = {
  'PENDING': 'bg-yellow-100 text-yellow-800',
  'SENT': 'bg-blue-100 text-blue-800',
  'ACCEPTED': 'bg-green-100 text-green-800',
  'REJECTED': 'bg-red-100 text-red-800',
  'EXPIRED': 'bg-gray-100 text-gray-800',
  'CONVERTED': 'bg-green-100 text-green-800'  // Add this line
};
    const expired = isExpired(quote);
    return (
      <tr
        key={quote.id}
        className={`hover:bg-gray-50 cursor-pointer ${
          quote.status === 'REJECTED' || expired ? 'opacity-75' : ''
        }`}
        onClick={() => handleQuoteClick(quote)}
      >
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          <div className="text-sm font-medium text-gray-900">{quote.quoteNumber}</div>
          <div className="text-xs text-gray-500">{new Date(quote.createdDate).toLocaleDateString('en-GB')}</div>
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          <div>
            <div className="text-sm text-gray-900">{quote.customerName}</div>
            <div className="text-sm text-gray-500">{quote.customerContact}</div>
          </div>
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.supplierName || '-'}
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.wasteType || quote.aggregateType || quote.jobType || '-'}
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.siteAddress || quote.siteAddress1 || '-'}
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.sitePostcode || quote.postcode || '-'}
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.jobType}
        </td>
        <td className="px-6 py-4 whitespace-nowrap">
          <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
            expired && quote.status === 'PENDING' ? statusColors['EXPIRED'] : statusColors[quote.status]
          }`}>
            {expired && quote.status === 'PENDING' ? 'EXPIRED' : quote.status}
          </span>
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          {quote.status === 'REJECTED' ? (quote.rejected_reason || '-') : '-'}
        </td>
        <td className={`px-6 py-4 whitespace-nowrap ${
  quote.status === 'REJECTED' ? 'line-through decoration-red-500' :
  quote.status === 'CONVERTED' ? 'line-through decoration-green-500' :
  expired ? 'line-through decoration-gray-500' : ''
}`}>
          £{quote.totalPrice?.toFixed(2)}
        </td>
        <td className="px-6 py-4 whitespace-nowrap text-sm">
          <div className="flex items-center space-x-2" onClick={(e) => e.stopPropagation()}>
            <button
              onClick={() => onEditQuote(quote)}
              className="text-blue-600 hover:text-blue-900"
            >
              <Edit3 size={16} />
            </button>
            {(quote.status === 'PENDING' || quote.status === 'SENT') && !expired ? (
              <button
                onClick={() => onConvertToJob(quote)}
                className="text-green-600 hover:text-green-900"
                title="Convert to Job"
              >
                <Package size={16} />
              </button>
            ) : null}
          </div>
        </td>
      </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          
          {filteredQuotes.length === 0 && (
            <div className="text-center py-8">
              <FileText className="mx-auto h-12 w-12 text-gray-400" />
              <p className="mt-2 text-gray-500">No quotes found</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

        // Add this RIGHT AFTER the JobsView component (around line 2800)

// SAFE VERSION - Add this AFTER your existing JobsView component (around line 2800)
// This works with your existing code structure and won't break anything

const FullPageJobView = ({ job, onClose, onEdit, onDuplicate, onDelete, onExchange, onCollection, onComplete, onDeleteAttachment, user, onUpdateDisplay }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [jobAttachments, setJobAttachments] = useState([]);
  const [currentJob, setCurrentJob] = useState(job);
const handleCreateInvoice = async (jobToInvoice) => {
  try {
    const isDemoMode = false;
    
    if (isDemoMode) {
      // ... demo code ...
    } else {
      const { data: customer } = await window.supabase
        .from('customers')
        .select('*')
        .eq('name', jobToInvoice.customerName)
        .single();
      
      if (!customer?.sage_id) {
        throw new Error('Customer not synced with Sage. Please sync customer first.');
      }
      
      // Calculate tax
      const unitPrice = jobToInvoice.customerUnitPrice || 0;
      const quantity = jobToInvoice.quantity || 1;
      // List of known inactive product IDs
      const lineTotal = unitPrice * quantity;
      const taxAmount = lineTotal * 0.20;
      // Use the stored sage_line_items for invoice line items
const lineItems = jobToInvoice.sage_product_data && jobToInvoice.sage_product_data.length > 0
  ? jobToInvoice.sage_product_data.map(item => {
      const line = {
          description: item.description || item.product_name,
          quantity: item.quantity || 1,
          unit_price: item.customer_price || item.unit_price || 0,
          tax_amount: (item.customer_price || item.unit_price || 0) * (item.quantity || 1) * 0.20,
          tax_rate_id: item.tax_code === 'T1' ? 'GB_STANDARD' : 'GB_ZERO',
          ledger_account_id: item.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e'
      };
      
      // Check for service (lowercase 'service')
      if (item.sage_id) {
          if (item.type?.toLowerCase() === 'service') {
              line.service_id = item.sage_id;
          } else {
              line.product_id = item.sage_id;
          }
      }
      
      return line;
  })
  : [{  // Fallback remains the same
      description: `${jobToInvoice.jobType} - ${jobToInvoice.wasteType || jobToInvoice.aggregateType || ''}`,
      quantity: jobToInvoice.quantity,
      unit_price: jobToInvoice.customerUnitPrice,
      tax_amount: jobToInvoice.customerUnitPrice * jobToInvoice.quantity * 0.20,
      tax_rate_id: 'GB_STANDARD',
      ledger_account_id: 'dc4b88bb472b11e9aac702d5719f235e'
  }];
console.log('JobToInvoice object:', jobToInvoice);
console.log('Site fields:', {
    siteAddress1: jobToInvoice.siteAddress1,
    siteAddress: jobToInvoice.siteAddress,
    siteCity: jobToInvoice.siteCity
});
const invoiceData = {
    sales_invoice: {
        contact_id: customer.sage_id,
        date: new Date().toISOString().split('T')[0],
        due_date: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
        reference: jobToInvoice.customerPO || jobToInvoice.customer_po || '',
        // REMOVE LINE 3314 - no notes field at all
        // CHANGE: Add delivery_settings instead of main_address
        delivery_address: {
    address_line_1: jobToInvoice.siteAddress1 || '',  // Changed from site_address1
address_line_2: jobToInvoice.siteAddress2 || '',  // Changed from site_address2
city: jobToInvoice.siteCity || '',                // Changed from site_city
region: jobToInvoice.siteCounty || '',            // Changed from site_county
postal_code: jobToInvoice.sitePostcode || '',     // Changed from site_postcode
    country_code: 'GB'
},
        invoice_lines: lineItems
    }
};
      console.log('=== FULL INVOICE DATA BEING SENT TO SAGE ===');
console.log(JSON.stringify(invoiceData, null, 2));
      console.log('Creating invoice in Sage...');
      const invoice = await window.SageAPI.createDraftInvoice(invoiceData);
      
      // DEBUG: Log the full response
      console.log('Sage API Response:', invoice);
      
      // Extract SI number - check different possible fields
      const siNumber = invoice.invoice_number || invoice.displayed_as || invoice.reference || invoice.id;
      
      console.log('Extracted SI Number:', siNumber);
      
      // Update database
      const updateData = {
        sage_invoice_id: invoice.id,
        invoice_number: siNumber,  // Use SI number as invoice number
        sage_si_number: siNumber,
        invoice_status: 'Invoiced'
      };
      
      console.log('Updating database with:', updateData);
      
      const { data: updateResult, error: updateError } = await window.supabase
        .from('jobs')
        .update(updateData)
        .eq('id', jobToInvoice.id)
        .select();  // Add .select() to see what was updated
      
      if (updateError) {
        console.error('Database update error:', updateError);
        throw updateError;
      }
      
      console.log('Database update result:', updateResult);
      
      // Fetch the updated job
      const { data: updatedJob, error: fetchError } = await window.supabase
        .from('jobs')
        .select('*')
        .eq('id', jobToInvoice.id)
        .single();
      
      if (fetchError) {
        console.error('Fetch error:', fetchError);
      } else {
        console.log('Updated job from database:', updatedJob);
         onUpdateDisplay(updatedJob);
        
      }
      
      alert(`Invoice created! SI: ${siNumber}`);
      
    }
  } catch (error) {
    console.error('Full error:', error);
    alert('Failed to create invoice: ' + error.message);
  }
};
  // Load attachments when component mounts
  useEffect(() => {
    if (job?.id) {
      loadJobAttachments(job.id);
    }
  }, [job?.id]);

  const loadJobAttachments = async (jobId) => {
    try {
      const { data, error } = await window.supabase
        .from('job_attachments')
        .select('*')
        .eq('job_id', jobId)
        .order('uploaded_at', { ascending: false });

      if (error) throw error;
      setJobAttachments(data || []);
    } catch (error) {
      console.error('Error loading job attachments:', error);
      setJobAttachments([]);
    }
  };

  const uploadJobAttachment = async () => {
    const attachmentType = document.getElementById('attachment-type')?.value;
    const fileInput = document.getElementById('attachment-file');
    const file = fileInput?.files[0];

    if (!attachmentType || !file || !job) {
      alert('Please select attachment type, file, and ensure a job is selected');
      return;
    }

    try {
      const fileName = `job_${job.id}_${Date.now()}_${file.name}`;
      const { data: fileData, error: fileError } = await window.supabase.storage
        .from('documents')
        .upload(fileName, file);

      if (fileError) throw fileError;

      const { data: { publicUrl } } = window.supabase.storage
        .from('documents')
        .getPublicUrl(fileName);

      const { data, error } = await window.supabase
        .from('job_attachments')
        .insert([{
          job_id: job.id,
          file_name: file.name,
          file_url: publicUrl,
          file_type: attachmentType,
          file_size: file.size,
          uploaded_by: user?.email
        }]);

      if (error) throw error;

      alert('Job attachment uploaded successfully!');
      loadJobAttachments(job.id);
      
      document.getElementById('attachment-file').value = '';
    } catch (error) {
      console.error('Error uploading job attachment:', error);
      alert('Error uploading job attachment');
    }
  };

  if (!job) return null;

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header Section */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-4">
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
            >
              <LucideIcon icon="ChevronUp" size={24} className="rotate-90" />
            </button>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">{job.jobNumber}</h1>
              <p className="text-gray-600">{job.jobType}</p>
            </div>
            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
              job.status === 'COLLECTED' ? 'bg-purple-100 text-purple-800' :
              job.isCompleted ? 'bg-emerald-100 text-emerald-800' :
              job.isCancelled ? 'bg-red-100 text-red-800' :
              'bg-blue-100 text-blue-800'
            }`}>
              {job.status === 'COLLECTED' ? 'Collected' :
               job.isCompleted ? 'Completed' : 
               job.isCancelled ? 'Cancelled' : 
               job.status}
            </span>
            {job.priority && (
              <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                job.priority === 'High' || job.priority === 'Urgent' ? 'bg-red-100 text-red-700' :
                job.priority === 'Medium' ? 'bg-yellow-100 text-yellow-700' :
                'bg-green-100 text-green-700'
              }`}>
                {job.priority} Priority
              </span>
            )}
          </div>
          
          <div className="flex items-center space-x-2">
            <button
             onClick={() => {
  onEdit(job);
  // Store a reference to reload attachments after edit
  window.refreshFullPageAttachments = () => loadJobAttachments(job.id);
}}
              className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
              title="Edit Job"
            >
              <Edit3 size={20} />
            </button>
            <button
              onClick={() => onDuplicate(job)}
              className="p-2 text-green-600 hover:bg-green-100 rounded-lg"
              title="Duplicate Job"
            >
              <Copy size={20} />
            </button>
            {job.jobType !== 'Skip Hire' && job.jobType !== 'Roll-on Roll-off' && !job.isCompleted && job.status !== 'COMPLETED' && (
  <button
   onClick={() => onComplete(job)}
    className="p-2 text-green-600 hover:bg-green-100 rounded-lg"
    title="Mark as Completed"
  >
  <LucideIcon icon="CheckCircle" size={20} />
  </button>
)}
            {(job.jobType === 'Skip Hire' || job.jobType === 'Roll-on Roll-off') && 
             !job.isCompleted && job.status !== 'COLLECTED' && (
              <>
                <button
                  onClick={() => onExchange(job)}
                  className="p-2 text-orange-600 hover:bg-orange-100 rounded-lg"
                  title="Exchange"
                >
                  <Repeat size={20} />
                </button>
                <button
                  onClick={() => onCollection(job)}
                  className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                  title="Mark as Collected"
                >
                  <Package size={20} />
                </button>
              </>
              
            )}
            {user?.role === 'ADMIN' && (
              <button
                onClick={() => onDelete(job.id)}
                className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                title="Delete Job"
              >
                <Trash2 size={20} />
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="bg-white border-b border-gray-200">
        <div className="px-6">
          <nav className="flex space-x-8">
            <button
              onClick={() => setActiveTab('overview')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'overview'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Job Overview
            </button>
            <button
              onClick={() => setActiveTab('financial')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'financial'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Financial & Billing
            </button>
            <button
              onClick={() => setActiveTab('documents')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'documents'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Documents
            </button>
          </nav>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="max-w-7xl mx-auto px-6 py-8">
        
        {/* Job Overview Tab */}
        {activeTab === 'overview' && (
          <div className="space-y-8">
            
            {/* Job & Customer Information */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Job & Customer Information</h2>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Customer:</span>
                      <span className="font-semibold text-gray-900">{job.customerName}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Customer PO:</span>
                      <span className="text-gray-900">{job.customerPO || 'Not provided'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Supplier:</span>
                      <span className="font-semibold text-gray-900">{job.supplierName}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Supplier Reference:</span>
                      <span className="font-semibold text-gray-900">{job.supplierRef || 'Not provided'}</span>
                    </div>
                  </div>
                  <div className="space-y-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Job Type:</span>
                      <span className="text-gray-900">{job.jobType}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Created Date:</span>
                      <span className="text-gray-900">{new Date(job.jobDate).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Delivery Date:</span>
                      <span className="text-gray-900 font-semibold">{new Date(job.jobDate).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Quantity:</span>
                      <span className="text-gray-900">{job.quantity} {job.unit}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {/* Customer Extended Information */}
<div className="bg-white rounded-lg border border-gray-200 p-4 mt-4">
  <h2 className="text-lg font-semibold text-gray-800 mb-4">Customer Details</h2>
  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div className="space-y-4">
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Reference:</span>
        <span className="font-medium text-gray-900">{job.customerReference || 'Not provided'}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Main Contact:</span>
        <span className="font-medium text-gray-900">{job.customerMainContact || 'Not provided'}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Mobile:</span>
        <span className="font-medium text-gray-900">{job.customerMobile || 'Not provided'}</span>
      </div>
    </div>
    <div className="space-y-4">
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Credit Limit:</span>
        <span className="font-medium text-gray-900">£{(job.customerCreditLimit || 0).toLocaleString()}</span>
      </div>
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Payment Terms:</span>
        <span className="font-medium text-gray-900">{job.customerCreditDays || 30} days</span>
      </div>
      <div className="flex justify-between">
        <span className="text-gray-600 font-medium">Account Status:</span>
        <span className={`font-semibold ${job.customerAccountStatus === 'Active' ? 'text-green-600' : 'text-gray-500'}`}>
          {job.customerAccountStatus || 'Active'}
        </span>
      </div>
    </div>
    {job.customerDeliveryAddress && (
      <div className="col-span-2 pt-4 border-t border-gray-200">
        <div className="flex justify-between">
          <span className="text-gray-600 font-medium">Delivery Address:</span>
          <span className="font-medium text-gray-900 text-right">
            {job.customerDeliveryAddress.address_line_1}
            {job.customerDeliveryAddress.address_line_2 && `, ${job.customerDeliveryAddress.address_line_2}`}
            {job.customerDeliveryAddress.city && `, ${job.customerDeliveryAddress.city}`}
            {job.customerDeliveryAddress.postal_code && ` ${job.customerDeliveryAddress.postal_code}`}
          </span>
        </div>
      </div>
    )}
  </div>
</div>

            {/* Site & Logistics */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Site & Logistics</h2>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div>
                      <span className="text-gray-600 font-medium block mb-1">Site Address:</span>
                      <div className="text-gray-900">
                        <div>{job.siteAddress1}</div>
                        {job.siteAddress2 && <div>{job.siteAddress2}</div>}
                        <div>{job.sitePostcode}</div>
                      </div>
                    </div>
                    {job.siteContact && (
                      <div className="flex justify-between">
                        <span className="text-gray-600 font-medium">Site Contact:</span>
                        <span className="text-gray-900">{job.siteContact}</span>
                      </div>
                    )}
                    {job.sitePhone && (
                      <div className="flex justify-between">
                        <span className="text-gray-600 font-medium">Contact Phone:</span>
                        <span className="text-gray-900">{job.sitePhone}</span>
                      </div>
                    )}
                  </div>
                  <div className="space-y-4">
                    {job.haulierName && (
                      <div className="flex justify-between">
                        <span className="text-gray-600 font-medium">Haulier:</span>
                        <span className="font-semibold text-gray-900">{job.haulierName}</span>
                      </div>
                    )}
                    {job.timeSlot && (
                      <div className="flex justify-between">
                        <span className="text-gray-600 font-medium">Time Slot:</span>
                        <span className="text-gray-900">{job.timeSlot}</span>
                      </div>
                    )}
                    {job.deliveryInstructions && (
                      <div>
                        <span className="text-gray-600 font-medium block mb-1">Delivery Instructions:</span>
                        <span className="text-gray-900">{job.deliveryInstructions}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Products & Services Summary */}
<div className="bg-white rounded-lg border border-gray-200">
  <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
    <h2 className="text-lg font-semibold text-gray-800">Products & Services</h2>
  </div>
  <div className="p-6">
    {job.lineItems && job.lineItems.length > 0 ? (
      <>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="border-b border-gray-200">
                <th className="text-left py-3 px-4 font-medium text-gray-700">Product/Service</th>
                <th className="text-left py-3 px-4 font-medium text-gray-700">Description</th>
                <th className="text-center py-3 px-4 font-medium text-gray-700">Qty</th>
                <th className="text-right py-3 px-4 font-medium text-gray-700">Cost</th>
                <th className="text-right py-3 px-4 font-medium text-gray-700">RRP</th>
                <th className="text-right py-3 px-4 font-medium text-gray-700">Line Profit</th>
              </tr>
            </thead>
            <tbody>
              {job.lineItems.map((item, index) => {
                const lineCost = (item.supplier_price || 0) * (item.quantity || 1);
                const lineRRP = (item.customer_price || 0) * (item.quantity || 1);
                const lineProfit = lineRRP - lineCost;
                const profitMargin = lineRRP > 0 ? ((lineProfit / lineRRP) * 100).toFixed(1) : 0;
                
                return (
                  <tr key={item.id || index} className="border-b border-gray-100">
                    <td className="py-3 px-4">
                      <div className="font-medium">{item.product_name || item.name}</div>
                      <div className="text-xs text-gray-500">Code: {item.item_code || 'N/A'}</div>
                    </td>
                    <td className="py-3 px-4 text-gray-600">
                      {item.description || 'No description'}
                    </td>
                    <td className="py-3 px-4 text-center">
                      <span className="font-medium">{item.quantity || 1}</span>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <div className="text-red-600 font-medium">
                        £{lineCost.toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500">
                        @ £{(item.supplier_price || 0).toFixed(2)}
                      </div>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <div className="text-blue-600 font-medium">
                        £{lineRRP.toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500">
                        @ £{(item.customer_price || 0).toFixed(2)}
                      </div>
                    </td>
                    <td className="py-3 px-4 text-right">
                      <div className={`font-medium ${lineProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        £{lineProfit.toFixed(2)}
                      </div>
                      <div className="text-xs text-gray-500">
                        {profitMargin}%
                      </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
        
        {/* Summary Cards */}
<div className="grid grid-cols-5 gap-4 mt-6 pt-6 border-t">
  <div className="bg-gray-50 rounded-lg p-4">
    <div className="text-sm text-gray-600 font-medium">Total Items</div>
    <div className="text-2xl font-bold text-gray-700">
      {job.lineItems.length}
    </div>
  </div>
  <div className="bg-gray-50 rounded-lg p-4">
    <div className="text-sm text-gray-600 font-medium">Total Quantity</div>
    <div className="text-2xl font-bold text-gray-700">
      {job.lineItems.reduce((sum, item) => sum + (item.quantity || 1), 0)}
    </div>
  </div>
  <div className="bg-blue-50 rounded-lg p-4">
    <div className="text-sm text-blue-600 font-medium">Total Job Value</div>
    <div className="text-2xl font-bold text-blue-700">
      £{job.lineItems.reduce((sum, item) =>
        sum + ((item.customer_price || 0) * (item.quantity || 1)), 0
      ).toFixed(2)}
    </div>
  </div>
  <div className="bg-green-50 rounded-lg p-4">
    <div className="text-sm text-green-600 font-medium">Total Job Profit</div>
    <div className="text-2xl font-bold text-green-700">
      £{(job.lineItems.reduce((sum, item) =>
        sum + ((item.customer_price || 0) * (item.quantity || 1)), 0
      ) - job.lineItems.reduce((sum, item) =>
        sum + ((item.supplier_price || 0) * (item.quantity || 1)), 0
      )).toFixed(2)}
    </div>
  </div>
  <div className="bg-purple-50 rounded-lg p-4">
    <div className="text-sm text-purple-600 font-medium">Profit Margin</div>
    <div className="text-2xl font-bold text-purple-700">
      {(() => {
        const totalRRP = job.lineItems.reduce((sum, item) =>
          sum + ((item.customer_price || 0) * (item.quantity || 1)), 0
        );
        const totalCost = job.lineItems.reduce((sum, item) =>
          sum + ((item.supplier_price || 0) * (item.quantity || 1)), 0
        );
        const margin = totalRRP > 0 ? ((totalRRP - totalCost) / totalRRP * 100) : 0;
        return margin.toFixed(1);
      })()}%
    </div>
  </div>
</div>
</>
) : (
  <div className="text-center py-8 text-gray-500">
    <p>No products or services added</p>
  </div>
)}
</div>
</div>

            {/* Special Information */}
            {(job.parentJobId || (job.linkedJobs && job.linkedJobs.length > 0)) && (
              <div className="space-y-4">
                {job.parentJobId && (
                  <div className="bg-orange-50 border border-orange-200 rounded-lg p-4">
                    <h3 className="font-semibold text-orange-900 mb-2">Exchange Information</h3>
                    <p className="text-orange-700">This is an exchange job from: <span className="font-semibold">{job.parentJobId}</span></p>
                  </div>
                )}

                {job.linkedJobs && job.linkedJobs.length > 0 && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 className="font-semibold text-blue-900 mb-2">Linked Jobs</h3>
                    <div className="flex flex-wrap gap-2">
                      {job.linkedJobs.map(jobId => (
                        <span key={jobId} className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">
                          {jobId}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            )}

          </div>
        )}

        {/* Financial & Billing Tab */}
        {activeTab === 'financial' && (
          <div className="space-y-8">
            
           
              {/* Add Create Invoice Button */}
{activeTab === 'financial' && (
  <div className="mt-6">
    {job.isCompleted && !job.sageInvoiceId && user.role === 'ADMIN' && (
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h3 className="text-lg font-semibold text-gray-800 mb-4">Sage Integration</h3>
        <button
  onClick={() => handleCreateInvoice(job)}
  disabled={job.sageInvoiceId ? true : false}
  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
>
          <FileText className="inline mr-2" size={20} />
          Create Invoice in Sage
        </button>
        {job.sageInvoiceId && (
          <p className="mt-2 text-sm text-gray-600">
            Sage Invoice ID: {job.sage_invoice_id}
          </p>
        )}
      </div>
    )}
  </div>
)}
           {/* Invoice Information */}
<div className="bg-white rounded-lg border border-gray-200">
  <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
    <h2 className="text-lg font-semibold text-gray-800">Invoice & Payment Status</h2>
  </div>
  <div className="p-6">
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div className="space-y-4">
        <div className="flex justify-between">
          <span className="text-gray-600 font-medium">Invoice Number:</span>
          <span className="text-gray-900">{job.invoiceNumber || 'Not invoiced'}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-gray-600 font-medium">Invoice Status:</span>
          <span className={`px-2 py-1 text-xs font-medium rounded-full ${
            job.invoiceStatus === 'Invoiced' ? 'bg-green-100 text-green-700' : 
            'bg-gray-100 text-gray-700'
          }`}>
            {job.invoiceStatus || 'Not Invoiced'}
          </span>
        </div>
        {job.wasteTransferNote && (
          <div className="flex justify-between">
            <span className="text-gray-600 font-medium">Waste Transfer Note:</span>
            <span className="text-gray-900">{currentjob.wasteTransferNote}</span>
          </div>
        )}
        {job.sage_si_number && (
          <div>
            <span className="font-medium">SI Number:</span>
            <span className="text-blue-600 font-bold">{currentJob.sage_si_number}</span>
          </div>
        )}
      </div>
    </div>
  </div>
</div>

          </div>
        )}

        {/* Documents Tab */}
        {activeTab === 'documents' && (
          <div className="space-y-8">
            
            {/* Job Attachments */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Job Attachments</h2>
              </div>
              <div className="p-6">
                
              {/* Upload Section */}
<div className="bg-gray-50 p-4 rounded-lg mb-6">
  <h4 className="font-medium text-gray-800 mb-4">Upload New Attachment</h4>
  <div className="space-y-4">
    <select id="attachment-type" className="px-3 py-2 border rounded">
      <option value="receipt">Receipt</option>
      <option value="wtn">Waste Transfer Note</option>
      <option value="invoice">Invoice</option>
      <option value="photo">Photo</option>
      <option value="other">Other</option>
    </select>
    <input type="file" id="attachment-file" className="block" accept=".pdf,.doc,.docx,.jpg,.png" onChange={(e) => setUploadFile(e.target.files[0])} />
    <button
      onClick={uploadJobAttachment}
      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
    >
      Upload Attachment
    </button>
  </div>
</div>

{/* Attachments List */}
<div className="space-y-4">
  {jobAttachments.length === 0 ? (
    <div className="text-center py-8 text-gray-500">
      <p className="mt-2">No attachments yet</p>
      <p className="text-sm">Upload documents, photos, or receipts related to this job</p>
    </div>
  ) : (
    jobAttachments.map(attachment => (
      <div key={attachment.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
        <span className="text-sm">{attachment.file_name} ({attachment.file_type})</span>
        <div className="flex gap-2">
          <button
            onClick={() => window.open(attachment.file_url)}
            className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
          >
            View
          </button>
          {user?.role === 'ADMIN' && (
            <button
              type="button"
              onClick={async () => {
  if (confirm(`Are you sure you want to delete ${attachment.file_name}?`)) {
    try {
      // Delete from database
      const { error } = await window.supabase
        .from('job_attachments')
        .delete()
        .eq('id', attachment.id);
      
      if (error) throw error;
      
      // Immediately update the local state to remove the attachment
      setJobAttachments(prevAttachments => 
        prevAttachments.filter(att => att.id !== attachment.id)
      );
      
      alert('Attachment deleted successfully!');
    } catch (error) {
      console.error('Error deleting attachment:', error);
      alert('Error deleting attachment: ' + error.message);
      // Reload attachments in case of error to ensure UI is in sync
      loadJobAttachments(job.id);
    }
  }
}}
              className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
            >
              Delete
            </button>
          )}
        </div>
      </div>
    ))
  )}
</div>
</div>
</div>

{/* Job Notes */}
{job.notes && (
  <div className="bg-white rounded-lg border border-gray-200">
    <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
      <h2 className="text-lg font-semibold text-gray-800">Job Notes</h2>
    </div>
    <div className="p-6">
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <p className="text-yellow-800">{job.notes}</p>
      </div>
    </div>
  </div>
)}
</div>
)}
</div>
</div>
);
};
// Full Page Quote View Component - Add this RIGHT AFTER FullPageJobView (around line 3400)
const FullPageQuoteView = ({ quote, onClose, onEdit, onDuplicate, onDelete, onSend, onAccept, onReject, onConvertToJob, user }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [quoteAttachments, setQuoteAttachments] = useState([]);

  // Load attachments when component mounts
  useEffect(() => {
    if (quote?.id) {
      loadQuoteAttachments(quote.id);
    }
  }, [quote?.id]);

  const loadQuoteAttachments = async (quoteId) => {
  try {
    const { data, error } = await window.supabase
      .from('quote_attachments')
      .select('*')
      .eq('quote_id', quoteId)
      .order('created_at', { ascending: false }); // Changed to created_at
    
    if (error) throw error;
    setQuoteAttachments(data || []);
  } catch (error) {
    console.error('Error loading quote attachments:', error);
    setQuoteAttachments([]);
  }
};

  const uploadQuoteAttachment = async () => {
    const attachmentType = document.getElementById('quote-attachment-type')?.value;
    const fileInput = document.getElementById('quote-attachment-file');
    const file = fileInput?.files[0];

    if (!attachmentType || !file || !quote) {
      alert('Please select attachment type and file');
      return;
    }

    try {
      const fileName = `quote_${quote.id}_${Date.now()}_${file.name}`;
      const { data: fileData, error: fileError } = await window.supabase.storage
        .from('documents')
        .upload(fileName, file);

      if (fileError) throw fileError;

      const { data: { publicUrl } } = window.supabase.storage
        .from('documents')
        .getPublicUrl(fileName);

      const { data, error } = await window.supabase
        .from('quote_attachments')
        .insert([{
          quote_id: quote.id,
          file_name: file.name,
          file_url: publicUrl,
          file_type: attachmentType,
          file_size: file.size,
          uploaded_by: user?.email
        }]);

      if (error) throw error;

      alert('Quote attachment uploaded successfully!');
      loadQuoteAttachments(quote.id);
      
      document.getElementById('quote-attachment-file').value = '';
    } catch (error) {
      console.error('Error uploading quote attachment:', error);
      alert('Error uploading quote attachment');
    }
  };

  const handleDeleteAttachment = async (attachmentId) => {
    if (!confirm('Are you sure you want to delete this attachment?')) return;
    
    try {
      const { error } = await window.supabase
        .from('quote_attachments')
        .delete()
        .eq('id', attachmentId);
      
      if (error) throw error;
      
      setQuoteAttachments(prevAttachments => 
        prevAttachments.filter(att => att.id !== attachmentId)
      );
      
      alert('Attachment deleted successfully!');
    } catch (error) {
      console.error('Error deleting attachment:', error);
      alert('Error deleting attachment: ' + error.message);
    }
  };

  if (!quote) return null;

  const isExpired = new Date(quote.validUntil) < new Date() && quote.status !== 'ACCEPTED';

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header Section */}
      <div className="bg-white border-b border-gray-200 px-6 py-4">
        <div className="flex justify-between items-center">
          <div className="flex items-center space-x-4">
            <button
              onClick={onClose}
              className="p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100"
            >
              <LucideIcon icon="ChevronUp" size={24} className="rotate-90" />
            </button>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">{quote.quoteNumber}</h1>
              <p className="text-gray-600">{quote.jobType}</p>
            </div>
            <span className={`px-3 py-1 rounded-full text-sm font-medium ${
              isExpired && quote.status === 'PENDING' ? 'bg-gray-100 text-gray-800' :
              quote.status === 'ACCEPTED' ? 'bg-green-100 text-green-800' :
              quote.status === 'REJECTED' ? 'bg-red-100 text-red-800' :
              quote.status === 'SENT' ? 'bg-blue-100 text-blue-800' :
              'bg-yellow-100 text-yellow-800'
            }`}>
              {isExpired && quote.status === 'PENDING' ? 'EXPIRED' : quote.status}
            </span>
            {quote.status === 'REJECTED' && quote.rejectedReason && (
  <div className="ml-4 text-sm text-red-600">
    Reason: {quote.rejectedReason}
  </div>
)}
            {quote.validUntil && (
              <span className="text-sm text-gray-600">
                Valid until: {new Date(quote.validUntil).toLocaleDateString()}
              </span>
            )}
          </div>
          
          <div className="flex items-center space-x-2">
            {quote.status === 'PENDING' && (
  <button
    onClick={() => onSend(quote)}
    className="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"
    title="Send to Sage"
  >
    <Mail size={16} className="mr-2" />
    Send to Sage
  </button>
)}
            {quote.status === 'SENT' && !isExpired && (
  <>
    <button
      onClick={() => onAccept(quote)}
      className="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center"
      title="Accept Quote"
    >
      <LucideIcon icon="CheckCircle" size={16} className="mr-2" />
      Accept Quote
    </button>
    <button
      onClick={() => onReject(quote)}
      className="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center"
      title="Reject Quote"
    >
      <X size={16} className="mr-2" />
      Reject
    </button>
  </>
)}
{(quote.status === 'PENDING' || quote.status === 'SENT') && !isExpired && (
  <button
    onClick={() => onConvertToJob(quote)}
    className="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center"
    title="Convert to Job"
  >
    <Package size={16} className="mr-2" />
    Convert to Job
  </button>
)}
            <button
              onClick={() => onEdit(quote)}
              className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
              title="Edit Quote"
            >
              <Edit3 size={20} />
            </button>
            <button
              onClick={() => onDuplicate(quote)}
              className="p-2 text-green-600 hover:bg-green-100 rounded-lg"
              title="Duplicate Quote"
            >
              <Copy size={20} />
            </button>
            {quote.status !== 'REJECTED' && (
  <button
    onClick={() => onReject(quote)}
    className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
    title="Reject Quote"
  >
    <X size={20} />
  </button>
)}
            {user?.role === 'ADMIN' && (
              <button
                onClick={() => onDelete(quote.id)}
                className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                title="Delete Quote"
              >
                <Trash2 size={20} />
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Tab Navigation */}
      <div className="bg-white border-b border-gray-200">
        <div className="px-6">
          <nav className="flex space-x-8">
            <button
              onClick={() => setActiveTab('overview')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'overview'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Quote Overview
            </button>
            <button
              onClick={() => setActiveTab('financial')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'financial'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Pricing Details
            </button>
            <button
              onClick={() => setActiveTab('documents')}
              className={`py-4 px-1 border-b-2 font-medium text-sm transition-all ${
                activeTab === 'documents'
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              Documents
            </button>
          </nav>
        </div>
      </div>

      {/* Main Content Area */}
      <div className="max-w-7xl mx-auto px-6 py-8">
        
        {/* Quote Overview Tab */}
        {activeTab === 'overview' && (
          <div className="space-y-8">
            
            {/* Customer Information */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Customer Information</h2>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div className="space-y-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Customer:</span>
                      <span className="font-semibold text-gray-900">{quote.customerName}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Contact:</span>
                      <span className="text-gray-900">{quote.customerContact || 'Not provided'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Email:</span>
                      <span className="text-gray-900">{quote.customerEmail || 'Not provided'}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Phone:</span>
                      <span className="text-gray-900">{quote.customerPhone || 'Not provided'}</span>
                    </div>
                  </div>
                  <div className="space-y-4">
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Quote Type:</span>
                      <span className="text-gray-900">{quote.jobType}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Created Date:</span>
                      <span className="text-gray-900">{new Date(quote.createdDate).toLocaleDateString()}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Valid Until:</span>
                      <span className={`font-semibold ${isExpired ? 'text-red-600' : 'text-gray-900'}`}>
                        {new Date(quote.validUntil).toLocaleDateString()}
                      </span>
                    </div>
                    {quote.deliveryDate && (
                      <div className="flex justify-between">
                        <span className="text-gray-600 font-medium">Proposed Delivery:</span>
                        <span className="text-gray-900">{new Date(quote.deliveryDate).toLocaleDateString()}</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>

            {/* Site Information */}
            {(quote.siteAddress || quote.sitePostcode) && (
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                  <h2 className="text-lg font-semibold text-gray-800">Site Information</h2>
                </div>
                <div className="p-6">
                  <div className="space-y-4">
                    <div>
                      <span className="text-gray-600 font-medium block mb-1">Site Address:</span>
                      <div className="text-gray-900">
                        {quote.siteAddress && <div>{quote.siteAddress}</div>}
                        {quote.sitePostcode && <div>{quote.sitePostcode}</div>}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Products & Services */}
            {quote.lineItems && quote.lineItems.length > 0 && (
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                  <h2 className="text-lg font-semibold text-gray-800">Products & Services</h2>
                </div>
                <div className="p-6">
                  <div className="space-y-4">
                    {quote.lineItems.map((item, index) => (
                      <div key={item.id || index} className="border border-gray-200 rounded-lg p-4 bg-green-50 border-green-200">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                          <div>
                            <div className="text-sm text-gray-600 font-medium">Product/Service</div>
                            <div className="text-lg font-semibold text-gray-900">{item.product_name || item.name}</div>
                            {item.item_code && (
                              <div className="text-sm text-gray-600">Code: {item.item_code}</div>
                            )}
                          </div>
                          <div>
                            <div className="text-sm text-gray-600 font-medium">Description</div>
                            <div className="text-gray-900">{item.description || 'No description'}</div>
                          </div>
                          <div>
                            <div className="text-sm text-gray-600 font-medium">Quantity</div>
                            <div className="text-gray-900">
                              <div className="font-semibold">{item.quantity || 1}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}

            {/* Notes */}
            {quote.notes && (
              <div className="bg-white rounded-lg border border-gray-200">
                <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                  <h2 className="text-lg font-semibold text-gray-800">Quote Notes</h2>
                </div>
                <div className="p-6">
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p className="text-yellow-800">{quote.notes}</p>
                  </div>
                </div>
              </div>
            )}

          </div>
        )}

        {/* Pricing Details Tab */}
        {activeTab === 'financial' && (
          <div className="space-y-8">
            
            {/* Pricing Summary */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Pricing Summary</h2>
              </div>
              <div className="p-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <div className="text-center">
                    <div className="text-sm text-gray-600 font-medium">Quantity</div>
                    <div className="text-2xl font-bold text-gray-900">{quote.quantity} {quote.unit}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-sm text-gray-600 font-medium">Unit Price</div>
                    <div className="text-2xl font-bold text-blue-600">£{quote.price?.toFixed(2) || '0.00'}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-sm text-gray-600 font-medium">Total Quote Value</div>
                    <div className="text-2xl font-bold text-green-600">£{quote.totalPrice?.toFixed(2) || '0.00'}</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Quote Details */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Quote Details</h2>
              </div>
              <div className="p-6">
                <div className="space-y-4">
                  <div className="flex justify-between">
                    <span className="text-gray-600 font-medium">Service Type:</span>
                    <span className="text-gray-900">{quote.jobType}</span>
                  </div>
                  {quote.wasteType && (
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Waste Type:</span>
                      <span className="text-gray-900">{quote.wasteType}</span>
                    </div>
                  )}
                  {quote.skipSize && (
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Skip Size:</span>
                      <span className="text-gray-900">{quote.skipSize}</span>
                    </div>
                  )}
                  {quote.aggregateType && (
                    <div className="flex justify-between">
                      <span className="text-gray-600 font-medium">Aggregate Type:</span>
                      <span className="text-gray-900">{quote.aggregateType}</span>
                    </div>
                  )}
                </div>
              </div>
            </div>

          </div>
        )}

        {/* Documents Tab */}
        {activeTab === 'documents' && (
          <div className="space-y-8">
            
            {/* Quote Attachments */}
            <div className="bg-white rounded-lg border border-gray-200">
              <div className="bg-gray-50 border-b border-gray-200 px-6 py-4">
                <h2 className="text-lg font-semibold text-gray-800">Quote Attachments</h2>
              </div>
              <div className="p-6">
                
                {/* Upload Section */}
                <div className="bg-gray-50 p-4 rounded-lg mb-6">
                  <h4 className="font-medium text-gray-800 mb-4">Upload New Attachment</h4>
                  <div className="space-y-4">
                    <select id="quote-attachment-type" className="px-3 py-2 border rounded">
                      <option value="Quote Document">Quote Document</option>
                      <option value="Supporting Document">Supporting Document</option>
                      <option value="Terms & Conditions">Terms & Conditions</option>
                      <option value="Other">Other</option>
                    </select>
                    <input type="file" id="quote-attachment-file" className="block" accept=".pdf,.doc,.docx,.jpg,.png" />
                    <button
                      onClick={uploadQuoteAttachment}
                      className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                    >
                      Upload Attachment
                    </button>
                  </div>
                </div>

                {/* Attachments List */}
                <div className="space-y-4">
                  {quoteAttachments.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      <p className="mt-2">No attachments yet</p>
                      <p className="text-sm">Upload quote documents or supporting files</p>
                    </div>
                  ) : (
                    quoteAttachments.map(attachment => (
                      <div key={attachment.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <span className="text-sm">{attachment.file_name} ({attachment.file_type})</span>
                        <div className="flex gap-2">
                          <button
                            onClick={() => window.open(attachment.file_url)}
                            className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                          >
                            View
                          </button>
                          {user?.role === 'ADMIN' && (
                            <button
                              type="button"
                              onClick={() => handleDeleteAttachment(attachment.id)}
                              className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                            >
                              Delete
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            </div>

          </div>
        )}
      </div>
    </div>
  );
};
        // Customers View Component
          const CustomersView = ({ customers, onAddCustomer, onUpdateCustomer, onDeleteCustomer, user }) => {
          const { hasPermission } = useAuth();
          const [selectedCustomer, setSelectedCustomer] = useState(null);
          const [editingCustomer, setEditingCustomer] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [filters, setFilters] = useState({
            businessType: '',
            creditRating: '',
            accountStatus: ''
          });

          const [showSyncDialog, setShowSyncDialog] = useState(false);
const [syncResults, setSyncResults] = useState(null);
const [syncing, setSyncing] = useState(false);
// Add auto-sync interval after your other useEffect hooks
useEffect(() => {
  // Run quick sync every 30 minutes
  const interval = setInterval(() => {
    console.log('Auto-sync check at ' + new Date().toLocaleTimeString());
    handleQuickSync();
  }, 30 * 60 * 1000); // 30 minutes
  
  // Cleanup on unmount
  return () => clearInterval(interval);
}, []);
          const filteredCustomers = customers.filter(customer => {
  if (searchQuery && 
      !(customer.companyName || customer.name || '').toLowerCase().includes(searchQuery.toLowerCase()) &&
      !(customer.primaryContact || '').toLowerCase().includes(searchQuery.toLowerCase())) {
    return false;
  }
  // ... rest of the filter logic
            if (filters.businessType && customer.businessType !== filters.businessType) return false;
            if (filters.creditRating && customer.creditRating !== filters.creditRating) return false;
            if (filters.accountStatus && customer.accountStatus !== filters.accountStatus) return false;
            return true;
          });
const displayCustomers = filteredCustomers.map(customer => ({
  ...customer,
  companyName: customer.companyName || customer.name,
  primaryContact: customer.primaryContact || '',
  businessType: customer.businessType || 'Other',
  creditRating: customer.creditRating || 'B',
  creditLimit: customer.creditLimit || 0,
  accountStatus: customer.accountStatus || 'Active',
  vatNumber: customer.vatNumber || customer.vat_number,
  email: customer.email || '',
  reference: customer.reference || '',
  mobile: customer.mobile || '',
  credit_days: customer.credit_days || 30,
  main_contact_name: customer.main_contact_name || '',
  delivery_address: customer.delivery_address || null
}));

          const handleDeleteCustomer = (customer) => {
          if (confirm(`Are you sure you want to delete ${customer.companyName || customer.name}?`)) {
              onDeleteCustomer(customer.id);
              setSelectedCustomer(null);
            }
          };

          const handleSyncFromSage = async () => {
            // Map database customers to the format the UI expects
  setSyncing(true);
  try {
    const results = await window.SageAPI.syncCustomersQuick();
    setSyncResults(results);
    setShowSyncDialog(true);
  } catch (error) {
    alert('Failed to sync from Sage: ' + error.message);
  } finally {
    setSyncing(false);
  }
};
const handleQuickSync = async () => {
  console.log('Quick sync - checking for new customers only...');
  setSyncing(true);
  
  try {
    // Use the new quick sync function
    const results = await window.SageAPI.syncCustomersQuick();
    
    setSyncResults(results);
    setShowSyncDialog(true);
    
    // Refresh the customer list if new ones were added
    if (results.new.length > 0) {
      await fetchCustomers(); // Refresh the list
    }
    
  } catch (error) {
    console.error('Quick sync error:', error);
    alert('Quick sync failed: ' + error.message);
  } finally {
    setSyncing(false);
  }
};

const handleApplySync = async () => {
  if (!syncResults) return;
  
  try {
    let successCount = 0;
    let skipCount = 0;
    
    // Add new customers directly to database
    for (const sageCustomer of syncResults.new) {
    
      
      // Save to Supabase with the correct field names
const { error } = await window.supabase
  .from('customers')
  .insert({
    name: sageCustomer.name,
    sage_id: sageCustomer.sage_id,
    reference: sageCustomer.reference || '',
    email: sageCustomer.email || '',
    phone: sageCustomer.phone || '',
    mobile: sageCustomer.mobile || '',
    vat_number: sageCustomer.vat_number || '',
    address: sageCustomer.address || '',
    credit_limit: sageCustomer.credit_limit || 0,
    credit_days: sageCustomer.credit_days || 30,
    account_status: sageCustomer.account_status || 'Active',
    main_contact_name: sageCustomer.main_contact_name || '',
    delivery_address: sageCustomer.delivery_address || null
  });
      
      if (error) {
        console.error('Error inserting customer:', error);
        // Continue with next customer instead of failing completely
        continue;
      }
      
      successCount++;
    }
    // Update existing customers with latest Sage data
        for (const sageCustomer of syncResults.updated) {
            const { error: updateError } = await window.supabase
                .from('customers')
                .update({
                    name: sageCustomer.name,
                    reference: sageCustomer.reference || '',
                    email: sageCustomer.email || '',
                    phone: sageCustomer.phone || '',
                    mobile: sageCustomer.mobile || '',
                    vat_number: sageCustomer.vat_number || '',
                    address: sageCustomer.address || '',
                    credit_limit: sageCustomer.credit_limit,
                    credit_days: sageCustomer.credit_days,
                    account_status: sageCustomer.account_status,
                    delivery_address: sageCustomer.delivery_address,
                    main_contact_name: sageCustomer.main_contact_name || ''
                })
                .eq('id', sageCustomer.id);

            if (!updateError) {
                successCount++;
            } else {
                console.error('Error updating customer:', updateError);
            }
        }
    setShowSyncDialog(false);
    setSyncResults(null);
    
    if (skipCount > 0) {
      alert(`Successfully synced ${successCount} new customers from Sage!\n${skipCount} customers were skipped (already exist).`);
    } else {
      alert(`Successfully synced ${successCount} new customers from Sage!`);
    }
    
    // Refresh the page to show new customers
   
    
  } catch (error) {
    alert('Error applying sync: ' + error.message);
  }
};
          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Customer Management</h2>
                  <p className="text-gray-600">{displayCustomers.length} customers found</p>
                </div>
                <div className="flex items-center space-x-2">
                <button 
  onClick={onAddCustomer}
  className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
>
  <Plus size={16} className="mr-1 sm:mr-2" />
  <span className="hidden sm:inline">Add Customer</span>
  <span className="sm:hidden">Add</span>
</button>
{user.role === 'ADMIN' && (
  <button
    onClick={handleSyncFromSage}
    disabled={syncing}
    className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-2 disabled:opacity-50 text-sm sm:text-base"
  >
    {syncing ? (
      <>
        <Loader size={16} className="mr-1 sm:mr-2 animate-spin" />
        <span className="hidden sm:inline">Syncing...</span>
        <span className="sm:hidden">Sync</span>
      </>
    ) : (
      <>
        <Repeat size={16} className="mr-1 sm:mr-2" />
        <span className="hidden sm:inline">Sync from Sage</span>
        <span className="sm:hidden">Sync</span>
      </>
    )}
  </button>
)}
    </div>
  </div>
              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
                <div className="flex items-center justify-between">
                  <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3">
                    <Filter size={16} className="text-gray-600" />
                    <input
                      type="text"
                      placeholder="Search customers..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <select
                      value={filters.businessType}
                      onChange={(e) => setFilters({...filters, businessType: e.target.value})}
                      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Business Types</option>
                      <option value="Construction Company">Construction Company</option>
                      <option value="Main Contractor">Main Contractor</option>
                      <option value="Sub Contractor">Sub Contractor</option>
                      <option value="Property Developer">Property Developer</option>
                      <option value="Demolition Contractor">Demolition Contractor</option>
                      <option value="Retail">Retail</option>
                      <option value="Other">Other</option>
                    </select>
                    <select
                      value={filters.creditRating}
                      onChange={(e) => setFilters({...filters, creditRating: e.target.value})}
                      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Credit Ratings</option>
                      <option value="A+">A+ (Excellent)</option>
                      <option value="A">A (Very Good)</option>
                      <option value="B+">B+ (Good)</option>
                      <option value="B">B (Average)</option>
                      <option value="C">C (Below Average)</option>
                    </select>
                    <button
                      onClick={() => {
                        setSearchQuery('');
                        setFilters({ businessType: '', creditRating: '', accountStatus: '' });
                      }}
                      className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                      Clear
                    </button>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setViewMode('grid')}
                      className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Grid size={16} />
                    </button>
                    <button
                      onClick={() => setViewMode('list')}
                      className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Layout size={16} />
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                      {displayCustomers.map(customer => (
                        <div
                          key={customer.id}
                          className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => setSelectedCustomer({
  ...customer,
  creditLimit: customer.credit_limit,
  creditDays: customer.credit_days,
  paymentTerms: customer.credit_days,
  creditRating: customer.credit_rating,
  vatNumber: customer.vat_number,
  accountStatus: customer.account_status,
  primaryContact: customer.primary_contact,
  businessType: customer.business_type,
  companyName: customer.name,  // Note: it's 'name' not 'company_name'
  phone: customer.phone,
  email: customer.email,
  address: customer.address,
  // ADD THESE LINES for billing address fields only:
billingAddress: customer.address ? customer.address.split('↵').slice(0, -1).join(', ') : '',
billingPostcode: customer.address ? customer.address.split('↵').pop() : '',
  // Parse address for the delivery address display (lines 3340-3343)
  customerDeliveryAddress: {
    address_line_1: customer.address?.split('↵')[0] || '',
    address_line_2: customer.address?.split('↵')[1] || '',
    city: customer.address?.split('↵')[2] || '',
    postal_code: customer.address?.split('↵')[3] || ''
  }
})}
                        >
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h4 className="font-semibold text-gray-900 truncate">{customer.companyName}</h4>
                              <p className="text-sm text-gray-600">{customer.businessType}</p>
                            </div>
                            <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                              customer.creditRating === 'A+' || customer.creditRating === 'A' ? 'bg-green-100 text-green-700' :
                              customer.creditRating === 'B+' || customer.creditRating === 'B' ? 'bg-yellow-100 text-yellow-700' :
                              'bg-red-100 text-red-700'
                            }`}>
                              {customer.creditRating}
                            </span>
                          </div>
                          
                          <div className="space-y-2 mb-4">
                            <div className="flex items-center text-sm text-gray-600">
                              <User size={14} className="mr-2 text-blue-500" />
                              <span className="truncate">{customer.primaryContact}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Phone size={14} className="mr-2 text-green-500" />
                              <span>{customer.phone}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Mail size={14} className="mr-2 text-purple-500" />
                              <span className="truncate">{customer.email}</span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div className="text-sm">
                              <span className="text-gray-600">Credit Limit:</span>
                              <span className="font-medium text-gray-900 ml-1">£{customer.creditLimit?.toLocaleString() || '0'}</span>
                            </div>
                            <div className="text-sm">
                              <span className="text-gray-600">Terms:</span>
                              <span className="font-medium text-gray-900 ml-1">{customer.paymentTerms || 30} days</span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ref</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone/Mobile</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Credit</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {displayCustomers.map(customer => (
                            <tr 
                              key={customer.id} 
                              className="hover:bg-gray-50 cursor-pointer"
                             onClick={() => setSelectedCustomer({
  ...customer,
  creditLimit: customer.credit_limit,
  creditDays: customer.credit_days,
  paymentTerms: customer.credit_days,
  creditRating: customer.credit_rating,
  vatNumber: customer.vat_number,
  accountStatus: customer.account_status,
  primaryContact: customer.primary_contact,
  businessType: customer.business_type,
  companyName: customer.name,  // Note: it's 'name' not 'company_name'
  phone: customer.phone,
  email: customer.email,
  address: customer.address,
  // ADD THESE LINES for billing address fields only:
billingAddress: customer.address ? customer.address.split('↵').slice(0, -1).join(', ') : '',
billingPostcode: customer.address ? customer.address.split('↵').pop() : '',
  // Parse address for the delivery address display (lines 3340-3343)
  customerDeliveryAddress: {
    address_line_1: customer.address?.split('↵')[0] || '',
    address_line_2: customer.address?.split('↵')[1] || '',
    city: customer.address?.split('↵')[2] || '',
    postal_code: customer.address?.split('↵')[3] || ''
  }
})}
                            >
                              <td className="px-6 py-4 whitespace-nowrap">
  <div className="text-sm font-medium text-gray-900">{customer.companyName}</div>
  <div className="text-xs text-gray-500">{customer.vatNumber}</div>
</td>
<td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
  {customer.reference || '-'}
</td>
<td className="px-6 py-4 whitespace-nowrap">
  <div className="text-sm text-gray-900">{customer.main_contact_name || '-'}</div>
  <div className="text-xs text-gray-500">{customer.email}</div>
</td>
<td className="px-6 py-4 whitespace-nowrap">
  <div className="text-sm text-gray-900">{customer.phone || '-'}</div>
  <div className="text-xs text-gray-500">{customer.mobile || '-'}</div>
</td>
<td className="px-6 py-4 whitespace-nowrap">
  <div className="text-sm font-medium text-gray-900">£{customer.creditLimit?.toLocaleString() || '0'}</div>
  <div className="text-xs text-gray-500">{customer.credit_days || 30} days</div>
</td>
<td className="px-6 py-4 whitespace-nowrap">
  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
    customer.accountStatus === 'Active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'
  }`}>
    {customer.accountStatus || 'Active'}
  </span>
</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  {displayCustomers.length === 0 && (
                    <div className="text-center py-8">
                      <Users className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No customers found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedCustomer && !editingCustomer && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedCustomer.companyName}</h2>
                        <p className="text-gray-600">{selectedCustomer.businessType}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        {hasPermission('customers:update') && (
                          <button
                            onClick={() => setEditingCustomer(selectedCustomer)}
                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                            title="Edit Customer"
                          >
                            <Edit3 size={20} />
                          </button>
                        )}
                        {hasPermission('customers:delete') && (
                          <button
                            onClick={() => handleDeleteCustomer(selectedCustomer)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Customer"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedCustomer(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 lg:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                          <h3 className="font-semibold mb-4">Contact Information</h3>
                          <div className="space-y-3">
                            <div className="flex items-center">
                              <User size={16} className="mr-3 text-blue-600" />
                              <div>
                                <p className="font-medium">{selectedCustomer.primaryContact}</p>
                                <p className="text-sm text-gray-600">{selectedCustomer.contactPosition || 'Primary Contact'}</p>
                              </div>
                            </div>
                            <div className="flex items-center">
                              <Phone size={16} className="mr-3 text-green-600" />
                              <span>{selectedCustomer.phone}</span>
                            </div>
                            {selectedCustomer.mobile && (
                              <div className="flex items-center">
                                <Phone size={16} className="mr-3 text-green-600" />
                                <span>{selectedCustomer.mobile} (Mobile)</span>
                              </div>
                            )}
                            <div className="flex items-center">
                              <Mail size={16} className="mr-3 text-purple-600" />
                              <span>{selectedCustomer.email}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div>
                          <h3 className="font-semibold mb-4">Business Details</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">VAT Number:</span>
                              <span className="font-medium">{selectedCustomer.vatNumber || 'Not provided'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Company Number:</span>
                              <span className="font-medium">{selectedCustomer.companyNumber || 'Not provided'}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Credit Rating:</span>
                              <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                selectedCustomer.creditRating === 'A+' || selectedCustomer.creditRating === 'A' ? 'bg-green-100 text-green-700' :
                                selectedCustomer.creditRating === 'B+' || selectedCustomer.creditRating === 'B' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {selectedCustomer.creditRating}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Credit Limit:</span>
                              <span className="font-medium">£{selectedCustomer.creditLimit?.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Payment Terms:</span>
                              <span className="font-medium">{selectedCustomer.paymentTerms} days</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Business Type:</span>
                              <span className="font-medium">{selectedCustomer.businessType}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {editingCustomer && (
                <CustomerForm
                  customer={editingCustomer}
                  onClose={() => setEditingCustomer(null)}
                  onSave={(updatedCustomer) => {
                    onUpdateCustomer(updatedCustomer);
                    setEditingCustomer(null);
                    setSelectedCustomer(null);
                  }}
                />
              )}

              {showSyncDialog && syncResults && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div className="p-6 border-b border-gray-200">
        <h2 className="text-xl font-bold">Sync Preview</h2>
        <p className="text-gray-600">Review changes before applying</p>
      </div>
      
      <div className="p-6">
        {/* New Customers */}
        {syncResults.new.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-green-700">
              New Customers to Import ({syncResults.new.length})
            </h3>
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {syncResults.new.map((customer, idx) => (
                <div key={idx} className="p-3 bg-green-50 rounded-lg">
                  <div className="font-medium">{customer.companyName}</div>
<div className="text-sm text-gray-600">
  {customer.email || 'No email'}
  {customer.billingAddress && customer.billingAddress.length > 0 && 
    ` | ${customer.billingAddress.filter(line => line).join(', ')}`
  }
</div>
                </div>
              ))}
            </div>
          </div>
        )}
        {/* Add this section for UPDATED customers */}
{syncResults.updated && syncResults.updated.length > 0 && (
  <div className="mb-6">
    <h3 className="font-semibold mb-3 text-yellow-700">
      Customers to Update ({syncResults.updated.length})
    </h3>
    <div className="space-y-2 max-h-60 overflow-y-auto">
      {syncResults.updated.map((customer, idx) => (
        <div key={idx} className="p-3 bg-yellow-50 rounded-lg">
          <div className="font-medium">{customer.name}</div>
          <div className="text-sm text-gray-600">
            {customer.email && `Email: ${customer.email}`}
            {customer.address && ` | Address: ${customer.address}`}
          </div>
        </div>
      ))}
    </div>
  </div>
)}
        {/* Conflicts */}
        {syncResults && syncResults.conflicts && syncResults.conflicts.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-yellow-700">
              Conflicts Found ({syncResults.conflicts.length})
            </h3>
            <div className="space-y-2">
              {syncResults.conflicts.map((conflict, idx) => (
                <div key={idx} className="p-3 bg-yellow-50 rounded-lg">
                  <div className="font-medium">VAT: {conflict.sage.tax_number}</div>
                  <div className="text-sm">
                    <span className="text-gray-600">Local:</span> {conflict.local.companyName}
                  </div>
                  <div className="text-sm">
                    <span className="text-gray-600">Sage:</span> {conflict.sage.name}
                  </div>
                </div>
              ))}
            </div>
            <p className="text-sm text-yellow-700 mt-2">
              Conflicts will be skipped. Update manually if needed.
            </p>
          </div>
        )}
        
        {syncResults.new.length === 0 && syncResults.conflicts.length === 0 && (
          <p className="text-gray-500">No new customers to sync.</p>
        )}
      </div>
      
      <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
        <button
          onClick={() => {
            setShowSyncDialog(false);
            setSyncResults(null);
          }}
          className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        {(syncResults.new.length > 0 || syncResults.updated.length > 0) && (
          <button
            onClick={handleApplySync}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            Import {syncResults.new.length + syncResults.updated.length} Customers
          </button>
        )}
      </div>
    </div>
  </div>
)}

            </div>
          );
        };

        // Suppliers View Component
          const SuppliersView = ({ suppliers, onAddSupplier, onUpdateSupplier, onDeleteSupplier, user }) => {
          const { hasPermission } = useAuth();
          const [selectedSupplier, setSelectedSupplier] = useState(null);
          const [editingSupplier, setEditingSupplier] = useState(null);
          const [searchQuery, setSearchQuery] = useState('');
          const [viewMode, setViewMode] = useState('list'); // CHANGED: default to 'list' instead of 'grid'
          const [filters, setFilters] = useState({
            service: '',
            rating: '',
            preferred: ''
          });
const [showSyncDialog, setShowSyncDialog] = useState(false);
const [syncResults, setSyncResults] = useState(null);
const [syncing, setSyncing] = useState(false);
// Change line 4919 from handleSyncFromSage to:
const handleSyncFromSage = async () => {
  setSyncing(true);
  try {
    const results = await window.SageAPI.syncSuppliersQuick();
    setSyncResults(results);
    setShowSyncDialog(true);
  } catch (error) {
    alert('Failed to sync suppliers from Sage: ' + error.message);
  } finally {
    setSyncing(false);
  }
};

// Change line 4932 from handleApplySync to:
const handleApplySupplierSync = async () => {
  if (!syncResults) return;
  
  try {
    let successCount = 0;
    let skipCount = 0;
    
    // Add new suppliers
    for (const sageSupplier of syncResults.new) {
      try {
        await onAddSupplier(sageSupplier);
        successCount++;
      } catch (error) {
        console.error(`Failed to add supplier ${sageSupplier.companyName}:`, error);
        skipCount++;
      }
    }
    
    // Update existing suppliers
    for (const sageSupplier of syncResults.updated) {
      try {
        await onUpdateSupplier(sageSupplier);
        successCount++;
      } catch (error) {
        console.error(`Failed to update supplier ${sageSupplier.companyName}:`, error);
        skipCount++;
      }
    }
    
    alert(`Sync complete! ${successCount} suppliers synced, ${skipCount} skipped.`);
    setShowSyncDialog(false);
    setSyncResults(null);
    
  } catch (error) {
    console.error('Error applying sync:', error);
    alert('Failed to apply sync: ' + error.message);
  }
};
          const filteredSuppliers = suppliers.filter(supplier => {
            if (searchQuery && 
                !(supplier.name || supplier.companyName || '').toLowerCase().includes(searchQuery.toLowerCase()) &&
                !(supplier.primaryContact || '').toLowerCase().includes(searchQuery.toLowerCase())) {
              return false;
            }
            if (filters.service && !supplier.primaryServices?.includes(filters.service)) return false;
            if (filters.rating && supplier.supplierRating !== filters.rating) return false;
            if (filters.preferred === 'yes' && !supplier.preferredSupplier) return false;
            if (filters.preferred === 'no' && supplier.preferredSupplier) return false;
            return true;
          });
          const displaySuppliers = filteredSuppliers.map(supplier => ({
  ...supplier,
  companyName: supplier.name && supplier.name !== 'Unknown Supplier' 
    ? supplier.name 
    : supplier.companyName || supplier.name || 'Unknown Supplier',
  primaryContact: supplier.primaryContact || 'No contact',
  vatNumber: supplier.vat_number || supplier.vatNumber || '',
  email: supplier.email || '',
  phone: supplier.phone || ''
}));

          const handleDeleteSupplier = (supplier) => {
          if (confirm(`Are you sure you want to delete ${supplier.name || supplier.companyName}?`)) {
              onDeleteSupplier(supplier.id);
              setSelectedSupplier(null);
            }
          };
          const handleSupplierSyncFromSage = async () => {
  setSyncing(true);
  try {
    const results = await window.SageAPI.syncSuppliersQuick();
    setSyncResults(results);
    setShowSyncDialog(true);
  } catch (error) {
    alert('Failed to sync from Sage: ' + error.message);
  } finally {
    setSyncing(false);
  }
};

const handleApplySync = async () => {
  if (!syncResults) return;
  
  try {
    let successCount = 0;
    let skipCount = 0;
    
    // Loop 1: Add NEW suppliers
    for (const sageSupplier of syncResults.new) {
      const { error } = await window.supabase
        .from('suppliers')
        .insert({
          name: sageSupplier.name || sageSupplier.companyName,
          sage_id: sageSupplier.sage_id,
          email: sageSupplier.email,
          phone: sageSupplier.phone,
          address: sageSupplier.address,
          vat_number: sageSupplier.vatNumber,
          contact_person: sageSupplier.primaryContact,
          position: sageSupplier.position,
          accountstatus: sageSupplier.accountStatus,
          accountsemail: sageSupplier.accountsEmail,
          supplierrating: sageSupplier.supplierRating,
          performancescore: sageSupplier.performanceScore || 0,
          preferredsupplier: sageSupplier.preferredSupplier || false,
        });
      
      if (!error) successCount++;
    }
    
    // Loop 2: UPDATE existing suppliers
    for (const sageSupplier of syncResults.updated) {
      const { error } = await window.supabase
        .from('suppliers')
        .update({
          name: sageSupplier.name || sageSupplier.companyName,
          email: sageSupplier.email,
          phone: sageSupplier.phone,
          address: sageSupplier.address,
          vat_number: sageSupplier.vatNumber,
          contact_person: sageSupplier.primaryContact,
        })
        .eq('id', sageSupplier.id);  // Use preserved database ID!
      
      if (!error) successCount++;
    }
    
    setShowSyncDialog(false);
    setSyncResults(null);
    
    alert(`Successfully synced ${successCount} suppliers from Sage!`);
    
    if (successCount > 0) {
      window.location.reload();
    }
    
  } catch (error) {
    console.error('Full error:', error);
    alert('Error applying sync: ' + error.message);
  }
};
    
          return (
            <div className="space-y-6">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-2xl font-bold text-gray-900">Supplier Management</h2>
                  <p className="text-gray-600">{filteredSuppliers.length} suppliers found</p>
                </div>
                <div className="flex items-center space-x-2">
  <button 
    onClick={onAddSupplier}
    className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm sm:text-base"
  >
    <Plus size={16} className="mr-1 sm:mr-2" />
    <span className="hidden sm:inline">Add Supplier</span>
    <span className="sm:hidden">Add</span>
  </button>
  {user?.role === 'ADMIN' && (
    <button
      onClick={handleSupplierSyncFromSage}
      disabled={syncing}
      className="flex items-center px-3 py-2 sm:px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 ml-2 disabled:opacity-50 text-sm sm:text-base"
    >
      {syncing ? (
        <>
          <Loader size={16} className="mr-1 sm:mr-2 animate-spin" />
          <span className="hidden sm:inline">Syncing...</span>
          <span className="sm:hidden">Sync</span>
        </>
      ) : (
        <>
          <Repeat size={16} className="mr-1 sm:mr-2" />
          <span className="hidden sm:inline">Sync from Sage</span>
          <span className="sm:hidden">Sync</span>
        </>
      )}
    </button>
  )}
</div>
              </div>

              {/* Filters */}
              <div className="bg-white rounded-lg border border-gray-200 p-4">
                <div className="flex items-center justify-between">
                  <div className="flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3">
                    <Filter size={16} className="text-gray-600" />
                    <input
                      type="text"
                      placeholder="Search suppliers..."
                      value={searchQuery}
                      onChange={(e) => setSearchQuery(e.target.value)}
                     className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    />
                    <select
                      value={filters.service}
                      onChange={(e) => setFilters({...filters, service: e.target.value})}
                      className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Services</option>
                      <option value="Skip Hire">Skip Hire</option>
                      <option value="Waste Collection">Waste Collection</option>
                      <option value="Aggregates Supply">Aggregates Supply</option>
                      <option value="Recycling">Recycling</option>
                      <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                      <option value="Haulage">Haulage</option>
                      <option value="Transport">Transport</option>
                    </select>
                    <select
                      value={filters.rating}
                      onChange={(e) => setFilters({...filters, rating: e.target.value})}
                     className="w-full sm:w-auto px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Ratings</option>
                      <option value="A+">A+ (Excellent)</option>
                      <option value="A">A (Very Good)</option>
                      <option value="A-">A- (Good)</option>
                      <option value="B+">B+ (Above Average)</option>
                      <option value="B">B (Average)</option>
                    </select>
                    <select
                      value={filters.preferred}
                      onChange={(e) => setFilters({...filters, preferred: e.target.value})}
                      className="px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">All Suppliers</option>
                      <option value="yes">Preferred Only</option>
                      <option value="no">Non-Preferred</option>
                    </select>
                    <button
                      onClick={() => {
                        setSearchQuery('');
                        setFilters({ service: '', rating: '', preferred: '' });
                      }}
                      className="px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg"
                    >
                      Clear
                    </button>
                  </div>
                  
                  <div className="flex items-center space-x-2">
                    <button
                      onClick={() => setViewMode('grid')}
                      className={`p-2 rounded ${viewMode === 'grid' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Grid size={16} />
                    </button>
                    <button
                      onClick={() => setViewMode('list')}
                      className={`p-2 rounded ${viewMode === 'list' ? 'bg-blue-100 text-blue-700' : 'text-gray-600'}`}
                    >
                      <Layout size={16} />
                    </button>
                  </div>
                </div>
              </div>

              <div className="bg-white rounded-lg border border-gray-200">
                <div className="p-6">
                  {viewMode === 'grid' ? (
                    <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-6">
                    {displaySuppliers.map(supplier => (
                        <div
                          key={supplier.id}
                          className="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow cursor-pointer"
                          onClick={() => setSelectedSupplier(supplier)}
                        >
                          <div className="flex items-start justify-between mb-4">
                            <div className="flex-1">
                              <h4 className="font-semibold text-gray-900 truncate">{supplier.name || supplier.companyName}</h4>
                              <p className="text-sm text-gray-600">{supplier.primaryServices?.join(', ') || 'Services not specified'}</p>
                            </div>
                            <div className="flex items-center space-x-2">
                              {supplier.preferredSupplier && (
                                <Star className="w-4 h-4 text-yellow-500 fill-current" />
                              )}
                              <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                supplier.supplierRating === 'A+' || supplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                supplier.supplierRating === 'A-' || supplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {supplier.supplierRating}
                              </span>
                            </div>
                          </div>
                          
                          <div className="space-y-2 mb-4">
                            <div className="flex items-center text-sm text-gray-600">
                              <User size={14} className="mr-2 text-blue-500" />
                              <span className="truncate">{supplier.primaryContact}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Phone size={14} className="mr-2 text-green-500" />
                              <span>{supplier.phone}</span>
                            </div>
                            <div className="flex items-center text-sm text-gray-600">
                              <Truck size={14} className="mr-2 text-purple-500" />
                              <span className="truncate">
                                {supplier.primaryServices?.slice(0, 2).join(', ') || 'Services not specified'}
                              </span>
                            </div>
                          </div>
                          
                          <div className="flex items-center justify-between pt-4 border-t border-gray-100">
                            <div className="text-sm">
                              <span className="text-gray-600">Rating:</span>
                              <span className="font-medium text-gray-900 ml-1">{supplier.supplierRating}</span>
                            </div>
                            <div className="text-sm">
                              {supplier.preferredSupplier ? (
                                <span className="text-yellow-600 font-medium">⭐ Preferred</span>
                              ) : (
                                <span className="text-gray-500">Standard</span>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Services</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rating</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preferred</th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {displaySuppliers.map(supplier => (
                            <tr 
                              key={supplier.id} 
                              className="hover:bg-gray-50 cursor-pointer"
                              onClick={() => setSelectedSupplier(supplier)}
                            >
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm font-medium text-gray-900">{supplier.name || supplier.companyName}</div>
                                  <div className="text-sm text-gray-500">{supplier.vatNumber}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div>
                                  <div className="text-sm text-gray-900">{supplier.primaryContact}</div>
                                  <div className="text-sm text-gray-500">{supplier.email}</div>
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <div className="text-sm text-gray-900">
                                  {supplier.primaryServices?.slice(0, 2).join(', ') || 'Not specified'}
                                  {supplier.primaryServices?.length > 2 && <span className="text-gray-500"> +{supplier.primaryServices.length - 2}</span>}
                                </div>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                                  supplier.supplierRating === 'A+' || supplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                  supplier.supplierRating === 'A-' || supplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-red-100 text-red-700'
                                }`}>
                                  {supplier.supplierRating}
                                </span>
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap">
                                {supplier.preferredSupplier && (
                                  <Star className="w-5 h-5 text-yellow-500 fill-current" />
                                )}
                              </td>
                              <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                {supplier.performanceScore}%
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                  
                  {filteredSuppliers.length === 0 && (
                    <div className="text-center py-8">
                      <Truck className="mx-auto h-12 w-12 text-gray-400" />
                      <p className="mt-2 text-gray-500">No suppliers found</p>
                    </div>
                  )}
                </div>
              </div>

              {selectedSupplier && !editingSupplier && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                  <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                      <div>
                        <h2 className="text-xl font-bold">{selectedSupplier.companyName}</h2>
                        <p className="text-gray-600">{selectedSupplier.primaryServices?.join(', ')}</p>
                      </div>
                      <div className="flex items-center space-x-2">
                        {hasPermission('suppliers:update') && (
                          <button
                            onClick={() => setEditingSupplier(selectedSupplier)}
                            className="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                            title="Edit Supplier"
                          >
                            <Edit3 size={20} />
                          </button>
                        )}
                        {hasPermission('suppliers:delete') && (
                          <button
                            onClick={() => handleDeleteSupplier(selectedSupplier)}
                            className="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                            title="Delete Supplier"
                          >
                            <Trash2 size={20} />
                          </button>
                        )}
                        <button onClick={() => setSelectedSupplier(null)}>
                          <X size={24} />
                        </button>
                      </div>
                    </div>
                    
                    <div className="p-6">
                      <div className="grid grid-cols-1 lg:grid-cols-1 sm:grid-cols-2 gap-6">
                        <div>
                          <h3 className="font-semibold mb-4">Contact Information</h3>
                          <div className="space-y-3">
                            <div className="flex items-center">
                              <User size={16} className="mr-3 text-blue-600" />
                              <div>
                                <p className="font-medium">{selectedSupplier.primaryContact}</p>
                                <p className="text-sm text-gray-600">Primary Contact</p>
                              </div>
                            </div>
                            <div className="flex items-center">
                              <Phone size={16} className="mr-3 text-green-600" />
                              <span>{selectedSupplier.phone}</span>
                            </div>
                            <div className="flex items-center">
                              <Mail size={16} className="mr-3 text-purple-600" />
                              <span>{selectedSupplier.email}</span>
                            </div>
                          </div>
                        </div>
                        
                        <div>
                          <h3 className="font-semibold mb-4">Business Details</h3>
                          <div className="space-y-3">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Supplier Rating:</span>
                              <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                selectedSupplier.supplierRating === 'A+' || selectedSupplier.supplierRating === 'A' ? 'bg-green-100 text-green-700' :
                                selectedSupplier.supplierRating === 'A-' || selectedSupplier.supplierRating === 'B+' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {selectedSupplier.supplierRating}
                              </span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Preferred Supplier:</span>
                              <span className="font-medium">
                                {selectedSupplier.preferredSupplier ? (
                                  <span className="text-yellow-600">⭐ Yes</span>
                                ) : (
                                  <span className="text-gray-500">No</span>
                                )}
                              </span>
                            </div>
                            <div>
                              <span className="text-gray-600">Services:</span>
                              <div className="mt-2 flex flex-wrap gap-1">
                                {selectedSupplier.primaryServices?.map(service => (
                                  <span key={service} className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                                    {service}
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {editingSupplier && (
                <SupplierForm
                  supplier={editingSupplier}
                  onClose={() => setEditingSupplier(null)}
                  onSave={(updatedSupplier) => {
                    onUpdateSupplier(updatedSupplier);
                    setEditingSupplier(null);
                    setSelectedSupplier(null);
                  }}
                />
              )}
              {showSyncDialog && syncResults && (
  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div className="p-6 border-b border-gray-200">
        <h2 className="text-xl font-bold">Supplier Sync Preview</h2>
        <p className="text-gray-600">Review changes before applying</p>
      </div>
      
      <div className="p-6">
        {syncResults.new.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-green-700">
              New Suppliers to Import ({syncResults.new.length})
            </h3>
            <div className="space-y-2 max-h-60 overflow-y-auto">
              {syncResults.new.map((supplier, idx) => (
                <div key={idx} className="p-3 bg-green-50 rounded-lg">
                  <div className="font-medium">{supplier.name || supplier.companyName}</div>
<div className="text-sm text-gray-600">
  {supplier.email || 'No email'} | 
  {supplier.phone || 'No phone'}
  {supplier.billingAddress && supplier.billingAddress.length > 0 && 
    ` | ${supplier.billingAddress.filter(line => line).join(', ')}`
  }
</div>
                </div>
              ))}
            </div>
          </div>
        )}
        
        {syncResults.conflicts.length > 0 && (
          <div className="mb-6">
            <h3 className="font-semibold mb-3 text-yellow-700">
              Conflicts Found ({syncResults.conflicts.length})
            </h3>
            <div className="space-y-2">
              {syncResults.conflicts.map((conflict, idx) => (
                <div key={idx} className="p-3 bg-yellow-50 rounded-lg">
                  <div className="font-medium">VAT: {conflict.sage.tax_number}</div>
                  <div className="text-sm">
                    <span className="text-gray-600">Local:</span> {conflict.local.companyName}
                  </div>
                  <div className="text-sm">
                    <span className="text-gray-600">Sage:</span> {conflict.sage.name}
                  </div>
                </div>
              ))}
            </div>
            <p className="text-sm text-yellow-700 mt-2">
              Conflicts will be skipped. Update manually if needed.
            </p>
          </div>
        )}
        
        {syncResults.new.length === 0 && syncResults.conflicts.length === 0 && (
          <p className="text-gray-500">No new suppliers to sync.</p>
        )}
      </div>
      
      <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
        <button
          onClick={() => {
            setShowSyncDialog(false);
            setSyncResults(null);
          }}
          className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          Cancel
        </button>
        {syncResults.new.length > 0 && (
          <button
            onClick={handleApplySync}
            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            Import {syncResults.new.length} Suppliers
          </button>
        )}
      </div>
    </div>
  </div>
)}
            </div>
          );
        };

// Simple Admin Panel
        const AdminPanel = ({ user }) => {
          const { wasteTypes, updateWasteTypes, addWasteType, deleteWasteType } = useWasteTypes();
          const [configSection, setConfigSection] = useState('general');
          const [companyName, setCompanyName] = useState('Total Waste Services');
          const [primaryColor, setPrimaryColor] = useState('#2563eb');
          const [editingJobType, setEditingJobType] = useState('');
          const [newType, setNewType] = useState('');
          const [logo, setLogo] = useState(localStorage.getItem('companyLogo') || '');
          // Sage Integration states
const [sageSettings, setSageSettings] = useState({
  clientId: '',
  clientSecret: '',
  accessToken: '',
  refreshToken: '',
  companyId: '',
  apiRegion: 'UK',
  connectionStatus: 'disconnected',
  lastSync: ''
});
const [testingConnection, setTestingConnection] = useState(false);
const [syncingProducts, setSyncingProducts] = useState(false);
const [products, setProducts] = useState([]);
const [showProductsSyncDialog, setShowProductsSyncDialog] = useState(false);
const [productsSyncResults, setProductsSyncResults] = useState(null);
          
          // Load saved settings when component loads
useEffect(() => {
  const loadSettings = async () => {
    try {
      const { data, error } = await window.supabase
        .from('company_settings')
        .select('*');
      
      if (data) {
        data.forEach(setting => {
          if (setting.setting_name === 'company_name') {
            setCompanyName(setting.setting_value);
          } else if (setting.setting_name === 'primary_color') {
            setPrimaryColor(setting.setting_value);
            document.documentElement.style.setProperty('--primary-color', setting.setting_value);
          } else if (setting.setting_name === 'logo_url' && setting.setting_value) {
            setLogo(setting.setting_value);
          }
             
});
      }
    } catch (error) {
      console.error('Error loading settings:', error);
    }
  };
  
  loadSettings();
  
}, []);

// Load products when component mounts
useEffect(() => {
  if (user?.role === 'ADMIN') {
    loadProducts();
  }
}, []);

// Function to handle color changes (existing line 3430)
// Function to handle color changes
const handleColorChange = (color) => {
  setPrimaryColor(color);
  document.documentElement.style.setProperty('--primary-color', color);
};

// Handle logo upload
const handleLogoUpload = async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const handleThemeToggle = (theme) => {
  const isDark = theme === 'Dark Mode';
  setDarkMode(isDark);
  if (isDark) {
    document.documentElement.classList.add('dark');
  } else {
    document.documentElement.classList.remove('dark');
  }
  localStorage.setItem('darkMode', isDark.toString());
};
  
  try {
    // Delete old logo if exists
    const { data: existingFiles } = await window.supabase.storage
      .from('logo')
      .list();
    
    if (existingFiles && existingFiles.length > 0) {
      await window.supabase.storage
        .from('logo')
        .remove(existingFiles.map(f => f.name));
    }
    
    // Upload new logo
    const fileName = `company-logo.${file.name.split('.').pop()}`;
    const { data, error } = await window.supabase.storage
      .from('logo')
      .upload(fileName, file, { upsert: true });
    
    if (error) throw error;
    
    // Get public URL
    const { data: { publicUrl } } = window.supabase.storage
      .from('logo')
      .getPublicUrl(fileName);
    
    setLogo(publicUrl);
    localStorage.setItem('companyLogo', publicUrl); // Keep local cache
    alert('Logo uploaded successfully!');
  } catch (error) {
    console.error('Error:', error);
    alert('Error uploading logo');
  }
};

// Load Sage settings
useEffect(() => {
  const loadSageSettings = async () => {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret', 'sage_access_token', 
                             'sage_refresh_token', 'sage_company_id', 'sage_api_region', 
                             'sage_last_sync']);
      
      if (data) {
        const settings = {};
        data.forEach(item => {
          const key = item.setting_name.replace('sage_', '');
          if (key === 'client_id') settings.clientId = item.setting_value;
          else if (key === 'client_secret') settings.clientSecret = item.setting_value;
          else if (key === 'access_token') settings.accessToken = item.setting_value;
          else if (key === 'refresh_token') settings.refreshToken = item.setting_value;
          else if (key === 'company_id') settings.companyId = item.setting_value;
          else if (key === 'api_region') settings.apiRegion = item.setting_value;
          else if (key === 'last_sync') settings.lastSync = item.setting_value;
        });
        setSageSettings(prev => ({ ...prev, ...settings }));
      }
    } catch (error) {
      console.error('Error loading Sage settings:', error);
    }
  };
  loadSageSettings();
}, []);

// Save Sage settings
const handleSaveSageSettings = async () => {
  try {
    const updates = [
      { setting_name: 'sage_client_id', setting_value: sageSettings.clientId },
      { setting_name: 'sage_client_secret', setting_value: sageSettings.clientSecret },
      { setting_name: 'sage_access_token', setting_value: sageSettings.accessToken },
      { setting_name: 'sage_refresh_token', setting_value: sageSettings.refreshToken },
      { setting_name: 'sage_company_id', setting_value: sageSettings.companyId },
      { setting_name: 'sage_api_region', setting_value: sageSettings.apiRegion }
    ];
    
    for (const update of updates) {
      await window.supabase
        .from('company_settings')
        .upsert(update, { onConflict: 'setting_name' });
    }
    
    alert('Sage settings saved successfully!');
  } catch (error) {
    console.error('Error saving Sage settings:', error);
    alert('Error saving Sage settings');
  }
};

// Test Sage connection
const testSageConnection = async () => {
  setTestingConnection(true);
  try {
    // For now, just simulate a connection test
    // In production, this would call the Sage API
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // Check if we have the minimum required credentials
    if (sageSettings.clientId && sageSettings.clientSecret) {
      setSageSettings(prev => ({ ...prev, connectionStatus: 'connected' }));
      alert('Successfully connected to Sage!');
    } else {
      throw new Error('Missing credentials');
    }
  } catch (error) {
    setSageSettings(prev => ({ ...prev, connectionStatus: 'error' }));
    alert('Failed to connect to Sage. Please check your credentials.');
  } finally {
    setTestingConnection(false);
  }
};
const syncProductsFromSage = async () => {
  setSyncingProducts(true);
  try {
    const results = await window.SageAPI.syncProductsFromSage();
    setProductsSyncResults(results);
    setShowProductsSyncDialog(true);
    await handleApplyProductsSync();
  } catch (error) {
    alert('Failed to sync products from Sage: ' + error.message);
  } finally {
    setSyncingProducts(false);
  }
};

const handleApplyProductsSync = async () => {
  if (!productsSyncResults) return;
  
  try {
    // Save products to Supabase
    for (const sageItem of productsSyncResults.new) {
      await window.supabase
        .from('sage_products')
       .insert({
  sage_id: sageItem.id,
  name: sageItem.displayed_as,
  description: sageItem.displayed_as,
  item_code: '',  // Just leave it empty
  sales_ledger_account: sageItem.sales_ledger_account_id,
  type: sageItem._isService ? 'service' : 'product',
  active: sageItem.active !== false
});
    }
    
    setShowProductsSyncDialog(false);
    setProductsSyncResults(null);
    alert(`Successfully synced ${productsSyncResults.new.length} products/services from Sage!`);
    
    // Reload products
    loadProducts();
  } catch (error) {
    alert('Error applying sync: ' + error.message);
  }
};

const loadProducts = async () => {
  try {
    const { data, error } = await window.supabase
      .from('sage_products')
      .select('*')
      .order('name');
    
    if (data) {
      setProducts(data);
    }
  } catch (error) {
    console.error('Error loading products:', error);
  }
};
          const [newUserData, setNewUserData] = useState({
            firstName: '',
            lastName: '',
            email: '',
            password: '',
            role: 'BROKER'
          });
          const [users, setUsers] = useState([]);

// Add this useEffect to load users
useEffect(() => {
  loadUsers();
}, []);

const loadUsers = async () => {
  try {
    const { data, error } = await window.supabase
      .from('users')
      .select('*')
      .order('created_at', { ascending: false });
    
    if (data) {
      setUsers(data.map(u => {
        const nameParts = u.name.split(' ');
        return {
          id: u.id,
          email: u.email,
          firstName: nameParts[0] || '',
          lastName: nameParts.slice(1).join(' ') || '',
          role: u.role
        };
      }));
    }
  } catch (error) {
    console.error('Error loading users:', error);
  }
};
          const [editingUser, setEditingUser] = useState(null);

          const sections = [
  { id: 'general', name: 'General Settings', icon: 'Settings' },
  { id: 'waste-types', name: 'Waste Types', icon: 'Trash2' },
  { id: 'forms', name: 'Form Configuration', icon: 'Layout' },
  { id: 'appearance', name: 'Appearance', icon: 'Palette' },
  { id: 'users', name: 'User Management', icon: 'Users' },
  { id: 'sage', name: 'Sage Integration', icon: 'Package' },
  { id: 'products', name: 'Products & Services', icon: 'Package' }
];

          const handleAddType = () => {
            if (newType && editingJobType) {
              addWasteType(editingJobType, newType);
              setNewType('');
            }
          };

          const handleDeleteType = (jobType, type) => {
            if (confirm(`Delete "${type}" from ${jobType}?`)) {
              deleteWasteType(jobType, type);
            }
          };

          const handleSaveSettings = async () => {
  try {
    // Save all settings to Supabase
    const updates = [
  { setting_name: 'company_name', setting_value: companyName },
  { setting_name: 'primary_color', setting_value: primaryColor },
  { setting_name: 'logo_url', setting_value: logo },
];
    
    for (const update of updates) {
      await window.supabase
        .from('company_settings')
        .upsert(update, { onConflict: 'setting_name' });
    }
    
    // Also update localStorage for immediate effect
    localStorage.setItem('companyName', companyName);
    localStorage.setItem('primaryColor', primaryColor);
    localStorage.setItem('companyLogo', logo);
    
    alert('Settings saved successfully for all users!');
  } catch (error) {
    console.error('Error saving settings:', error);
    alert('Error saving settings');
  }
};
          const handleAddUser = async () => {
  if (!newUserData.firstName || !newUserData.email || !newUserData.password) {
    alert('Please fill in all required fields');
    return;
  }
  
  try {
    const fullName = `${newUserData.firstName} ${newUserData.lastName || ''}`.trim();
    
    const { data, error } = await window.supabase
      .from('users')
      .insert([{
        email: newUserData.email,
        password: newUserData.password,
        name: fullName,
        role: newUserData.role
      }])
      .select();
    
    if (error) throw error;
    
    await loadUsers(); // Refresh the list
    setNewUserData({
      firstName: '',
      lastName: '',
      email: '',
      password: '',
      role: 'BROKER'
    });
    alert('User added successfully!');
  } catch (error) {
    console.error('Error adding user:', error);
    alert('Error adding user: ' + error.message);
  }
};

          const handleDeleteUser = async (userId) => {
  if (confirm('Are you sure you want to delete this user?')) {
    try {
      const { error } = await window.supabase
        .from('users')
        .delete()
        .eq('id', userId);
      
      if (error) throw error;
      await loadUsers(); // Refresh the list
    } catch (error) {
      console.error('Error deleting user:', error);
      alert('Error deleting user');
    }
  }
};

          const handleUpdateUser = async (updatedUser) => {
  try {
    const fullName = `${updatedUser.firstName} ${updatedUser.lastName || ''}`.trim();
    
    const { error } = await window.supabase
      .from('users')
      .update({
        email: updatedUser.email,
        name: fullName,
        role: updatedUser.role
      })
      .eq('id', updatedUser.id);
    
    if (error) throw error;
    await loadUsers(); // Refresh the list
    setEditingUser(null);
  } catch (error) {
    console.error('Error updating user:', error);
    alert('Error updating user');
  }
};

          return (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">System Administration</h2>
                <p className="text-gray-600">Configure your waste management system</p>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div className="lg:col-span-1">
                  <div className="bg-white rounded-lg border border-gray-200 p-4">
                    <nav className="space-y-2">
                      {sections.map(section => {
                        const Icon = section.icon === 'Settings' ? Settings :
             section.icon === 'Layout' ? Layout :
             section.icon === 'Palette' ? Palette :
             section.icon === 'Trash2' ? Trash2 : 
             section.icon === 'Package' ? Package : Users;
                        return (
                          <button
                            key={section.id}
                            onClick={() => setConfigSection(section.id)}
                            className={`w-full text-left flex items-center space-x-3 px-3 py-2 rounded-lg transition-colors ${
                              configSection === section.id ? 'bg-blue-50 text-blue-700' : 'hover:bg-gray-50'
                            }`}
                          >
                            <Icon size={18} />
                            <span>{section.name}</span>
                          </button>
                        );
                      })}
                    </nav>
                  </div>
                </div>

                <div className="lg:col-span-3">
                  <div className="bg-white rounded-lg border border-gray-200 p-6">
                    {configSection === 'general' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">General Settings</h3>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                            <input
                              type="text"
                              value={companyName}
                              onChange={(e) => setCompanyName(e.target.value)}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                            <input
                              type="color"
                              value={primaryColor}
                              onChange={(e) => handleColorChange(e.target.value)}
                              className="w-full h-10 border border-gray-300 rounded-lg cursor-pointer"
                            />
                          </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Default VAT Rate (%)</label>
                            <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
                              <option value="20">20% (Standard)</option>
                              <option value="5">5% (Reduced)</option>
                              <option value="0">0% (Zero)</option>
                            </select>
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Currency</label>
                            <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
                              <option value="GBP">GBP (£)</option>
                              <option value="EUR">EUR (€)</option>
                              <option value="USD">USD ($)</option>
                            </select>
                          </div>
                        </div>
                        <button 
                          onClick={handleSaveSettings}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          Save Settings
                        </button>
                      </div>
                    )}

                    {configSection === 'waste-types' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Waste & Aggregate Types Management</h3>
                        <div className="space-y-4">
                          {Object.entries(wasteTypes).map(([jobType, types]) => (
                            <div key={jobType} className="border border-gray-200 rounded-lg p-4">
                              <h4 className="font-medium text-gray-900 mb-3">{jobType}</h4>
                              <div className="space-y-2">
                                {types.map(type => (
                                  <div key={type} className="flex items-center justify-between py-2 px-3 bg-gray-50 rounded">
                                    <span className="text-sm">{type}</span>
                                    <button
                                      onClick={() => handleDeleteType(jobType, type)}
                                      className="text-red-600 hover:text-red-800"
                                    >
                                      <Trash2 size={16} />
                                    </button>
                                  </div>
                                ))}
                              </div>
                              {editingJobType === jobType ? (
                                <div className="mt-3 flex space-x-2">
                                  <input
                                    type="text"
                                    value={newType}
                                    onChange={(e) => setNewType(e.target.value)}
                                    placeholder="New type name"
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAddType()}
                                  />
                                  <button
                                    onClick={handleAddType}
                                    className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700"
                                  >
                                    Add
                                  </button>
                                  <button
                                    onClick={() => {
                                      setEditingJobType('');
                                      setNewType('');
                                    }}
                                    className="px-3 py-2 border border-gray-300 text-gray-700 rounded-lg text-sm hover:bg-gray-50"
                                  >
                                    Cancel
                                  </button>
                                </div>
                              ) : (
                                <button
                                  onClick={() => setEditingJobType(jobType)}
                                  className="mt-3 px-3 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm hover:bg-gray-200"
                                >
                                  <Plus size={16} className="inline mr-1" />
                                  Add New Type
                                </button>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {configSection === 'forms' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Form Configuration</h3>
                        <p className="text-gray-600">Configure form fields and validation rules</p>
                        <div className="space-y-4">
                          <div className="border border-gray-200 rounded-lg p-4">
                            <h4 className="font-medium mb-3">Job Form Fields</h4>
                            <div className="space-y-2">
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Customer PO Number (Optional)</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Waste Transfer Note</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" defaultChecked className="mr-2" />
                                <span className="text-sm">Hazardous Waste Options</span>
                              </label>
                              <label className="flex items-center">
                                <input type="checkbox" className="mr-2" />
                                <span className="text-sm">Photos Upload</span>
                              </label>
                            </div>
                          </div>
                          <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Form Configuration
                          </button>
                        </div>
                      </div>
                    )}

                    {configSection === 'appearance' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">Appearance Settings</h3>
                        <p className="text-gray-600">Customize the look and feel of your system</p>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-2">Logo Upload</label>
                            <div className="flex items-center space-x-4">
                        <input 
                        type="file" 
                        accept="image/*" 
                        onChange={handleLogoUpload}
                         className="block" 
                          />
                        {logo && (
                        <img src={logo} alt="Company Logo" className="h-12 w-auto" />
                         )}
                          </div>
                          </div>
                          <div>
<label className="block text-sm font-medium text-gray-700 mb-2">Font Size</label>
  <select className="w-full px-3 py-2 border border-gray-300 rounded-lg">
  <option>Small</option>
  <option>Medium</option>
  <option>Large</option>
</select>
</div>
                          <button 
  onClick={() => handleSaveSettings()}
  style={{ backgroundColor: 'var(--primary-color)' }}
  className="px-4 py-2 text-white rounded-lg hover:opacity-90 mt-4"
  type="button"
>
  Save Appearance Settings
</button>
                        </div>
                      </div>
                    )}

                    {configSection === 'users' && (
                      <div className="space-y-6">
                        <h3 className="text-lg font-semibold">User Management</h3>
                        
                        {!editingUser && (
                          <>
                            <div className="bg-gray-50 p-4 rounded-lg">
                              <h4 className="font-medium mb-3">Add New User</h4>
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <input
                                  type="text"
                                  placeholder="First Name"
                                  value={newUserData.firstName}
                                  onChange={(e) => setNewUserData({...newUserData, firstName: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="text"
                                  placeholder="Last Name"
                                  value={newUserData.lastName}
                                  onChange={(e) => setNewUserData({...newUserData, lastName: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="email"
                                  placeholder="Email"
                                  value={newUserData.email}
                                  onChange={(e) => setNewUserData({...newUserData, email: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <input
                                  type="password"
                                  placeholder="Password"
                                  value={newUserData.password}
                                  onChange={(e) => setNewUserData({...newUserData, password: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                />
                                <select
                                  value={newUserData.role}
                                  onChange={(e) => setNewUserData({...newUserData, role: e.target.value})}
                                  className="px-3 py-2 border border-gray-300 rounded-lg"
                                >
                                  <option value="ADMIN">Admin</option>
                                  <option value="MANAGER">Manager</option>
                                  <option value="BROKER">Broker</option>
                                </select>
                                <button
                                  onClick={handleAddUser}
                                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                                >
                                  Add User
                                </button>
                              </div>
                            </div>

                            <div className="space-y-4">
                              {users.map(user => (
                                <div key={user.id} className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                                  <div>
                                    <p className="font-medium">{user.firstName} {user.lastName}</p>
                                    <p className="text-sm text-gray-600">{user.email}</p>
                                  </div>
                                  <div className="flex items-center space-x-3">
                                    <span className={`px-2 py-1 text-xs font-medium rounded-full ${
                                      user.role === 'ADMIN' ? 'bg-red-100 text-red-700' :
                                      user.role === 'MANAGER' ? 'bg-blue-100 text-blue-700' :
                                      'bg-green-100 text-green-700'
                                    }`}>
                                      {user.role}
                                    </span>
                                    <button
                                      onClick={() => setEditingUser(user)}
                                      className="text-blue-600 hover:text-blue-800"
                                    >
                                      <Edit3 size={16} />
                                    </button>
                                    {user.id !== '1' && (
                                      <button
                                        onClick={() => handleDeleteUser(user.id)}
                                        className="text-red-600 hover:text-red-800"
                                      >
                                        <Trash2 size={16} />
                                      </button>
                                    )}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </>
                        )}

                        {editingUser && (
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-medium mb-3">Edit User</h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                              <input
                                type="text"
                                value={editingUser.firstName}
                                onChange={(e) => setEditingUser({...editingUser, firstName: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <input
                                type="text"
                                value={editingUser.lastName}
                                onChange={(e) => setEditingUser({...editingUser, lastName: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <input
                                type="email"
                                value={editingUser.email}
                                onChange={(e) => setEditingUser({...editingUser, email: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              />
                              <select
                                value={editingUser.role}
                                onChange={(e) => setEditingUser({...editingUser, role: e.target.value})}
                                className="px-3 py-2 border border-gray-300 rounded-lg"
                              >
                                <option value="ADMIN">Admin</option>
                                <option value="MANAGER">Manager</option>
                                <option value="BROKER">Broker</option>
                              </select>
                              <button
                                onClick={() => handleUpdateUser(editingUser)}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                              >
                                Save Changes
                              </button>
                              <button
                                onClick={() => setEditingUser(null)}
                                className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                              >
                                Cancel
                              </button>
                            </div>
                          </div>
                        )}
                      </div>
                    )}
    {configSection === 'sage' && (
  <div className="space-y-6">
    <h3 className="text-lg font-semibold">Sage 50 Cloud Integration</h3>
    
    {/* Connection Status */}
    <div className="bg-gray-50 p-4 rounded-lg">
      <div className="flex items-center justify-between">
        <div>
          <h4 className="font-medium">Connection Status</h4>
          <p className="text-sm text-gray-600">
            {localStorage.getItem('sage_connected') === 'true' ? 'Connected to Sage' : 'Not Connected'}
          </p>
          {sageSettings.lastSync && (
            <p className="text-xs text-gray-500 mt-1">
              Last sync: {new Date(sageSettings.lastSync).toLocaleString()}
            </p>
          )}
        </div>
        <div className={`w-3 h-3 rounded-full ${
          localStorage.getItem('sage_connected') === 'true' ? 'bg-green-500' : 'bg-gray-400'
        }`} />
      </div>
    </div>

    {/* API Credentials */}
    <div className="space-y-4">
      <h4 className="font-medium">API Credentials</h4>
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Client ID</label>
          <input
            type="text"
            value={sageSettings.clientId}
            onChange={(e) => setSageSettings({...sageSettings, clientId: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Your Sage Client ID"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Client Secret</label>
          <input
            type="password"
            value={sageSettings.clientSecret}
            onChange={(e) => setSageSettings({...sageSettings, clientSecret: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Your Sage Client Secret"
          />
        </div>
      </div>
      
      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">Company ID (Optional)</label>
          <input
            type="text"
            value={sageSettings.companyId}
            onChange={(e) => setSageSettings({...sageSettings, companyId: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
            placeholder="Sage Company ID"
          />
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-2">API Region</label>
          <select
            value={sageSettings.apiRegion}
            onChange={(e) => setSageSettings({...sageSettings, apiRegion: e.target.value})}
            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
          >
            <option value="UK">UK & Ireland</option>
            <option value="US">United States</option>
            <option value="CA">Canada</option>
          </select>
        </div>
      </div>
    </div>

    {/* Action Buttons */}
    <div className="flex flex-wrap gap-3">
      <button
        onClick={handleSaveSageSettings}
        className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
      >
        Save Settings
      </button>
      
      {localStorage.getItem('sage_connected') !== 'true' ? (
        <button
  onClick={() => {
    if (sageSettings.clientId && sageSettings.clientSecret) {
        connectToSagePopup();
    } else {
        alert('Please enter Client ID and Client Secret first');
    }
}}
          disabled={!sageSettings.clientId || !sageSettings.clientSecret}
          className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Connect to Sage
        </button>
      ) : (
        <>
          <button
            onClick={async () => {
              if (confirm('Are you sure you want to disconnect from Sage?')) {
                // Clear tokens
                const updates = [
                  { setting_name: 'sage_access_token', setting_value: '' },
                  { setting_name: 'sage_refresh_token', setting_value: '' }
                ];
                
                for (const update of updates) {
                  await window.supabase
                    .from('company_settings')
                    .upsert(update, { onConflict: 'setting_name' });
                }
                
                localStorage.removeItem('sage_connected');
                setSageSettings(prev => ({ ...prev, accessToken: '', refreshToken: '' }));
                alert('Disconnected from Sage');
              }
            }}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            Disconnect
          </button>
          
          <button
            onClick={syncProductsFromSage}
            disabled={syncingProducts}
            className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50"
          >
            {syncingProducts ? (
              <>
                <Loader className="animate-spin mr-2 inline" size={16} />
                Syncing...
              </>
            ) : (
              'Sync Products'
            )}
          </button>
        </>
      )}
    </div>

    {/* Integration Features */}
    <div className="border-t pt-6">
      <h4 className="font-medium mb-4">Integration Features</h4>
      <div className="space-y-3">
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Sync customers from Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Sync suppliers from Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" defaultChecked />
          <span className="text-sm">Create invoices in Sage</span>
        </label>
        <label className="flex items-center">
          <input type="checkbox" className="mr-2" />
          <span className="text-sm">Auto-sync on job completion</span>
        </label>
      </div>
    </div>

    {/* Help Section */}
    <div className="bg-blue-50 p-4 rounded-lg">
      <h4 className="font-medium text-blue-900 mb-2">Setup Instructions</h4>
      <ol className="text-sm text-blue-800 space-y-1 list-decimal list-inside">
        <li>Log in to your Sage Developer account</li>
        <li>Create a new application for API access</li>
        <li>Set redirect URI to: <code className="bg-blue-100 px-1">{window.location.origin}/sage-callback</code></li>
        <li>Copy your Client ID and Client Secret</li>
        <li>Enter the credentials above and save</li>
        <li>Click "Connect to Sage" to authorize access</li>
      </ol>
    </div>
  </div>
)}
{configSection === 'products' && (
  <div className="space-y-6">
    <h3 className="text-lg font-semibold">Products & Services Sync</h3>
    
    <div className="bg-gray-50 p-4 rounded-lg">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h4 className="font-medium">Sync from Sage</h4>
          <p className="text-sm text-gray-600">Import products and services from Sage</p>
        </div>
        <button
          onClick={syncProductsFromSage}
          disabled={syncingProducts}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center"
        >
          {syncingProducts ? (
            <>
              <Loader className="animate-spin mr-2" size={16} />
              Syncing...
            </>
          ) : (
            'Sync Products'
          )}
        </button>
      </div>
    </div>

    {products.length > 0 && (
      <div>
        <h4 className="font-medium mb-3">Synced Products ({products.length})</h4>
        <div className="bg-white border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {products.map((product) => (
                <tr key={product.id}>
                  <td className="px-4 py-2 text-sm">{product.item_code}</td>
                  <td className="px-4 py-2 text-sm">{product.name}</td>
                  <td className="px-4 py-2 text-sm">
                    <span className={`px-2 py-1 text-xs rounded-full ${
                      product.type === 'product' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'
                    }`}>
                      {product.type}
                    </span>
                  </td>
                  <td className="px-4 py-2 text-sm">
                    <span className={`px-2 py-1 text-xs rounded-full ${
                      product.active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700'
                    }`}>
                      {product.active ? 'Active' : 'Inactive'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    )}

    {showProductsSyncDialog && productsSyncResults && (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div className="p-6 border-b border-gray-200">
            <h2 className="text-xl font-bold">Products Sync Preview</h2>
            <p className="text-gray-600">Review products and services to import</p>
          </div>
          
          <div className="p-6">
            {productsSyncResults.new.length > 0 && (
              <div className="mb-6">
                <h3 className="font-semibold mb-3 text-green-700">
                  New Products/Services to Import ({productsSyncResults.new.length})
                </h3>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {productsSyncResults.new.map((item, idx) => (
                    <div key={idx} className="p-3 bg-green-50 rounded-lg">
                      <div className="font-medium">{item.displayed_as}</div>
                      <div className="text-sm text-gray-600">
                        Code: {item.item_code || 'N/A'} | 
                        Type: {item.type}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {productsSyncResults.new.length === 0 && (
              <p className="text-gray-500">No new products or services to sync.</p>
            )}
          </div>
          
          <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
            <button
              onClick={() => {
                setShowProductsSyncDialog(false);
                setProductsSyncResults(null);
              }}
              className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            {productsSyncResults.new.length > 0 && (
              <button
                onClick={handleApplyProductsSync}
                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
              >
                Import {productsSyncResults.new.length} Items
              </button>
            )}
          </div>
        </div>
      </div>
    )}
  </div>
)}
                  </div>
                </div>
              </div>
            </div>
          );
        };
        // Documents View Component
        const DocumentsView = ({ user }) => {
          const [documents, setDocuments] = useState([]);
          const [loading, setLoading] = useState(true);
          const [activeCategory, setActiveCategory] = useState('policies');

          useEffect(() => {
            loadDocuments();
          }, []);

          const loadDocuments = async () => {
            try {
              setLoading(true);
              const { data, error } = await window.supabase
                .from('documents')
                .select('*')
                .order('created_at', { ascending: false });
              
              if (error) {
                console.error('Error loading documents:', error);
                return;
              }
              
              setDocuments(data || []);
            } catch (error) {
              console.error('Error:', error);
            } finally {
              setLoading(false);
            }
          };

          const uploadDocument = async () => {
            const docType = document.getElementById('doc-category')?.value;
            const docTitle = document.getElementById('doc-title')?.value;
            const fileInput = document.getElementById('doc-file');
            const file = fileInput?.files[0];
            
            if (!docType || !docTitle || !file) {
              alert('Please fill all fields');
              return;
            }
            
            try {
              const fileName = `${Date.now()}_${file.name}`;
              const { data: fileData, error: fileError } = await window.supabase.storage
                .from('documents')
                .upload(fileName, file);
              
              if (fileError) throw fileError;
              
              const { data: { publicUrl } } = window.supabase.storage
                .from('documents')
                .getPublicUrl(fileName);
              
              const { data, error } = await window.supabase
                .from('documents')
                .insert([{
                  name: docTitle,
                  category: docType,
                  file_type: docType,
                  file_path: fileName,
                  file_url: publicUrl,
                  file_size: file.size
                }])
                .select();
              
              if (error) throw error;
              
              alert('Document uploaded successfully!');
              document.getElementById('doc-title').value = '';
              document.getElementById('doc-file').value = '';
              loadDocuments();
            } catch (error) {
              console.error('Error:', error);
              alert('Error: ' + error.message);
            }
          };

          const deleteDocument = async (docId) => {
            if (!confirm('Are you sure you want to delete this document?')) return;
            
            try {
              const { error } = await window.supabase
                .from('documents')
                .delete()
                .eq('id', docId);
              
              if (error) throw error;
              loadDocuments();
            } catch (error) {
              console.error('Error deleting document:', error);
              alert('Error deleting document');
            }
          };

               const filteredDocuments = documents.filter(doc => 
                 doc.file_type?.toLowerCase() === activeCategory
               );

          return (
            <div className="p-6">
              <h2 className="text-2xl font-bold mb-6">Company Documents</h2>
              
              {user?.role === 'ADMIN' && (
                <div className="bg-gray-100 p-4 rounded-lg mb-6">
                  <h3 className="text-lg font-semibold mb-4">Upload New Document</h3>
                  <div className="space-y-4">
                    <select id="doc-category" className="px-3 py-2 border rounded">
                      <option value="policies">Policies</option>
                      <option value="procedures">Procedures</option>
                    </select>
                    <input type="file" id="doc-file" className="block" accept=".pdf,.doc,.docx" />
                    <input type="text" id="doc-title" placeholder="Document Title" className="px-3 py-2 border rounded w-full max-w-xs" />
                    <button onClick={uploadDocument} className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                      Upload Document
                    </button>
                  </div>
                </div>
              )}
              
              <div className="flex gap-4 mb-6">
                <button 
                  onClick={() => setActiveCategory('policies')}
                  className={`px-4 py-2 rounded ${activeCategory === 'policies' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  Policies
                </button>
                <button 
                  onClick={() => setActiveCategory('procedures')}
                  className={`px-4 py-2 rounded ${activeCategory === 'procedures' ? 'bg-blue-500 text-white' : 'bg-gray-200'}`}
                >
                  Procedures
                </button>
              </div>
              
              {loading ? (
                <div className="text-center py-8">
                  <Loader className="mx-auto h-8 w-8 animate-spin text-blue-500" />
                  <p className="mt-2 text-gray-500">Loading documents...</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 sm:grid-cols-3 gap-4">
                  {filteredDocuments.length === 0 ? (
                    <div className="col-span-full text-center py-8 text-gray-500">
                      No {activeCategory} found
                    </div>
                  ) : (
                    filteredDocuments.map(doc => (
                      <div key={doc.id} className="border rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <h4 className="font-semibold">{doc.name || 'Untitled'}</h4>
                        <p className="text-sm text-gray-600">Uploaded: {new Date(doc.created_at).toLocaleDateString()}</p>
                        <div className="mt-2 flex gap-2">
                          <a 
                            href={doc.file_url} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-blue-500 hover:text-blue-700"
                          >
                            View/Download
                          </a>
                          {user?.role === 'ADMIN' && (
                            <button 
                              onClick={() => deleteDocument(doc.id)}
                              className="text-red-500 hover:text-red-700"
                            >
                              Delete
                            </button>
                          )}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              )}
            </div>
          );
        };
        // Main Application
        const App = () => {
          // Load company settings on app start
useEffect(() => {
  const loadGlobalSettings = async () => {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*');
      
      if (data) {
        data.forEach(setting => {
          if (setting.setting_name === 'primary_color') {
            document.documentElement.style.setProperty('--primary-color', setting.setting_value);
            localStorage.setItem('primaryColor', setting.setting_value);
          } else if (setting.setting_name === 'logo_url') {
            localStorage.setItem('companyLogo', setting.setting_value);
          }
        });
      }
    } catch (error) {
      console.error('Error loading global settings:', error);
    }
  };
  
  loadGlobalSettings();
}, []);
          const { user, logout } = useAuth();
          const [activeTab, setActiveTab] = useState('jobs');
          const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
          
          // State for data management
         const [jobs, setJobs] = useState([]);
const [customers, setCustomers] = useState([]);
const [suppliers, setSuppliers] = useState([]);
const [jobAttachments, setJobAttachments] = useState([]);
const [selectedJob, setSelectedJob] = useState(null);
const [showFullPageJob, setShowFullPageJob] = useState(null);
const [addressSuggestions, setAddressSuggestions] = useState([]);
const [showAddressSuggestions, setShowAddressSuggestions] = useState(false);
const [contactSuggestions, setContactSuggestions] = useState([]);
const [showContactSuggestions, setShowContactSuggestions] = useState(false);
const [phoneSuggestions, setPhoneSuggestions] = useState([]);
const [showPhoneSuggestions, setShowPhoneSuggestions] = useState(false);
          // Load suppliers from Supabase when app starts
useEffect(() => {
  const loadSuppliersFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('suppliers')
        .select('*');
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setSuppliers(data);
        console.log('Loaded', data.length, 'suppliers from Supabase');
      }
    } catch (error) {
      console.error('Error loading suppliers:', error);
    }
  };
  
  loadSuppliersFromSupabase();
}, []);
          // Load customers from Supabase when app starts
useEffect(() => {
  const loadCustomersFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('customers')
        .select('*');
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        setCustomers(data);
        console.log('Loaded', data.length, 'customers from Supabase');
      }
    } catch (error) {
      console.error('Error loading customers:', error);
    }
  };
  
  const loadSageProducts = async () => {
  try {
    const { data, error } = await window.supabase
      .from('sage_products')
      .select('*')
      .eq('active', true)
      .order('name');
    
    if (error) throw error;
    setSageProducts(data || []);
    console.log('Loaded', data.length, 'Sage products from Supabase');
  } catch (error) {
    console.error('Error loading Sage products:', error);
    setSageProducts([]);
  }
};
  loadCustomersFromSupabase();
  loadSageProducts();
}, []);

// 2 AM Full Sync with Phone Lookups
useEffect(() => {
  const runFullSync = async () => {
    const now = new Date();
    const hour = now.getHours();
    const lastSync = localStorage.getItem('lastFullSageSync');
    const lastSyncDate = lastSync ? new Date(lastSync) : null;
    
    // Run at 2 AM if not already done today (change to 2 after testing)
    if (hour === 2 && (!lastSyncDate || lastSyncDate.getDate() !== now.getDate())) {
      
      if (user && user.role === 'ADMIN') {
        console.log('🌙 Starting FULL 2 AM sync with phone lookups...');
        
        // Customer sync with error handling
        console.log('Starting customer sync...');
        let customerResults = null;
        try {
          customerResults = await window.SageAPI.syncCustomersFromSage();
          console.log('Customer sync completed:', customerResults);
        } catch (customerError) {
          console.error('❌ Customer sync error:', customerError);
        }

        if (customerResults && customerResults.new && customerResults.updated) {
          console.log(`✅ Synced ${customerResults.new.length} new, ${customerResults.updated.length} updated customers`);
          
          for (const customer of customerResults.new) {
            try {
              await window.supabase.from('customers').insert(customer);
            } catch (e) {
              console.error('Failed to insert customer:', e);
            }
          }
          
          for (const customer of customerResults.updated) {
            try {
              await window.supabase.from('customers').update(customer).eq('id', customer.id);
            } catch (e) {
              console.error('Failed to update customer:', e);
            }
          }
        }

        // Supplier sync with error handling
        console.log('Starting supplier sync...');
        let supplierResults = null;
        try {
          supplierResults = await window.SageAPI.syncSuppliersFromSage();
          console.log('Supplier sync completed:', supplierResults);
        } catch (supplierError) {
          console.error('❌ Supplier sync error:', supplierError);
        }

        if (supplierResults && supplierResults.new && supplierResults.updated) {
          console.log(`✅ Synced ${supplierResults.new.length} new, ${supplierResults.updated.length} updated suppliers`);
          
          for (const supplier of supplierResults.new) {
            try {
              await window.supabase.from('suppliers').insert(supplier);
            } catch (e) {
              console.error('Failed to insert supplier:', e);
            }
          }
          
          for (const supplier of supplierResults.updated) {
            try {
              await window.supabase.from('suppliers').update(supplier).eq('id', supplier.id);
            } catch (e) {
              console.error('Failed to update supplier:', e);
            }
          }
        }

        // Product sync with error handling
        console.log('Starting product sync...');
        try {
          const productResults = await window.SageAPI.syncProductsFromSage();
          console.log('✅ Synced products');
        } catch (productError) {
          console.error('❌ Product sync error:', productError);
        }
        
        localStorage.setItem('lastFullSageSync', now.toISOString());
        console.log('✅ Full 2 AM sync completed!');
      }
    }
  };
  
  // Check every 30 minutes
  const interval = setInterval(runFullSync, 30 * 60 * 1000);
  runFullSync(); // Check immediately on mount
  
  return () => clearInterval(interval);
}, [user]);

// Load jobs from Supabase when app starts <- This is line 6850
useEffect(() => {
  const loadJobsFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('jobs')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      if (data && data.length > 0) {
  // Convert snake_case from database back to camelCase for React
  const jobsWithCamelCase = data.map(job => ({
  id: job.id,
  jobNumber: job.job_number,
  jobDate: job.job_date,
  createdDate: job.created_date || job.created_at,
  customerName: job.customer_name,
  customerPO: job.customer_po,
  supplierName: job.supplier_name,
  supplierRef: job.supplier_ref,
  haulierName: job.haulier_name,
  jobType: job.job_type,
  wasteType: job.waste_type,
  skipSize: job.skip_size,

  quantity: job.quantity || 1,
  unit: job.unit || 'skip',
  weight: job.weight,
  customerUnitPrice: job.customer_unit_price || 0,
  customerFinalPrice: job.customer_final_price || 0,
  supplierUnitPrice: job.supplier_unit_price || 0,
  supplierFinalPrice: job.supplier_final_price || 0,
  vatRate: job.vat_rate || 20,
  grossProfit: job.gross_profit || 0,
  profitMargin: job.profit_margin || 0,
  jobValue: job.job_value || 0,
  siteAddress: job.site_address,
  siteAddress1: job.site_address1,
  siteAddress2: job.site_address2,
  siteCity: job.site_city,
  sitePostcode: job.site_postcode,
  siteContact: job.site_contact,
  sitePhone: job.site_phone,
  siteNotes: job.site_notes,
  deliveryInstructions: job.delivery_instructions,
  timeSlot: job.time_slot,
  collectionDate: job.collection_date,
  status: job.status || 'CONFIRMED',
  priority: job.priority || 'Medium',
  isCompleted: job.is_completed || false,
  isCancelled: job.is_cancelled || false,
  wasteTransferNote: job.waste_transfer_note,
  hazardousWaste: job.hazardous_waste || false,
  consignmentNote: job.consignment_note,
  invoiceNumber: job.invoice_number,
  invoiceStatus: job.invoice_status || 'Not Invoiced',
  paymentStatus: job.payment_status || 'Not Paid',
  sageProductId: job.sage_product_id,
  sageProductName: job.sage_product_name,
  sageId: job.sage_id,
  // Handle both old and new line_items format
  lineItems: (() => {
    try {
      if (job.line_items) {
        return typeof job.line_items === 'string' ? JSON.parse(job.line_items) : job.line_items;
      }
      return [];
    } catch (e) {
      console.warn('Error parsing line_items for job', job.id);
      return [];
    }
  })(),
  parentJobId: job.parent_job_id,
  linkedJobs: (() => {
    try {
      if (job.linked_jobs) {
        return typeof job.linked_jobs === 'string' ? JSON.parse(job.linked_jobs) : job.linked_jobs;
      }
      return [];
    } catch (e) {
      console.warn('Error parsing linked_jobs for job', job.id);
      return [];
    }
  })(),
  notes: job.notes
}));
  setJobs(jobsWithCamelCase);
        console.log('Loaded', data.length, 'jobs from Supabase');
      }
    } catch (error) {
      console.error('Error loading jobs:', error);
    }
  };
  
  loadJobsFromSupabase();
}, []);
          const [quotes, setQuotes] = useState([]);
          // Load quotes from Supabase when app starts
// Load quotes from Supabase when app starts
useEffect(() => {
  const loadQuotesFromSupabase = async () => {
    try {
      const { data, error } = await window.supabase
        .from('quotes')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      if (data && data.length > 0) {
        // Convert snake_case from database to camelCase for React
        const quotesWithCamelCase = data.map(quote => ({
          id: quote.id,
          quoteNumber: quote.quote_number,
          customerName: quote.customer_name,
          customerContact: quote.customer_contact,
          customerEmail: quote.customer_email,
          customerPhone: quote.customer_phone,
          supplierName: quote.supplier_name,
          jobType: quote.job_type,
          wasteType: quote.waste_type,
          skipSize: quote.skip_size,
          aggregateType: quote.aggregate_type,
          quantity: quote.quantity || 1,
          unit: quote.unit || 'skip',
          price: quote.price || 0,
          totalPrice: quote.total_price || 0,
          validUntil: quote.valid_until,
          deliveryDate: quote.delivery_date,
          siteAddress: quote.site_address,
          sitePostcode: quote.site_postcode,
          notes: quote.notes,
          status: quote.status || 'PENDING',
          rejectedReason: quote.rejected_reason,
          sentDate: quote.sent_date,
          acceptedDate: quote.accepted_date,
          rejectedDate: quote.rejected_date,
          lineItems: quote.line_items ? JSON.parse(quote.line_items) : [],
          // FIX: Ensure createdDate is properly set
        created_at: quote.created_at || new Date().toISOString().split('T')[0]
        }));
        
        setQuotes(quotesWithCamelCase);
        console.log('Loaded', data.length, 'quotes from Supabase');
      }
    } catch (error) {
      console.error('Error loading quotes:', error);
    }
  };
  
  loadQuotesFromSupabase();
}, []);
          const [showFullPageQuote, setShowFullPageQuote] = useState(null);
          
          // Form states
          const [showJobForm, setShowJobForm] = useState(false);
          const [showCustomerForm, setShowCustomerForm] = useState(false);
          const [showSupplierForm, setShowSupplierForm] = useState(false);
          const [showQuoteForm, setShowQuoteForm] = useState(false);
          const [editingJob, setEditingJob] = useState(null);
          const [editingQuote, setEditingQuote] = useState(null);
          const [sageProducts, setSageProducts] = useState([]);
          const [isSubmitting, setIsSubmitting] = useState(false);
          if (!user) {
            return <LoginScreen />;
          }

          const tabs = [
            { id: 'jobs', name: 'Jobs', icon: 'Grid' },
            { id: 'customers', name: 'Customers', icon: 'Users' },
            { id: 'suppliers', name: 'Suppliers', icon: 'Truck' },
            { id: 'quotes', name: 'Quotes', icon: 'FileText' },
            { id: 'dashboard', name: 'Dashboard', icon: 'BarChart3' },
            { id: 'documents', name: 'Documents', icon: 'FileText' },
            ...(user.role === 'ADMIN' ? [{ id: 'admin', name: 'Admin', icon: 'Settings' }] : [])
          ];

      const handleAddJob = async (newJob) => {
  // Prevent duplicate submissions
  if (isSubmitting) return;
  setIsSubmitting(true);
  
  try {
    // Save to Supabase database
    // Convert camelCase JavaScript fields to snake_case database fields
    const jobForDatabase = {
      job_number: newJob.jobNumber,
      quote_reference: newJob.quoteReference || null,
      job_date: newJob.jobDate || null,
      customer_name: newJob.customerName,
      customer_po: newJob.customerPO || null,
      supplier_name: newJob.supplierName || null,
      supplier_ref: newJob.supplierRef || null,
      haulier_name: newJob.haulierName || null,
      job_type: newJob.jobType,
      waste_type: newJob.wasteType || null,
      skip_size: newJob.skipSize || null,
      aggregate_type: newJob.aggregateType || null,
      quantity: parseInt(newJob.quantity) || 1,
      unit: newJob.unit || 'skip',
      weight: newJob.weight || null,
      customer_unit_price: parseFloat(newJob.customerUnitPrice) || 0,
customer_final_price: parseFloat(newJob.customerFinalPrice) || 0,
supplier_unit_price: parseFloat(newJob.supplierUnitPrice) || 0,
supplier_final_price: parseFloat(newJob.supplierFinalPrice) || 0,
vat_rate: parseFloat(newJob.vatRate) || 20,
gross_profit: parseFloat(newJob.grossProfit) || 0,
profit_margin: parseFloat(newJob.profitMargin) || 0,
job_value: parseFloat(newJob.jobValue) || 0,
      site_address: newJob.siteAddress || null,
      site_address1: newJob.siteAddress1 || null,
      site_address2: newJob.siteAddress2 || null,
      site_city: newJob.siteCity || null,
      site_postcode: newJob.sitePostcode || null,
      site_contact: newJob.siteContact || null,
      site_phone: newJob.sitePhone || null,
      site_notes: newJob.siteNotes || null,
      delivery_instructions: newJob.deliveryInstructions || null,
      access_restrictions: newJob.accessRestrictions || null,
      time_slot: newJob.timeSlot || null,
      collection_date: newJob.collectionDate || null,
      delivery_date: newJob.deliveryDate || null,
collection_date: newJob.collectionDate || null,
      status: newJob.status || 'CONFIRMED',
      priority: newJob.priority || 'Medium',
      is_completed: newJob.isCompleted || false,
      is_cancelled: newJob.isCancelled || false,
      waste_transfer_note: newJob.wasteTransferNote || null,
      hazardous_waste: newJob.hazardousWaste || false,
      consignment_note: newJob.consignmentNote || null,
      invoice_number: newJob.invoiceNumber || null,
      invoice_status: newJob.invoiceStatus || 'Not Invoiced',
      payment_status: newJob.paymentStatus || 'Not Paid',
      sage_product_id: newJob.sageProductId || null,
      sage_product_name: newJob.sageProductName || null,
      sage_id: newJob.sage_id || null,
      line_items: JSON.stringify(newJob.lineItems || []),
      parent_job_id: newJob.parentJobId || null,
      linked_jobs: JSON.stringify(newJob.linkedJobs || []),
      notes: newJob.notes || null,
       sage_product_data: newJob.sage_product_data || null,
  sage_line_items: newJob.sage_line_items || null
    };
// Remove id field if invalid
if (!jobForDatabase.id || jobForDatabase.id === 'undefined' || jobForDatabase.id === 'null') {
    delete jobForDatabase.id;
}
    const { data, error } = await window.supabase
      .from('jobs')
      .insert([jobForDatabase])
      .select();
    
    if (error) throw error;

    // IMPORTANT FIX: Use the returned data which includes the generated UUID
    const savedJob = {
      ...newJob,
      id: data[0].id  // This is the generated UUID from Supabase
    };

    // Add to local jobs state with the proper ID
    setJobs(prevJobs => [savedJob, ...prevJobs]);

    setShowJobForm(false);
    setEditingJob(null);
    
    console.log('Job saved to database with ID:', data[0].id);
  } catch (error) {
    console.error('Error saving job:', error);
    alert('Error saving job: ' + error.message);
  } finally {
    setIsSubmitting(false);
  }
};

 const handleUpdateJob = async (updatedJob) => {
  try {
    // Convert camelCase to snake_case for database
    const jobForDatabase = {
      customer_name: updatedJob.customerName,
      customer_po: updatedJob.customerPO,
      supplier_name: updatedJob.supplierName,
      supplier_ref: updatedJob.supplierRef,
      haulier_name: updatedJob.haulierName,
      job_type: updatedJob.jobType,
      waste_type: updatedJob.wasteType,
      skip_size: updatedJob.skipSize,
      aggregate_type: updatedJob.aggregateType,
      quantity: parseInt(updatedJob.quantity) || 1,
      unit: updatedJob.unit || 'skip',
      weight: updatedJob.weight ? parseFloat(updatedJob.weight) : null,
     customer_unit_price: parseFloat(updatedJob.customerUnitPrice) || 0,
customer_final_price: parseFloat(updatedJob.customerFinalPrice) || 0,
supplier_unit_price: parseFloat(updatedJob.supplierUnitPrice) || 0,
supplier_final_price: parseFloat(updatedJob.supplierFinalPrice) || 0,
vat_rate: parseFloat(updatedJob.vatRate) || 20,
gross_profit: parseFloat(updatedJob.grossProfit) || 0,
profit_margin: parseFloat(updatedJob.profitMargin) || 0,
job_value: parseFloat(updatedJob.jobValue) || 0,
      site_address: updatedJob.siteAddress,
      site_address1: updatedJob.siteAddress1,
      site_address2: updatedJob.siteAddress2,
      site_city: updatedJob.siteCity,
      site_postcode: updatedJob.sitePostcode,
      site_contact: updatedJob.siteContact,
      site_phone: updatedJob.sitePhone,
      site_notes: updatedJob.siteNotes,
      delivery_instructions: updatedJob.deliveryInstructions,
      delivery_date: updatedJob.deliveryDate || null,
      job_date: updatedJob.jobDate || null,
collection_date: updatedJob.collectionDate || null,
      time_slot: updatedJob.timeSlot,
      status: updatedJob.status || 'CONFIRMED',
      priority: updatedJob.priority || 'Medium',
      is_completed: updatedJob.isCompleted || false,
      is_cancelled: updatedJob.isCancelled || false,
      waste_transfer_note: updatedJob.wasteTransferNote,
      hazardous_waste: updatedJob.hazardousWaste || false,
      consignment_note: updatedJob.consignmentNote,
      invoice_number: updatedJob.invoiceNumber,
      invoice_status: updatedJob.invoiceStatus || 'Not Invoiced',
      payment_status: updatedJob.paymentStatus || 'Not Paid',
      sage_si_number: updatedJob.sage_si_number,  // ADD THIS LINE
  sage_invoice_id: updatedJob.sage_invoice_id
    };

    const { error } = await window.supabase
      .from('jobs')
      .update(jobForDatabase)
      .eq('id', updatedJob.id);

    if (error) throw error;

    setJobs(jobs.map(job => job.id === updatedJob.id ? updatedJob : job));
    setEditingJob(updatedJob);  // Update with new data
setShowJobForm(false);
setShowFullPageJob(updatedJob);
alert('Job updated successfully!');
  } catch (error) {
    console.error('Error updating job:', error);
    alert('Error updating job: ' + error.message);
  }
};
const handleCompleteJob = async (job) => {
    try {
        // For Skip Hire jobs, set status to COLLECTED when marking as complete
        const updateData = {
            is_completed: true,  // Database field name
            status: job.jobType === 'Skip Hire' ? 'COLLECTED' : 'COMPLETED'
        };
        
        const { error } = await window.supabase
            .from('jobs')
            .update(updateData)
            .eq('id', job.id);
            
        if (error) throw error;
        
        // Update local state with camelCase
        const updatedJob = {
            ...job,
            isCompleted: true,  // JavaScript field name
            is_completed: true, // Keep both for compatibility
            status: updateData.status
        };
        
        setJobs(jobs.map(j => j.id === job.id ? updatedJob : j));
        
        // Force update the full page view
        if (setShowFullPageJob) {
            setShowFullPageJob(updatedJob);
        }
        
        alert('Job marked as completed!');
        
        // Reload the page data to ensure sync
    } catch (error) {
        console.error('Error completing job:', error);
        alert('Error completing job: ' + error.message);
    }
};
const handleDeleteAttachment = async (attachment) => {
  if (!confirm(`Are you sure you want to delete ${attachment.file_name}?`)) return;
  
  try {
    // Delete from storage
    const { error: storageError } = await window.supabase.storage
      .from('documents')
      .remove([attachment.file_name]);
    
    if (storageError) throw storageError;
    
    // Delete from database
    const { error: dbError } = await window.supabase
      .from('job_attachments')
      .delete()
      .eq('id', attachment.id);
    
    if (dbError) throw dbError;
    
    // Update UI
    setJobAttachments(jobAttachments.filter(att => att.id !== attachment.id));
    alert('Attachment deleted successfully!');
  } catch (error) {
    console.error('Error deleting attachment:', error);
    alert('Error deleting attachment: ' + error.message);
  }
};
  const handleExchange = (job) => {
            // Create new exchange job - duplicate all details
            const exchangeJob = {
              ...job,
              id: null,
              jobNumber: null,
              parentJobId: job.id,
              isCompleted: false,
              isCancelled: false,
              status: 'CONFIRMED',
              notes: `Exchange for job ${job.jobNumber}. ${job.notes || ''}`.trim(),
              jobDate: job?.jobDate || new Date().toISOString().split('T')[0],
              linkedJobs: []
            };
            
            // Remove the old id and jobNumber completely
            delete exchangeJob.id;
            delete exchangeJob.jobNumber;
            
            // Mark original job as collected
            onUpdateJob({ ...job, status: 'COLLECTED', isCompleted: true });
            
            // Add the exchange job
            onAddJob(exchangeJob);
            setSelectedJob(null);
          };
          const handleCollection = (job) => {
  console.log('Collection job:', job);
};
   const handleDeleteJob = async (jobId) => {
  try {
    // First, get the job to check if it was created from a quote
    const jobToDelete = jobs.find(job => job.id === jobId);
    
    // Delete from Supabase database
    const { error } = await window.supabase
      .from('jobs')
      .delete()
      .eq('id', jobId);
    
    if (error) throw error;
    
    // If this job was created from a quote, revert the quote status
    if (jobToDelete?.quoteReference) {
      // Find the quote by quote number
      const quoteToRevert = quotes.find(q => q.quoteNumber === jobToDelete.quoteReference);
      
      if (quoteToRevert) {
        // Update quote status back to PENDING in database
        const { error: quoteError } = await window.supabase
          .from('quotes')
          .update({ 
            status: 'PENDING',
            converted_date: null,
            job_reference: null
          })
          .eq('id', quoteToRevert.id);
        
        if (!quoteError) {
          // Update local state
          setQuotes(quotes.map(q => 
            q.id === quoteToRevert.id 
              ? { ...q, status: 'PENDING', converted_date: null, job_reference: null }
              : q
          ));
          
          console.log(`Quote ${jobToDelete.quoteReference} reverted to PENDING status`);
        }
      }
    }
    
    // Update local state only if database delete succeeds
    setJobs(jobs.filter(job => job.id !== jobId));
    
    console.log('Job deleted from database:', jobId);
    setShowFullPageJob(null);
  } catch (error) {
    console.error('Error deleting job:', error);
    alert('Error deleting job: ' + error.message);
  }
};

        const handleDuplicateJob = async (jobTemplate) => {
    try {
        // Create a completely fresh job object
        const year = new Date().getFullYear();
        const lastJobNumber = parseInt(localStorage.getItem('lastJobNumber') || '0');
        const newJobNumber = lastJobNumber + 1;
        localStorage.setItem('lastJobNumber', newJobNumber.toString());
        const jobNumber = `TWS-${year}-${String(newJobNumber).padStart(4, '0')}`;
        
        // Get the job type (could be Skip Hire, Waste Collection, Grab Hire, Muck Hire)
        const jobType = jobTemplate.jobType || jobTemplate.job_type || 'Skip Hire';
        
        const jobForDatabase = {
            job_number: jobNumber,
            customer_name: jobTemplate.customerName || jobTemplate.customer_name,
            supplier_name: jobTemplate.supplierName || jobTemplate.supplier_name,
            job_type: jobType, // Preserves the original job type
            waste_type: jobTemplate.wasteType || jobTemplate.waste_type,
            skip_size: jobTemplate.skipSize || jobTemplate.skip_size,
            quantity: jobTemplate.quantity || 1,
            unit: jobTemplate.unit || 'skip',
            customer_unit_price: jobTemplate.customerUnitPrice || jobTemplate.customer_unit_price || 0,
            supplier_unit_price: jobTemplate.supplierUnitPrice || jobTemplate.supplier_unit_price || 0,
            customer_final_price: jobTemplate.customerFinalPrice || jobTemplate.customer_final_price || 0,
            supplier_final_price: jobTemplate.supplierFinalPrice || jobTemplate.supplier_final_price || 0,
            job_date: new Date().toISOString().split('T')[0],
            status: 'CONFIRMED',
            is_completed: false,
            is_cancelled: false,
            notes: `Duplicated from ${jobTemplate.jobNumber || jobTemplate.job_number} (${jobType})`
        };
        
        // NO job-type specific fields - database doesn't have those columns
        
        // Save directly to database
        const { data, error } = await window.supabase
            .from('jobs')
            .insert([jobForDatabase])
            .select();
            
        if (error) throw error;
        
        // Fetch updated jobs list
        const { data: updatedJobs, error: fetchError } = await window.supabase
            .from('jobs')
            .select('*')
            .order('created_at', { ascending: false });
            
        if (fetchError) throw fetchError;
        
        // Convert snake_case to camelCase for the app
        const formattedJobs = updatedJobs.map(job => ({
            ...job,
            jobNumber: job.job_number,
            customerName: job.customer_name,
            supplierName: job.supplier_name,
            jobType: job.job_type,
            wasteType: job.waste_type,
            skipSize: job.skip_size,
            customerUnitPrice: job.customer_unit_price,
            supplierUnitPrice: job.supplier_unit_price,
            customerFinalPrice: job.customer_final_price,
            supplierFinalPrice: job.supplier_final_price,
            jobDate: job.job_date,
            isCompleted: job.is_completed,
            isCancelled: job.is_cancelled
        }));
        
        // Update the jobs state
        setJobs(formattedJobs);
        
        setShowFullPageJob(null); // Close the full page view
        alert(`${jobType} job duplicated successfully!`);
        
    } catch (error) {
        console.error('Error duplicating job:', error);
        alert('Error duplicating job: ' + error.message);
    }
};
const handleAddressSearch = async (searchText) => {

    
    try {
        if (searchText.length < 2) {
            setAddressSuggestions([]);
            setShowAddressSuggestions(false);
            return;
        }
        
        const { data, error } = await window.supabase
            .from('jobs')
            .select('site_address1, site_address2, site_postcode')
            .or(`site_address1.ilike.%${searchText}%,site_address2.ilike.%${searchText}%,site_postcode.ilike.%${searchText}%`)
            .limit(10);
            
        
        if (error) throw error;
        
        // Remove duplicates and format suggestions
        const uniqueAddresses = [...new Map(
            data
                .filter(job => job.site_address1)
                .map(job => [`${job.site_address1}|${job.site_postcode || ''}`, {
                    address: job.site_address1,
                    postcode: job.site_postcode || ''
                }])
        ).values()];
        
        setAddressSuggestions(uniqueAddresses);
        setShowAddressSuggestions(uniqueAddresses.length > 0);
        
        
    } catch (error) {
        console.error('Error in handleAddressSearch:', error);
    }
};
const handleContactSearch = async (searchText) => {
    try {
        if (searchText.length < 2) {
            setContactSuggestions([]);
            setShowContactSuggestions(false);
            return;
        }
        
        const { data, error } = await window.supabase
            .from('jobs')
            .select('site_contact')
            .ilike('site_contact', `%${searchText}%`)
            .limit(10);
            
        if (error) throw error;
        
        // Remove duplicates
        const uniqueContacts = [...new Set(data
            .filter(job => job.site_contact)
            .map(job => job.site_contact))];
        
        setContactSuggestions(uniqueContacts);
        setShowContactSuggestions(uniqueContacts.length > 0);
        
    } catch (error) {
        console.error('Error searching contacts:', error);
    }
};

const handlePhoneSearch = async (searchText) => {
    try {
        if (searchText.length < 2) {
            setPhoneSuggestions([]);
            setShowPhoneSuggestions(false);
            return;
        }
        
        const { data, error } = await window.supabase
            .from('jobs')
            .select('site_phone')
            .ilike('site_phone', `%${searchText}%`)
            .limit(10);
            
        if (error) throw error;
        
        // Remove duplicates
        const uniquePhones = [...new Set(data
            .filter(job => job.site_phone)
            .map(job => job.site_phone))];
        
        setPhoneSuggestions(uniquePhones);
        setShowPhoneSuggestions(uniquePhones.length > 0);
        
    } catch (error) {
        console.error('Error searching phones:', error);
    }
};
          const handleEditJob = (job) => {
    // Convert the job data to the format expected by the form
    const editableJob = {
        ...job,
        id: job.id,
        jobNumber: job.job_number || job.jobNumber,
        customerName: job.customer_name || job.customerName,
        supplierName: job.supplier_name || job.supplierName,
        jobType: job.job_type || job.jobType,
        wasteType: job.waste_type || job.wasteType,
        skipSize: job.skip_size || job.skipSize,
        quantity: job.quantity || 1,
        unit: job.unit || 'skip',
        customerUnitPrice: job.customer_unit_price || job.customerUnitPrice || 0,
        supplierUnitPrice: job.supplier_unit_price || job.supplierUnitPrice || 0,
        customerFinalPrice: job.customer_final_price || job.customerFinalPrice || 0,
        supplierFinalPrice: job.supplier_final_price || job.supplierFinalPrice || 0,
        jobDate: job.job_date || job.jobDate,
        status: job.status || 'CONFIRMED',
        isCompleted: job.is_completed || job.isCompleted || false,
        isCancelled: job.is_cancelled || job.isCancelled || false,
        notes: job.notes || ''
    };
    
    setEditingJob(editableJob);
    setShowJobForm(true);
    setShowFullPageJob(null); // Close the full page view if open
};
          const handleUpdateCustomer = (updatedCustomer) => {
            setCustomers(customers.map(customer => customer.id === updatedCustomer.id ? updatedCustomer : customer));
          };

          const handleDeleteCustomer = (customerId) => {
            setCustomers(customers.filter(customer => customer.id !== customerId));
          };

          const handleAddSupplier = async (newSupplier) => {
  try {
    await saveSupplierToDatabase(newSupplier);
    setSuppliers([...suppliers, newSupplier]);
    setShowSupplierForm(false);
  } catch (error) {
    alert('Error saving supplier: ' + error.message);
  }
};

const saveSupplierToDatabase = async (supplier) => {
 // Map to correct database field names
const supplierData = {
  name: supplier.companyName || 'Unknown Supplier',
  sage_id: supplier.sage_id || supplier.id,
  email: supplier.email || '',
  phone: supplier.phone || '',
  vat_number: supplier.vatNumber || '',
  address: supplier.address || ''
};

const { error } = await window.supabase
  .from('suppliers')
  .insert([supplierData]);
  
  if (error) {
    console.error('Error saving supplier:', error);
    throw error;
  }
};

          const handleUpdateSupplier = (updatedSupplier) => {
            setSuppliers(suppliers.map(supplier => supplier.id === updatedSupplier.id ? updatedSupplier : supplier));
          };

          const handleDeleteSupplier = (supplierId) => {
            setSuppliers(suppliers.filter(supplier => supplier.id !== supplierId));
          };

        const handleAddQuote = async (newQuote) => {
  try {
    const quoteForDatabase = {
      // DO NOT include 'id' field - let Supabase generate it
      quote_number: newQuote.quoteNumber,
      customer_name: newQuote.customerName,
      customer_contact: newQuote.customerContact || '',
      customer_email: newQuote.customerEmail || '',
      customer_phone: newQuote.customerPhone || '',
      supplier_name: newQuote.supplierName || '',
      job_type: newQuote.jobType,
      waste_type: newQuote.wasteType || '',
      skip_size: newQuote.skipSize || '',
      aggregate_type: newQuote.aggregateType || '',
      quantity: newQuote.quantity || 1,
      unit: newQuote.unit || 'skip',
      price: newQuote.customerUnitPrice || 0,
      total_price: newQuote.customerFinalPrice || 0,
      supplier_unit_price: newQuote.supplierUnitPrice || 0,
      supplier_final_price: newQuote.supplierFinalPrice || 0,
      vat_rate: newQuote.vatRate || 20,
      valid_until: newQuote.validUntil,
      delivery_date: newQuote.deliveryDate || null,
      site_address: newQuote.siteAddress || newQuote.siteAddress1 || '',
      site_postcode: newQuote.sitePostcode || '',
      notes: newQuote.notes || '',
      status: newQuote.status || 'PENDING',
      line_items: JSON.stringify(newQuote.lineItems || []),
      created_at: newQuote.createdDate || new Date().toISOString()
    };

    const { data, error } = await window.supabase
      .from('quotes')
      .insert([quoteForDatabase])
      .select();
    
    if (error) throw error;
    
    // Add to local state with the returned ID from database
    const savedQuote = {
      ...newQuote,
      id: data[0].id  // Use the UUID that Supabase generated
    };
    
    setQuotes(prevQuotes => [savedQuote, ...prevQuotes]);
    setShowQuoteForm(false);
    setEditingQuote(null);
    
    console.log('Quote saved to database:', data);
  } catch (error) {
    console.error('Error saving quote:', error);
    alert('Error saving quote: ' + error.message);
  }
};

         const handleUpdateQuote = async (updatedQuote) => {
  try {
    const quoteForDatabase = {
      customer_name: updatedQuote.customerName,
      customer_contact: updatedQuote.customerContact || '',
      customer_email: updatedQuote.customerEmail || '',
      customer_phone: updatedQuote.customerPhone || '',
      supplier_name: updatedQuote.supplierName || '',
      job_type: updatedQuote.jobType,
      waste_type: updatedQuote.wasteType || '',
      skip_size: updatedQuote.skipSize || '',
      quantity: updatedQuote.quantity || 1,
      unit: updatedQuote.unit || 'skip',
      price: updatedQuote.price || 0,
      total_price: updatedQuote.totalPrice || 0,
      valid_until: updatedQuote.validUntil,
      delivery_date: updatedQuote.deliveryDate || null,
      site_address: updatedQuote.siteAddress || updatedQuote.siteAddress1 || '',
      site_postcode: updatedQuote.sitePostcode || '',
      notes: updatedQuote.notes || '',
      status: updatedQuote.status || 'PENDING'
    };

    // Only add line_items if your quotes table has this column
    if (updatedQuote.lineItems) {
      quoteForDatabase.line_items = JSON.stringify(updatedQuote.lineItems);
    }

    const { error } = await window.supabase
      .from('quotes')
      .update(quoteForDatabase)
      .eq('id', updatedQuote.id);

    if (error) throw error;

    setQuotes(quotes.map(quote => quote.id === updatedQuote.id ? updatedQuote : quote));
    setEditingQuote(null);
setShowQuoteForm(false);
setShowFullPageQuote(updatedQuote);
alert('Quote updated successfully!');
  } catch (error) {
    console.error('Error updating quote:', error);
    alert('Error updating quote: ' + error.message);
  }
};

          const handleEditQuote = (quote) => {
            setEditingQuote(quote);
            setShowQuoteForm(true);
          };

          const handleConvertToJob = (newJob) => {
            setEditingJob(newJob);
            setShowJobForm(true);
            setActiveTab('jobs');
          };
// ADD these NEW quote management functions after line 6947

const handleDuplicateQuote = (quoteTemplate) => {
  const duplicatedQuote = { ...quoteTemplate, id: null, quoteNumber: null };
  delete duplicatedQuote.id;
  delete duplicatedQuote.quoteNumber;
  setEditingQuote(duplicatedQuote);
  setShowQuoteForm(true);
};

const handleDeleteQuote = async (quoteId) => {
  if (confirm('Are you sure you want to delete this quote?')) {
    try {
      const { error } = await window.supabase
        .from('quotes')
        .delete()
        .eq('id', quoteId);
      
      if (error) throw error;
      
      setQuotes(quotes.filter(quote => quote.id !== quoteId));
      setShowFullPageQuote(null);
      alert('Quote deleted successfully!');
    } catch (error) {
      console.error('Error deleting quote:', error);
      alert('Error deleting quote: ' + error.message);
    }
  }
};

const handleSendQuote = async (quote) => {
  try {
    const updatedQuote = {
      ...quote,
      status: 'SENT',
      sent_date: new Date().toISOString()
    };
    
    const { error } = await window.supabase
      .from('quotes')
      .update({ 
        status: 'SENT',
        sent_date: new Date().toISOString()
      })
      .eq('id', quote.id);
    
    if (error) throw error;
    
    setQuotes(quotes.map(q => q.id === quote.id ? updatedQuote : q));
    setShowFullPageQuote(updatedQuote);
    alert('Quote sent to customer!');
  } catch (error) {
    console.error('Error sending quote:', error);
    alert('Error sending quote: ' + error.message);
  }
};

const handleAcceptQuote = async (quote) => {
  try {
    // Create job from quote
    const newJob = {
      customerName: quote.customerName,
      customerPO: '',
      supplierName: quote.supplierName || '',
      supplierRef: '',
      jobType: quote.jobType,
      wasteType: quote.wasteType || '',
      skipSize: quote.skipSize || '',
      aggregateType: quote.aggregateType || '',
      quantity: quote.quantity,
      unit: quote.unit,
      customerUnitPrice: quote.price,
      customerFinalPrice: quote.totalPrice,
      supplierUnitPrice: 0,
      supplierFinalPrice: 0,
      vatRate: 20,
      jobDate: quote.deliveryDate || new Date().toISOString().split('T')[0],
      status: 'CONFIRMED',
      priority: 'Medium',
      siteAddress1: quote.siteAddress || '',
      sitePostcode: quote.sitePostcode || '',
      siteContact: quote.customerContact || '',
      sitePhone: quote.customerPhone || '',
      notes: `Created from accepted quote ${quote.quoteNumber}. ${quote.notes || ''}`.trim(),
      invoiceNumber: '',
      invoiceStatus: 'Not Invoiced',
      paymentStatus: 'Not Paid',
      isCompleted: false,
      isCancelled: false,
      lineItems: quote.lineItems || []
    };
    
    // Save job
    await handleAddJob(newJob);
    
    // Update quote status
    const updatedQuote = {
      ...quote,
      status: 'ACCEPTED',
      accepted_date: new Date().toISOString()
    };
    
    const { error } = await window.supabase
      .from('quotes')
      .update({ 
        status: 'ACCEPTED',
        accepted_date: new Date().toISOString()
      })
      .eq('id', quote.id);
    
    if (error) throw error;
    
    setQuotes(quotes.map(q => q.id === quote.id ? updatedQuote : q));
    setShowFullPageQuote(null);
    setActiveTab('jobs');
    alert(`Quote ${quote.quoteNumber} accepted and job created!`);
  } catch (error) {
    console.error('Error accepting quote:', error);
    alert('Error accepting quote: ' + error.message);
  }
};

const handleRejectQuote = async (quote) => {
  const reason = prompt('Please provide a reason for rejection (optional):');
  
  try {
    const updatedQuote = {
      ...quote,
      status: 'REJECTED',
      isDeclined: true,  // ADD THIS to sync with checkbox
      rejectedReason: reason || '',
      rejected_reason: reason || '',
      rejected_date: new Date().toISOString()
    };
    
    const { error } = await window.supabase
      .from('quotes')
      .update({ 
        status: 'REJECTED',
        rejected_reason: reason || '',
        rejected_date: new Date().toISOString()
      })
      .eq('id', quote.id);
    
    if (error) throw error;
    
    setQuotes(quotes.map(q => q.id === quote.id ? updatedQuote : q));
    setShowFullPageQuote(updatedQuote);
    alert('Quote rejected!');
  } catch (error) {
    console.error('Error rejecting quote:', error);
    alert('Error rejecting quote: ' + error.message);
  }
};


   const handleConvertQuoteToJob = async (quote) => {
  try {
    // Generate new job number
    // Get the highest job number from existing jobs
const currentYear = new Date().getFullYear();
const yearJobs = jobs.filter(j => j.jobNumber && j.jobNumber.startsWith(`TWS-${currentYear}`));
const lastJobNumber = yearJobs.length > 0 
  ? Math.max(...yearJobs.map(j => parseInt(j.jobNumber.split('-')[2]) || 0))
  : 0;
const jobNumber = `TWS-${currentYear}-${String(lastJobNumber + 1).padStart(4, '0')}`;
    
    // Create job from quote - matching exact fields that handleAddJob expects
    const newJob = {
      jobNumber: jobNumber,
      quoteReference: quote.quoteNumber,  // This might need to be added to handleAddJob mapping
      customerName: quote.customerName,
      customerPO: '',
      supplierName: quote.supplierName || '',
      supplierRef: '',
      haulierName: '',  // Add this field
      jobType: quote.jobType,
      wasteType: quote.wasteType || '',
      skipSize: quote.skipSize || '',
      aggregateType: quote.aggregateType || '',  // This is correct, gets converted to aggregate_type
      quantity: quote.quantity || 1,
      unit: quote.unit || 'skip',
      weight: null,  // Add this field
      customerUnitPrice: quote.price || 0,
      customerFinalPrice: quote.totalPrice || 0,
      supplierUnitPrice: 0,
      supplierFinalPrice: 0,
      vatRate: 20,
      grossProfit: 0,  // Add this
      profitMargin: 0,  // Add this
      jobValue: quote.totalPrice || 0,  // Add this
      jobDate: quote.deliveryDate || new Date().toISOString().split('T')[0],
      collectionDate: null,  // Add this
      status: 'CONFIRMED',
      priority: quote.priority || 'Medium',
      siteAddress: quote.siteAddress || '',
      siteAddress1: quote.siteAddress1 || '',
      siteAddress2: '',  // Add this
      siteCity: '',  // Add this
      sitePostcode: quote.sitePostcode || '',
      siteContact: quote.customerContact || '',
      sitePhone: quote.customerPhone || '',
      siteNotes: '',  // Add this
      deliveryInstructions: '',  // Add this
      accessRestrictions: '',  // Add this
      timeSlot: '',  // Add this
      notes: `Converted from Quote: ${quote.quoteNumber}. ${quote.notes || ''}`.trim(),
      invoiceNumber: '',
      invoiceStatus: 'Not Invoiced',
      paymentStatus: 'Not Paid',
      isCompleted: false,
      isCancelled: false,
      wasteTransferNote: '',  // Add this
      hazardousWaste: false,  // Add this
      consignmentNote: '',  // Add this
      sageProductId: null,  // Add this
      sageProductName: null,  // Add this
      sage_id: null,  // Add this
      lineItems: quote.lineItems || [],
      parentJobId: null,  // Add this
      linkedJobs: []  // Add this
    };
    
   // Save job using handleAddJob which handles field conversions
await handleAddJob(newJob);
    
    // Update quote status to CONVERTED
    const { error: quoteError } = await window.supabase
      .from('quotes')
      .update({ 
        status: 'CONVERTED',
        converted_date: new Date().toISOString(),
        job_reference: jobNumber  // Store the new job number
      })
      .eq('id', quote.id);
    
    if (quoteError) throw quoteError;
    
    // Update local state
    setQuotes(quotes.map(q => 
      q.id === quote.id 
        ? { ...q, status: 'CONVERTED', job_reference: jobNumber }
        : q
    ));
    
    // Close the quote view and switch to jobs tab
    setShowFullPageQuote(null);
    setActiveTab('jobs');
    
    alert(`✅ Quote ${quote.quoteNumber} successfully converted to Job ${jobNumber}!`);
    
  } catch (error) {
    console.error('Error converting quote to job:', error);
    alert('Error converting quote to job: ' + error.message);
  }
};
          return (
            <div className="min-h-screen bg-gray-50">
              <div className="bg-white border-b border-gray-200">
  <div className="px-4 sm:px-6 py-4">
    <div className="flex items-center justify-between">
      <div className="flex items-center space-x-4">
        {/* Mobile menu button */}
        <button
          onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
          className="sm:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100"
        >
          <Menu size={24} />
        </button>
        
        <div className="flex items-center space-x-3">
          <div className="w-10 h-10">
            {localStorage.getItem('companyLogo') ? (
              <img 
                src={localStorage.getItem('companyLogo')} 
                alt="Company Logo" 
                className="w-full h-full object-contain"
              />
            ) : (
              <div className="w-full h-full bg-blue-600 rounded-lg flex items-center justify-center">
                <Recycle className="w-6 h-6 text-white" />
              </div>
            )}
          </div>
          <div className="hidden sm:block">
            <h1 className="text-xl font-bold text-gray-900">Total Waste Services</h1>
          </div>
        </div>
      </div>
      
      <div className="flex items-center space-x-2 sm:space-x-4">
        <div className="hidden sm:flex items-center space-x-2">
          <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
          <span className="text-sm text-gray-600">Live</span>
        </div>
        
        <div className="flex items-center space-x-2">
          <div className="hidden sm:block w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center">
            <User size={16} />
          </div>
          <div className="text-sm">
            <div className="font-medium">{user.firstName}</div>
            <div className="text-gray-600 hidden sm:block">{user.role}</div>
          </div>
          <button
            onClick={logout}
            className="p-2 text-gray-600 hover:bg-gray-100 rounded-lg"
          >
            <LogOut size={16} />
          </button>
        </div>
      </div>
    </div>
  </div>

  {/* Desktop tabs */}
  <div className="hidden sm:block px-6">
    <div className="flex space-x-8">
      {tabs.map(tab => {
        const Icon = tab.icon === 'BarChart3' ? BarChart3 :
                     tab.icon === 'Grid' ? Grid :
                     tab.icon === 'Users' ? Users :
                     tab.icon === 'Truck' ? Truck :
                     tab.icon === 'FileText' ? FileText : Settings;
        return (
          <button
            key={tab.id}
            
// TO THIS:
onClick={() => {
  setActiveTab(tab.id);
  setShowFullPageJob(null);
  setShowFullPageQuote(null);
}}
            className={`flex items-center space-x-2 px-4 py-3 border-b-2 font-medium text-sm transition-all ${
              activeTab === tab.id
                ? 'border-blue-500 text-blue-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <Icon size={16} />
            <span>{tab.name}</span>
          </button>
        );
      })}
    </div>
  </div>

  {/* Mobile menu */}
  {mobileMenuOpen && (
    <div className="sm:hidden px-4 py-2 space-y-1">
      {tabs.map(tab => {
        const Icon = tab.icon === 'BarChart3' ? BarChart3 :
                     tab.icon === 'Grid' ? Grid :
                     tab.icon === 'Users' ? Users :
                     tab.icon === 'Truck' ? Truck :
                     tab.icon === 'FileText' ? FileText : Settings;
        return (
          <button
            key={tab.id}
            onClick={() => {
  setActiveTab(tab.id);
  setMobileMenuOpen(false);
  setShowFullPageJob(null);
  setShowFullPageQuote(null);
}}
            className={`w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-left ${
              activeTab === tab.id
                ? 'bg-blue-50 text-blue-600'
                : 'text-gray-700 hover:bg-gray-50'
            }`}
          >
            <Icon size={20} />
            <span>{tab.name}</span>
          </button>
        );
      })}
    </div>
  )}
</div>
{/* Full Page Job View - Add this BEFORE the tab content */}
{showFullPageJob && (
  <FullPageJobView 
    job={showFullPageJob}
    onClose={() => setShowFullPageJob(null)}
    onUpdateDisplay={setShowFullPageJob}
    onEdit={handleEditJob}
    onDuplicate={() => handleDuplicateJob(showFullPageJob)}
    onDelete={handleDeleteJob}
    onExchange={async (job) => {
    try {
        // Create exchange job
        const exchangeJob = {
            ...job,
            id: null,
            jobNumber: null,
            isCompleted: false,
            is_completed: false,
            isCancelled: false,
            status: 'CONFIRMED',
            notes: `Exchange for job ${job.jobNumber}. ${job.notes || ''}`.trim(),
            jobDate: job?.jobDate || new Date().toISOString().split('T')[0],
            linkedJobs: []
        };
        
        // Generate new job number
        const year = new Date().getFullYear();
        const lastJobNumber = parseInt(localStorage.getItem('lastJobNumber') || '0');
        const newJobNumber = lastJobNumber + 1;
        localStorage.setItem('lastJobNumber', newJobNumber.toString());
        exchangeJob.id = `TWS-${year}-${String(newJobNumber).padStart(4, '0')}`;
        exchangeJob.jobNumber = exchangeJob.id;
        
        // Mark original job as collected
        await window.supabase
            .from('jobs')
            .update({ status: 'COLLECTED', is_completed: true })
            .eq('id', job.id);
        
        // Add the exchange job
        await handleAddJob(exchangeJob);
        
        alert('Exchange job created!');
        setShowFullPageJob(null);  // Close the full page view
    } catch (error) {
        console.error('Error:', error);
        alert('Error creating exchange: ' + error.message);
    }
}}
    onCollection={async (job) => {
    try {
        const { error } = await window.supabase
            .from('jobs')
.update({
    ...updatedJob,
    si_number: updatedJob.si_number === '' ? null : updatedJob.si_number,
    quote_number: updatedJob.quote_number === '' ? null : updatedJob.quote_number
})
            .eq('id', job.id);
            
        if (error) throw error;
        
        const updatedJob = {...job, status: 'COLLECTED', isCompleted: true, is_completed: true};
        setJobs(jobs.map(j => j.id === job.id ? updatedJob : j));
        setShowFullPageJob(updatedJob);
        
        alert('Job marked as collected!');
    } catch (error) {
        console.error('Error:', error);
        alert('Error updating job: ' + error.message);
    }
}}
    onComplete={handleCompleteJob}
    user={user}
    onDeleteAttachment={handleDeleteAttachment}
  />
)}
{/* Full Page Quote View - ADD this RIGHT AFTER showFullPageJob section */}
{showFullPageQuote && (
  <FullPageQuoteView 
    quote={showFullPageQuote}
    onClose={() => setShowFullPageQuote(null)}
    onEdit={handleEditQuote}
    onDuplicate={handleDuplicateQuote}
    onDelete={handleDeleteQuote}
    onSend={handleSendQuote}
    onAccept={handleAcceptQuote}
    onReject={handleRejectQuote}
    onConvertToJob={handleConvertQuoteToJob}
    user={user}
  />
)}
              <div className="p-4 sm:p-6">
                {activeTab === 'dashboard' && <Dashboard jobs={jobs} customers={customers} />}
                {activeTab === 'documents' && (
                  <DocumentsView user={user} />
                )}
                {activeTab === 'jobs' && (
                  <JobsView 
                    jobs={jobs} 
                    onAddJob={() => setShowJobForm(true)}
                    onUpdateJob={handleUpdateJob}
                    onDeleteJob={handleDeleteJob}
                    onDuplicateJob={handleDuplicateJob}
                    onEditJob={handleEditJob}
                    customers={customers}
                    suppliers={suppliers}
                    user={user}
                    setShowFullPageJob={setShowFullPageJob}
                  />
                )}
                {activeTab === 'customers' && (
                  <CustomersView 
                    customers={customers} 
                    onAddCustomer={() => setShowCustomerForm(true)}
                    onUpdateCustomer={handleUpdateCustomer}
                    onDeleteCustomer={handleDeleteCustomer}
                    user={user}  
                  />
                )}
                {activeTab === 'suppliers' && (
                  <SuppliersView 
                    suppliers={suppliers} 
                    onAddSupplier={() => setShowSupplierForm(true)}
                    onUpdateSupplier={handleUpdateSupplier}
                    onDeleteSupplier={handleDeleteSupplier}
                    user={user}
                  />
                  
                )}
                {activeTab === 'quotes' && (
  <QuotesView 
    quotes={quotes}
    onAddQuote={() => setShowQuoteForm(true)}
    onUpdateQuote={handleUpdateQuote}
    onEditQuote={handleEditQuote}
    onConvertToJob={handleConvertQuoteToJob}
    onSendQuote={handleSendQuote}
    onAcceptQuote={handleAcceptQuote}
    onRejectQuote={handleRejectQuote}
    onDeleteQuote={handleDeleteQuote}
    customers={customers}
    suppliers={suppliers}
    user={user}
    setShowFullPageQuote={setShowFullPageQuote}
  />
)}
                {activeTab === 'admin' && <AdminPanel user={user} />}
              </div>

              {/* Forms */}
  {showJobForm && (
    <JobForm
        job={editingJob}
        onClose={() => {
            setShowJobForm(false);
            setEditingJob(null);
        }}
        onSave={(jobData) => {
            if (editingJob) {
                handleUpdateJob(jobData);
            } else {
                handleAddJob(jobData);
            }
        }}
        customers={customers}
        suppliers={suppliers}
        sageProducts={sageProducts}
        user={user}
        // MAKE SURE THESE 4 LINES ARE HERE:
        addressSuggestions={addressSuggestions}
        showAddressSuggestions={showAddressSuggestions}
        setShowAddressSuggestions={setShowAddressSuggestions}
        handleAddressSearch={handleAddressSearch}
        contactSuggestions={contactSuggestions}
showContactSuggestions={showContactSuggestions}
setShowContactSuggestions={setShowContactSuggestions}
handleContactSearch={handleContactSearch}
phoneSuggestions={phoneSuggestions}
showPhoneSuggestions={showPhoneSuggestions}
setShowPhoneSuggestions={setShowPhoneSuggestions}
handlePhoneSearch={handlePhoneSearch}
    />
)}

              {showSupplierForm && (
                <SupplierForm 
                  onClose={() => setShowSupplierForm(false)}
                  onSave={handleAddSupplier}
                />
              )}

              {showQuoteForm && (
  <QuoteForm 
    quote={editingQuote}
    onClose={() => {
      setShowQuoteForm(false);
      setEditingQuote(null);
    }}
    onSave={editingQuote?.id ? handleUpdateQuote : handleAddQuote}
    customers={customers}
    suppliers={suppliers}
    sageProducts={sageProducts}  // ADD THIS LINE
    user={user}  // ADD THIS LINE
  />
)}
            </div>
          );
        };
        // Sage API Service
const SageAPI = {
  baseURL: 'https://api.sage.com/v3.1',
  
  async getAccessToken() {
    // In production, this would handle OAuth2 flow
    const settings = await this.getSettings();
    return settings.accessToken;
  },
  
  async getSettings() {
    try {
      const { data } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_access_token', 'sage_refresh_token', 'sage_company_id', 'sage_api_region']);
      
      const settings = {};
      data?.forEach(item => {
        const key = item.setting_name.replace('sage_', '');
        settings[key] = item.setting_value;
      });
      return settings;
    } catch (error) {
      console.error('Error getting Sage settings:', error);
      return {};
    }
  },
  
  
 async makeRequest(endpoint, method = 'GET', body = null) {
    // Get settings including business ID
    const settings = await this.getSettings();
    
    // Fetch the business ID from settings
    const { data: businessData } = await window.supabase
        .from('company_settings')
        .select('setting_value')
        .eq('setting_name', 'sage_business_id')
        .single();
    
    const businessId = businessData?.setting_value;
    
    const response = await fetch('/api/sage-proxy', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            endpoint: endpoint.startsWith('/') ? endpoint.substring(1) : endpoint,
            method,
            body,
            businessId // Include the business ID
        })
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || `HTTP error! status: ${response.status}`);
    }
    
    return response.json();
},
  
  async refreshToken() {
    try {
      const settings = await this.getSettings();
      if (!settings.refreshToken) return false;
      
      const { data: credentials } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret']);
      
      const clientId = credentials.find(s => s.setting_name === 'sage_client_id')?.setting_value;
      const clientSecret = credentials.find(s => s.setting_name === 'sage_client_secret')?.setting_value;
      
      const response = await fetch('https://oauth.accounting.sage.com/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        
        body: new URLSearchParams({
          grant_type: 'refresh_token',
          refresh_token: settings.refreshToken,
          client_id: clientId,
          client_secret: clientSecret
        })
      });
      
      if (!response.ok) return false;
      
      const tokens = await response.json();
      
      // Save new tokens
      await window.supabase
        .from('company_settings')
        .upsert([
          { setting_name: 'sage_access_token', setting_value: tokens.access_token },
          { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token }
        ], { onConflict: 'setting_name' });
      
      return true;
    } catch (error) {
      console.error('Token refresh failed:', error);
      return false;
    }
  },
  async getContactPersonDetails(customerId) {
  try {
    const customer = await this.makeRequest('contacts/' + customerId);
    
    if (customer?.main_contact_person?.id) {
      const contactPerson = await this.makeRequest('contact_persons/' + customer.main_contact_person.id);
      return {
        telephone: contactPerson.telephone || '',
        mobile: contactPerson.mobile || ''
      };
    }
    return { telephone: '', mobile: '' };
  } catch (error) {
    console.error('Error fetching details for ' + customerId + ':', error);
    return { telephone: '', mobile: '' };
  }
},
  async testConnection() {
    try {
      // Test endpoint to verify connection
      await this.makeRequest('/user');
      return true;
    } catch (error) {
      console.error('Sage connection test failed:', error);
      return false;
    }
  },
  
async getCustomers() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`contacts?contact_type=customer&attributes=all&items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      // Check if there are more pages
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} customers from Sage`);
  return { $items: allItems };
},
 

async getSuppliers() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`contacts?contact_type=supplier&attributes=all&items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      // Check if there are more pages
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} suppliers from Sage`);
  return { $items: allItems };
},

  async getProducts() {
  return this.makeRequest('/products');
},

async getServices() {
  return this.makeRequest('/services');
},

async createDraftInvoice(invoiceData) {
  // If already wrapped in sales_invoice, add status to it
  if (invoiceData.sales_invoice) {
    invoiceData.sales_invoice.status = 'draft';
    return this.makeRequest('sales_invoices', 'POST', invoiceData);
  }
  // Otherwise wrap it properly
  return this.makeRequest('sales_invoices', 'POST', {
    sales_invoice: {
      ...invoiceData,
      status: 'draft'
    }
  });
},
    async syncCustomersFromSage() {
  try {
    const sageCustomers = await this.getCustomers();
    const customerContacts = sageCustomers.$items.filter(function(contact) {
      return contact.contact_types && contact.contact_types.some(function(type) {
        return type.id === 'CUSTOMER';
      });
    });
    
    console.log(`Fetched ${customerContacts.length} customers from Sage`);
    
  //  existingCustomers = await window.supabase
    //  .from('customers')
      //.select('*');
    
    //syncResults = {
      //new: [],
      //updated: [],
      //conflicts: []
    //};
    
    // Continue with the rest of your existing code from line 5565 onwards...

    const existingCustomers = await window.supabase
      .from('customers')
      .select('*');
    
    const syncResults = {
      new: [],
      updated: [],
      conflicts: []
    };
    
 // Inside the for loop that processes sageCustomers
for (const sageCustomer of customerContacts) {
  // DEBUG: Log first 3 customers to see what Sage provides
if (customerContacts.indexOf(sageCustomer) < 3) {
    console.log('=== SAGE CUSTOMER #' + customerContacts.indexOf(sageCustomer) + ' ===');
    console.log('Full object:', sageCustomer);
    console.log('Field names:', Object.keys(sageCustomer));
    
    // Log specific fields we're trying to map
    console.log('Looking for email:', {
        main_contact_email: sageCustomer.main_contact_email,
        email: sageCustomer.email,
        contact_email: sageCustomer.contact_email
    });
    
    console.log('Looking for phone:', {
        main_contact_telephone: sageCustomer.main_contact_telephone,
        telephone: sageCustomer.telephone,
        phone: sageCustomer.phone,
        contact_telephone: sageCustomer.contact_telephone
    });
    
    console.log('Looking for address:', {
        main_address: sageCustomer.main_address,
        address: sageCustomer.address,
        delivery_address: sageCustomer.delivery_address
    });
    
    console.log('Looking for credit info:', {
        credit_limit: sageCustomer.credit_limit,
        credit_days: sageCustomer.credit_days,
        payment_terms: sageCustomer.payment_terms
    });
}
    const existing = existingCustomers.data?.find(
    c => c.sage_id === sageCustomer.id  // Match by Sage ID instead!
);
        // Map Sage fields to your database fields
   // Map Sage fields to your database fields
const mappedCustomer = {
    sage_id: sageCustomer.id,
    name: sageCustomer.displayed_as || '',  // ← Use displayed_as
    email: sageCustomer.email || '',
    phone: '',  // We'll try to get this below
    mobile: '',  
    reference: sageCustomer.reference || '',
    credit_limit: parseFloat(sageCustomer.credit_limit) || 0,
    credit_days: parseInt(sageCustomer.credit_days) || 30,
    account_status: sageCustomer.deletable === false ? 'Active' : 'Inactive',
    main_contact_name: '',
    delivery_address: sageCustomer.delivery_address?.displayed_as || null,
    vat_number: sageCustomer.tax_number || '',
    address: sageCustomer.main_address?.displayed_as || sageCustomer.main_address?.address_line_1 || '',
city: sageCustomer.main_address?.city || '',
postcode: sageCustomer.main_address?.postal_code || '',
county: sageCustomer.main_address?.region || '',
};

// Try to get phone if the method exists
if (this.getContactPersonDetails && sageCustomer.main_contact_person?.id) {
  try {
    console.log(`📞 Fetching phone for ${sageCustomer.displayed_as}...`);
    const fullContact = await this.getContactPersonDetails(sageCustomer.id);
    console.log(`   Result:`, fullContact);
    if (fullContact) {
      mappedCustomer.phone = fullContact.telephone || fullContact.phone || '';
      mappedCustomer.mobile = fullContact.mobile || '';
      mappedCustomer.email = fullContact.email || mappedCustomer.email;
      console.log(`   ✓ Set phone: ${mappedCustomer.phone}, mobile: ${mappedCustomer.mobile}`);
    }
  } catch (err) {
    console.log(`   ✗ Error: ${err.message}`);
  }
} else {
  console.log(`⚠️ Skipping phone for ${sageCustomer.displayed_as}: No contact person ID`);
}

    if (!existing) {
    
        syncResults.new.push(mappedCustomer);
    } else {
    // Update existing customer with latest Sage data
    syncResults.updated.push({
        ...mappedCustomer,
        id: existing.id  // Preserve the existing database ID
    });
}
}
    
    return syncResults;
  } catch (error) {
    console.error('Error syncing customers:', error);
    throw error;
  }
},

async syncSuppliersFromSage() {
    try {
        const sageSuppliers = await this.getSuppliers();
        // Don't filter - use all suppliers that Sage returns
        const supplierContacts = sageSuppliers.$items;
        const { data: existingSuppliers, error } = await window.supabase
            .from('suppliers')
            .select('*');
        
        if (error) throw error;
        
        const syncResults = {
            new: [],
            updated: [],
            conflicts: []
        };
        
        // Inside syncSuppliersFromSage - for the supplier processing loop
        for (const sageSupplier of supplierContacts) {
            const existing = existingSuppliers?.find(
                s => s.sage_id === sageSupplier.id
            );
            
           const mappedSupplier = {
    sage_id: sageSupplier.id,
    name: sageSupplier.displayed_as || sageSupplier.name || '',
    email: sageSupplier.email || '',
    phone: '',  // Will be filled later if available
    address: sageSupplier.main_address?.displayed_as?.replace(/↵/g, ', ').replace(/\n/g, ', ') || '',
    vat_number: sageSupplier.tax_number || '',
    contact_person: sageSupplier.main_contact_person?.displayed_as || '',
    accountstatus: sageSupplier.deletable === false ? 'Active' : 'Inactive',
    accountsemail: sageSupplier.email || '',
    position: '',
    supplierrating: 'A+',
    performancescore: 0,
    preferredsupplier: false,
    credit_limit: parseFloat(sageSupplier.credit_limit) || 0,
    credit_days: parseInt(sageSupplier.credit_days) || 30,
};
            
            // Try to get phone if the method exists
            if (this.getContactPersonDetails && sageSupplier.main_contact_person?.id) {
                try {
                    console.log(`📞 Fetching phone for ${sageSupplier.displayed_as}...`);
                    const fullContact = await this.getContactPersonDetails(sageSupplier.id);
                    console.log('📞 Result:', fullContact);
                    if (fullContact) {
                        mappedSupplier.phone = fullContact.telephone || fullContact.phone || '';
                        mappedSupplier.mobile = fullContact.mobile || '';
                        mappedSupplier.email = fullContact.email || mappedSupplier.email;
                        console.log(`✓ Set phone: ${mappedSupplier.phone}, mobile: ${mappedSupplier.mobile}`);
                    }
                } catch (err) {
                    console.log(`✗ Error: ${err.message}`);
                }
            } else {
                console.log(`⚠️ No contact person for ${sageSupplier.displayed_as}, but still adding supplier`);
            }
            
            // ALWAYS add the supplier regardless of contact details
            if (!existing) {
                syncResults.new.push(mappedSupplier);
            } else {
                syncResults.updated.push({
                    ...mappedSupplier,
                    id: existing.id // IMPORTANT: Preserve the database ID!
                });
            }
        }
        
        return syncResults;
    } catch (error) {
        console.error('Error syncing suppliers:', error);
        throw error;
    }
},
// QUICK SYNC FUNCTIONS - For manual button clicks (new records only, no phone lookups)
async syncCustomersQuick() {
  try {
    console.log('🚀 Starting QUICK customer sync (new records only)...');
    
    const sageCustomers = await this.getCustomers();
    const customerContacts = sageCustomers.$items.filter(contact => 
      contact.contact_types?.some(type => type.id === 'CUSTOMER')
    );
    
    // Get existing Sage IDs only (fast query)
    const { data: existingCustomers } = await window.supabase
      .from('customers')
      .select('sage_id');
    
    const existingSageIds = new Set(existingCustomers?.map(c => c.sage_id) || []);
    const newCustomers = [];
    
    for (const sageCustomer of customerContacts) {
      if (!existingSageIds.has(sageCustomer.id)) {
        console.log(`✅ Found NEW customer: ${sageCustomer.displayed_as}`);
        
        // Quick mapping - NO phone API calls
        const mappedCustomer = {
          sage_id: sageCustomer.id,
          name: sageCustomer.displayed_as || '',
          email: sageCustomer.email || '',
          phone: '', // Skip phone lookup for quick sync
          mobile: '',
          reference: sageCustomer.reference || '',
          credit_limit: parseFloat(sageCustomer.credit_limit) || 0,
          credit_days: parseInt(sageCustomer.credit_days) || 30,
          account_status: sageCustomer.deletable === false ? 'Active' : 'Inactive',
          address: sageCustomer.main_address?.displayed_as || '',
          city: sageCustomer.main_address?.city || '',
          postcode: sageCustomer.main_address?.postal_code || '',
          county: sageCustomer.main_address?.region || '',
          vat_number: sageCustomer.tax_number || '',
          delivery_address: sageCustomer.delivery_address?.displayed_as || null
        };
        
        // Insert immediately
        const { error } = await window.supabase.from('customers').insert(mappedCustomer);
        if (!error) {
          newCustomers.push(mappedCustomer);
        } else {
          console.error(`Failed to insert customer ${sageCustomer.displayed_as}:`, error);
        }
      }
    }
    
    console.log(`✅ Quick sync complete: ${newCustomers.length} new customers added`);
    return { new: newCustomers, updated: [], conflicts: [] };
    
  } catch (error) {
    console.error('❌ Quick customer sync failed:', error);
    throw error;
  }
},

async syncSuppliersQuick() {
    try {
        console.log('🚀 Starting QUICK supplier sync (new records only)...');
        
        const sageSuppliers = await this.getSuppliers();
        
        // Filter to ensure we only have suppliers (not customers)
        const supplierContacts = sageSuppliers.$items.filter(contact => {
            const types = contact.contact_types || [];
            const isSupplier = types.some(t => t.id === 'SUPPLIER' || t.id === 'VENDOR');
            const isCustomer = types.some(t => t.id === 'CUSTOMER');
            return isSupplier && !isCustomer;  // Only suppliers, not dual customer-suppliers
        });
        
        console.log('📊 Raw from Sage:', sageSuppliers.$items.length);
        console.log('📊 Suppliers only:', supplierContacts.length);
        
        // Get existing Sage IDs only (fast query)
        const { data: existingSuppliers, error: fetchError } = await window.supabase
            .from('suppliers')
            .select('sage_id, name');
            
        if (fetchError) {
            console.error('❌ Error fetching existing:', fetchError);
            return;
        }
        
        const existingSageIds = new Set(existingSuppliers?.map(s => s.sage_id) || []);
        const newSuppliers = [];
        
        for (const sageSupplier of supplierContacts) {
            if (!existingSageIds.has(sageSupplier.id)) {
                console.log(`✅ Found NEW supplier: ${sageSupplier.displayed_as}`);
                
                // Mapping matching YOUR DB SCHEMA
                const mappedSupplier = {
                    sage_id: sageSupplier.id,
                    name: sageSupplier.displayed_as || sageSupplier.name || '',
                    email: sageSupplier.email || '',
                    phone: '',  // Will be filled later if available
                    address: sageSupplier.main_address?.displayed_as?.replace(/↵/g, ', ').replace(/\n/g, ', ') || '',
                    vat_number: sageSupplier.tax_number || '',
                    contact_person: sageSupplier.main_contact_person?.displayed_as || '',
                    accountstatus: sageSupplier.deletable === false ? 'Active' : 'Inactive',
                    accountsemail: sageSupplier.email || '',
                    position: '',
                    supplierrating: 'A+',
                    performancescore: 0,
                    preferredsupplier: false,
                    credit_limit: parseFloat(sageSupplier.credit_limit) || 0,
                    credit_days: parseInt(sageSupplier.credit_days) || 30,
                };
                
                // Insert immediately
                const { error } = await window.supabase.from('suppliers').insert(mappedSupplier);
                if (!error) {
                    newSuppliers.push(mappedSupplier);
                } else {
                    console.error(`Failed to insert supplier ${sageSupplier.displayed_as}:`, error);
                }
            }
        }
        
        console.log(`✅ Quick sync complete: ${newSuppliers.length} new suppliers added`);
        
        // Refresh the display
        if (typeof this.loadSuppliers === 'function') {
            await this.loadSuppliers();
        }
        
        return { new: newSuppliers, updated: [], conflicts: [] };
    } catch (error) {
        console.error('❌ Quick supplier sync failed:', error);
        throw error;
    }
},
async getProducts() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`products?items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} products from Sage`);
  return { $items: allItems };
},

async getServices() {
  let allItems = [];
  let page = 1;
  let hasMore = true;
  
  while (hasMore) {
    const response = await this.makeRequest(`services?items_per_page=200&page=${page}`);
    
    if (response && response.$items) {
      allItems = allItems.concat(response.$items);
      
      if (response.$next) {
        page++;
      } else {
        hasMore = false;
      }
    } else {
      hasMore = false;
    }
  }
  
  console.log(`Fetched total of ${allItems.length} services from Sage`);
  return { $items: allItems };
},

async syncProductsFromSage() {
    try {
        // Get both products and services
        const sageProducts = await this.getProducts();
        const sageServices = await this.getServices();
        
        // Combine products and services with proper tagging
        const allProducts = [
            ...(sageProducts.$items || []).map(item => ({ ...item, _isService: false })),
            ...(sageServices.$items || []).map(item => ({ ...item, _isService: true }))
        ];
        
        console.log(`Fetched total of ${allProducts.length} products and services from Sage`);
        
        // Filter out inactive products by fetching full details
        const activeProducts = [];
        
        // Loop through allProducts to check each one
        for (const item of allProducts) {
            try {
                const response = await fetch('/api/sage-proxy', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        endpoint: item._isService ? `services/${item.id}` : `products/${item.id}`,
                        method: 'GET'
                    })
                });
                
                if (!response.ok) {
                    continue;
                }
                
                const fullProduct = await response.json();
                
                // DEBUG: Log first product to see structure
                if (activeProducts.length === 0) {
                }
                
                if (fullProduct.active !== false) {
                    activeProducts.push(item);
                } else {
                }
            } catch (error) {
    // Still try to include it if we can't verify active status
    activeProducts.push(item);
}
        }
        
        
        // Get existing items from Supabase
        const { data: existingItems, error } = await window.supabase
            .from('sage_products')
            .select('*');
        
        if (error) throw error;
        
        const syncResults = {
            new: [],
            updated: [],
            conflicts: []
        };
        
        // Loop through activeProducts instead of allProducts
        for (const sageItem of activeProducts) {
            const existing = existingItems?.find(
                item => item.sage_id === sageItem.id
            );
            
            if (!existing) {
                syncResults.new.push(sageItem);
            }
        }
        
        return syncResults;
    } catch (error) {
        console.error('Error syncing products:', error);
        throw error;
    }
},
  async createInvoice(invoiceData) {
    return this.makeRequest('/sales_invoices', 'POST', invoiceData);
  }
};

// Make SageAPI available globally
window.SageAPI = SageAPI;
// Override the broken compiled version
window.SageAPI.createDraftInvoice = async function(invoiceData) {
  if (invoiceData.sales_invoice) {
    invoiceData.sales_invoice.status = 'draft';
    return this.makeRequest('/sales_invoices', 'POST', invoiceData);
  }
  return this.makeRequest('/sales_invoices', 'POST', {
    sales_invoice: {
      ...invoiceData,
      status: 'draft'
    }
  });
};
// Sage OAuth Handler
window.SageOAuthHandler = {
  authorizationUrl: 'https://www.sageone.com/oauth2/auth/central?filter=apiv3.1',
  tokenUrl: 'https://oauth.accounting.sage.com/token',
  redirect_uri: encodeURIComponent(window.location.origin + '/api/sage-callback'),
  
async connect() {
    try {
        const { data: settings } = await window.supabase
            .from('company_settings')
            .select('*')
            .in('setting_name', ['sage_client_id', 'sage_client_secret']);

        const clientId = settings.find(s => s.setting_name === 'sage_client_id')?.setting_value;
        console.log('Client ID:', clientId);

        if (!clientId) {
            alert('Please configure Sage Client ID in Admin settings first');
            return;
        }

        window.location.href = '/api/sage-auth';
        
    } catch (error) {
        console.error('Error starting OAuth flow:', error);
        alert('Failed to start Sage connection');
    }
},
      

  async handleCallback() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const error = urlParams.get('error');
    
    if (error) {
      console.error('OAuth error:', error);
      alert('Authorization failed: ' + error);
      window.location.href = '/';
      return;
    }
    
    if (!code) {
      console.error('No authorization code received');
      window.location.href = '/';
      return;
    }
    
    //const savedState = localStorage.getItem('sage_oauth_state');
    //if (state !== savedState) {
      //console.error('State mismatch');
      //window.location.href = '/';
      //return;
    //}
    
    try {
      document.getElementById('root').innerHTML = '<div class="min-h-screen flex items-center justify-center"><div class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-lg">Completing Sage connection...</p></div></div>';
      
      const { data: settings } = await window.supabase
        .from('company_settings')
        .select('*')
        .in('setting_name', ['sage_client_id', 'sage_client_secret']);
      
      const clientId = settings.find(s => s.setting_name === 'sage_client_id')?.setting_value;
      const clientSecret = settings.find(s => s.setting_name === 'sage_client_secret')?.setting_value;
      
      if (!clientId || !clientSecret) {
        throw new Error('Missing client credentials');
      }
      
      const tokenData = new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: window.location.origin + '/api/sage-callback',
        client_id: clientId,
        client_secret: clientSecret
      });
      
     const tokenResponse = await fetch('/api/sage-token-exchange', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
    },
    body: JSON.stringify({
        code: code,
        client_id: clientId,
        client_secret: clientSecret,
        redirect_uri: window.location.origin + '/api/sage-callback'
    })
});
      
      if (!tokenResponse.ok) {
        const errorData = await tokenResponse.text();
        console.error('Token response:', errorData);
        throw new Error('Token exchange failed');
      }
      
      const tokens = await tokenResponse.json();
      
      const updates = [
        { setting_name: 'sage_access_token', setting_value: tokens.access_token },
        { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token }
      ];
      
      for (const update of updates) {
        await window.supabase
          .from('company_settings')
          .upsert(update, { onConflict: 'setting_name' });
      }
      
      localStorage.removeItem('sage_oauth_state');
      localStorage.setItem('sage_connected', 'true');
      
     alert('Successfully connected to Sage!');
console.log('DEBUG: About to redirect to /#sage-integration');
console.trace('Stack trace');
debugger;
window.location.href = '/#sage-integration';  // Keep this line!
      
    } catch (error) {
      console.error('Error handling OAuth callback:', error);
      alert('Failed to complete Sage connection: ' + error.message);
      window.location.href = '/#sage-integration';
    }
  }
};
        // Customer Form Component
        const CustomerForm = ({ customer, onClose, onSave }) => {
          const [formData, setFormData] = useState(customer || {
            companyName: '',
            tradingName: '',
            companyNumber: '',
            vatNumber: '',
            primaryContact: '',
            contactPosition: '',
            phone: '',
            mobile: '',
            email: '',
            accountsEmail: '',
            businessType: 'Construction Company',
            siteAddress: '',
            sitePostcode: '',
            billingAddress: '',
            billingPostcode: '',
            creditRating: 'B',
            paymentTerms: 30,
            creditLimit: 10000,
            accountStatus: 'Active',
            wasteCarrierLicense: '',
            insuranceExpiry: '',
            healthSafetyCompliant: false,
            chasAccredited: false,
            preferredContactMethod: 'Email',
            specialRequirements: '',
            accountManager: '',
            dateRegistered: new Date().toISOString().split('T')[0]
          });

          const [activeTab, setActiveTab] = useState('company');

          const handleSubmit = () => {
            const newCustomer = {
              ...formData,
              id: customer?.id || `CUST-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`
            };
            onSave(newCustomer);
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{customer ? 'Edit Customer' : 'Add New Customer'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('company')}
                    className={`px-6 py-3 font-medium ${activeTab === 'company' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Company Details
                  </button>
                  <button
                    onClick={() => setActiveTab('contact')}
                    className={`px-6 py-3 font-medium ${activeTab === 'contact' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Contact Information
                  </button>
                  <button
                    onClick={() => setActiveTab('financial')}
                    className={`px-6 py-3 font-medium ${activeTab === 'financial' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Financial & Compliance
                  </button>
                  <button
                   onClick={() => {
                        setActiveTab('documents');

                     }}
                     className={`px-6 py-3 font-medium ${activeTab === 'documents' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                     Documents
        </button>
                </div>

                <div className="p-6">
                  {/* Company Details Tab */}
                  {activeTab === 'company' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                          <input
                            type="text"
                            value={formData.companyName}
                            onChange={(e) => setFormData({...formData, companyName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Legal company name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Trading Name</label>
                          <input
                            type="text"
                            value={formData.tradingName}
                            onChange={(e) => setFormData({...formData, tradingName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If different from company name"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Registration Number</label>
                          <input
                            type="text"
                            value={formData.companyNumber}
                            onChange={(e) => setFormData({...formData, companyNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="12345678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Number</label>
                          <input
                            type="text"
                            value={formData.vatNumber}
                            onChange={(e) => setFormData({...formData, vatNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="GB123456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Business Type</label>
                          <select
                            value={formData.businessType}
                            onChange={(e) => setFormData({...formData, businessType: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Construction Company">Construction Company</option>
                            <option value="Main Contractor">Main Contractor</option>
                            <option value="Sub Contractor">Sub Contractor</option>
                            <option value="Property Developer">Property Developer</option>
                            <option value="Demolition Contractor">Demolition Contractor</option>
                            <option value="Civil Engineering">Civil Engineering</option>
                            <option value="House Builder">House Builder</option>
                            <option value="Local Authority">Local Authority</option>
                            <option value="Facilities Management">Facilities Management</option>
                            <option value="Retail">Retail</option>
                            <option value="Other">Other</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Status</label>
                          <select
                            value={formData.accountStatus}
                            onChange={(e) => setFormData({...formData, accountStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Closed">Closed</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Site Address</label>
                        <input
                          type="text"
                          value={formData.siteAddress}
                          onChange={(e) => setFormData({...formData, siteAddress: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                          placeholder="Primary site address"
                        />
                        <input
                          type="text"
                          value={formData.sitePostcode}
                          onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Postcode"
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Billing Address</label>
                        <input
                          type="text"
                          value={formData.billingAddress}
                          onChange={(e) => setFormData({...formData, billingAddress: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                          placeholder="If different from site address"
                        />
                        <input
                          type="text"
                          value={formData.billingPostcode}
                          onChange={(e) => setFormData({...formData, billingPostcode: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          placeholder="Postcode"
                        />
                      </div>
                    </div>
                  )}

                  {/* Contact Information Tab */}
                  {activeTab === 'contact' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Contact Name *</label>
                          <input
                            type="text"
                            value={formData.primaryContact}
                            onChange={(e) => setFormData({...formData, primaryContact: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Full name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                          <input
                            type="text"
                            value={formData.contactPosition}
                            onChange={(e) => setFormData({...formData, contactPosition: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Job title"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Office Phone</label>
                          <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 20 1234 5678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                          <input
                            type="tel"
                            value={formData.mobile}
                            onChange={(e) => setFormData({...formData, mobile: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 7123 456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Email *</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="contact@company.com"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Accounts Email</label>
                          <input
                            type="email"
                            value={formData.accountsEmail}
                            onChange={(e) => setFormData({...formData, accountsEmail: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="accounts@company.com"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Preferred Contact Method</label>
                          <select
                            value={formData.preferredContactMethod}
                            onChange={(e) => setFormData({...formData, preferredContactMethod: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Email">Email</option>
                            <option value="Phone">Phone</option>
                            <option value="Mobile">Mobile</option>
                            <option value="WhatsApp">WhatsApp</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Manager</label>
                          <input
                            type="text"
                            value={formData.accountManager}
                            onChange={(e) => setFormData({...formData, accountManager: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Internal account manager"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Special Requirements / Notes</label>
                        <textarea
                          value={formData.specialRequirements}
                          onChange={(e) => setFormData({...formData, specialRequirements: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Any special delivery instructions, site access requirements, etc."
                        />
                      </div>
                    </div>
                  )}

                  {/* Financial & Compliance Tab */}
                  {activeTab === 'financial' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Credit Rating</label>
                          <select
                            value={formData.creditRating}
                            onChange={(e) => setFormData({...formData, creditRating: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="A+">A+ (Excellent)</option>
                            <option value="A">A (Very Good)</option>
                            <option value="B+">B+ (Good)</option>
                            <option value="B">B (Average)</option>
                            <option value="C">C (Below Average)</option>
                            <option value="COD">Cash on Delivery Only</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Credit Limit (£)</label>
                          <input
                            type="number"
                            value={formData.creditLimit}
                            onChange={(e) => setFormData({...formData, creditLimit: parseFloat(e.target.value) || 0})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Terms (days)</label>
                          <select
                            value={formData.paymentTerms}
                            onChange={(e) => setFormData({...formData, paymentTerms: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>Payment in Advance</option>
                            <option value={7}>7 days</option>
                            <option value={14}>14 days</option>
                            <option value={30}>30 days</option>
                            <option value={45}>45 days</option>
                            <option value={60}>60 days</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Date Registered</label>
                          <input
                            type="date"
                            value={formData.dateRegistered}
                            onChange={(e) => setFormData({...formData, dateRegistered: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Waste Carrier License</label>
                          <input
                            type="text"
                            value={formData.wasteCarrierLicense}
                            onChange={(e) => setFormData({...formData, wasteCarrierLicense: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If applicable"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Expiry Date</label>
                          <input
                            type="date"
                            value={formData.insuranceExpiry}
                            onChange={(e) => setFormData({...formData, insuranceExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div className="space-y-3 pt-4 border-t">
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.healthSafetyCompliant}
                            onChange={(e) => setFormData({...formData, healthSafetyCompliant: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Health & Safety Compliant</span>
                        </label>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.chasAccredited}
                            onChange={(e) => setFormData({...formData, chasAccredited: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">CHAS Accredited</span>
                        </label>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {customer ? 'Update Customer' : 'Add Customer'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // Supplier Form Component
        const SupplierForm = ({ supplier, onClose, onSave }) => {
         const [formData, setFormData] = useState({
  companyName: '',
  tradingName: '',
  companyNumber: '',
  vatNumber: '',
  primaryContact: '',
  contactPosition: '',
  phone: '',
  mobile: '',
  email: '',
  accountsEmail: '',
  address: '',
  city: '',
  postcode: '',
  county: '',
  supplierRating: 'B',
  preferredSupplier: false,
  primaryServices: [],
  wasteCarrierLicense: '',
  wasteCarrierExpiry: '',
  environmentalPermits: '',
  publicLiabilityInsurance: '',
  insuranceExpiry: '',
  insuranceAmount: '',
  serviceAreas: [],
  fleetSize: '',
  skipSizes: [],
  aggregateTypes: [],
  certifications: [],
  bankName: '',
  bankAccountNumber: '',
  bankSortCode: '',
  paymentTerms: 30,
  minimumOrderValue: '',
  accountStatus: 'Active',
  performanceScore: 100,
  dateRegistered: new Date().toISOString().split('T')[0],
  notes: '',
  ...(supplier || {})
});
          const [activeTab, setActiveTab] = useState('company');

          const handleSubmit = () => {
            const newSupplier = {
              ...formData,
              id: supplier?.id || `SUPP-${String(Math.floor(Math.random() * 1000)).padStart(3, '0')}`
            };
            onSave(newSupplier);
          };

          const handleServiceChange = (service, checked) => {
            if (checked) {
              setFormData({...formData, primaryServices: [...formData.primaryServices, service]});
            } else {
              setFormData({...formData, primaryServices: formData.primaryServices.filter(s => s !== service)});
            }
          };

          const handleAreaChange = (area, checked) => {
            if (checked) {
              setFormData({...formData, serviceAreas: [...formData.serviceAreas, area]});
            } else {
              setFormData({...formData, serviceAreas: formData.serviceAreas.filter(a => a !== area)});
            }
          };

          const handleCertChange = (cert, checked) => {
            if (checked) {
              setFormData({...formData, certifications: [...formData.certifications, cert]});
            } else {
              setFormData({...formData, certifications: formData.certifications.filter(c => c !== cert)});
            }
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
                <div className="p-6 border-b border-gray-200 flex items-center justify-between">
                  <h2 className="text-xl font-bold">{supplier ? 'Edit Supplier' : 'Add New Supplier'}</h2>
                  <button onClick={onClose}>
                    <X size={24} />
                  </button>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex border-b border-gray-200">
                  <button
                    onClick={() => setActiveTab('company')}
                    className={`px-6 py-3 font-medium ${activeTab === 'company' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Company Details
                  </button>
                  <button
                    onClick={() => setActiveTab('services')}
                    className={`px-6 py-3 font-medium ${activeTab === 'services' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Services & Equipment
                  </button>
                  <button
                    onClick={() => setActiveTab('compliance')}
                    className={`px-6 py-3 font-medium ${activeTab === 'compliance' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
                  >
                    Compliance & Financial
                  </button>
                </div>

                <div className="p-6">
                  {/* Company Details Tab */}
                  {activeTab === 'company' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Name *</label>
                          <input
                            type="text"
                            value={formData.companyName}
                            onChange={(e) => setFormData({...formData, companyName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Legal company name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Trading Name</label>
                          <input
                            type="text"
                            value={formData.tradingName}
                            onChange={(e) => setFormData({...formData, tradingName: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="If different from company name"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Company Registration Number</label>
                          <input
                            type="text"
                            value={formData.companyNumber}
                            onChange={(e) => setFormData({...formData, companyNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="12345678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">VAT Number *</label>
                          <input
                            type="text"
                            value={formData.vatNumber}
                            onChange={(e) => setFormData({...formData, vatNumber: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="GB123456789"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Contact Name *</label>
                          <input
                            type="text"
                            value={formData.primaryContact}
                            onChange={(e) => setFormData({...formData, primaryContact: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Full name"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Position</label>
                          <input
                            type="text"
                            value={formData.contactPosition}
                            onChange={(e) => setFormData({...formData, contactPosition: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Job title"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Office Phone</label>
                          <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({...formData, phone: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 20 1234 5678"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                          <input
                            type="tel"
                            value={formData.mobile}
                            onChange={(e) => setFormData({...formData, mobile: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="+44 7123 456789"
                          />
                        </div>
                      </div>
<div>
  <label className="block text-sm font-medium text-gray-700">Address</label>
  <input
    type="text"
    name="address"
    value={formData.address}
    onChange={(e) => setFormData({...formData, address: e.target.value})}
    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
  />
</div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Primary Email *</label>
                          <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({...formData, email: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="contact@supplier.com"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Accounts Email</label>
                          <input
                            type="email"
                            value={formData.accountsEmail}
                            onChange={(e) => setFormData({...formData, accountsEmail: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="accounts@supplier.com"
                          />
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Rating</label>
                          <select
                            value={formData.supplierRating}
                            onChange={(e) => setFormData({...formData, supplierRating: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="A+">A+ (Excellent)</option>
                            <option value="A">A (Very Good)</option>
                            <option value="A-">A- (Good)</option>
                            <option value="B+">B+ (Above Average)</option>
                            <option value="B">B (Average)</option>
                            <option value="C">C (Below Average)</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Account Status</label>
                          <select
                            value={formData.accountStatus}
                            onChange={(e) => setFormData({...formData, accountStatus: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Closed">Closed</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Performance Score</label>
                          <input
                            type="number"
                            value={formData.performanceScore}
                            onChange={(e) => setFormData({...formData, performanceScore: parseInt(e.target.value) || 100})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            min="0"
                            max="100"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={formData.preferredSupplier}
                            onChange={(e) => setFormData({...formData, preferredSupplier: e.target.checked})}
                            className="mr-2"
                          />
                          <span className="text-sm font-medium">Preferred Supplier</span>
                        </label>
                      </div>
                    </div>
                  )}

                  {/* Services & Equipment Tab */}
                  {activeTab === 'services' && (
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Primary Services</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {['Skip Hire', 'Aggregates Supply', 'Hazardous Waste', 
                            'Muck Away', 'Grab Hire', 'Roll-on Roll-off', 'Plant Hire', 'Haulage', 'Transport'].map(service => (
                            <label key={service} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.primaryServices.includes(service)}
                                onChange={(e) => handleServiceChange(service, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{service}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Service Areas</label>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-2">
                          {['London', 'South East', 'South West', 'Midlands', 'North West', 'North East', 
                            'Scotland', 'Wales', 'Northern Ireland', 'National Coverage'].map(area => (
                            <label key={area} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.serviceAreas?.includes(area) || false}
                                onChange={(e) => handleAreaChange(area, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{area}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Fleet Size</label>
                          <select
                            value={formData.fleetSize}
                            onChange={(e) => setFormData({...formData, fleetSize: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value="">Select fleet size</option>
                            <option value="1-5">1-5 vehicles</option>
                            <option value="6-10">6-10 vehicles</option>
                            <option value="11-20">11-20 vehicles</option>
                            <option value="21-50">21-50 vehicles</option>
                            <option value="50+">50+ vehicles</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Minimum Order Value (£)</label>
                          <input
                            type="number"
                            value={formData.minimumOrderValue}
                            onChange={(e) => setFormData({...formData, minimumOrderValue: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="0.00"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                        <textarea
                          value={formData.notes}
                          onChange={(e) => setFormData({...formData, notes: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={3}
                          placeholder="Special equipment, unique services, operational notes..."
                        />
                      </div>
                    </div>
                  )}

                  {/* Compliance & Financial Tab */}
                  {activeTab === 'compliance' && (
                    <div className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Waste Carrier License *</label>
                          <input
                            type="text"
                            value={formData.wasteCarrierLicense}
                            onChange={(e) => setFormData({...formData, wasteCarrierLicense: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="CBDU123456"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">License Expiry Date</label>
                          <input
                            type="date"
                            value={formData.wasteCarrierExpiry}
                            onChange={(e) => setFormData({...formData, wasteCarrierExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Environmental Permits</label>
                        <textarea
                          value={formData.environmentalPermits}
                          onChange={(e) => setFormData({...formData, environmentalPermits: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          rows={2}
                          placeholder="List any environmental permits held..."
                        />
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Public Liability Insurance</label>
                          <input
                            type="text"
                            value={formData.publicLiabilityInsurance}
                            onChange={(e) => setFormData({...formData, publicLiabilityInsurance: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            placeholder="Policy number"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Expiry Date</label>
                          <input
                            type="date"
                            value={formData.insuranceExpiry}
                            onChange={(e) => setFormData({...formData, insuranceExpiry: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">Insurance Cover Amount (£)</label>
                        <select
                          value={formData.insuranceAmount}
                          onChange={(e) => setFormData({...formData, insuranceAmount: e.target.value})}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                        >
                          <option value="">Select amount</option>
                          <option value="1000000">£1,000,000</option>
                          <option value="2000000">£2,000,000</option>
                          <option value="5000000">£5,000,000</option>
                          <option value="10000000">£10,000,000</option>
                        </select>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">Certifications & Accreditations</label>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                          {['ISO 9001', 'ISO 14001', 'ISO 45001', 'FORS Bronze', 'FORS Silver', 'FORS Gold', 
                            'CHAS', 'SafeContractor', 'Constructionline', 'CLOCS'].map(cert => (
                            <label key={cert} className="flex items-center">
                              <input
                                type="checkbox"
                                checked={formData.certifications?.includes(cert) || false}
                                onChange={(e) => handleCertChange(cert, e.target.checked)}
                                className="mr-2"
                              />
                              <span className="text-sm">{cert}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div className="pt-4 border-t">
                        <h4 className="font-medium text-gray-900 mb-3">Bank Details</h4>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                            <input
                              type="text"
                              value={formData.bankName}
                              onChange={(e) => setFormData({...formData, bankName: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Account Number</label>
                            <input
                              type="text"
                              value={formData.bankAccountNumber}
                              onChange={(e) => setFormData({...formData, bankAccountNumber: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="12345678"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Sort Code</label>
                            <input
                              type="text"
                              value={formData.bankSortCode}
                              onChange={(e) => setFormData({...formData, bankSortCode: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                              placeholder="12-34-56"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Payment Terms (days)</label>
                          <select
                            value={formData.paymentTerms}
                            onChange={(e) => setFormData({...formData, paymentTerms: parseInt(e.target.value)})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          >
                            <option value={0}>Payment on Delivery</option>
                            <option value={7}>7 days</option>
                            <option value={14}>14 days</option>
                            <option value={30}>30 days</option>
                            <option value={45}>45 days</option>
                            <option value={60}>60 days</option>
                          </select>
                        </div>
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">Date Registered</label>
                          <input
                            type="date"
                            value={formData.dateRegistered}
                            onChange={(e) => setFormData({...formData, dateRegistered: e.target.value})}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                          />
                        </div>
                      </div>
                    </div>
                  )}
                </div>

                <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
                  <button
                    onClick={onClose}
                    className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
                  >
                    Cancel
                  </button>
                  <button
                    onClick={handleSubmit}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                  >
                    {supplier ? 'Update Supplier' : 'Add Supplier'}
                  </button>
                </div>
              </div>
            </div>
          );
        };

       // Replace the existing QuoteForm component (around line 7141) with this FULLY TESTED version:

const QuoteForm = ({ quote, onClose, onSave, customers, suppliers, sageProducts = [], user }) => {
  const { wasteTypes } = useWasteTypes();
  const [uploadFile, setUploadFile] = useState(null);
  const [quoteAttachments, setQuoteAttachments] = useState([]);
  
  // Load attachments when quote changes
  useEffect(() => {
    if (quote?.id) {
      loadQuoteAttachments(quote.id);
    }
  }, [quote?.id]);

  const loadQuoteAttachments = async (quoteId) => {
    try {
      const { data, error } = await window.supabase
        .from('quote_attachments')
        .select('*')
        .eq('quote_id', quoteId)
        .order('uploaded_at', { ascending: false });
      
      if (error) throw error;
      setQuoteAttachments(data || []);
    } catch (error) {
      console.error('Error loading attachments:', error);
    }
  };

  const [attachmentType, setAttachmentType] = useState('Quote Document');
  
  const handleDeleteAttachment = async (attachmentId) => {
    if (!window.confirm('Are you sure you want to delete this attachment?')) {
      return;
    }
    
    try {
      const { error } = await window.supabase
        .from('quote_attachments')
        .delete()
        .eq('id', attachmentId);
      
      if (error) throw error;
      
      alert('Attachment deleted successfully!');
      await loadQuoteAttachments(quote.id);
      
    } catch (error) {
      console.error('Error deleting attachment:', error);
      alert('Error deleting attachment: ' + error.message);
    }
  };

  const handleUploadInForm = async () => {
    const attachmentType = document.getElementById('attachment-type')?.value || 'Quote Document';
    const fileInput = document.getElementById('attachment-file');
    const file = fileInput?.files[0];

    if (!attachmentType || !file || !quote) {
      alert('Please select attachment type, file, and ensure a quote is saved first');
      return;
    }

    try {
      const fileName = `quote_${quote.id}_${Date.now()}_${file.name}`;
      const { data: fileData, error: fileError } = await window.supabase.storage
        .from('documents')
        .upload(fileName, file);

      if (fileError) throw fileError;

      const { data: { publicUrl } } = window.supabase.storage
        .from('documents')
        .getPublicUrl(fileName);

      const { error } = await window.supabase
        .from('quote_attachments')
        .insert([{
          quote_id: quote.id,
          file_name: file.name,
          file_url: publicUrl,
          file_type: attachmentType,
          file_size: file.size,
          uploaded_by: user?.email || 'System Admin'
        }]);

      if (error) throw error;

      alert('Attachment uploaded successfully!');
      await loadQuoteAttachments(quote.id);
      
      // Clear the file input
      document.getElementById('attachment-file').value = '';
      
    } catch (error) {
      console.error('Error uploading attachment:', error);
      alert('Error uploading attachment: ' + error.message);
    }
  };

  const [formData, setFormData] = useState(quote || {
    customerName: '',
    id: quote?.id,
    customerPO: '',
    supplierName: '',
    supplierRef: '',
    haulierName: '',
    jobType: 'Skip Hire',
    wasteType: '',
    skipSize: '',
    aggregateType: '',
    quantity: 1,
    unit: 'skip',
    weight: '',
    customerUnitPrice: 0,
    customerFinalPrice: 0,
    vatRate: 20,
    jobDate: job?.jobDate || new Date().toISOString().split('T')[0],
    timeSlot: '',
    collectionDate: '',
    status: 'PENDING',
    priority: 'Medium',
    siteAddress1: '',
    siteAddress2: '',
    siteCity: '',
    sitePostcode: '',
    siteContact: '',
    sitePhone: '',
    siteNotes: '',
    deliveryInstructions: '',
    accessRestrictions: '',
    hazardousWaste: false,
    consignmentNote: '',
    notes: '',
    isDeclined: false,
    sageProductId: '',
    sageProductName: '',
    lineItems: quote?.lineItems || [],
    validUntil: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0],
    createdDate: quote?.createdDate || new Date().toISOString().split('T')[0]
  });

  const [activeTab, setActiveTab] = useState('details');

  // Auto-set unit to tonnes for Aggregates
  useEffect(() => {
    if (formData.jobType === 'Aggregates' && formData.unit !== 'tonnes') {
      setFormData({...formData, unit: 'tonnes'});
    }
  }, [formData.jobType]);

  const calculatePrices = () => {
    const customerTotal = formData.customerUnitPrice * formData.quantity;
    setFormData(prev => ({
      ...prev,
      customerFinalPrice: customerTotal
    }));
  };

  useEffect(() => {
    calculatePrices();
  }, [formData.customerUnitPrice, formData.quantity]);

  const generateQuoteNumber = () => {
    const year = new Date().getFullYear();
    const lastQuoteNumber = parseInt(localStorage.getItem('lastQuoteNumber') || '0');
    const newQuoteNumber = lastQuoteNumber + 1;
    localStorage.setItem('lastQuoteNumber', newQuoteNumber.toString());
    return `QT-${year}-${String(newQuoteNumber).padStart(4, '0')}`;
  };

  const handleSubmit = () => {
    const newQuoteNumber = quote?.quoteNumber || generateQuoteNumber();
    const newQuote = {
      ...formData,
      id: quote?.id || undefined,
      quoteNumber: newQuoteNumber,
      createdDate: quote?.createdDate || new Date().toISOString().split('T')[0],
      totalPrice: formData.customerFinalPrice,
      customerEmail: formData.customerEmail || customers.find(c => c.companyName === formData.customerName)?.email || '',
      customerContact: formData.customerContact || customers.find(c => c.companyName === formData.customerName)?.primaryContact || '',
      customerPhone: formData.customerPhone || customers.find(c => c.companyName === formData.customerName)?.phone || ''
    };
    onSave(newQuote);
  };

  const skipSizes = ['4 yard', '6 yard', '8 yard', '8 yard enclosed', '10 yard', '10 yard enclosed', 
                     '12 yard', '12 yard enclosed', '14 yard', '14 yard enclosed', '16 yard', '16 yard enclosed'];
  const roroSizes = ['20 yard', '40 yard'];
  const timeSlots = ['AM (8:00-12:00)', 'PM (12:00-17:00)'];

  // Filter suppliers who provide haulage services (same as Job Form)
  const hauliers = suppliers.filter(s => 
    s.primaryServices?.includes('Haulage') || 
    s.primaryServices?.includes('Transport')
  );

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto mx-auto">
        <div className="p-6 border-b border-gray-200 flex items-center justify-between">
          <h2 className="text-xl font-bold">{quote ? 'Edit Quote' : 'Add New Quote'}</h2>
          <button onClick={onClose}>
            <X size={24} />
          </button>
        </div>
        
        {/* Tab Navigation - EXACT SAME AS JOB FORM */}
        <div className="flex border-b border-gray-200">
          <button
            onClick={() => setActiveTab('details')}
            className={`px-6 py-3 font-medium ${activeTab === 'details' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
          >
            Quote Details
          </button>
          <button
            onClick={() => setActiveTab('site')}
            className={`px-6 py-3 font-medium ${activeTab === 'site' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
          >
            Site Information
          </button>
          <button
            onClick={() => setActiveTab('financial')}
            className={`px-6 py-3 font-medium ${activeTab === 'financial' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
          >
            Pricing & Status
          </button>
          <button
            onClick={() => setActiveTab('documents')}
            className={`px-6 py-3 font-medium ${activeTab === 'documents' ? 'border-b-2 border-blue-500 text-blue-600' : 'text-gray-600'}`}
          >
            Documents
          </button>
        </div>

        <div className="p-6">
          {/* Quote Details Tab - EXACT COPY OF JOB DETAILS TAB */}
          {activeTab === 'details' && (
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer *</label>
                  <SearchableDropdown
                    options={customers.map(c => ({
                      ...c,
                      name: c.companyName || c.name
                    }))}
                    value={formData.customerName}
                    onChange={(value) => {
                      const customer = customers.find(c => (c.companyName || c.name) === value);
                      setFormData({
                        ...formData,
                        customerName: value,
                        siteContact: customer?.primaryContact || formData.siteContact,
                        customerPhone: customer?.phone || formData.customerPhone,
                        customerEmail: customer?.email || formData.customerEmail
                      });
                    }}
                    placeholder={`Select Customer (${customers.length} available)`}
                    displayField="name"
                    valueField="name"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Customer PO Number</label>
                  <input
                    type="text"
                    value={formData.customerPO}
                    onChange={(e) => setFormData({...formData, customerPO: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    placeholder="Customer purchase order"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Supplier</label>
                  <SearchableDropdown
                    options={suppliers.map(s => ({
                      ...s,
                      name: s.name || s.companyName
                    }))}
                    value={formData.supplierName}
                    onChange={(value) => setFormData({...formData, supplierName: value})}
                    placeholder={`Select Supplier (${suppliers.length} available)`}
                    displayField="name"
                    valueField="name"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Reference</label>
                  <input
                    type="text"
                    value={formData.supplierRef}
                    onChange={(e) => setFormData({...formData, supplierRef: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    placeholder="Supplier job reference"
                  />
                </div>
              </div>

              {formData.jobType === 'Aggregates' && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Haulier</label>
                    <SearchableDropdown
                      options={suppliers.map(s => ({
                        ...s,
                        name: s.name || s.companyName
                      }))}
                      value={formData.haulierName}
                      onChange={(value) => setFormData({...formData, haulierName: value})}
                      placeholder={`Select Haulier (${suppliers.length} available)`}
                      displayField="name"
                      valueField="name"
                    />
                  </div>
                </div>
              )}

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Job Type *</label>
                  <select
                    value={formData.jobType}
                    onChange={(e) => setFormData({...formData, jobType: e.target.value, wasteType: '', skipSize: '', aggregateType: ''})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="Skip Hire">Skip Hire</option>
                    <option value="Aggregates">Aggregates</option>
                    <option value="Waste Collection">Waste Collection</option>
                    <option value="Grab Hire">Grab Hire</option>
                    <option value="Muck Away">Muck Away</option>
                    <option value="Roll-on Roll-off">Roll-on Roll-off</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                  <select
                    value={formData.priority}
                    onChange={(e) => setFormData({...formData, priority: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="Low">Low</option>
                    <option value="Medium">Medium</option>
                    <option value="High">High</option>
                    <option value="Urgent">Urgent</option>
                  </select>
                </div>
              </div>

              {/* SAGE PRODUCT SELECTION - EXACT COPY FROM JOB FORM */}
              {formData.jobType === 'Skip Hire' && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <SageProductSelector 
                      jobType="Skip Hire"
                      selectedProduct={formData.sageProductName}
                      onSelect={(product) => {
                        console.log('Selected product:', product);  // ADD THIS
                        setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
                        const newLineItem = {
                          id: Date.now(),
                          sage_id: product.sage_id,
                          product_name: product.name,
                          description: product.description || product.name,
                          item_code: product.item_code,
                          type: product.type,
                          quantity: 1,
                          unit_price: 0.00,
                          discount: 0.00,
                          vat_rate: 20,
                          total: 0.00,
                          sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
                        };
                        const updatedLineItems = [...(formData.lineItems || []), newLineItem];
                        setFormData({...formData, lineItems: updatedLineItems});
                      }}
                      products={sageProducts}
                    />
                  </div>
                </div>
              )}

              {/* LINE ITEMS TABLE - EXACT COPY FROM JOB FORM */}
              {formData.lineItems && formData.lineItems.length > 0 && (
                <div className="mt-8 p-6 border border-gray-200 rounded-lg bg-gray-50">
                  <h3 className="text-xl font-semibold mb-6">Selected Products & Services</h3>
                  <div className="overflow-x-auto">
                    <table className="w-full border border-gray-300 rounded-lg bg-white">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="px-4 py-3 text-left font-medium w-1/4">Product/Service</th>
                          <th className="px-4 py-3 text-left font-medium w-2/5">Description (Editable)</th>
                          <th className="px-2 py-3 text-left font-medium w-20">Code</th>
                          <th className="px-4 py-3 text-left font-medium w-20">Type</th>
                          <th className="px-4 py-3 text-left font-medium w-20">Quantity</th>
                          <th className="px-4 py-3 text-left font-medium w-20">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {formData.lineItems.map((item, index) => (
                          <tr key={item.id} className="border-t hover:bg-gray-50">
                            <td className="px-4 py-3">{item.product_name}</td>
                            <td className="px-4 py-3">
                              <input
                                type="text"
                                value={item.description}
                                onChange={(e) => {
                                  const updatedItems = [...formData.lineItems];
                                  updatedItems[index].description = e.target.value;
                                  setFormData({...formData, lineItems: updatedItems});
                                }}
                                className="w-full px-3 py-2 border border-gray-300 rounded"
                                placeholder="Edit description..."
                              />
                            </td>
                            <td className="px-2 py-3 text-xs text-gray-500 max-w-20 truncate" title={item.item_code || 'N/A'}>
                              {item.item_code || 'N/A'}
                            </td>
                            <td className="px-4 py-3">
                              <span className={`px-2 py-1 rounded text-xs ${item.type === 'service' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}`}>
                                {item.type}
                              </span>
                            </td>
                            <td className="px-4 py-3">
                              <input
                                type="number"
                                value={item.quantity}
                                onChange={(e) => {
                                  const updatedItems = [...formData.lineItems];
                                  updatedItems[index].quantity = parseInt(e.target.value) || 1;
                                  setFormData({...formData, lineItems: updatedItems});
                                  setFormData(prev => ({...prev, quantity: parseInt(e.target.value) || 1}));
                                }}
                                className="w-20 px-2 py-1 border border-gray-300 rounded text-sm"
                                min="1"
                              />
                            </td>
                            <td className="px-4 py-3">
                              <button 
                                onClick={() => {
                                  const updatedItems = formData.lineItems.filter((_, i) => i !== index);
                                  setFormData({...formData, lineItems: updatedItems});
                                }}
                                className="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700"
                              >
                                Remove
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                  <div className="mt-4 text-sm text-gray-600">
                    Total items: {formData.lineItems.length} | Total quantity: {formData.lineItems.reduce((sum, item) => sum + item.quantity, 0)}
                  </div>
                </div>
              )}

              {/* ALL OTHER JOB TYPES - EXACT COPY */}
              {formData.jobType === 'Roll-on Roll-off' && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <SageProductSelector 
                      jobType="Roll-on Roll-off"
                      selectedProduct={formData.sageProductName}
                      onSelect={(product) => {
                        setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
                        const newLineItem = {
                          id: Date.now(),
                          sage_id: product.sage_id,
                          product_name: product.name,
                          description: product.description || product.name,
                          item_code: product.item_code,
                          type: product.type,
                          quantity: 1,
                          unit_price: 0.00,
                          discount: 0.00,
                          vat_rate: 20,
                          total: 0.00,
                          sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
                        };
                        const updatedLineItems = [...(formData.lineItems || []), newLineItem];
                        setFormData({...formData, lineItems: updatedLineItems});
                      }}
                      products={sageProducts}
                    />
                  </div>
                </div>
              )}

              {formData.jobType === 'Aggregates' && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <SageProductSelector 
                      jobType="Aggregates"
                      selectedProduct={formData.sageProductName}
                      onSelect={(product) => {
                        setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
                        const newLineItem = {
                          id: Date.now(),
                          sage_id: product.sage_id,
                          product_name: product.name,
                          description: product.description || product.name,
                          item_code: product.item_code,
                          type: product.type,
                          quantity: 1,
                          unit_price: 0.00,
                          discount: 0.00,
                          vat_rate: 20,
                          total: 0.00,
                          sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
                        };
                        const updatedLineItems = [...(formData.lineItems || []), newLineItem];
                        setFormData({...formData, lineItems: updatedLineItems});
                      }}
                      products={sageProducts}
                    />
                  </div>
                </div>
              )}

              {(formData.jobType === 'Grab Hire' || formData.jobType === 'Muck Away' || formData.jobType === 'Waste Collection') && (
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <SageProductSelector 
                      jobType={formData.jobType}
                      selectedProduct={formData.sageProductName}
                      onSelect={(product) => {
                        setFormData({...formData, sageProductName: product.name, sage_id: product.sage_id});
                        const newLineItem = {
                          id: Date.now(),
                          sage_id: product.sage_id,
                          product_name: product.name,
                          description: product.description || product.name,
                          item_code: product.item_code,
                          type: product.type,
                          quantity: 1,
                          unit_price: 0.00,
                          discount: 0.00,
                          vat_rate: 20,
                          total: 0.00,
                          sales_ledger_account: product.sales_ledger_account || 'dc4b88bb472b11e9aac702d5719f235e',
nominal_code: product.nominal_code || 'dc4b88bb472b11e9aac702d5719f235e',
tax_code: product.tax_rate_id || 'T1'
                        };
                        const updatedLineItems = [...(formData.lineItems || []), newLineItem];
                        setFormData({...formData, lineItems: updatedLineItems});
                      }}
                      products={sageProducts}
                    />
                  </div>
                </div>
              )}
              
              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                  <input
                    type="number"
                    value={formData.quantity}
                    onChange={(e) => setFormData({...formData, quantity: parseFloat(e.target.value) || 0})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Unit</label>
                  <select
                    value={formData.unit}
                    onChange={(e) => setFormData({...formData, unit: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    disabled={formData.jobType === 'Aggregates'}
                  >
                    <option value="skip">Skip</option>
                    <option value="tonnes">Tonnes</option>
                    <option value="loads">Loads</option>
                    <option value="collections">Collections</option>
                    <option value="days">Days</option>
                  </select>
                </div>
                {formData.jobType !== 'Aggregates' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Weight (tonnes)</label>
                    <input
                      type="number"
                      step="0.1"
                      value={formData.weight}
                      onChange={(e) => setFormData({...formData, weight: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      placeholder="If known"
                    />
                  </div>
                )}
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Proposed Delivery Date</label>
                  <input
                    type="date"
                    value={formData.jobDate}
                    onChange={(e) => setFormData({...formData, jobDate: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  />
                </div>
                {formData.jobType === 'Aggregates' ? (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Time Slot</label>
                    <select
                      value={formData.timeSlot}
                      onChange={(e) => setFormData({...formData, timeSlot: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    >
                      <option value="">Select time slot</option>
                      {timeSlots.map(slot => (
                        <option key={slot} value={slot}>{slot}</option>
                      ))}
                    </select>
                  </div>
                ) : (
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Collection Date</label>
                    <input
                      type="date"
                      value={formData.collectionDate}
                      onChange={(e) => setFormData({...formData, collectionDate: e.target.value})}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    />
                  </div>
                )}
              </div>

              <div>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={formData.hazardousWaste}
                    onChange={(e) => setFormData({...formData, hazardousWaste: e.target.checked})}
                    className="mr-2"
                  />
                  <span className="text-sm font-medium">Contains Hazardous Waste</span>
                </label>
              </div>

              {formData.hazardousWaste && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Consignment Note Number</label>
                  <input
                    type="text"
                    value={formData.consignmentNote}
                    onChange={(e) => setFormData({...formData, consignmentNote: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    placeholder="Hazardous waste consignment note"
                  />
                </div>
              )}
            </div>
          )}

          {/* Site Information Tab - EXACT COPY FROM JOB FORM */}
          {activeTab === 'site' && (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Site Address *</label>
                <input
                  type="text"
                  value={formData.siteAddress1}
                  onChange={(e) => setFormData({...formData, siteAddress1: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                  placeholder="Delivery/collection address"
                />
                <input
                  type="text"
                  value={formData.siteAddress2}
                  onChange={(e) => setFormData({...formData, siteAddress2: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2"
                  placeholder="Address line 2 (optional)"
                />
                <input
                  type="text"
                  value={formData.sitePostcode}
                  onChange={(e) => setFormData({...formData, sitePostcode: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  placeholder="Postcode"
                />
              </div>

              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Name</label>
                  <input
                    type="text"
                    value={formData.siteContact}
                    onChange={(e) => setFormData({...formData, siteContact: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    placeholder="On-site contact person"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Site Contact Phone</label>
                  <input
                    type="tel"
                    value={formData.sitePhone}
                    onChange={(e) => setFormData({...formData, sitePhone: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    placeholder="Mobile number"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Site Notes</label>
                <textarea
                  value={formData.siteNotes}
                  onChange={(e) => setFormData({...formData, siteNotes: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  rows={3}
                  placeholder="Any additional site information, access instructions, etc."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Delivery Instructions</label>
                <textarea
                  value={formData.deliveryInstructions}
                  onChange={(e) => setFormData({...formData, deliveryInstructions: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  rows={3}
                  placeholder="Specific placement instructions, site entry procedure, etc."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Access Restrictions</label>
                <textarea
                  value={formData.accessRestrictions}
                  onChange={(e) => setFormData({...formData, accessRestrictions: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  rows={2}
                  placeholder="Height/width restrictions, weight limits, time restrictions, etc."
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Additional Notes</label>
                <textarea
                  value={formData.notes}
                  onChange={(e) => setFormData({...formData, notes: e.target.value})}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  rows={3}
                  placeholder="Any other relevant information..."
                />
              </div>
            </div>
          )}

         
{activeTab === 'financial' && (
  <div className="space-y-4">
    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Customer Unit Price (£) *</label>
        <input
          type="number"
          step="0.01"
          value={formData.customerUnitPrice}
          onChange={(e) => setFormData({...formData, customerUnitPrice: parseFloat(e.target.value) || 0})}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-1">Supplier Unit Cost (£)</label>
        <input
          type="number"
          step="0.01"
          value={formData.supplierUnitPrice}
          onChange={(e) => setFormData({...formData, supplierUnitPrice: parseFloat(e.target.value) || 0})}
          className="w-full px-3 py-2 border border-gray-300 rounded-lg"
        />
      </div>
    </div>
    
    

              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">VAT Rate (%)</label>
                  <select
                    value={formData.vatRate}
                    onChange={(e) => setFormData({...formData, vatRate: parseFloat(e.target.value)})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value={0}>0% (Zero Rated)</option>
                    <option value={5}>5% (Reduced)</option>
                    <option value={20}>20% (Standard)</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Quote Status</label>
                  <select
                    value={formData.status}
                    onChange={(e) => setFormData({...formData, status: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                  >
                    <option value="PENDING">Pending</option>
                    <option value="SENT">Sent to Customer</option>
                    <option value="ACCEPTED">Accepted</option>
                    <option value="REJECTED">Rejected</option>
                    <option value="CONVERTED">Converted</option>
                    <option value="EXPIRED">Expired</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Created Date</label>
                  <input
                    type="date"
                    value={formData.createdDate}
                    onChange={(e) => setFormData({...formData, createdDate: e.target.value})}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                    disabled
                  />
                </div>
              </div>

            <div className="space-y-3">
  <label className="flex items-center">
    <input
      type="checkbox"
      checked={formData.isDeclined}
      onChange={(e) => setFormData({...formData, isDeclined: e.target.checked, status: e.target.checked ? 'REJECTED' : 'PENDING'})}
      className="mr-2"
    />
    <span className="text-sm font-medium text-red-600">Quote Declined</span>
  </label>
  
  {formData.isDeclined && (
    <div>
      <label className="block text-sm font-medium text-gray-700 mb-1">Rejection Reason</label>
      <textarea
        value={formData.rejectedReason || ''}
        onChange={(e) => setFormData({...formData, rejectedReason: e.target.value})}
        className="w-full px-3 py-2 border border-red-300 rounded-lg"
        rows={2}
        placeholder="Please provide a reason for rejection..."
      />
    </div>
  )}
</div>

              {formData.customerUnitPrice > 0 && (
                <div className="bg-green-50 p-4 rounded-lg">
                  <h4 className="font-medium text-green-900 mb-3">Quote Calculation</h4>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span className="text-green-700">Unit Price:</span>
                      <p className="font-semibold">£{formData.customerUnitPrice.toFixed(2)}</p>
                    </div>
                    <div>
                      <span className="text-green-700">Quantity:</span>
                      <p className="font-semibold">{formData.quantity} {formData.unit}</p>
                    </div>
                    <div>
                      <span className="text-green-700">Net Total:</span>
                      <p className="font-semibold">£{formData.customerFinalPrice.toFixed(2)}</p>
                    </div>
                    <div>
                      <span className="text-green-700">Total + VAT:</span>
                      <p className="font-semibold text-green-600">
                        £{(formData.customerFinalPrice * (1 + formData.vatRate / 100)).toFixed(2)}
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Documents Tab - EXACT COPY FROM JOB FORM BUT FOR QUOTES */}
          {activeTab === 'documents' && (
            <div className="space-y-4">
              <div className="bg-white rounded-lg border border-gray-200 p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Upload Quote Attachments</h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Attachment Type</label>
                    <select id="attachment-type" className="w-full px-3 py-2 border border-gray-300 rounded-lg">
                      <option value="Quote Document">Quote Document</option>
                      <option value="Terms & Conditions">Terms & Conditions</option>
                      <option value="Specifications">Specifications</option>
                      <option value="Site Photos">Site Photos</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">Choose File</label>
                    <input
                      id="attachment-file"
                      type="file"
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg"
                      accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                    />
                  </div>
                  
                  <button
                    type="button"
                    onClick={handleUploadInForm}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                  >
                    Upload Attachment
                  </button>
                </div>

                {/* Display existing attachments */}
                {quoteAttachments.length > 0 && (
                  <div className="mt-6">
                    <h4 className="font-medium text-gray-800 mb-3">Existing Attachments</h4>
                    <div className="space-y-2">
                      {quoteAttachments.map(attachment => (
                        <div key={attachment.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                          <span className="text-sm">{attachment.file_name} ({attachment.file_type})</span>
                          <div className="flex gap-2">
                            <a 
                              href={attachment.file_url} 
                              target="_blank" 
                              rel="noopener noreferrer"
                              className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                            >
                              View
                            </a>
                            {user?.role === 'ADMIN' && (
                              <button
                                type="button"
                                onClick={() => handleDeleteAttachment(attachment.id)}
                                className="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm"
                              >
                                Delete
                              </button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        <div className="p-6 border-t border-gray-200 flex justify-end space-x-4">
          <button
            onClick={onClose}
            className="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
          >
            Cancel
          </button>
          <button
            onClick={handleSubmit}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            {quote ? 'Update Quote' : 'Create Quote'}
          </button>
        </div>
      </div>
    </div>
  );
};

        // Root Component
        const WasteManagementDemo = () => {
          return (
            <WasteTypesProvider>
              <AuthProvider>
                <App />
              </AuthProvider>
            </WasteTypesProvider>
          );
        };

        // Render the app
        ReactDOM.render(<WasteManagementDemo />, document.getElementById('root'));
    </script>
<script>
</script>
<script>
// Check for Sage OAuth success FIRST - BEFORE ANYTHING ELSE
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('sage_success') === 'true') {
    const accessToken = urlParams.get('access_token');
    const refreshToken = urlParams.get('refresh_token');
    
    if (accessToken && refreshToken) {
        // Save tokens to localStorage temporarily
        localStorage.setItem('sage_temp_access_token', accessToken);
        localStorage.setItem('sage_temp_refresh_token', refreshToken);
        localStorage.setItem('sage_oauth_complete', 'true');
        
        // Clean URL and redirect to login
        window.location.href = '/?sage_connection_pending=true';
    }
}

// Wait for Supabase to load
if (typeof window.supabase === 'undefined') {
    console.error('Supabase library not loaded!');
    alert('Supabase library not loaded!');
} else {
    // Initialize Supabase
    const SUPABASE_URL = 'https://ykpbnrjlqlhckmgcoulv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlrcGJucmpscWxoY2ttZ2NvdWx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4MzE0OTAsImV4cCI6MjA2ODQwNzQ5MH0.YSt9xxYSskCp98iJDN0iQ5nNDRbI_EQWNnImcBxVBRU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase;
    // Handle OAuth callback if we're on the callback URL
if (window.location.pathname.includes('/api/sage-callback') ||
    (window.location.search.includes('code='))) {
  // We're on the OAuth callback
  document.getElementById('root').innerHTML = `
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p class="mt-4">Completing Sage connection...</p>
      </div>
    </div>
  `;
  
  // Wait for OAuth handler to be defined
  setTimeout(() => {
    if (window.SageOAuthHandler) {
      window.SageOAuthHandler.handleCallback();
    } else {
      console.error('OAuth handler not ready');
      window.location.href = '/';
    }
  }, 100);
}
    // Add this after line 4921 (window.supabase = supabase;)

// Function to load documents from Supabase
window.loadDocumentsFromSupabase = async function() {
    try {
        console.log('Loading documents from Supabase...');
        
        const { data, error } = await supabase
            .from('documents')
            .select('*')
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading documents:', error);
            return;
        }
        
        if (data && data.length > 0) {
            console.log(`Loaded ${data.length} documents`);
            
            // Find the documents list container
            const docsList = document.querySelector('#docs-list');
            if (docsList) {
                // Clear existing content except the sample
                docsList.innerHTML = '';
                
                // Add each document
                data.forEach(doc => {
                    const docDiv = document.createElement('div');
                    docDiv.className = 'bg-white p-4 rounded-lg shadow hover:shadow-lg transition-shadow';
                    docDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2">${doc.name || 'Untitled'}</h3>
                        <p class="text-gray-600 text-sm mb-3">${doc.type || 'Document'}</p>
                        <div class="flex gap-2">
                            <a href="${doc.file_url}" target="_blank" 
                               class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                                View
                            </a>
                            <button onclick="deleteDocument('${doc.id}')" 
                                    class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600">
                                Delete
                            </button>
                        </div>
                    `;
                    docDiv.setAttribute('data-type', doc.type?.toLowerCase() || '');
                    docsList.appendChild(docDiv);
                });
            }
        } else {
            console.log('No documents found');
        }
    } catch (error) {
        console.error('Error in loadDocumentsFromSupabase:', error);
    }
};
// Function to complete pending Sage connection
async function checkPendingSageConnection() {
    const urlParams = new URLSearchParams(window.location.search);
    
    // Check if we have pending Sage connection
    if (urlParams.get('sage_connection_pending') === 'true' || localStorage.getItem('sage_oauth_complete') === 'true') {
        const accessToken = localStorage.getItem('sage_temp_access_token');
        const refreshToken = localStorage.getItem('sage_temp_refresh_token');
        
        if (accessToken && refreshToken) {
            try {
                // Save tokens to your database
                await window.supabase
                    .from('company_settings')
                    .upsert([
                        { setting_name: 'sage_access_token', setting_value: accessToken },
                        { setting_name: 'sage_refresh_token', setting_value: refreshToken },
                        { setting_name: 'sage_connected', setting_value: 'true' }
                    ]);
                
                // Clean up temporary storage
                localStorage.removeItem('sage_temp_access_token');
                localStorage.removeItem('sage_temp_refresh_token');
                localStorage.removeItem('sage_oauth_complete');
                
                // Set permanent connection flag
                localStorage.setItem('sage_connected', 'true');
                
                // Clean URL and show success
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('Successfully connected to Sage!');
                
                // Redirect to Sage integration page
                window.location.href = '/#sage-integration';
                
            } catch (error) {
                console.error('Error saving Sage tokens:', error);
                alert('Error completing Sage connection');
            }
        }
    }
}

// Load documents when user is authenticated
supabase.auth.getSession().then(({ data: { session } }) => {
  if (session) {
    console.log('User is authenticated, loading documents...');
    window.loadDocumentsFromSupabase();
    
    // Add delay and logging to ensure it runs
    setTimeout(() => {
        console.log('Checking for pending Sage connection...');
        checkPendingSageConnection();
    }, 1000);
}
});
// Also modify your upload function to refresh the list after upload
// Find your uploadDocument function and add this at the end of the success case:
// window.loadDocumentsFromSupabase();
    // Document upload function
    window.documentManager = {
   async uploadDocument() {
    const docType = document.getElementById('doc-category')?.value;
    const docTitle = document.getElementById('doc-title')?.value;
    const fileInput = document.getElementById('doc-file');
    const file = fileInput?.files[0];
    
    if (!docType || !docTitle || !file) {
        alert('Please fill all fields');
        return;
    }
    
    try {
        const fileName = `${Date.now()}_${file.name}`;
        const { data: fileData, error: fileError } = await supabase.storage
            .from('documents')
            .upload(fileName, file);
        
        if (fileError) throw fileError;
        
        const { data: { publicUrl } } = supabase.storage
            .from('documents')
            .getPublicUrl(fileName);
        
        const { data, error } = await supabase
            .from('documents')
            .insert([{
                name: docTitle,
                file_path: fileName,
                file_url: publicUrl,
                file_type: docType,
                file_size: file.size,
                category: 'TEXT'
            }])
            .select();
        
        if (error) throw error;
        // Show success message
alert('Document uploaded successfully!');

// Update the display directly
const container = document.getElementById('docs-list');
if (container) {
  const docDiv = document.createElement('div');
  docDiv.className = 'border rounded-lg p-4';
  docDiv.innerHTML = 
    '<h4 class="font-semibold">' + docTitle + '</h4>' +
    '<p class="text-sm text-gray-600">Type: ' + docType + '</p>' +
    '<p class="text-sm text-gray-600">Uploaded: ' + new Date().toLocaleDateString() + '</p>' +
    '<a href="' + publicUrl + '" target="_blank" class="text-blue-500">View/Download</a>';
  container.appendChild(docDiv);
  
  // Hide the sample document
  const sample = document.querySelector('h4.font-semibold');
  if (sample && sample.textContent.includes('Sample Policy')) {
    sample.parentElement.style.display = 'none';
  }
}
        document.getElementById('doc-title').value = '';
        document.getElementById('doc-file').value = '';
        
       if (window.refreshDocuments) window.refreshDocuments();
        
        // Refresh the page to show the new document
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    }
}
    };
}
// Job attachment upload function
window.uploadJobAttachment = async () => {
  const attachmentType = document.getElementById('attachment-type')?.value;
  const fileInput = document.getElementById('attachment-file');
  const file = fileInput?.files[0];

  if (!attachmentType || !file || !selectedJob) {
    alert('Please select attachment type, file, and ensure a job is selected');
    return;
  }

  try {
    const fileName = `job_${selectedJob.id}_${Date.now()}_${file.name}`;
    const { data: fileData, error: fileError } = await window.supabase.storage
      .from('documents')
      .upload(fileName, file);

    if (fileError) throw fileError;

    const { data: { publicUrl } } = window.supabase.storage
      .from('documents')
      .getPublicUrl(fileName);

    // Save to job_attachments table
    const { data, error } = await window.supabase
      .from('job_attachments')
      .insert([{
        job_id: selectedJob.id,
        file_name: file.name,
        file_url: publicUrl,
        file_type: attachmentType,
        file_size: file.size,
        uploaded_by: user?.email
      }]);

    if (error) throw error;

    alert('Job attachment uploaded successfully!');
    loadJobAttachments(selectedJob.id);
    
    // Clear the form
    document.getElementById('attachment-file').value = '';
  } catch (error) {
    console.error('Error uploading job attachment:', error);
    alert('Error uploading job attachment');
  }
};
// Load job attachments function
window.loadJobAttachments = async (jobId) => {
  try {
    const { data, error } = await window.supabase
      .from('job_attachments')
      .select('*')
      .eq('job_id', jobId)
      .order('uploaded_at', { ascending: false });

    if (error) throw error;

    setJobAttachments(data || []);
  } catch (error) {
    console.error('Error loading job attachments:', error);
    setJobAttachments([]);
  }
};
</script>
<!-- Your existing content -->

<script>
function connectToSagePopup() {
    const width = 600;
    const height = 700;
    const left = (window.screen.width - width) / 2;
    const top = (window.screen.height - height) / 2;
    
    const popup = window.open(
        '/api/sage-auth',
        'sage_oauth',
        `width=${width},height=${height},left=${left},top=${top}`
    );
    
    if (!popup) {
        alert('Please allow popups to connect to Sage');
        return;
    }
    
    const checkInterval = setInterval(() => {
        if (popup.closed) {
            clearInterval(checkInterval);
            checkPendingSageConnection();
        }
    }, 1000);
}

window.addEventListener('message', async (event) => {
    if (event.data.type === 'sage-oauth-complete') {
        console.log('Received OAuth tokens from popup');
        
        const { tokens } = event.data;
        const expiresAt = new Date(Date.now() + (tokens.expires_in * 1000)).toISOString();
        
        try {
            // Update each setting individually with proper upsert
            const settings = [
                { setting_name: 'sage_access_token', setting_value: tokens.access_token },
                { setting_name: 'sage_refresh_token', setting_value: tokens.refresh_token },
                { setting_name: 'sage_token_expires_at', setting_value: expiresAt },
                { setting_name: 'sage_connected', setting_value: 'true' }
            ];
            
            for (const setting of settings) {
                const { error } = await window.supabase
                    .from('company_settings')
                    .upsert(setting, { 
                        onConflict: 'setting_name'
                    });
                
                if (error) {
                    console.error('Error upserting:', setting.setting_name, error);
                }
            }
            
            localStorage.setItem('sage_connected', 'true');
            alert('Successfully connected to Sage!');
            // Don't reload to avoid logout
            // window.location.reload();
            
        } catch (error) {
            console.error('Error saving tokens:', error);
            alert('Error saving Sage connection. Please try again.');
        }
    } else if (event.data.type === 'sage-oauth-error') {
        console.error('OAuth error:', event.data.error);
        alert(`Failed to connect to Sage: ${event.data.error}`);
    }
});
</script>
</script>
</body>
</html>
